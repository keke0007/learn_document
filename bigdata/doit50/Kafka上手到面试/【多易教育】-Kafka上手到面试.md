# 1. kafkaæ˜¯ä»€ä¹ˆ

kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶ˆæ¯ç¼“å­˜ ä¸­é—´ä»¶ï¼›

> æ­¤å¤„çš„â€œæ¶ˆæ¯â€è¿™ä¸ªè¯ï¼Œæ¥è‡ªäºä¸€ç§å†å²æ‚ ä¹…çš„å·¥å…·ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆactiveMQï¼ŒrocksMQï¼ŒrabbitMQç­‰ï¼‰
>
> æ‰€è°“â€œæ¶ˆæ¯é˜Ÿåˆ—â€æ˜¯ä¸€ç§å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒæœ‰ä¸€ä¸ªå…³é”®ç‰¹ç‚¹ï¼š
>
> &#x20;      å­˜å‚¨çš„æ•°æ®ï¼Œä»¥â€œé˜Ÿåˆ—â€ç»“æ„æ¥å­˜å‚¨ï¼ˆæœ‰åºï¼Œå…ˆè¿›å…ˆå‡ºï¼‰
>
> &#x20;      æ•°æ®æ˜¯ä¸€æ¡ä¸€æ¡çš„ï¼Œåœ¨è¿™ç±»å‹å·¥å…·ä¸­æŠŠä¸€æ¡æ•°æ®ç§°ä¹‹ä¸ºä¸€ä¸ªâ€œæ¶ˆæ¯â€
>
> â€œæ¶ˆæ¯é˜Ÿåˆ—â€è¿™ç§å·¥å…·åœ¨åº”ç”¨å¼€å‘ä¸­éå¸¸å¹¿æ³›

è€Œkafkaä¸­ï¼Œç”±äºåˆ†å¸ƒå¼æ¶æ„æ‰€è‡´ï¼Œå®ƒæ— æ³•ä¿è¯æ•°æ®ä¸¥æ ¼æŒ‰ç…§é˜Ÿåˆ—çš„è¦æ±‚æœ‰åºï¼›





# 2. kafkaç”¨æ¥åšä»€ä¹ˆ

å¦‚æœæ˜¯åº”ç”¨å¼€å‘ï¼Œéœ€è¦ç”¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„åœºæ™¯ï¼Œé€šå¸¸ä¸ä¼šä½¿ç”¨kafkaï¼›è€Œæ˜¯ä½¿ç”¨ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼›

***kafkaä¸»è¦ç”¨åœ¨å¤§æ•°æ®çš„æ•°æ®å¼€å‘ä¸­ï¼Œå°¤å…¶æ˜¯å®æ—¶æµå¼è®¡ç®—åœºæ™¯ä¸­ï¼›***

> **ä¸»è¦ä½œç”¨æ˜¯ï¼š**

1. **è§£è€¦ï¼š  æ•°æ®æºçš„æ•°æ®ç”Ÿäº§  å’Œ  æ•°æ®çš„è®¡ç®—ï¼›**

2. **ç¼“å†²ï¼š  å‰Šå³°å¡«è°·ï¼**

![](images/diagram.png)

> ä¸ºä»€ä¹ˆkafkaå¯ç”¨åœ¨ä¸Šè¿°åœºæ™¯

è¿™æ˜¯ç”±kafkaçš„ç‰¹æ€§ï¼Œå’Œå®æ—¶æµå¼è®¡ç®—çš„è¦æ±‚æ‰€å†³å®šï¼›

* å®æ—¶æµå¼è®¡ç®—åœ¨è¯»ã€å†™æ•°æ®çš„æ—¶å€™ï¼Œå°±è¦æ±‚å­˜å‚¨ç³»ç»Ÿçš„æ•°æ® ç»“æ„ç®€å•ã€æœ‰åºè¿ç»­ï¼›è€Œä¸”è¯»å†™é€Ÿåº¦è¦å¿«ï¼›

* è€Œkafkaæ­£å¥½æ»¡è¶³è¿™äº›è¦æ±‚ï¼›





# 3. kafkaçš„å­˜å‚¨å’Œè½¯ä»¶æ¶æ„

## 3.1 è½¯ä»¶æ•´ä½“æ¶æ„

![](images/diagram-1.png)



## 3.2 ç‰©ç†å­˜å‚¨ç»“æ„

* å­˜å‚¨ç›®å½•   **topicåç§°-åˆ†åŒºå·**&#x20;

![](images/å›¾ç‰‡1.png)

> æ³¨ï¼št1ä¸ºtopicçš„åç§°ï¼›è€Œ t1-0 / t1-1 æ˜¯t1çš„ä¸¤ä¸ªåˆ†åŒºæ•°æ®ç›®å½•



* æ¶ˆæ¯åç§»é‡

![](images/image21.png)



* æ•°æ®æ–‡ä»¶&#x20;

ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸æ–­è¿½åŠ åˆ°logæ–‡ä»¶æœ«å°¾ï¼Œä¸ºé˜²æ­¢logæ–‡ä»¶è¿‡å¤§å¯¼è‡´æ•°æ®å®šä½æ•ˆç‡ä½ä¸‹ï¼ŒKafkaé‡‡å–äº†åˆ†ç‰‡å’Œç´¢å¼•æœºåˆ¶ ï¼›

![](images/image25.png)

indexå’Œlogæ–‡ä»¶ä»¥å½“å‰segmentçš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„offsetå‘½åã€‚

![](images/image26.png)

indexç´¢å¼•æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ºï¼š  æ¶ˆæ¯offset -> logæ–‡ä»¶ä¸­è¯¥æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ä½ç½®ï¼›



Kafka ä¸­çš„ç´¢å¼•æ–‡ä»¶ä»¥**ç¨€ç–ç´¢å¼•**ï¼ˆ sparse index ï¼‰çš„æ–¹å¼æ„é€ æ¶ˆæ¯çš„ç´¢å¼•ï¼Œå®ƒå¹¶ä¸ä¿è¯æ¯ä¸ªæ¶ˆæ¯åœ¨ç´¢å¼•æ–‡ä»¶ä¸­éƒ½æœ‰å¯¹åº”çš„ç´¢å¼•ï¼›æ¯å½“å†™å…¥ä¸€å®šé‡ï¼ˆç”± broker ç«¯å‚æ•° log.index.interval.bytes æŒ‡å®šï¼Œé»˜è®¤å€¼ä¸º 4096 ï¼Œå³ 4KB ï¼‰çš„æ¶ˆæ¯æ—¶ï¼Œåç§»é‡ç´¢å¼•æ–‡ä»¶å’Œæ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶åˆ†åˆ«å¢åŠ ä¸€ä¸ªåç§»é‡ç´¢å¼•é¡¹å’Œæ—¶é—´æˆ³ç´¢å¼•é¡¹ï¼Œå¢å¤§æˆ–å‡å° log.index.interval.bytesçš„å€¼ï¼Œå¯¹åº”åœ°å¯ä»¥ç¼©å°æˆ–å¢åŠ ç´¢å¼•é¡¹çš„å¯†åº¦ï¼›

æŸ¥è¯¢æŒ‡å®šåç§»é‡æ—¶ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æ¥å¿«é€Ÿå®šä½åç§»é‡çš„ä½ç½®ã€‚







# 4. å®‰è£…éƒ¨ç½²

1. **ä¸Šä¼ å®‰è£…åŒ…**

2. **è§£å‹**

```plain&#x20;text
tar -zxvf kafka_2.11-2.2.2.tgz tar  -C /opt/apps/
```

* **ä¿®æ”¹é…ç½®æ–‡ä»¶**

```plain&#x20;text
ï¼ˆ1ï¼‰è¿›å…¥é…ç½®æ–‡ä»¶ç›®å½•
[root@linux01 apps]# cd kafka_2.12-2.3.1/config
ï¼ˆ2ï¼‰ç¼–è¾‘é…ç½®æ–‡ä»¶
vi server.properties
#ä¸ºä¾æ¬¡å¢é•¿çš„ï¼š0ã€1ã€2ã€3ã€4ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ id
broker.id=0   
#æ•°æ®å­˜å‚¨çš„â½¬å½• 
log.dirs=/opt/data/kafkadata
#åº•å±‚å­˜å‚¨çš„æ•°æ®ï¼ˆæ—¥å¿—ï¼‰ç•™å­˜æ—¶é•¿ï¼ˆé»˜è®¤7å¤©ï¼‰
log.retention.hours=168
#åº•å±‚å­˜å‚¨çš„æ•°æ®ï¼ˆæ—¥å¿—ï¼‰ç•™å­˜é‡ï¼ˆé»˜è®¤1Gï¼‰ 
log.retention.bytes=1073741824
#æŒ‡å®šzké›†ç¾¤åœ°å€
zookeeper.connect=linux01:2181,linux02:2181,linux03:2181
```

* **åˆ†å‘å®‰è£…åŒ…**

```plain&#x20;text
for  i  in {2..3} 
do 
scp  -r  kafka_2.11-2.2.2  linux0$i:$PWD 
done
```

> å®‰è£…åŒ…åˆ†å‘åï¼Œè®°å¾—ä¿®æ”¹config/server.propertiesä¸­çš„ é…ç½®å‚æ•°ï¼š broker.id

* **ç¯å¢ƒå˜é‡**

```plain&#x20;text
vi /etc/profile
export KAFKA_HOME=/opt/apps/kafka_2.11-2.2.2
export PATH=$PATH:$KAFKA_HOME/bin 

source /etc/profile
# æ³¨æ„ï¼šè¿˜éœ€è¦åˆ†å‘ç¯å¢ƒå˜é‡
```

* **å¯åœé›†ç¾¤ï¼ˆåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨ï¼‰**

```plain&#x20;text
bin/kafka-server-start.sh -daemon /opt/apps/kafka_2.11-2.2.2/config/server.properties   

# åœæ­¢é›†ç¾¤
bin/kafka-server-stop.sh
```

* **ä¸€é”®å¯åœè„šæœ¬ï¼š**

```plain&#x20;text
#!/bin/bash

case $1 in
"start"){
        for i in linux01 linux02 linux03
        do
        echo ---------- kafka $i å¯åŠ¨ ------------
                ssh $i "source /etc/profile;  /opt/app/kafka2.4.1/bin/kafka-server-start.sh -daemon /opt/app/kafka2.4.1/config/server.properties"
        done
};;
"stop"){
        for i in linux01 linux02 linux03
        do
        echo ---------- kafka $i åœæ­¢ ------------
                ssh $i "source /etc/profile;  /opt/app/kafka2.4.1/bin/kafka-server-stop.sh "
        done
};;
esac
```

æ›´ç²¾ç®€ç‰ˆæœ¬ï¼š

```shell
#!/bin/bash
export KAFKA_HOME=/opt/app/kafka-2.8.2
for host in doitedu01 doitedu02 doitedu03
do

echo "${1}ing $host .............."
ssh $host "source /etc/profile;${KAFKA_HOME}/bin/kafka-server-${1}.sh -daemon ${KAFKA_HOME}/config/server.properties"

done
```









# 5. ä½¿ç”¨æ“ä½œ

## 5.1 å‘½ä»¤è¡Œå®¢æˆ·ç«¯ç®€å•ä½“éªŒ

åˆ›å»ºtopic

```shell
[root@doitedu01 kafka-2.8.2]# bin/kafka-topics.sh \
--create  \
--topic user-actions \
--partitions 2 \
--replication-factor 2 -\
-zookeeper doitedu01:2181
```



åˆ—å‡ºæ‰€æœ‰topic

```shell
[root@doitedu01 kafka-2.8.2]# bin/kafka-topics.sh --list --zookeeper doitedu01:2181
```





ç”Ÿäº§æ•°æ®

```shell
[root@doitedu01 kafka-2.8.2]# bin/kafka-console-producer.sh \
--topic user-actions \
--bootstrap-server doitedu01:9092
```





æ¶ˆè´¹æ•°æ®

```shell
[root@doitedu01 kafka-2.8.2]# bin/kafka-console-consumer.sh \
--bootstrap-server doitedu01:9092 \
--topic user-actions \
--from-beginning
```













## 5.2 javaå®¢æˆ·ç«¯ä½¿ç”¨

### 5.2.1 ç”Ÿäº§è€…

#### åŸºæœ¬ç¤ºä¾‹

```java
package top.doe.kafka.demos;

import com.alibaba.fastjson.JSONObject;
import org.apache.commons.lang3.RandomStringUtils;
import org.apache.commons.lang3.RandomUtils;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.serialization.StringSerializer;

import java.util.Properties;

public class ProducerDemo1 {
    public static void main(String[] args) throws InterruptedException {

        Properties props = new Properties();
        //æŒ‡å®škafkaé›†ç¾¤çš„åœ°å€
        props.setProperty("bootstrap.servers", "doitedu01:9092,doitedu02:9092,doitedu03:9092");
        //æŒ‡å®škeyçš„åºåˆ—åŒ–æ–¹å¼
        props.setProperty("key.serializer", StringSerializer.class.getName());
        //æŒ‡å®švalueçš„åºåˆ—åŒ–æ–¹å¼
        props.setProperty("value.serializer", StringSerializer.class.getName());
        //ackæ¨¡å¼ï¼Œå–å€¼æœ‰0ï¼Œ1ï¼Œ-1ï¼ˆallï¼‰ï¼Œallæ˜¯æœ€æ…¢ä½†æœ€å®‰å…¨çš„  æœåŠ¡å™¨åº”ç­”ç”Ÿäº§è€…æˆåŠŸçš„ç­–ç•¥
        props.put("acks", "all");
        //è¿™æ˜¯kafkaå‘é€æ•°æ®å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œè¿™ä¸ªå¯èƒ½ä¼šé€ æˆå‘é€æ•°æ®çš„ä¹±åºé—®é¢˜
        props.setProperty("retries", "3");
        //æ•°æ®å‘é€æ‰¹æ¬¡çš„å¤§å° å•ä½æ˜¯å­—èŠ‚
        props.setProperty("batch.size", "1024");
        //ä¸€æ¬¡æ•°æ®å‘é€è¯·æ±‚æ‰€èƒ½å‘é€çš„æœ€å¤§æ•°æ®é‡
        props.setProperty("max.request.size", "102400");
        //æ¶ˆæ¯åœ¨ç¼“å†²åŒºä¿ç•™çš„æ—¶é—´ï¼Œè¶…è¿‡è®¾ç½®çš„å€¼å°±ä¼šè¢«æäº¤åˆ°æœåŠ¡ç«¯
        props.put("linger.ms", 1000);
        //æ•´ä¸ªProducerç”¨åˆ°æ€»å†…å­˜çš„å¤§å°ï¼Œå¦‚æœç¼“å†²åŒºæ»¡äº†ä¼šæäº¤æ•°æ®åˆ°æœåŠ¡ç«¯
        //buffer.memoryè¦å¤§äºbatch.sizeï¼Œå¦åˆ™ä¼šæŠ¥ç”³è¯·å†…å­˜ä¸è¶³çš„é”™è¯¯
        props.put("buffer.memory", 2048);


        // æ„é€ ç”Ÿäº§è€…å®¢æˆ·ç«¯å¯¹è±¡
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);


        String[] devices = {"mi8","oppo6","mate-x","phone-16","mi10","serial-T"};


        for(int i=0;i<1000;i++) {
            // ä¸šåŠ¡é€»è¾‘,åœ¨äº§ç”Ÿæ•°æ®
            JSONObject dataObj = new JSONObject();

            String uid = RandomStringUtils.randomNumeric(5);
            dataObj.put("uid", uid);
            dataObj.put("event_id", RandomStringUtils.randomAlphabetic(4).toUpperCase());
            dataObj.put("action_time", System.currentTimeMillis());
            dataObj.put("device_type", devices[RandomUtils.nextInt(0, devices.length)]);

            // æŠŠä¸šåŠ¡é€»è¾‘äº§ç”Ÿçš„æ•°æ®ï¼Œå†™å…¥kafka
            // å…ˆæŠŠä¸šåŠ¡æ•°æ®ï¼Œå°è£…æˆkafkaçš„ç”Ÿäº§è€…recordå¯¹è±¡

            int partitionId = Integer.parseInt(uid) % 3;
            // æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„éœ€æ±‚ï¼Œæ¥è¿›è¡Œæ•°æ®çš„åˆ†åŒºï¼›å¦‚æœä¸æŒ‡å®šæ•°æ®çš„åˆ†åŒºï¼Œåˆ™producerä¼šéšæœºé€‰æ‹©ä¸€ä¸ªåˆ†åŒº
            ProducerRecord<String, String> record = new ProducerRecord<>("stu",partitionId, uid, dataObj.toJSONString());

            // ç„¶åå‘é€
            producer.send(record);

            Thread.sleep(100);
        }

        // æ”¶å°¾ï¼ŒæŠŠæœ€åä¸€æ‰¹æ”’åœ¨ç¼“å­˜ä¸­çš„æ•°æ®åˆ·å‡ºå»
        producer.flush();
        producer.close();


    }
}
```



#### å…³é”®ç»†èŠ‚

* ç”Ÿäº§è€…å‘é€æ•°æ®æ˜¯å¯ä»¥æŒ‰ç…§æ‰¹æ¬¡å‘é€ï¼ˆå¯ä»¥é…ç½®æ‰¹æ¬¡å¤§å°ï¼Œæ”’æ‰¹æ¬¡çš„æ—¶é•¿ï¼Œç¼“å­˜çš„å¤§å°ï¼‰

* ç”Ÿäº§è€…å‘é€æ•°æ®æ—¶å¯ä»¥æŒ‡å®šâ€œç¡®è®¤æ¨¡å¼â€\[ackæ¨¡å¼,ackçº§åˆ«] ï¼Œackæœ‰3ç§çº§åˆ«ï¼š&#x20;

  * 0ï¼ˆNone)  ï¼š ç”Ÿäº§è€…ä¸éœ€è¦é›†ç¾¤ç«¯çš„ç¡®è®¤ï¼Œå°±è®¤ä¸ºæ•°æ®å‘é€æˆåŠŸ

  * 1 (leader) ï¼š ç”Ÿäº§è€…éœ€è¦é›†ç¾¤ç«¯çš„åˆ†åŒºleaderå­˜å¥½æ•°æ®å†ç¡®è®¤ï¼Œå¾—åˆ°ç¡®è®¤æ‰è®¤ä¸ºæ•°æ®å‘é€æˆåŠŸ

  * -1(allï¼‰ï¼š     ç”Ÿäº§è€…éœ€è¦é›†ç¾¤ç«¯çš„åˆ†åŒºæ‰€æœ‰åŒæ­¥å‰¯æœ¬éƒ½å­˜å¥½æ•°æ®å†åé¦ˆç¡®è®¤ï¼Œå¾—åˆ°ç¡®è®¤æ‰è®¤ä¸ºæ•°æ®å‘é€æˆåŠŸ

* ç”Ÿäº§è€…å‘é€æ•°æ®æ—¶å¯ä»¥ç»™æ¯æ¡æ•°æ®éƒ½æŒ‡å®šç›®æ ‡åˆ†åŒºï¼ˆé»˜è®¤æ˜¯éšæœºï¼‰

* ç”Ÿäº§è€…å‘é€æ•°æ®å¦‚æœå¤±è´¥ï¼ˆæ²¡æœ‰å¾—åˆ°ç¡®è®¤ç­‰ï¼‰ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨é‡è¯•

* ç”Ÿäº§è€…å‘é€æ•°æ®å¯ä»¥ä¿è¯å¹‚ç­‰æ€§

* ç”Ÿäº§è€…å‘é€æ•°æ®å¯ä»¥å¼€å¯äº‹åŠ¡ï¼ˆä¼ªäº‹åŠ¡ï¼Œäº‹åŠ¡å¦‚æœå¤±è´¥ï¼Œæ•°æ®ä¹Ÿæ— æ³•çœŸæ­£å›æ»šï¼Œä½†æ•°æ®çš„æ¶ˆè´¹è€…å¯ä»¥é€‰æ‹©åªè¯»commitedï¼‰





### 5.2.2 æ¶ˆè´¹è€…

#### åŸºæœ¬ç¤ºä¾‹

```java
package top.doe.kafka.demos;


import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.common.header.Header;
import org.apache.kafka.common.header.Headers;
import org.apache.kafka.common.record.TimestampType;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.io.IOException;
import java.time.Duration;
import java.util.*;

public class ConsumerDemo1 {
    public static void main(String[] args) throws IOException {

        Properties props = new Properties();
        // åŠ è½½propertiesé…ç½®æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨è§£æ
        props.load(ConsumerDemo1.class.getClassLoader().getResourceAsStream("consumer.properties"));

        // æ„é€ æ¶ˆè´¹è€…å®¢æˆ·ç«¯
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

        // è®¢é˜…ä¸»é¢˜ topic;  å„ä¸»é¢˜çš„å„åˆ†åŒºå¦‚ä½•åœ¨ç»„ä¸­åˆ†é…ï¼Œæ˜¯è‡ªåŠ¨å‡è¡¡åˆ†é…çš„
        //consumer.subscribe(Collections.singletonList("stu"));


        //  æ‰‹åŠ¨åˆ†é…ä¸»é¢˜åˆ†åŒºç»™æ¶ˆè´¹è€…
        TopicPartition tp0 = new TopicPartition("stu", 0);
        TopicPartition tp1 = new TopicPartition("stu", 1);
        TopicPartition tp2 = new TopicPartition("stu", 2);
        //  æ‰‹åŠ¨åˆ†é…ä¸»é¢˜åˆ†åŒºç»™æ¶ˆè´¹è€…
        consumer.assign(Arrays.asList(tp0,tp1,tp2));
        // æ‰‹åŠ¨æŒ‡å®šå„åˆ†åŒºçš„æ¶ˆè´¹èµ·å§‹ä½ç§»
        consumer.seek(tp0,255);
        consumer.seek(tp1,240);
        consumer.seek(tp2,245);


        // æ‹‰å–æ•°æ®
        while (true) {

            // è¿™é‡Œæ‰€æ‹‰å–çš„æ•°æ®ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªä¸»é¢˜ã€å¤šä¸ªåˆ†åŒºçš„æ•°æ®
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));

            // ä»æ‹‰å–åˆ°çš„æ•°æ®ä¸­ï¼Œè·å–æŒ‡å®štopicæŒ‡å®špartitionçš„æ•°æ®
            //TopicPartition tp0 = new TopicPartition("stu", 0);
            //List<ConsumerRecord<String, String>> tp0Records = records.records(tp0);

            // ä»æ‹‰å–åˆ°çš„æ•°æ®ä¸­ï¼Œè·å–æŒ‡å®štopicçš„æ•°æ®
            //Iterable<ConsumerRecord<String, String>> rc = records.records("stu");

            // æŠŠæœ¬æ¬¡æ‹‰å–çš„æ‰€æœ‰æ•°æ®è½¬æˆä¸€ä¸ªè¿­ä»£å™¨
            Iterator<ConsumerRecord<String, String>> iter = records.iterator();

            while(iter.hasNext()){
                // è¿­ä»£åˆ°ä¸€æ¡æ•°æ®
                ConsumerRecord<String, String> record = iter.next();

                // è·å–æ•°æ®çš„header
                Headers headers = record.headers();
                Iterator<Header> headerIter = headers.iterator();
                while(headerIter.hasNext()){
                    Header header = headerIter.next();
                    String key = header.key();
                    byte[] valueBytes = header.value();
                    System.out.println("æœ¬æ¡æ•°æ®çš„header: " + key + "->" + new String(valueBytes));
                }


                // è·å–æ•°æ®çš„keyå’Œvalue
                String recordKey = record.key();
                String recordValue = record.value();
                System.out.println(String.format("æœ¬æ¡æ•°æ®çš„key: %s , value: %s",recordKey,recordValue));


                // è·å–æ•°æ®æ‰€å±çš„topic
                String topic = record.topic();
                System.out.println(String.format("æœ¬æ¡æ•°æ®æ‰€å±çš„topic: %s",topic));


                // è·å–æ•°æ®æ‰€å±çš„partition
                int partition = record.partition();
                System.out.println(String.format("æœ¬æ¡æ•°æ®æ‰€å±çš„partition: %d",partition));

                // è·å–æœ¬æ¡æ•°æ®çš„offset
                long offset = record.offset();
                System.out.println(String.format("æœ¬æ¡æ•°æ®çš„offset: %d",offset));

                // è·å–æœ¬æ¡æ•°æ®æ‰€å±çš„leaderçºªå…ƒ
                Optional<Integer> epoch = record.leaderEpoch();
                System.out.println("å½“å‰çš„leader epoch: " + epoch);

                // è·å–æœ¬æ¡æ•°æ®çš„æ—¶é—´æˆ³
                // é»˜è®¤æ˜¯ CREATE_TIME
                // kafkaä¸­çš„æ•°æ®çš„æ—¶é—´æˆ³ï¼Œæœ‰3ç§ç±»å‹ï¼š NO_TIMESTAMP_TYPE,CREATE_TIME,LOG_APPEND_TIME
                long timestamp = record.timestamp();
                System.out.println(String.format("æœ¬æ¡æ•°æ®çš„timestamp: %d",timestamp));
                TimestampType timestampType = record.timestampType();
                System.out.println("æœ¬æ¡æ•°æ®çš„timestampç±»å‹ä¸ºï¼š" + timestampType);


                System.out.println("--------------------------------------------");

            }
        }

    }
}
```







#### å…³é”®ç»†èŠ‚

* ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶æ¶ˆè´¹å¤šä¸ªtopicã€å¤šä¸ªåˆ†åŒº





* **æ¶ˆè´¹è€…å¯ä»¥ä»æŒ‡å®šçš„åˆ†åŒºçš„æŒ‡å®šçš„ä½ç½®ï¼ˆoffsetã€timestampï¼‰å¼€å§‹æ¶ˆè´¹**

  * ä»åˆ†åŒºçš„å¼€å¤´å¼€å§‹ï¼šearliest

  * ä»åˆ†åŒºçš„æœ€æ–°å¼€å§‹ï¼šlatest

  * ä»åˆ†åŒºçš„æŒ‡å®šoffsetå¼€å§‹

  * ä»åˆ†åŒºçš„æŒ‡å®šçš„timestampå¼€å§‹



* **æ¶ˆè´¹è€…ç»„ï¼ˆæ¶ˆè´¹ç»„ï¼‰**

> æ¶ˆè´¹ç»„æ˜¯ä¸ºäº†æé«˜æ¶ˆè´¹ç«¯å¹¶è¡Œåº¦çš„è‡ªåŠ¨å‡è¡¡çš„æ¦‚å¿µ
>
> kafkaçš„æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡ä¸€ä¸ªæ¶ˆè´¹ç»„idæ ‡è¯†ï¼Œç»„ç»‡æˆâ€œç»„â€
>
> åŒä¸€ä¸ªæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…ï¼Œåœ¨æ¶ˆè´¹topicæ•°æ®æ—¶ï¼Œä¼šåˆ†å·¥ï¼šåŒä¸€ä¸ªpartitionåªä¼šåˆ†é…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ¶ˆè´¹
>
> è¿™ä¸ªåˆ†å·¥æ˜¯è‡ªåŠ¨å‡è¡¡çš„&#x20;
>
> åœ¨è¿è¡Œæ—¶ï¼Œæ¶ˆè´¹ç»„ä¸­æ–°å¢æˆ–å‡å°‘æ¶ˆè´¹è€…ï¼Œéƒ½ä¼šå¼•èµ·ç»„å†…çš„åŠ¨æ€å†å‡è¡¡





> å¦‚æœç”¨subscribe()è®¢é˜…ä¸»é¢˜ï¼Œèµ·å§‹ä½ç½®æ˜¯ä»æœ¬æ¶ˆè´¹ç»„ä¹‹å‰æ‰€è®°å½•çš„æ¶ˆè´¹ä½ç§»å¼€å§‹å¾€ä¸‹è¯»ï¼›
>
> å¦‚æœæ­¤å‰æ²¡æœ‰è¯¥ç»„çš„åç§»é‡è®°å½•ï¼Œåˆ™æŒ‰å‚æ•°  "auto.offset.reset" æ‰€æŒ‡å®šçš„ä½ç½®è¯»ï¼ˆæ¯”å¦‚earliestã€latestï¼‰

```java
consumer.subscribe(Arrays.asList("stu-a","stu-b"));
```

> è¿™ç§æ–¹å¼ä¸‹ï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œåˆ†é…æ‰€è®¢é˜…ä¸»é¢˜çš„åˆ†åŒºï¼Œæ˜¯è‡ªåŠ¨åˆ†é…çš„ï¼›





> å¦‚æœç”¨assign()è®¢é˜…ä¸»é¢˜åˆ†åŒºï¼Œåˆ™å¯ä»¥æ‰‹åŠ¨æŒ‡å®šå„åˆ†åŒºçš„è¯»å–èµ·å§‹offsetï¼›

```java
//  æ„é€ topicPartitionå¯¹è±¡æ¥æè¿°å„ä¸»é¢˜åˆ†åŒº
TopicPartition tp0 = new TopicPartition("stu", 0);
TopicPartition tp1 = new TopicPartition("stu", 1);
TopicPartition tp2 = new TopicPartition("stu", 2);

//  æ‰‹åŠ¨åˆ†é…ä¸»é¢˜åˆ†åŒºç»™æ¶ˆè´¹è€…
consumer.assign(Arrays.asList(tp0,tp1,tp2));

// æ‰‹åŠ¨æŒ‡å®šå„åˆ†åŒºçš„æ¶ˆè´¹èµ·å§‹ä½ç§»
consumer.seek(tp0,255);
consumer.seek(tp1,240);
consumer.seek(tp2,245);
```

> åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå“ªä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å“ªä¸ªåˆ†åŒºï¼Œå…¨æ˜¯æ‰‹åŠ¨æ˜¾å¼æŒ‡å®šçš„
>
> æ‰‹åŠ¨åˆ†é…åˆ†åŒºçš„æ–¹å¼ä¸‹ï¼Œæ¶ˆè´¹ç»„çš„è‡ªåŠ¨å‡è¡¡æœºåˆ¶å°±å¤±æ•ˆ





* **æ¶ˆè´¹ä½ç§»çš„è‡ªåŠ¨æäº¤æœºåˆ¶**

kafkaä¸­çš„æ¯ä¸€æ¡æ¶ˆæ¯ï¼Œéƒ½æœ‰ä¸€ä¸ªåç§»é‡offset

æ¶ˆè´¹è€…é€šå¸¸éƒ½æ˜¯è¦æŒç»­æ¶ˆè´¹çš„ï¼Œä¸ºäº†åœ¨æ•…éšœé‡å¯åè¿˜èƒ½ä»æ•…éšœå‰çš„ä½ç½®æ¥ç€æ¶ˆè´¹ï¼Œæ‰€ä»¥éœ€è¦å®šæœŸåœ°è®°å½•æ¶ˆè´¹åˆ°çš„ä½ç½®ï¼ˆæ¶ˆè´¹ä½ç§»ï¼‰

kafkaçš„æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œæ‹¥æœ‰è‡ªåŠ¨è®°å½•æ¶ˆè´¹ä½ç§»çš„åŠŸèƒ½ï¼›

è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»çš„åŠŸèƒ½ï¼š&#x20;



* **æ¶ˆè´¹ä½ç§»çš„æäº¤å­˜åœ¨çš„é—®é¢˜**

åœºæ™¯1ï¼šå¦‚æœæ‹‰äº†ä¸€æ‰¹æ•°æ®ï¼Œè¿˜æ²¡æœ‰è®¡ç®—ï¼Œå…ˆæ›´æ–°äº†æ¶ˆè´¹ä½ç§»ï¼›

> æ•…éšœé‡å¯åï¼Œå¯èƒ½ä¼šæ¼å¤„ç†æ•°æ®ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰



åœºæ™¯2ï¼šå¦‚æœæ‹‰äº†ä¸€æ‰¹æ•°æ®ï¼Œè®¡ç®—æˆåŠŸï¼Œå†æ›´æ–°æ¶ˆè´¹ä½ç§»ï¼›

> æ•…éšœé‡å¯åï¼Œå¯èƒ½ä¼šé‡å¤å¤„ç†æ•°æ®ï¼ˆæ•°æ®é‡å¤ï¼‰



> å¦‚æœä½¿ç”¨kafkaæ¶ˆè´¹è€…çš„è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»æœºåˆ¶ï¼Œåˆ™ä¸Šè¿°çš„ä¸¤ç§æ¼æ´éƒ½æœ‰å¯èƒ½å‘ç”Ÿ





* æ¶ˆè´¹ç»„å†å‡è¡¡æµ‹è¯•

å¦‚æœç”¨subscribe() è®¢é˜…ä¸»é¢˜ï¼Œåˆ™å„ä¸»é¢˜çš„å„åˆ†åŒºï¼Œåœ¨ç»„å†…æ˜¯è‡ªåŠ¨å‡è¡¡åˆ†é…çš„ï¼›

è€Œä¸”ï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç»„å†…å¢åŠ äº†æ–°çš„æ¶ˆè´¹è€…ï¼Œæˆ–å‡å°‘äº†ä¹‹å‰çš„æ¶ˆè´¹è€…ï¼Œéƒ½ä¼šè§¦å‘ç»„å†…çš„å†å‡è¡¡æµç¨‹ï¼Œé‡æ–°åˆ†é…ç›®æ ‡åˆ†åŒºï¼›











# 6. åŸç†åŠ å¼ºï¼ˆé¢è¯•é‡ç‚¹ï¼‰

## 6.1 kafkaçš„æ•°æ®å¯é æ€§æ˜¯å¦‚ä½•ä¿è¯çš„

* é¦–å…ˆï¼Œkafkaç³»ç»Ÿå†…éƒ¨é€šè¿‡**åˆ†åŒºçš„å‰¯æœ¬æœºåˆ¶**æ¥å®ç°æ•°æ®å¯é æ€§ä¿è¯ï¼›

> æ¯ä¸ªpartitionéƒ½å¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å½“leaderå®•æœºæˆ–æŸåï¼Œåˆ«çš„æœºå™¨ä¸Šè¿˜æœ‰å‰¯æœ¬æ•°æ®ä¸”å‰¯æœ¬è¿˜å¯ä»¥æˆä¸ºæ–°çš„leaderå¯¹å¤–æœåŠ¡ï¼›



* ç„¶åï¼Œç”¨ç”Ÿäº§è€…ï¼ˆproducerï¼‰å¾€kafkaå†™æ•°æ®æ—¶ï¼Œå¯ä»¥é…ç½®**é«˜çº§åˆ«çš„ackï¼ˆç¡®è®¤çº§åˆ«ã€ç¡®è®¤æœºåˆ¶ï¼‰**&#x6765;ä¿éšœæ•°æ®å¯é æ€§

> ackï¼š0  ,ç”Ÿäº§è€…ä¸ç­‰å¾…æœåŠ¡ç«¯çš„ç¡®è®¤å³è®¤ä¸ºå‘é€æˆåŠŸï¼ˆå¯èƒ½ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ï¼‰
>
> ack:  1  ,æœåŠ¡ç«¯ä¼šåœ¨leaderæŒä¹…åŒ–å­˜å¥½è¿™æ¡æ•°æ®åå†ç»™ç¡®è®¤ï¼›ï¼ˆå¯é æ€§æ¯”0é«˜ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨å¯é ï¼‰
>
> ack:  -1(all) ï¼Œ æœåŠ¡ç«¯ä¼šåœ¨leaderåŠæ‰€æœ‰â€åŒæ­¥å‰¯æœ¬inSyncâ€œéƒ½å­˜å¥½è¿™æ¡æ•°æ®åå†ç”±leaderç»™ç¡®è®¤ï¼›ï¼ˆæŸç§æ„ä¹‰ä¸Šè¯´å°±ä¸ä¼šä¸¢å¤±äº†ï¼Œä½†æœ€å¥½è¿˜è¦é…ä¸€ä¸ªå‚æ•°ï¼šæœ€å° "åŒæ­¥å‰¯æœ¬æ•° min.insync.replicas >= 2 "ï¼‰



> åŒæ­¥å‰¯æœ¬ï¼š
>
> ä¸€ä¸ªpartitionæœ‰ä¸€ä¸ªleaderå’Œå¤šä¸ªfollower
>
> è¿™äº›followerä¼šå‘¨æœŸæ€§åœ°æ‰¾leaderåŒæ­¥æ•°æ®
>
> å¦‚æœä¸€ä¸ªfolloweréš”äº†å¾ˆé•¿æ—¶é—´æ²¡å»æ‰¾leaderåŒæ­¥æ•°æ®ï¼Œæˆ–è€…æ•°æ®ä¸leaderä¹‹é—´å·®è·å¤ªå¤šï¼Œåˆ™ä¼šè¢«åˆ¤å®šä¸ºéåŒæ­¥å‰¯æœ¬
>
> * replica.lag.time.max.ms = 10ç§’
>
> * replica.lag.max.messages = 4000æ¡





## 6.2 kafkaçš„æ•°æ®ä¸€è‡´æ€§ä¿éšœæœºåˆ¶

### 6.2.1 åˆ†å¸ƒå¼ç³»ç»Ÿçš„CAPç†è®º

CAPç†è®ºä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€ç†è®º,å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ä¸­ï¼š

* ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼š åˆ†åŒºçš„å„å‰¯æœ¬ä¹‹é—´æ•°æ®è¦ä¿æŒä¸€è‡´

* å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ ï¼š ä¸€ä¸ªåˆ†åŒºï¼ˆæˆ–ä¸€ä¸ªèŠ‚ç‚¹ï¼‰å®•æœºï¼Œä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨

* åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ ï¼š ä¸€ä¸ªåˆ†åŒºå®•æœºï¼Œï¼ˆåˆ†åŒºæ•°æ®ä¸ä¼šä¸¢å¤±ï¼‰ï¼ˆåˆ†åŒºä»»åŠ¡å¯é‡å¯ï¼‰

åˆ†å¸ƒå¼ç³»ç»Ÿè¦ä¹ˆæ»¡è¶³CAï¼Œè¦ä¹ˆCPï¼Œè¦ä¹ˆAPï¼›æ— æ³•åŒæ—¶æ»¡è¶³CAPã€‚



* åˆ†åŒºå®¹é”™æ€§ï¼šæŒ‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹æˆ–è€…ç½‘ç»œåˆ†åŒºå‡ºç°äº†æ•…éšœçš„æ—¶å€™ï¼Œæ•´ä¸ªç³»ç»Ÿä»ç„¶èƒ½å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´éƒ¨åˆ†æ•…éšœä¸å½±å“æ•´ä½“ä½¿ç”¨ã€‚

Â 

* å¯ç”¨æ€§ï¼šä¸€ç›´å¯ä»¥æ­£å¸¸çš„åšè¯»å†™æ“ä½œã€‚ç®€å•è€Œè¨€å°±æ˜¯å®¢æˆ·ç«¯ä¸€ç›´å¯ä»¥æ­£å¸¸è®¿é—®å¹¶å¾—åˆ°ç³»ç»Ÿçš„æ­£å¸¸å“åº”ã€‚ç”¨æˆ·è§’åº¦æ¥çœ‹å°±æ˜¯ä¸ä¼šå‡ºç°ç³»ç»Ÿæ“ä½œå¤±è´¥æˆ–è€…è®¿é—®è¶…æ—¶ç­‰é—®é¢˜ã€‚

Â 

* ä¸€è‡´æ€§ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå®ŒæˆæŸå†™æ“ä½œåä»»ä½•è¯»æ“ä½œï¼Œéƒ½åº”è¯¥è·å–åˆ°è¯¥å†™æ“ä½œå†™å…¥çš„é‚£ä¸ªæœ€æ–°çš„å€¼ã€‚ç›¸å½“äºè¦æ±‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å„èŠ‚ç‚¹æ—¶æ—¶åˆ»åˆ»ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚

KafkaÂ ä½œä¸ºä¸€ä¸ªå•†ä¸šçº§æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œ**åˆ†åŒºå®¹é”™æ€§**å’Œ**å¯ç”¨æ€§**æ˜¯ä¼˜å…ˆè€ƒè™‘çš„é‡ç‚¹ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸¢å¤±ä¹Ÿä¸ä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨ï¼‰ï¼Œå…¼é¡¾æ•°æ®ä¸€è‡´æ€§ï¼›

> æ—¢ç„¶è¦ä¿è¯åˆ†åŒºå®¹é”™æ€§å’Œå¯ç”¨æ€§ï¼Œå°±å¿…ç„¶ç»™ä¸€ä¸ªåˆ†åŒºé™„å¸¦å¤šä¸ªå‰¯æœ¬ï¼›è¿™æ ·å°±æ„å‘³ç€æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬é—´å¾ˆéš¾å®ç°ä¸€è‡´ï¼›



### 6.2.2 åˆ†åŒºå‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§å›°éš¾

kafkaè®©åˆ†åŒºå¤šå‰¯æœ¬åŒæ­¥çš„åŸºæœ¬æ‰‹æ®µæ˜¯ï¼š followerå‰¯æœ¬å®šæœŸå‘leaderè¯·æ±‚æ•°æ®åŒæ­¥ï¼

æ—¢ç„¶æ˜¯å®šæœŸåŒæ­¥ï¼Œåˆ™leaderå’Œfollowerä¹‹é—´å¿…ç„¶å­˜åœ¨å„ç§æ•°æ®ä¸ä¸€è‡´çš„æƒ…æ™¯ï¼

**&#x20; é—®é¢˜1ï¼šåˆ†åŒºå‰¯æœ¬é—´åŠ¨æ€ä¸ä¸€è‡´**

![](images/image38.png)



**&#x20; é—®é¢˜2ï¼šæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´**

å¦‚æœæ­¤æ—¶leaderå®•æœºï¼Œfollower1æˆ–follower2è¢«é€‰ä¸ºæ–°çš„leaderï¼Œåˆ™leaderæ¢å±Šå‰åï¼Œæ¶ˆè´¹è€…æ‰€èƒ½è¯»å–åˆ°çš„æ•°æ®å‘ç”Ÿäº†ä¸ä¸€è‡´ï¼›

![](images/image39.png)



**&#x20; é—®é¢˜3ï¼šåˆ†åŒºå‰¯æœ¬é—´æœ€ç»ˆä¸ä¸€è‡´**

![](images/image40.png)



### 6.2.3 ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼ˆHWï¼‰

åŠ¨æ€è¿‡ç¨‹ä¸­çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´ï¼Œæ˜¯å¾ˆéš¾è§£å†³çš„ï¼›

***kafkaå…ˆå°è¯•ç€è§£å†³ä¸Šè¿° â€œæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´â€ åŠ â€œå‰¯æœ¬é—´æ•°æ®æœ€ç»ˆä¸ä¸€è‡´â€ çš„é—®é¢˜ï¼›***

**æ ¸å¿ƒæ€æƒ³ï¼š**

* kafkaè®¤ä¸ºæˆåŠŸåŒæ­¥ç»™äº†æ‰€æœ‰å‰¯æœ¬çš„æ•°æ®æ‰æ˜¯å®‰å…¨çš„ï¼›

* ç”±äºåŒæ­¥çš„è¿›åº¦åœ¨å„å‰¯æœ¬é—´ä¸ä¸€è‡´ï¼Œä¸Šé¢çš„æ‰€è°“â€œå®‰å…¨â€çš„ï¼Œå°±åº”è¯¥å–æ‰€æœ‰å‰¯æœ¬ä¸­æœ€å°çš„LEOä½œä¸ºå®‰å…¨çº¿ï¼›

* è¿™ä¸ªå®‰å…¨çº¿ï¼Œå°±å«åšHW

* æ¶ˆè´¹è€…åªå…è®¸è¯»åˆ°HWä»¥ä¸‹çš„æ•°æ®ï¼›



#### **HWçš„ç»´æŠ¤å’Œæ›´æ–°æœºåˆ¶**

##### æ­£å¸¸ç»´æŠ¤

* leaderä¸­è®°å½•ç€æ‰€æœ‰å‰¯æœ¬çš„leoï¼›

* å‰¯æœ¬å‘leaderå‘èµ·æ•°æ®è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šæºå¸¦è‡ªå·±å½“å‰çš„leoï¼›é‚£ä¹ˆleaderå°±ä¼šæ›´æ–°å®ƒçš„leoï¼Œå¹¶å°è¯•æ›´æ–°HW

* ç”Ÿäº§è€…å‘leaderå‘é€æ•°æ®æ—¶ï¼Œleaderä¹Ÿä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°HWï¼ˆå› ä¸ºæœ‰å¯èƒ½åŒæ­¥å‰¯æœ¬åªæœ‰1ä¸ªï¼Œå¦‚æœåªä¿ç•™ä¸Šé¢çš„æ£€æŸ¥æœºåˆ¶å°±ä¼šæ°¸è¿œæ›´æ–°ä¸äº†HWäº†ï¼‰



##### å¼‚å¸¸ç»´æŠ¤

ç”±äºHWæ˜¯leaderç»´æŠ¤å¹¶å­˜å‚¨çš„ï¼Œé‚£ä¹ˆleaderå®•æœºåï¼Œå„å‰¯æœ¬é—´å°±ä¸çŸ¥é“å®•æœºå‰çš„HWï¼›

æ­¤æ—¶ï¼Œå„å‰¯æœ¬ä¼šé€‰ä¸¾å‡ºæ–°çš„leaderï¼ˆåŒæ­¥å‰¯æœ¬åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªï¼‰

æ–°leaderè¯ç”Ÿä¹‹åï¼Œä¼šæŸ¥è¯¢å…¶ä»–å­˜æ´»å‰¯æœ¬çš„LEOï¼Œç„¶åå–æœ€å°å€¼ä½œä¸ºæ–°çš„HWï¼›



```java
--1---åˆå§‹çŠ¶æ€---------------
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  æ­¤åˆ»çš„é«˜æ°´ä½æ˜¯4  ï¼ˆ1,0)
doitedu02:follow1: [0,1,2,3,4,5]
doitedu03:follow2: [0,1,2,3,4]


--2--LEADERå®•æœº-------follow1æˆä¸ºæ–°leader----
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  é«˜æ°´ä½æ˜¯4
doitedu02:leader:  [0,1,2,3,4, 5 ]  è®¡ç®—å‡ºæœ€æ–°çš„é«˜æ°´ä½4,æˆªæ–­è¶…å‡ºçš„éƒ¨åˆ†
doitedu03:follow2: [0,1,2,3,4]


--3--ç”Ÿäº§è€…å†™å…¥äº†æ–°æ•°æ®----
doitedu01:followerï¼š [0,1,2,3,4,5,6,7,8] 
doitedu02:leader:    [0,1,2,3,4,a,b,c,d]
doitedu03:follow2:   [0,1,2,3,4,a,b]

--4--doitedu01ä¿®å¤é‡å¯äº†ï¼Œæˆä¸ºäº†æ–°çš„follower----
doitedu01:followerï¼š [0,1,2,3,4,5,6,7,8]  å‘leaderæ–°çš„HWï¼Œç»“æœæ˜¯ HW:e > 8 ï¼Œä¸éœ€è¦æˆªæ–­æ•°æ®ï¼Œå¼€å§‹åŒæ­¥
doitedu02:leader:    [0,1,2,3,4,a,b,c,d,e,f,g]
doitedu03:follow2:   [0,1,2,3,4,a,b,c,d,e]

--5--doitedu01åŒæ­¥ä¸€æ‰¹æ•°æ®åçš„çŠ¶æ€ : è¿™å°±æ˜¯æ¼æ´ä¹‹ä¸€ï¼Œäº§ç”Ÿäº†æœ€ç»ˆä¸ä¸€è‡´çš„ç°è±¡  ---
doitedu01:followerï¼š [0,1,2,3,4,5,6,7,8,e,f]  
doitedu02:leader:    [0,1,2,3,4,a,b,c,d,e,f,g]
doitedu03:follow2:   [0,1,2,3,4,a,b,c,d,e,f]
```



### 6.2.4 ä¸€è‡´æ€§é—®é¢˜è¡¥å……æ–¹æ¡ˆï¼ˆepochæœºåˆ¶ï¼‰

***epochæœºåˆ¶çš„ä¸»è¦ä½œç”¨æ˜¯è§£å†³HWçš„æœ€ç»ˆä¸ä¸€è‡´é—®é¢˜***

åœ¨å…‰æœ‰HWçš„æœºåˆ¶ä¸‹ï¼Œåœ¨leaderå®•æœºï¼Œæ–°leaderäº§ç”Ÿçš„åœºæ™¯ä¸‹

å¦‚æœæœ‰æŸä¸ªæ•°æ®åˆé•¿ï¼Œä½†æ˜¯ä¸Šçº¿åˆæ™šçš„å‰¯æœ¬ï¼Œä¸Šçº¿åï¼Œå°±ä¼šå‘ç”Ÿæœ‰ä¸€æ®µæ•°æ®æ²¡æœ‰è¢«æ­£ç¡®æˆªæ–­ï¼›

![](images/diagram-2.png)

kafkaä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¼•å…¥äº†epochæœºåˆ¶ï¼›

epochå°±æ˜¯ä»£è¡¨leaderçš„ä»£ï¼ˆçºªå…ƒï¼‰

![](images/image-6.png)





**æ ¸å¿ƒæœºåˆ¶**

* ä¸€ä¸ªå‰¯æœ¬ç«é€‰ä¸ºleaderåï¼Œå°±ä¼šç”Ÿæˆçš„æ–°çš„epochï¼ˆ=åŸæ¥çš„epoch+1ï¼‰ï¼Œå¹¶ä¸”ä¼šæŠŠè¿™ä¸ªä¿¡æ¯è®°å½•åœ¨ç£ç›˜æ–‡ä»¶ä¸­ï¼šï¼ˆæ–°çš„epochï¼Œæ–°çºªå…ƒæ•°æ®å†™å…¥çš„ä½ç½®ï¼‰ï¼›

* followerç¬¬ä¸€æ¬¡å‘æ–°leaderåŒæ­¥æ•°æ®å‰ï¼Œä¼šå…ˆè¯·æ±‚æ–°leaderçš„epochä¿¡æ¯ï¼›å¾—åˆ°ä¿¡æ¯åï¼Œåˆ¤æ–­è‡ªå·±çš„æ—¥å¿—æ•°æ®æ˜¯å¦è·Ÿæ–°leaderçš„çºªå…ƒä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œä¼šæˆªæ–­  â€œæ–°çºªå…ƒçš„æ•°æ®çš„èµ·å§‹ä½ç½®ä»¥ä¸Šçš„â€ ï¼›

```java
--1---åˆå§‹çŠ¶æ€---------------
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  æ­¤åˆ»çš„é«˜æ°´ä½æ˜¯4  çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)
doitedu02:follow1: [0,1,2,3,4,5]   çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)
doitedu03:follow2: [0,1,2,3,4]     çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)

--2--leaderå®•æœºäº†,é€‰ä¸¾æ–°leader ------------
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  æ­¤åˆ»çš„é«˜æ°´ä½æ˜¯4  çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)
doitedu02:follow1: [0,1,2,3,4,5]   çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)
doitedu03:leader:  [0,1,2,3,4]     çºªå…ƒä¿¡æ¯ï¼šï¼ˆ2,5)
  
--2--æ–°leaderå¼€å¯æ–°çºªå…ƒ ------------
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  æ­¤åˆ»çš„é«˜æ°´ä½æ˜¯4  çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)

doitedu02:follow1: [0,1,2,3,4,5]   è€çºªå…ƒä¿¡æ¯ï¼šï¼ˆ1,0)ï¼Œè¯·æ±‚æ–°çºªå…ƒä¿¡æ¯(2,5) ï¼Œè‡ªå·±çš„LEOæ˜¯5ï¼Œé‚£ä¹ˆéœ€è¦é˜¶æ®µåç§»é‡5è¿™æ¡æ•°æ®
doitedu02:follow1: [0,1,2,3,4,a,b,c]   ç»“æœå°±æ˜¯,çºªå…ƒä¿¡æ¯ï¼ˆ2,5)ï¼Œæ•°æ®æ˜¯01234abc

doitedu03:leader:  [0,1,2,3,4,a,b,c]     çºªå…ƒä¿¡æ¯ï¼šï¼ˆ2,5)


--3--æ™šåˆ°çš„æ¥äº†  ------------
doitedu01:leaderï¼š [0,1,2,3,4,5,6,7,8]  è¯·æ±‚leaderè·å–çºªå…ƒä¿¡æ¯(2,5),å‘ç°è‡ªå·±çš„è€æ•°æ®leo>=æ–°çºªå…ƒæ•°æ®èµ·å§‹ä½ç½®,æˆªæ–­
doitedu01:leaderï¼š [0,1,2,3,4,a,b,c]  çºªå…ƒä¿¡æ¯ï¼ˆ2,5)ï¼Œæ•°æ®æ˜¯01234abc

doitedu02:follow1: [0,1,2,3,4,a,b,c]    çºªå…ƒä¿¡æ¯ï¼ˆ2,5)ï¼Œæ•°æ®æ˜¯01234abc

doitedu03:leader:  [0,1,2,3,4,a,b,c]     çºªå…ƒä¿¡æ¯ï¼šï¼ˆ2,5)

```



### 6.2.5 LEO/HW/LSOç­‰ç›¸å…³æœ¯è¯­é€ŸæŸ¥

LEO:ï¼ˆlast end offsetï¼‰**å°±æ˜¯è¯¥å‰¯æœ¬ä¸­æ¶ˆæ¯çš„æœ€å¤§åç§»é‡çš„å€¼+1** ï¼›

**HW:ï¼ˆhigh watermarkï¼‰å„å‰¯æœ¬ä¸­LEOçš„æœ€å°å€¼ã€‚è¿™ä¸ªå€¼è§„å®šäº†æ¶ˆè´¹è€…ä»…èƒ½æ¶ˆè´¹HWä¹‹å‰çš„æ•°æ®ï¼›**

LWï¼šï¼ˆlow watermarkï¼‰ä¸€ä¸ªå‰¯æœ¬çš„logä¸­ï¼Œæœ€å°çš„æ¶ˆæ¯åç§»é‡ï¼›

LSOï¼šï¼ˆlast stable offsetï¼‰ æœ€åä¸€ä¸ªç¨³å®šçš„offsetï¼›å¯¹æœªå®Œæˆçš„äº‹åŠ¡è€Œè¨€ï¼ŒLSO çš„å€¼ç­‰äºäº‹åŠ¡ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç½®(firstUnstableOffset)ï¼Œå¯¹å·²å®Œæˆçš„äº‹åŠ¡è€Œè¨€ï¼Œå®ƒçš„å€¼åŒ HW ç›¸åŒï¼›

**LEOä¸HW ä¸æ•°æ®ä¸€è‡´æ€§å¯†åˆ‡ç›¸å…³ï¼›**

![](images/image51.png)


å¦‚å›¾ï¼Œå„å‰¯æœ¬ä¸­æœ€å°çš„LEOæ˜¯3ï¼Œæ‰€ä»¥HWæ˜¯3ï¼Œæ‰€ä»¥ï¼Œæ¶ˆè´¹è€…æ­¤åˆ»æœ€å¤šèƒ½è¯»åˆ°Msg2;

***









## 6.3 å¹‚ç­‰æ€§

### 6.3.1 å¹‚ç­‰æ€§çš„å«ä¹‰

é€šå¸¸æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªåŠ¨ä½œåå¤æ‰§è¡Œå¤šæ¬¡ï¼Œäº§ç”Ÿçš„ç»“æœä¸å˜

æœ€å¸¸è§çš„åœºæ™¯æ˜¯ï¼ŒåŒä¸€æ¡æ•°æ®å†™å…¥ç›®æ ‡å­˜å‚¨ç³»ç»Ÿï¼Œå†™1æ¬¡æˆ–å†™å¤šæ¬¡ï¼Œæ•°æ®å­˜å‚¨ä¸­çš„ç»“æœä¸å˜ï¼›





### 6.3.2 kafkaä¸­çš„å¹‚ç­‰æ€§

**ğŸ“› é—®é¢˜èƒŒæ™¯**

kafkaçš„ç”Ÿäº§è€…ï¼Œå†™ä¸€æ¡æ•°æ®åˆ°æœåŠ¡ç«¯æ—¶ï¼Œå¦‚æœå†™å¤±è´¥ï¼ˆæœ‰å¯èƒ½åªæ˜¯æ²¡æœ‰å¾—åˆ°ackè€Œå·²ï¼‰ï¼Œä¼šè‡ªåŠ¨é‡è¯•ï¼›

ä¹Ÿå°±æ˜¯ï¼šåŒä¸€æ¡æ•°æ®ï¼Œå¯èƒ½ä¼šè¢«å†™å¤šæ¬¡ï¼›ï¼ˆæ­¤å¤„çš„â€œå¤šæ¬¡â€ï¼Œæ˜¯ç”Ÿäº§è€…è‡ªå‘çš„é‡è¯•å¤šæ¬¡ï¼›ä¸æ˜¯ç”¨æˆ·çš„é€»è¾‘ï¼‰

è¿™é‡Œä¼šäº§ç”Ÿé—®é¢˜ï¼š

ä¸€æ¡æ•°æ®ï¼Œè¢«ç”Ÿäº§è€…å‘å‡ºå»åï¼Œæ²¡æœ‰å¾—åˆ°ç¡®è®¤ï¼Œæœ‰å¯èƒ½å¹¶ä¸æ˜¯çœŸçš„å¤±è´¥ï¼Œè€Œæ˜¯æœåŠ¡ç«¯æ‹¿åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› æ²¡æœ‰æˆåŠŸæ”¶åˆ°ç¡®è®¤ä¿¡æ¯ï¼›è¿™æ ·ä¼šå¯¼è‡´åŒä¸€æ¡æ•°æ®å¯èƒ½è¢«æœåŠ¡ç«¯ä¿å­˜äº†å¤šæ¡ï¼›



ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œkafkaå¼•å…¥äº†å¹‚ç­‰æ€§æœºåˆ¶ï¼š å³ä½¿ç”Ÿäº§è€…æŠŠåŒä¸€æ¡æ•°æ®å‘é€äº†å¤šæ¬¡ï¼ŒæœåŠ¡ç«¯ä¹Ÿåªä¿ç•™ä¸€æ¬¡ï¼›



**ğŸ“› å¹‚ç­‰æ€§æœºåˆ¶çš„æ ¸å¿ƒåŸç†ï¼š**

æ¯ä¸€ä¸ªç”Ÿäº§è€…ï¼Œéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„ç”Ÿäº§è€…idï¼›

*ç”Ÿäº§è€…æ¯å‘é€ä¸€æ¡æ•°æ®ï¼Œéƒ½ä¼šå¸¦ä¸Šä¸€ä¸ªè‡ªå¢çš„ç¼–å·ï¼*

brokerç«¯ä¼šä¸ºè¿™ä¸ªç”Ÿäº§è€…ç»´æŠ¤è®°å½•å®ƒå‘è¿‡æ¥çš„æ•°æ®çš„æœ€æ–°ç¼–å·ï¼›è€Œä¸”ï¼Œæ¯æ”¶åˆ°ä¸€æ¡æ•°æ®ä¼šè¿›è¡Œåˆ¤æ–­ï¼š

> brokerç«¯çš„è®°å½•çš„ä¸Šä¸€æ¡ç¼–å·ï¼ˆOLD)  å’Œ  å½“å‰æ”¶åˆ°çš„æ•°æ®ç¼–å·(NEW) è¿›è¡Œå¯¹æ¯” =>
>
> * OLD+1ï¼ˆæœŸå¾…çš„ï¼‰ = NEW  ä¸€åˆ‡æ­£å¸¸
>
> * OLD+1ï¼ˆæœŸå¾…çš„ï¼‰  > NEW  æ–°æ•°æ®ç¼–å·ï¼Œå°äºæœåŠ¡ç«¯æœŸå¾…çš„ç¼–å·ï¼Œè¯´æ˜æœ¬æ¡æ•°æ®æ˜¯é‡å¤çš„ï¼Œç›´æ¥ä¸¢å¼ƒ
>
> * OLD+1ï¼ˆæœŸå¾…çš„ï¼‰  < NEW  æ–°æ•°æ®ç¼–å·ï¼Œå¤§äºæœåŠ¡ç«¯æœŸå¾…çš„ç¼–å·ï¼Œè¯´æ˜æ•°æ®è¦ä¹ˆæœ‰ä¹±åºã€è¦ä¹ˆæœ‰ä¸¢å¤±ï¼Œåˆ™æŠ›å‡ºä¸¥é‡å¼‚å¸¸



**ğŸ“› å¹‚ç­‰æ€§çš„å¼€å¯**

> å¼€å¯å¹‚ç­‰æ€§åŠŸèƒ½ï¼Œåªéœ€è¦æ˜¾å¼åœ°å°†ç”Ÿäº§è€…å‚æ•° enable.idempotenceè®¾ç½®ä¸º true ï¼ˆé»˜è®¤å€¼ä¸º falseï¼‰ï¼š
>
> props.pu&#x74;**("enable.idempotence",true);**

åœ¨å¼€å¯å¹‚ç­‰æ€§åŠŸèƒ½æ—¶ï¼Œå¦‚ä¸‹å‡ ä¸ªå‚æ•°å¿…é¡»æ­£ç¡®é…ç½®ï¼š

* retries > 0&#x20;

* max.in.flight.requests.per.connection<=5

* acks = -1

å¦‚æœ‰è¿åï¼Œåˆ™ä¼šæŠ›å‡ºConfigExceptionå¼‚å¸¸ï¼›

> æ³¨æ„ï¼škafkaåªä¿è¯producerå•ä¸ªä¼šè¯ä¸­çš„å•ä¸ªåˆ†åŒºå¹‚ç­‰ï¼›









## 6.4 kafkaçš„äº‹åŠ¡æœºåˆ¶

### 6.4.1 äº‹åŠ¡æœºåˆ¶çš„åŸç†

kafkaä¸­çš„äº‹åŠ¡æœºåˆ¶ï¼Œä¸»è¦æ˜¯ç”Ÿäº§è€…å†™æ•°æ®çš„åœºæ™¯ï¼›

> ç”Ÿäº§è€…æŠŠè‹¥å¹²æ¡æ•°æ®ç»‘å®šåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¦ä¹ˆéƒ½å†™å…¥æˆåŠŸï¼Œè¦ä¹ˆå°±å›æ»šï¼›

*kafkaç¡®å®å¯ä»¥æ”¯æŒè¿™æ ·çš„äº‹åŠ¡éœ€æ±‚ï¼›*



**ä¸»è¦åŸç†ï¼š&#x20;**&#x20;å¼€å§‹äº‹åŠ¡ --> å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡å¼€å§‹ï¼‰

&#x20;                 æäº¤äº‹åŠ¡--> å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡æäº¤ï¼‰

&#x20;                 æ”¾å¼ƒäº‹åŠ¡--> å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡ç»ˆæ­¢ï¼‰

![](images/diagram-3.png)

**æ¶ˆè´¹è€…apiæ˜¯ä¼šæ‹‰å–åˆ°å°šæœªæäº¤äº‹åŠ¡çš„æ•°æ®çš„ï¼›åªä¸è¿‡å¯ä»¥é€‰æ‹©æ˜¯å¦è®©ç”¨æˆ·çœ‹åˆ°ï¼**

æ˜¯å¦è®©ç”¨æˆ·çœ‹åˆ°æœªæäº¤äº‹åŠ¡çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ¶ˆè´¹è€…å‚æ•°æ¥é…ç½®ï¼š

* isolation.level=read\_uncommittedï¼ˆé»˜è®¤å€¼ï¼‰

* isolation.level=read\_committed







### 6.4.2 ä½¿ç”¨äº‹åŠ¡çš„ä»£ç 

* å¼€å¯äº‹åŠ¡çš„å¿…é¡»é…ç½®å‚æ•°

```java
Properties props = new Properties();
props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"doit01:9092");
props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

// acks
props.setProperty(ProducerConfig.ACKS_CONFIG,"-1");
// ç”Ÿäº§è€…çš„é‡è¯•æ¬¡æ•°
props.setProperty(ProducerConfig.RETRIES_CONFIG,"3");
// é£è¡Œä¸­çš„è¯·æ±‚ç¼“å­˜æœ€å¤§æ•°é‡
props.setProperty(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION,"3");

// å¼€å¯å¹‚ç­‰æ€§
props.setProperty(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,"true");

// è®¾ç½®äº‹åŠ¡id
props.setProperty(ProducerConfig.TRANSACTIONAL_ID_CONFIG,"trans_001");
```

**äº‹åŠ¡æ§åˆ¶çš„ä»£ç æ¨¡æ¿**

```java
try{
    // åˆå§‹åŒ–äº‹åŠ¡
    producer.initTransaction( )
    
    // å¼€å¯äº‹åŠ¡    
    producer.beginTransaction( )
        
    // å‘é€äº‹åŠ¡ä¸­çš„æ•°æ®
    producer.send(producerRecord1);
    producer.send(producerRecord2);
    producer.send(producerRecord3);
    producer.send(producerRecord4);
    producer.send(producerRecord5);
    
    // æäº¤äº‹åŠ¡
    producer.commitTransaction( )
} catch(Exception e){
    // å¼‚å¸¸å›æ»šï¼ˆæ”¾å¼ƒäº‹åŠ¡ï¼‰-
    producer.abortTransaction( )
}
```







# 7. é«˜é¢‘é¢è¯•é¢˜

## 7.1 **kafka éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ**

* é«˜ååé‡ï¼Œä½å»¶è¿Ÿ

* å¯ä»¥çƒ­æ‰©å±•

* å¹¶å‘åº¦é«˜

* å…·æœ‰å®¹é”™æ€§(æŒ‚çš„åªå‰©1å°ä¹Ÿèƒ½æ­£å¸¸è·‘)

* å¯é æ€§é«˜



## 7.2 **kafkaä¸ºä»€ä¹ˆå¿«**

#### æ ¹æœ¬åŸå› 

kafkaçš„æ•°æ®ç»„ç»‡æ ¼å¼ï¼šæ—¥å¿—çš„å½¢&#x5F0F;***ï¼ˆé¡ºåºè¯»å†™ï¼‰***

è™½ç„¶kafkaçš„æ•°æ®æ˜¯æ”¾åœ¨æœ¬åœ°ç£ç›˜ï¼Œä½†æ˜¯æœ¬åœ°ç£ç›˜æ–‡ä»¶çš„é¡ºåºè¯»å†™ä¸å†…å­˜çš„éšæœºè¯»å†™å·²ç»ç›¸å·®ä¸å¤§





#### **å……åˆ†åˆ©ç”¨åˆ†å¸ƒå¼ç‰¹æ€§æ¥æé«˜ååé‡å’Œå¹¶è¡Œåº¦**

ä¸€ä¸ªtopicå¯ä»¥åˆ†ä¸ºå¤šä¸ªpartitionï¼Œå„ä¸ªpartitionå¯ä»¥æ”¾ç½®åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šæä¾›è¯»å†™æœåŠ¡





#### åº•å±‚IOåˆ©ç”¨äº†é›¶æ‹·è´

![](images/diagram-4.png)





























## 7.3 **ä½ ä»¬é¡¹ç›®ä¸­ç”¨kafkaæ¥åšä»€ä¹ˆ**

## 7.4 **kafka çš„è®¾è®¡æ¶æ„ä½ çŸ¥é“å—ï¼Ÿ**

* kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼**æ¶ˆæ¯ç¼“å­˜**ä¸­é—´ä»¶

* é›†ç¾¤ä¸­çš„**è§’è‰²**å¤§æ¦‚æœ‰ï¼š  brokerï¼Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œç”Ÿäº§è€…å®¢æˆ·ç«¯ï¼Œä¾èµ–zookeeperåšé›†ç¾¤åè°ƒ

* æ¶ˆè´¹è€…å¯ä»¥ç»„æˆ**æ¶ˆè´¹ç»„**ï¼Œæ¥å…±åŒåä½œæ¶ˆè´¹ç›®æ ‡æ•°æ®ï¼›

* **å­˜å‚¨ç»“æ„ï¼š**&#x6570;æ®åˆ’åˆ†æˆtopicï¼Œæ¯ä¸ªtopicå¯ä»¥åˆ†ä¸ºå¤šä¸ªpartitionï¼Œæ¯ä¸ªpartitionå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼›

* **å‰¯æœ¬**ä¸­æœ‰ä¸€ä¸ªæ˜¯leaderï¼Œå…¶ä»–æ˜¯followerï¼› leaderè´Ÿè´£æ•°æ®è¯»å†™ï¼Œfollowerä¸»è¦æ˜¯æ•°æ®å¤‡ä»½ï¼›è€Œä¸”åœ¨leaderå®•æœºåï¼Œfollowerå¯ä»¥ç«é€‰å‡ºæ–°çš„leaderå¯¹å¤–æœåŠ¡ï¼›

* **åº•å±‚å­˜å‚¨**ï¼špartitionçš„æ•°æ®å­˜åœ¨brokeræœåŠ¡å™¨çš„æœ¬åœ°ç£ç›˜ä¸Šï¼›è€Œä¸”æ•°æ®æ˜¯ä»¥é¡ºåºè¿½åŠ çš„å½¢å¼å†™æ–‡ä»¶çš„ï¼›

* **æ•°æ®æ–‡ä»¶ä¸­çš„å†…å®¹**ï¼šä¸€æ¡ä¸€æ¡çš„messageï¼Œmessageåˆ†ä¸ºkeyå’Œvalueï¼Œç„¶åè¿˜æœ‰headerï¼Œæœ‰metadataï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œè¿˜æœ‰timestampï¼›

* æ•°æ®æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜æœ‰é™„å¸¦çš„**ç´¢å¼•æ–‡ä»¶**ï¼š åç§»é‡ç´¢å¼•ï¼›æ—¶é—´æˆ³ç´¢å¼•ï¼›





## 7.5 **kafka åˆ†åŒºçš„ç›®çš„ï¼Ÿ**

åˆ†åŒºå¯¹äºkafkaé›†ç¾¤çš„å¥½å¤„æ˜¯ï¼šå®ç°è´Ÿè½½å‡è¡¡ã€‚

åˆ†åŒºå¯¹äºæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æ¥è¯´ï¼Œå¯ä»¥æé«˜è¯»å†™å¹¶è¡Œåº¦



## 7.6 **kafka æ˜¯å¦‚ä½•åšåˆ°æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Ÿ**

kafkaä¸­çš„æ¯ä¸ª partition ä¸­çš„æ¶ˆæ¯åœ¨å†™å…¥æ—¶éƒ½æ˜¯é¡ºåºè¿½åŠ ï¼›

kafkaçš„æ¶ˆæ¯æœ‰åºæ€§ï¼Œåªä½“ç°åœ¨åˆ†åŒºå†…éƒ¨ï¼›åˆ†åŒºä¹‹é—´çš„æ¶ˆæ¯æ˜¯ä¸ä¿è¯æœ‰åºçš„ã€‚



## 7.7 **kafka çš„é«˜å¯é æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ**

å‰¯æœ¬æœºåˆ¶

ç”Ÿäº§è€…å†™æ•°æ®åˆ°brokeræ—¶é…ç½®é«˜çº§åˆ«çš„ackï¼ˆæ¯”å¦‚ï¼Œ-1ï¼‰

æœ€å°"åŒæ­¥å‰¯æœ¬"æ•°é…ç½®>=2





## 7.8 **è¯·è°ˆä¸€è°ˆkafkaæ•°æ®ä¸€è‡´æ€§åŸç†**

* é«˜æ°´ä½çº¿æœºåˆ¶ï¼Œä¿éšœ æ•°æ®æ‰€è§æ€§ä¸€è‡´ï¼ˆleaderå®•æœºå‰åï¼Œæ¶ˆè´¹è€…çœ‹è§çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼‰

* epochæœºåˆ¶ï¼Œ ä¿éšœ  å‰¯æœ¬é—´æ•°æ®æœ€ç»ˆä¸€è‡´&#x20;



## 7.9 **kafka åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±ï¼Ÿ**

* topicçš„å‰¯æœ¬å¦‚æœåªæœ‰1ä¸ªï¼Œé‚£ä¹ˆä¸€æ—¦è¿™ä¸ªå‰¯æœ¬æ‰€åœ¨brokeræœåŠ¡å™¨å®•æœºï¼Œåˆ™æœ‰å¯èƒ½ä¸¢å¤±ï¼›

* producerå¾€kafkaå†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœç¡®è®¤æœºåˆ¶å‚æ•°acks !=allï¼Œä¹Ÿå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼›



## 7.10 **æ•°æ®ä¼ è¾“çš„è¯­ä¹‰æœ‰å‡ ç§ï¼Ÿ**

æ•°æ®ä¼ è¾“çš„è¯­ä¹‰é€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§çº§åˆ«ï¼š

è®¾ç½®æ¶ˆè´¹è€…é‡Œé¢æœ‰enable.auto.commit = true/false

* æœ€å¤šä¸€æ¬¡ï¼ˆat-most-onceï¼‰: æ¶ˆæ¯ä¸ä¼šé‡å¤ï¼Œä½†æœ‰å¯èƒ½ä¸¢å¤±ï¼›

* æœ€å°‘ä¸€æ¬¡ (at-least-once)ï¼šæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œä½†æœ‰å¯èƒ½é‡å¤ï¼›

* ç²¾ç¡®ä¸€æ¬¡ï¼ˆExactly-onceï¼‰: ä¸ä¸¢ä¹Ÿä¸é‡





## 7.11 kafkaçš„ç”Ÿäº§è€…å†™æ•°æ®åˆ°æœåŠ¡ç«¯èƒ½å®ç°å“ªç§æ•°æ®ä¼ è¾“è¯­ä¹‰ï¼Ÿ

å–å†³äºé…ç½®

* æœ€å¤šä¸€æ¬¡ï¼šack=0

* æœ€å°‘ä¸€æ¬¡ï¼šretries > 0

* ç²¾ç¡®ä¸€æ¬¡ï¼šå¼€å¯é‡è¯•ï¼Œå¼€å¯ack=-1ï¼Œå¼€å¯å¹‚ç­‰æ€§ï¼›





## 7.12 **kafka æ¶ˆè´¹è€…æ˜¯å¦å¯ä»¥æŒ‡å®šåˆ†åŒºè¿›è¡Œæ¶ˆè´¹ï¼Ÿ**

å¯ä»¥ï¼›

consumer.assign()ï¼› // æ‰‹åŠ¨åˆ†é…





## 7.13 **kafka æ¶ˆè´¹è€…æ˜¯å¦ä»æŒ‡å®šoffsetå¼€å§‹æ¶ˆè´¹ï¼Ÿ**

å¯ä»¥ï¼Œé€šè¿‡seekæŒ‡å®šåç§»é‡åå†å¼€å§‹æ¶ˆè´¹



## 7.14 **å®¢æˆ·ç«¯æ“ä½œkafkaæ¶ˆæ¯æ˜¯é‡‡ç”¨pollæ¨¡å¼ï¼Œè¿˜æ˜¯pushæ¨¡å¼ï¼Ÿ**

é‡‡ç”¨pollæ¨¡å¼ï¼ˆæ‹‰å–ï¼‰

è¿™æ ·æ›´å¥½æ ¹æ®æ¶ˆè´¹è€…çš„è®¡ç®—èƒ½åŠ›æ¥æ§åˆ¶æ¶ˆè´¹çš„é€Ÿåº¦å’Œä¸»åŠ¨æ€§ï¼›





## 7.15 **kafkaçš„æ¶ˆæ¯æ ¼å¼æœ‰äº†è§£å—ï¼Ÿï¼ˆäº†è§£ï¼‰**

ç®€å•æ¥è¯´ï¼Œkafkaä¸­çš„æ¯ä¸ªmassageç”±ä¸€å¯¹key-valueæ„æˆï¼›

Kafkaä¸­çš„messageæ ¼å¼ç»å†äº†3ä¸ªç‰ˆæœ¬çš„å˜åŒ–äº†ï¼šv0 ã€ v1 ã€ v2  &#x20;

![](images/image-5.png)

å„ä¸ªå­—æ®µçš„å«ä¹‰ä»‹ç»å¦‚ä¸‹ï¼š

* crcï¼šå ç”¨4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨äºæ ¡éªŒæ¶ˆæ¯çš„å†…å®¹ï¼›

* magicï¼šè¿™ä¸ªå ç”¨1ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨äºæ ‡è¯†æ—¥å¿—æ ¼å¼ç‰ˆæœ¬å·ï¼Œæ­¤ç‰ˆæœ¬çš„magicå€¼ä¸º1 &#x20;

* attributesï¼šå ç”¨1ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œé¢å­˜å‚¨äº†æ¶ˆæ¯å‹ç¼©ä½¿ç”¨çš„ç¼–ç ä»¥åŠTimestampç±»å‹ã€‚ç›®å‰Kafka æ”¯æŒ gzipã€snappy ä»¥åŠ lz4ï¼ˆ0.8.2å¼•å…¥ï¼‰ ä¸‰ç§å‹ç¼©æ ¼å¼ï¼›\[0,1,2]ä¸‰ä½bitè¡¨ç¤ºå‹ç¼©ç±»å‹ã€‚\[3]ä½è¡¨ç¤ºæ—¶é—´æˆ³ç±»å‹ï¼ˆ0ï¼Œcreate timeï¼›1ï¼Œappend timeï¼‰ï¼Œ\[4,5,6,7]ä½ä¿ç•™ï¼›

* key lengthï¼šå ç”¨4ä¸ªå­—èŠ‚ã€‚ä¸»è¦æ ‡è¯† Keyçš„å†…å®¹çš„é•¿åº¦ï¼›

* keyï¼šå ç”¨ Nä¸ªå­—èŠ‚ï¼Œå­˜å‚¨çš„æ˜¯ key çš„å…·ä½“å†…å®¹ï¼›

* value lengthï¼šå ç”¨4ä¸ªå­—èŠ‚ã€‚ä¸»è¦æ ‡è¯† value çš„å†…å®¹çš„é•¿åº¦ï¼›

* valueï¼švalueå³æ˜¯æ¶ˆæ¯çš„çœŸå®å†…å®¹ï¼Œåœ¨ Kafka ä¸­è¿™ä¸ªä¹Ÿå«åšpayloadã€‚







## 7.16 **kafka çš„æ•°æ®æ–‡ä»¶å­˜å‚¨è®¾è®¡ç‰¹ç‚¹**

KafkaæŠŠtopicä¸­ä¸€ä¸ªparitionçš„æ•°æ®åˆ†æˆå¤šä¸ªå°æ–‡ä»¶æ®µï¼›

```java
-rw-r--r--. 1 root root    56 Oct  4 18:01 00000000000000000000.index  // offsetç´¢å¼•

// æ•°æ®æ–‡ä»¶æ®µï¼Œåå­—ä»£è¡¨æ–‡ä»¶ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„offset
-rw-r--r--. 1 root root 31529 Oct  2 10:48 00000000000000000000.log  
-rw-r--r--. 1 root root 31529 Oct  2 10:48 00000000000000010000.log
-rw-r--r--. 1 root root 31529 Oct  2 10:48 00000000000000042000.log

-rw-r--r--. 1 root root    96 Oct  4 18:01 00000000000000000000.timeindex  // timestampç´¢å¼•

-rw-r--r--. 1 root root    10 Oct  2 17:59 00000000000000000245.snapshot
-rw-r--r--. 1 root root     8 Oct  4 08:47 leader-epoch-checkpoint
-rw-r--r--. 1 root root    43 Oct  4 08:47 partition.metadata
```

é€šè¿‡å¤šä¸ªå°æ–‡ä»¶æ®µï¼Œå°±å®¹æ˜“å®šæœŸæ¸…é™¤æˆ–åˆ é™¤å·²ç»è¿‡æœŸçš„æ–‡ä»¶ï¼Œå‡å°‘ç£ç›˜å ç”¨ï¼›  é»˜è®¤å­˜å‚¨æ—¶é—´7å¤©

**é€šè¿‡ç´¢å¼•ä¿¡æ¯**ï¼ˆoffsetç´¢å¼•ï¼Œtimestampç´¢å¼•ï¼‰å¯ä»¥å¿«é€Ÿå®šä½æ•°æ®æ–‡ä»¶ä¸­çš„messageï¼›

***ç´¢å¼•æ˜¯ç¨€ç–ç´¢å¼•***

![](images/diagram-5.png)





## 7.17 **kafkaçš„åˆ†åŒº åˆ†å¸ƒç­–ç•¥ æ˜¯æ€æ ·çš„ï¼Ÿ**

> ä¸€ä¸ªtopicåˆ›å»ºæ—¶æœ‰å¤šä¸ªåˆ†åŒºï¼Œé‚£è¿™äº›åˆ†åŒºåŠå‰¯æœ¬æ˜¯æ€æ ·æ”¾ç½®åœ¨å“ªäº›brokerèŠ‚ç‚¹ä¸Š

åˆ†åŒºåˆ†å¸ƒçš„è®¡ç®—ç­–ç•¥å¦‚ä¸‹

* å‰¯æœ¬å› å­ä¸èƒ½å¤§äº Broker çš„ä¸ªæ•°ï¼›

* **ç¬¬ä¸€ä¸ªåˆ†åŒº**ï¼ˆç¼–å·ä¸º0ï¼‰çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®æ˜¯éšæœºä» brokerList é€‰æ‹©çš„ï¼›

* **å…¶ä»–åˆ†åŒº**çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®ç›¸å¯¹äºç¬¬0ä¸ªåˆ†åŒºä¾æ¬¡å¾€åç§»ã€‚ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬æœ‰5ä¸ª Brokerï¼Œ5ä¸ªåˆ†åŒºï¼Œå‡è®¾ç¬¬1ä¸ªåˆ†åŒºæ”¾åœ¨ç¬¬å››ä¸ª Broker ä¸Šï¼Œé‚£ä¹ˆç¬¬2ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬äº”ä¸ª Broker ä¸Šï¼›ç¬¬3ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬ä¸€ä¸ª Broker ä¸Šï¼›ç¬¬4ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬äºŒä¸ª Broker ä¸Šï¼Œä¾æ¬¡ç±»æ¨ï¼›

* **å‰©ä½™å‰¯æœ¬**ç›¸å¯¹äºç¬¬1ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®æ˜¯ç”±ä¸€ä¸ªéšæœºæ•°nextReplicaShift å†³å®šï¼›&#x20;



> é¦–å…ˆï¼ŒæŠŠå„åˆ†åŒºçš„leaderå‰¯æœ¬å®‰æ’ä½ç½®ï¼šé€‰ä¸€ä¸ªéšæœºbrokerï¼Œä»è¿™é‡Œå¼€å§‹ä¾æ¬¡é¡ºåºæ”¾ç½®å„åˆ†åŒºleader
>
> ç„¶åï¼Œå®‰æ’å„åˆ†åŒºçš„followerå‰¯æœ¬ï¼šç›¸å¯¹äºå®ƒçš„leaderåä¸€ä¸ªéšæœºæ•°ï¼Œä¾æ¬¡é¡ºå»¶æ”¾å„ä¸ªfollower





## 7.18 **kafkaçš„topicçš„åˆ†åŒºæ•°å¯ä»¥å¢åŠ æˆ–å‡å°‘å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ**

**kafkaå…è®¸å¯¹topicåŠ¨æ€å¢åŠ åˆ†åŒºï¼Œä½†ä¸æ”¯æŒå‡å°‘åˆ†åŒº**

å› ä¸ºå‡å°‘åˆ†åŒºï¼Œå¿…ç„¶éœ€è¦è¿ç§»æ•°æ®ï¼Œè€Œè¿ç§»æ•°æ®å¿…ç„¶ä¼šç ´ååˆ†åŒºæ•°æ®æœ‰åºæ€§ï¼›



## 7.19 **kafkaæ–°å»ºçš„åˆ†åŒºä¼šåœ¨å“ªåˆ›å»ºå­˜å‚¨ç›®å½•**

&#x7531;**`log.dirs`**`å‚æ•°`å†³å®šçš„





## 7.20 **æ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…ç»„æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ**

* æ¶ˆè´¹è€…å±äºæŸä¸ªæ¶ˆè´¹ç»„

* æ¶ˆè´¹ç»„åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…



æ¶ˆè´¹ç»„ï¼Œå¯ä»¥æŠŠå¤šä¸ªæ¶ˆè´¹è€…ç»‘åœ¨ä¸€èµ·å…±åŒæ¶ˆè´¹åŒä¸€ä»½ç›®æ ‡æ•°æ®ï¼ˆå¤šä¸ªtopicå¤šä¸ªpartitionï¼‰ï¼›äº’ç›¸ä¸é‡å¤ï¼›

è€Œä¸”ï¼Œæ¶ˆè´¹ç»„å¯ä»¥å®ç°åœ¨ç»„å†…è¿›è¡Œåˆ†åŒºåˆ†é…çš„åŠ¨æ€å‡è¡¡ï¼›

æœ‰æ–°æ¶ˆè´¹è€…åŠ å…¥ç»„ï¼Œä¼šè§¦å‘å†å‡è¡¡ï¼›

æœ‰æ¶ˆè´¹è€…ä¸‹çº¿ï¼Œä¼šè§¦å‘å†å‡è¡¡ï¼›







## 7.21 **kafka ç›‘æ§æ’ä»¶éƒ½æœ‰å“ªäº›ï¼Ÿ**

* kafka manager

* kafka-offset-monitor ï¼šä¸»è¦åšæ¶ˆè´¹è€…åç§»é‡çš„ç›‘æ§

* kafka-eagleï¼šåŠŸèƒ½å¾ˆå¼ºå¤§ï¼ï¼ˆç°å·²æ”¹åä¸ºï¼šEFAK â€”â€” eagle for apache kafkaï¼‰

https://www.kafka-eagle.org/















***

# å¤‡ç”¨å†…å®¹------------------------------------------------------

# **1.åŸºæœ¬æ¦‚å¿µ**

## **1.1ä»€ä¹ˆæ˜¯kafka&#x20;**

Kafka æœ€åˆæ˜¯ç”± LinkedIn å³é¢†è‹±å…¬å¸åŸºäº Scala å’Œ Java è¯­è¨€å¼€å‘çš„åˆ†å¸ƒå¼**æ¶ˆæ¯å‘å¸ƒ-è®¢é˜…ç³»ç»Ÿ**ï¼Œç°å·²æçŒ®ç»™Apache è½¯ä»¶åŸºé‡‘ä¼šã€‚å…¶å…·æœ‰é«˜ååã€ä½å»¶è¿Ÿçš„ç‰¹æ€§ï¼Œè®¸å¤šå¤§æ•°æ®å®æ—¶æµå¼å¤„ç†ç³»ç»Ÿæ¯”å¦‚ Stormã€Sparkã€Flinkç­‰éƒ½èƒ½å¾ˆå¥½åœ°ä¸ä¹‹é›†æˆã€‚

æ€»çš„æ¥è®²ï¼ŒKafka é€šå¸¸å…·æœ‰ 3 é‡è§’è‰²ï¼š

* **å­˜å‚¨ç³»ç»Ÿï¼š**&#x901A;å¸¸æ¶ˆæ¯é˜Ÿåˆ—ä¼šæŠŠæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Œä¿è¯æ¶ˆæ¯å¯é æ€§ã€‚Kafka çš„æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶å’Œå¤šå‰¯æœ¬æœºåˆ¶ä½¿å…¶èƒ½å¤Ÿä½œä¸ºé€šç”¨æ•°æ®å­˜å‚¨ç³»ç»Ÿæ¥ä½¿ç”¨ã€‚

* **æ¶ˆæ¯ç³»ç»Ÿï¼š**&#x4B;afka å’Œä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—æ¯”å¦‚ RabbitMQã€RocketMQã€ActiveMQ ç±»ä¼¼ï¼Œæ”¯æŒæµé‡å‰Šå³°ã€æœåŠ¡è§£è€¦ã€å¼‚æ­¥é€šä¿¡ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

* **æµå¤„ç†å¹³å°ï¼š**&#x4B;afka ä¸ä»…èƒ½å¤Ÿä¸å¤§å¤šæ•°æµå¼è®¡ç®—æ¡†æ¶å®Œç¾æ•´åˆï¼Œå¹¶ä¸”è‡ªèº«ä¹Ÿæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµå¼å¤„ç†åº“ï¼Œå³ Kafka Streamingã€‚Kafka Streaming æä¾›äº†ç±»ä¼¼ Flink ä¸­çš„çª—å£ã€èšåˆã€å˜æ¢ã€è¿æ¥ç­‰åŠŸèƒ½ã€‚

  **ä¸€å¥è¯æ¦‚æ‹¬ï¼šKafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨ä¸šç•Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®å®æ—¶æµå¼è®¡ç®—é¢†åŸŸï¼Œèµ·è§£è€¦åˆå’Œå‰Šå³°å¡«è°·çš„ä½œç”¨ã€‚&#x20;**

## **1.2kafkaçš„ç‰¹ç‚¹**

* **é«˜ååé‡ã€ä½å»¶è¿Ÿï¼š**&#x6B;afkaæ¯ç§’å¯ä»¥å¤„ç†å‡ åä¸‡æ¡æ¶ˆæ¯ï¼Œå®ƒçš„å»¶è¿Ÿæœ€ä½åªæœ‰å‡ æ¯«ç§’ï¼Œæ¯ä¸ªtopicå¯ä»¥åˆ†å¤šä¸ªpartition, ç”±å¤šä¸ªconsumer group å¯¹partitionè¿›è¡Œconsumeæ“ä½œã€‚

* **å¯æ‰©å±•æ€§ï¼š**&#x6B;afkaé›†ç¾¤æ”¯æŒçƒ­æ‰©å±•

* **æŒä¹…æ€§ã€å¯é æ€§ï¼š**&#x6D88;æ¯è¢«æŒä¹…åŒ–åˆ°æœ¬åœ°ç£ç›˜ï¼Œå¹¶ä¸”**æ”¯æŒæ•°æ®å¤‡ä»½**é˜²æ­¢æ•°æ®ä¸¢å¤±

* **å®¹é”™æ€§ï¼šå…è®¸é›†ç¾¤ä¸­æœ‰èŠ‚ç‚¹å¤±è´¥**ï¼ˆè‹¥å‰¯æœ¬æ•°é‡ä¸ºn,åˆ™å…è®¸n-1ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼‰

* **é«˜å¹¶å‘ï¼š**&#x652F;æŒæ•°åƒä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å†™

Kafkaåœ¨å„ç§åº”ç”¨åœºæ™¯ä¸­ï¼Œèµ·åˆ°çš„ä½œç”¨å¯ä»¥å½’çº³ä¸ºè¿™ä¹ˆå‡ ä¸ªæœ¯è¯­ï¼š**å‰Šå³°å¡«è°·ï¼Œè§£è€¦ï¼**

**åœ¨å¤§æ•°æ®æµå¼è®¡ç®—é¢†åŸŸä¸­ï¼Œkafkaä¸»è¦ä½œä¸ºè®¡ç®—ç³»ç»Ÿçš„å‰ç½®ç¼“å­˜å’Œè¾“å‡ºç»“æœç¼“å­˜ï¼›**

## 2.1å®‰è£…zookeeperé›†ç¾¤

1. **ä¸Šä¼ å®‰è£…åŒ…**

2. **ç§»åŠ¨åˆ°æŒ‡å®šæ–‡ä»¶å¤¹**

```plain&#x20;text
 mv zookeeper-3.4.6.tar.gz  /opt/apps/
```

* **è§£å‹**

```plain&#x20;text
tar -zxvf zookeeper-3.4.6.tar.gz
```

* **ä¿®æ”¹é…ç½®æ–‡ä»¶**

```plain&#x20;text
ï¼ˆ1ï¼‰è¿›å…¥åˆ°confç›®å½•ä¸‹
cd /opt/apps/zookeeper-3.4.6/conf
ï¼ˆ2ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶åç§°
mv  zoo_sample.cfg   zoo.cfg
ï¼ˆ3ï¼‰ç¼–è¾‘é…ç½®æ–‡ä»¶
vi zoo.cfg
dataDir=/opt/apps/data/zkdata
server.1=linux01:2888:3888
server.2=linux01:2888:3888
server.3=linux01:2888:3888
```

* **åˆ›å»ºæ•°æ®ç›®å½•**

```plain&#x20;text
mkdir -p /opt/apps/data/zkdata
```

* **åœ¨å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®å­˜å‚¨ç›®å½•ä¸­ï¼Œç”Ÿæˆä¸€ä¸ªmyidæ–‡ä»¶ï¼Œå†…å®¹ä¸ºå®ƒçš„id**

```plain&#x20;text
echo 1 > /opt/apps/data/zkdata/myid
echo 2 > /opt/apps/data/zkdata/myid
echo 3 > /opt/apps/data/zkdata/myid
```

* **åˆ†å‘å®‰è£…åŒ…**

```plain&#x20;text
# ä½¿ç”¨forå¾ªç¯åˆ†å‘
for i in {2..3}; 
do scp -r zookeeper-3.4.6 linux0$i:$PWD;  
done 
```

* **é…ç½®ç¯å¢ƒå˜é‡**

```plain&#x20;text
vi /etc/profile
#ZOOKEEPER_HOME
export ZOOKEEPER_HOME=/opt/apps/zookeeper-3.4.6
export PATH=$PATH:$ZOOKEEPER_HOME/bin 

source /etc/profile
# æ³¨æ„ï¼šè¿˜éœ€è¦åˆ†å‘ç¯å¢ƒå˜é‡
```

* **å¯åœé›†ç¾¤**

```plain&#x20;text
bin/zkServer.sh start   # zkæœåŠ¡å¯åŠ¨
bin/zkServer.sh status  # zkæŸ¥çœ‹æœåŠ¡çŠ¶æ€
bin/zkServer.sh stop    # zkåœæ­¢æœåŠ¡
```

* **ä¸€é”®å¯åœè„šæœ¬**

ï¼ˆ1ï¼‰å¯åŠ¨è„šæœ¬

```plain&#x20;text
#!/bin/bash
for i in 1 2 3 
do
ssh linux0${i} "source /etc/profile;/opt/apps/zookeeper-3.4.6/bin/zkServer.sh start"
done
```

ï¼ˆ2ï¼‰åœæ­¢è„šæœ¬

```plain&#x20;text
#!/bin/bash
for i in 1 2 3
do
ssh linux0${i} "source /etc/profile;/opt/apps/zookeeper-3.4.6/bin/zkServer.sh stop"
done
```

## 2.2å®‰è£…kafkaé›†ç¾¤

1. **ä¸Šä¼ å®‰è£…åŒ…**

2. **è§£å‹**

```plain&#x20;text
tar -zxvf kafka_2.11-2.2.2.tgz tar  -C /opt/apps/
```

* **ä¿®æ”¹é…ç½®æ–‡ä»¶**

```plain&#x20;text
ï¼ˆ1ï¼‰è¿›å…¥é…ç½®æ–‡ä»¶ç›®å½•
[root@linux01 apps]# cd kafka_2.12-2.3.1/config
ï¼ˆ2ï¼‰ç¼–è¾‘é…ç½®æ–‡ä»¶
vi server.properties
#ä¸ºä¾æ¬¡å¢é•¿çš„ï¼š0ã€1ã€2ã€3ã€4ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ id
broker.id=0   
#æ•°æ®å­˜å‚¨çš„â½¬å½• 
log.dirs=/opt/data/kafkadata
#åº•å±‚å­˜å‚¨çš„æ•°æ®ï¼ˆæ—¥å¿—ï¼‰ç•™å­˜æ—¶é•¿ï¼ˆé»˜è®¤7å¤©ï¼‰
log.retention.hours=168
#åº•å±‚å­˜å‚¨çš„æ•°æ®ï¼ˆæ—¥å¿—ï¼‰ç•™å­˜é‡ï¼ˆé»˜è®¤1Gï¼‰ 
log.retention.bytes=1073741824
#æŒ‡å®šzké›†ç¾¤åœ°å€
zookeeper.connect=linux01:2181,linux02:2181,linux03:2181
```

* **åˆ†å‘å®‰è£…åŒ…**

```plain&#x20;text
for  i  in {2..3} 
do 
scp  -r  kafka_2.11-2.2.2  linux0$i:$PWD 
done
```

> å®‰è£…åŒ…åˆ†å‘åï¼Œè®°å¾—ä¿®æ”¹config/server.propertiesä¸­çš„ é…ç½®å‚æ•°ï¼š broker.id

* **ç¯å¢ƒå˜é‡**

```plain&#x20;text
vi /etc/profile
export KAFKA_HOME=/opt/apps/kafka_2.11-2.2.2
export PATH=$PATH:$KAFKA_HOME/bin 

source /etc/profile
# æ³¨æ„ï¼šè¿˜éœ€è¦åˆ†å‘ç¯å¢ƒå˜é‡
```

* **å¯åœé›†ç¾¤ï¼ˆåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨ï¼‰**

```plain&#x20;text
bin/kafka-server-start.sh -daemon /opt/apps/kafka_2.11-2.2.2/config/server.properties   

# åœæ­¢é›†ç¾¤
bin/kafka-server-stop.sh
```

* **ä¸€é”®å¯åœè„šæœ¬ï¼š**

```plain&#x20;text
#!/bin/bash

case $1 in
"start"){
        for i in linux01 linux02 linux03
        do
        echo ---------- kafka $i å¯åŠ¨ ------------
                ssh $i "source /etc/profile;  /opt/app/kafka2.4.1/bin/kafka-server-start.sh -daemon /opt/app/kafka2.4.1/config/server.properties"
        done
};;
"stop"){
        for i in linux01 linux02 linux03
        do
        echo ---------- kafka $i åœæ­¢ ------------
                ssh $i "source /etc/profile;  /opt/app/kafka2.4.1/bin/kafka-server-stop.sh "
        done
};;
esac
```

## 2.3**Kafkaè¿ç»´ç›‘æ§ï¼šKafka-Eagleï¼ˆäº†è§£ï¼‰**

kafkaè‡ªèº«å¹¶æ²¡æœ‰é›†æˆç›‘æ§ç®¡ç†ç³»ç»Ÿï¼Œå› æ­¤å¯¹kafkaçš„ç›‘æ§ç®¡ç†æ¯”è¾ƒä¸ä¾¿ï¼Œå¥½åœ¨æœ‰å¤§é‡çš„ç¬¬ä¸‰æ–¹ç›‘æ§ç®¡ç†ç³»ç»Ÿæ¥ä½¿ç”¨ï¼Œå¸¸è§çš„æœ‰ï¼š

* Kafka Eagle

* KafkaOffsetMonitor

* Kafka Managerï¼ˆé›…è™å¼€æºçš„Kafkaé›†ç¾¤ç®¡ç†å™¨ï¼‰

* Kafka Web Console

* è¿˜æœ‰JMXæ¥å£è‡ªå¼€å‘ç›‘æ§ç®¡ç†ç³»ç»Ÿ

![](images/image.png)

**2.3.1Kafka-Eagleå®‰è£…**

å®‰è£…åŒ…ä¸‹è½½åœ°å€ï¼š http://download.kafka-eagle.org/

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼š<https://docs.kafka-eagle.org/>

1. **ä¸Šä¼ ï¼Œè§£å‹**

2. **é…ç½®ç¯å¢ƒå˜é‡ï¼šJAVA\_HOME å’ŒKE\_HOME**

```plain&#x20;text
vi /etc/profile

-- ä¹‹å‰é…è¿‡äº†å°±ä¸ç”¨å†é…äº†
export JAVA_HOME=/opt/apps/jdk1.8.3_9u19
export PATH=$PATH:$JAVA_HOME/bin

export KE_HOME=/opt/apps/efak-web-2.1.0
export PATH=$PATH:$KE_HOME/bin
```

* **é…ç½®KafkaEagle**

```plain&#x20;text
cd ${KE_HOME}/conf
vi system-config.properties

ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š
######################################
# multi zookeeper & kafka cluster list
# Settings prefixed with 'kafka.eagle.' will be deprecated, use 'efak.' instead
######################################
efak.zk.cluster.alias=cluster1
cluster1.zk.list=linux01:2181,linux02:2181,linux03:2181

######################################
# broker size online list
######################################
cluster1.efak.broker.size=3

######################################
# kafka sqlite jdbc driver address
######################################
efak.driver=org.sqlite.JDBC
efak.url=jdbc:sqlite:/opt/data/kafka-eagle/db/ke.db
efak.username=root
efak.password=www.kafka-eagle.org

######################################
# kafka mysql jdbc driver address
######################################
#efak.driver=com.mysql.cj.jdbc.Driver
#efak.url=jdbc:mysql://linux01:3306/ke?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull
#efak.username=root
#efak.password=123456
```

> å¦‚ä¸Šï¼Œæ•°æ®åº“é€‰æ‹©çš„æ˜¯sqliteï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºæ‰€é…ç½®çš„dbæ–‡ä»¶å­˜æ”¾ç›®å½•ï¼š/opt/data/kafka-eagle/db/
>
> å¦‚æœä½¿ç”¨MySQL æå‰åœ¨mysqlä¸­åˆ›å»ºæŒ‡å®šçš„æ•°æ®åº“
>
> mysql> CREATE DATABASE IF NOT EXISTS ke DEFAULT CHARSET utf8 COLLATE utf8\_general\_ci;

* **é…ç½®kafkaæœåŠ¡ç«¯çš„JMXç«¯å£ã€é€‰é…ã€‘**

```plain&#x20;text
åœ¨kafkaçš„å¯åŠ¨è„šæœ¬ï¼š  kafka-server-start.sh ä¸­æ·»åŠ å¦‚ä¸‹å‘½ä»¤ï¼š
if [ "x$KAFKA_HEAP_OPTS" = "x" ]; then
    export JMX_PORT="9999"
    export KAFKA_HEAP_OPTS="-Xmx1G -Xms1G"
fi
    
   è¿™ä¸ªåŠ åœ¨æ–‡ä»¶çš„æœ€åé¢
 
æ”¹å®Œåï¼Œå°†æ–‡ä»¶åŒæ­¥ç»™æ‰€æœ‰èŠ‚ç‚¹
ç„¶åé‡å¯kafkaé›†ç¾¤
```

* é…ç½®KE\_HOME ç¯å¢ƒå˜é‡

* **å¯åŠ¨KafkaEagle**

```plain&#x20;text
cd ${KE_HOME}/bin
chmod +x ke.sh
./ke.sh start
```

* **è®¿é—®webç•Œé¢**

http://192.168.232.3:8048

è´¦å·å¯†ç ï¼šAccount:admin ,Password:123456

![](images/image-1.png)

![](images/image-2.png)

# 3.åŸºæœ¬æ“ä½œ

## **3.1æ¦‚è¿°**

Kafka ä¸­æä¾›äº†è®¸å¤šå‘½ä»¤è¡Œå·¥å…·ï¼ˆä½äº$KAFKA HOME/bin ç›®å½•ä¸‹ï¼‰ç”¨äºç®¡ç†é›†ç¾¤çš„å˜æ›´ã€‚

| **kafka-console-consumer.sh**       | **ç”¨äºæ¶ˆè´¹æ¶ˆæ¯**            |
| ----------------------------------- | --------------------- |
| **kafka-console-producer.sh**       | **ç”¨äºç”Ÿäº§æ¶ˆæ¯**            |
| **kafka-topics.sh**                 | **ç”¨äºç®¡ç†ä¸»é¢˜**            |
| kafka-server-stop.sh                | ç”¨äºå…³é—­KafkaæœåŠ¡           |
| kafka-server-start.sh               | ç”¨äºå¯åŠ¨KafkaæœåŠ¡           |
| kafka-configs.sh                    | ç”¨äºé…ç½®ç®¡ç†                |
| kafka-consumer-perf-test.sh         | ç”¨äºæµ‹è¯•æ¶ˆè´¹æ€§èƒ½              |
| kafka-producer-perf-test.sh         | ç”¨äºæµ‹è¯•ç”Ÿäº§æ€§èƒ½              |
| kafka-dump-log.sh                   | ç”¨äºæŸ¥çœ‹æ•°æ®æ—¥å¿—å†…å®¹            |
| kafka-preferred-replica-election.sh | ç”¨äºä¼˜å…ˆå‰¯æœ¬çš„é€‰ä¸¾             |
| kafka-reassign-partitions.sh        | ç”¨äºåˆ†åŒºé‡åˆ†.000000000000 é… |

## 3.2**topicç®¡ç†æ“ä½œï¼škafka-topics**

### 3.2.1**æŸ¥çœ‹topicåˆ—è¡¨**

```shell
kafka-topics.sh --bootstrap-server linux01:9092,linux02:9092,linux03:9092 --list
```

```shell
[root@linux01 bin]# ./kafka-topics.sh --list --zookeeper linux01:2181
__consumer_offsets
gmall2022_db_c
gmall_event_bak
gmall_start_bak
test001
topic_log
```

### **3.2.2æŸ¥çœ‹topicçŠ¶æ€ä¿¡æ¯**

```shell
[root@linux01 bin]# ./kafka-topics.sh --describe --zookeeper linux01:2181  --topic test
Topic: test     PartitionCount: 3       ReplicationFactor: 3    Configs: 
        Topic: test     Partition: 0    Leader: 2       Replicas: 2,0,1 Isr: 2,0,1
        Topic: test     Partition: 1    Leader: 0       Replicas: 0,1,2 Isr: 0,1,2
        Topic: test     Partition: 2    Leader: 1       Replicas: 1,2,0 Isr: 1,2,0
```

![](images/image-4.png)

> ä»ä¸Šé¢çš„ç»“æœä¸­å¯ä»¥çœ‹å‡º
>
> topicçš„åˆ†åŒºæ•°é‡ï¼Œä»¥åŠæ¯ä¸ªåˆ†åŒºçš„å‰¯æœ¬æ•°é‡ï¼Œä»¥åŠæ¯ä¸ªå‰¯æœ¬æ‰€åœ¨çš„brokerèŠ‚ç‚¹ï¼Œä»¥åŠæ¯ä¸ªåˆ†åŒºçš„leaderå‰¯æœ¬æ‰€åœ¨brokerèŠ‚ç‚¹ï¼Œä»¥åŠæ¯ä¸ªåˆ†åŒºçš„ISRå‰¯æœ¬åˆ—è¡¨ï¼›
>
> **ISRï¼š** in  sync  replica ,åŒæ­¥å‰¯åŒæ­¥æœ¬ï¼ˆå½“ç„¶ä¹ŸåŒ…å«leaderè‡ªèº«ï¼Œreplica.lag.time.max.ms =30000ï¼‰
>
> **OSRï¼š**&#x6F;ut  of  sync replicas å¤±å»åŒæ­¥çš„å‰¯æœ¬ï¼ˆè¯¥å‰¯æœ¬ä¸Šæ¬¡è¯·æ±‚leaderåŒæ­¥æ•°æ®è·ç°åœ¨çš„æ—¶é—´é—´éš”è¶…å‡ºé…ç½®é˜ˆå€¼ï¼‰

* ISRåŒæ­¥å‰¯æœ¬åˆ—è¡¨

ISRæ¦‚å¿µï¼šï¼ˆåŒæ­¥å‰¯æœ¬ï¼‰ã€‚æ¯ä¸ªåˆ†åŒºçš„leaderä¼šç»´æŠ¤ä¸€ä¸ªISRåˆ—è¡¨ï¼ŒISRåˆ—è¡¨é‡Œé¢å°±æ˜¯followerå‰¯æœ¬çš„Borkerç¼–å·ï¼Œåªæœ‰è·Ÿå¾—ä¸ŠLeaderçš„ followerå‰¯æœ¬æ‰èƒ½åŠ å…¥åˆ° ISRé‡Œé¢ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡replica.lag.time.max.msÂ =30000ï¼ˆé»˜è®¤å€¼ï¼‰å‚æ•°é…ç½®çš„ï¼Œåªæœ‰ISRé‡Œçš„æˆå‘˜æ‰æœ‰è¢«é€‰ä¸º leader çš„å¯èƒ½ã€‚

![](images/image-3.png)

**è¸¢å‡ºISRå’Œé‡æ–°åŠ å…¥ISRçš„æ¡ä»¶ï¼š**

* è¸¢å‡ºISRçš„æ¡ä»¶ï¼š  ç”±replica.lag.time.max.ms =30000å†³å®šï¼Œå¦‚ä¸Šå›¾ï¼›

* é‡æ–°åŠ å…¥ISRçš„æ¡ä»¶ï¼š OSRå‰¯æœ¬çš„LEOï¼ˆlog end offsetï¼‰è¿½ä¸Šleaderçš„LEOï¼›

### **3.2.3åˆ›å»ºtopic**

> \--bootstrap-server  --zookeeperä¸€æ ·çš„æ•ˆæœ ï¼Œæ–°ç‰ˆæœ¬å»ºè®®ä½¿ç”¨ --bootstrap-server&#x20;

```shell
kafka-topics.sh   --bootstrap-server  linux01:9092,linux02:9092,linux03:9092    --create --topic test01  --partitions 3  --replication-factor  3
```

> å‚æ•°è§£é‡Šï¼š
>
> \--replication-factor  å‰¯æœ¬æ•°é‡
> \--partitions åˆ†åŒºæ•°é‡&#x20;
> \--topic topicåç§°
>
> æœ¬æ–¹å¼ï¼Œå‰¯æœ¬çš„å­˜å‚¨ä½ç½®æ˜¯ç³»ç»Ÿè‡ªåŠ¨å†³å®šçš„ï¼›

æ‰‹åŠ¨æŒ‡å®šåˆ†é…æ–¹æ¡ˆï¼šåˆ†åŒºæ•°ï¼Œå‰¯æœ¬æ•°ï¼Œå­˜å‚¨ä½ç½®

```typescript
kafka-topics.sh --create --topic tpc-1  --zookeeper linux01:2181 --replica-assignment 0:1:3,1:2:6

è¯¥topicï¼Œå°†æœ‰å¦‚ä¸‹partitionï¼š(2ä¸ªåˆ†åŒº 3ä¸ªå‰¯æœ¬)
partition0 ï¼Œæ‰€åœ¨èŠ‚ç‚¹ï¼š broker0ã€broker1ã€broker3
partition1 ï¼Œæ‰€åœ¨èŠ‚ç‚¹ï¼š broker1ã€broker2ã€broker6

[root@linux01 logs]# kafka-topics.sh --describe --topic tpc-1 --zookeeper linux01:2181
Topic: tpc-1    PartitionCount: 2       ReplicationFactor: 3    Configs: 
        Topic: tpc-1    Partition: 0    Leader: 0       Replicas: 0,1,3 Isr: 0,1
        Topic: tpc-1    Partition: 1    Leader: 1       Replicas: 1,2,6 Isr: 1,2
```

### 3.2.4**åˆ é™¤topic**

```typescript
bin/kafka-topics.sh --zookeeper linux01:2181 --delete --topic test
åˆ é™¤topicï¼Œserver.propertiesä¸­éœ€è¦ä¸€ä¸ªå‚æ•°å¤„äºå¯ç”¨çŠ¶æ€ï¼š delete.topic.enable = true(é»˜è®¤æ˜¯true)
```

> ä½¿ç”¨ kafka-topics .sh è„šæœ¬åˆ é™¤ä¸»é¢˜çš„è¡Œä¸ºæœ¬è´¨ä¸Šåªæ˜¯åœ¨ ZooKeeper ä¸­çš„ /admin/delete\_topics è·¯å¾„ä¸‹å»ºä¸€ä¸ªä¸å¾…åˆ é™¤ä¸»é¢˜åŒåçš„èŠ‚ç‚¹ï¼Œä»¥æ ‡è®°è¯¥ä¸»é¢˜ä¸ºå¾…åˆ é™¤çš„çŠ¶æ€ã€‚ç„¶åç”± Kafkaæ§åˆ¶å™¨å¼‚æ­¥å®Œæˆã€‚

### **3.2.5å¢åŠ åˆ†åŒºæ•°**

```shell
kafka-topics.sh --zookeeper doit01:2181 --alter --topic doitedu-tpc2 --partitions 3
```

> Kafkaåªæ”¯æŒå¢åŠ åˆ†åŒºï¼Œä¸æ”¯æŒå‡å°‘åˆ†åŒº
>
> åŸå› æ˜¯ï¼šå‡å°‘åˆ†åŒºï¼Œä»£ä»·å¤ªå¤§ï¼ˆæ•°æ®çš„è½¬ç§»ï¼Œæ—¥å¿—æ®µæ‹¼æ¥åˆå¹¶ï¼‰
>
> å¦‚æœçœŸçš„éœ€è¦å®ç°æ­¤åŠŸèƒ½ï¼Œåˆ™å®Œå…¨å¯ä»¥é‡æ–°åˆ›å»ºä¸€ä¸ªåˆ†åŒºæ•°è¾ƒå°çš„ä¸»é¢˜ï¼Œç„¶åå°†ç°æœ‰ä¸»é¢˜ä¸­çš„æ¶ˆæ¯æŒ‰ç…§æ—¢å®šçš„é€»è¾‘å¤åˆ¶è¿‡å»ï¼›

### **3.2.6åŠ¨æ€é…ç½®topicå‚æ•°ï¼ˆä¸å¸¸ç”¨)**

é€šè¿‡ç®¡ç†å‘½ä»¤ï¼Œå¯ä»¥ä¸ºå·²åˆ›å»ºçš„topicå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤topic levelå‚æ•°

* æ·»åŠ /ä¿®æ”¹  æŒ‡å®štopicçš„é…ç½®å‚æ•°ï¼š

```shell
kafka-topics.sh  --zookeeper linux01:2181  --alter  --topic tpc2 --config compression.type=gzip 
# --config compression.type=gzip  ä¿®æ”¹æˆ–æ·»åŠ å‚æ•°é…ç½®
# --add-config compression.type=gzip  æ·»åŠ å‚æ•°é…ç½®
# --delete-config compression.type  åˆ é™¤é…ç½®å‚æ•°
```

topicé…ç½®å‚æ•°æ–‡æ¡£åœ°å€ï¼š https://kafka.apache.org/documentation/#topicconfigs

## 3.3**ç”Ÿäº§è€…ï¼škafka-console-producer**

```shell
[root@linux01 logs]# kafka-console-producer.sh --broker-list linux01:9092 --topic test01                   
>a
>b     
>c
>hello 
>hi
>hadoop
>hive
```

### é¡ºåºè½®è¯¢ï¼ˆè€ç‰ˆæœ¬ï¼‰

é¡ºåºåˆ†é…ï¼Œæ¶ˆæ¯æ˜¯å‡åŒ€çš„åˆ†é…ç»™æ¯ä¸ª partitionï¼Œå³æ¯ä¸ªåˆ†åŒºå­˜å‚¨ä¸€æ¬¡æ¶ˆæ¯ï¼Œè½®è¯¢ç­–ç•¥æ˜¯ Kafka Producer æä¾›çš„é»˜è®¤ç­–ç•¥ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨æŒ‡å®šçš„è½®è¯¢ç­–ç•¥çš„è¯ï¼ŒKafka é»˜è®¤ä¼šä½¿ç”¨é¡ºåºè½®è®­ç­–ç•¥çš„æ–¹å¼ã€‚

### éšæœºåˆ†é…

å®ç°éšæœºåˆ†é…çš„ä»£ç åªéœ€è¦ä¸¤è¡Œï¼Œå¦‚ä¸‹

```java
List<PartitionInfo> partitions = cluster.partitionsForTopic(topic);
return ThreadLocalRandom.current().nextInt(partitions.size()); 
```

## **3.4æ¶ˆè´¹è€…ï¼škafka-console-consumer**

æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šè¦è®¢é˜…çš„ä¸»é¢˜ï¼Œè¿˜å¯ä»¥æŒ‡å®šæ¶ˆè´¹çš„èµ·å§‹åç§»é‡

èµ·å§‹åç§»é‡çš„æŒ‡å®šç­–ç•¥æœ‰3ä¸­ï¼š

* earliest èµ·å§‹ç‚¹ &#x20;

* latest   æœ€æ–°

* æŒ‡å®šçš„offsetï¼ˆ åˆ†åŒºå·ï¼šåç§»é‡ï¼‰  ==ã€‹ å¿…é¡»çš„å‘Šè¯‰ä»–æ˜¯å“ªä¸ªtopic çš„å“ªä¸ªåˆ†åŒºçš„å“ªä¸ªoffset

* ä»ä¹‹å‰æ‰€è®°å½•çš„åç§»é‡å¼€å§‹æ¶ˆè´¹

> åœ¨å‘½ä»¤è¡Œä¸­ï¼Œå¯ä»¥æŒ‡å®šä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹æ¶ˆè´¹
>
> 1. åŠ ä¸Šå‚æ•° --from-beginning æŒ‡å®šä»æœ€å‰é¢å¼€å§‹æ¶ˆè´¹
>
> 2. å¦‚æœä¸åŠ --from-beginning  å°±éœ€è¦åˆ†æƒ…å†µè®¨è®ºäº†ï¼Œå¦‚æœä¹‹å‰è®°å½•è¿‡æ¶ˆè´¹çš„ä½ç½®ï¼Œé‚£ä¹ˆå°±ä»ä¹‹å‰æ¶ˆè´¹çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼Œå¦‚æœè¯´ä¹‹å‰æ²¡æœ‰è®°å½•è¿‡ä¹‹å‰æ¶ˆè´¹çš„åç§»é‡ï¼Œé‚£ä¹ˆå°±ä»æœ€æ–°çš„ä½ç½®å¼€å§‹æ¶ˆè´¹

kafkaçš„topicä¸­çš„æ¶ˆæ¯ï¼Œæ˜¯æœ‰åºå·çš„ï¼ˆåºå·å«æ¶ˆæ¯åç§»é‡ï¼‰ï¼Œè€Œä¸”æ¶ˆæ¯çš„åç§»é‡æ˜¯åœ¨å„ä¸ªpartitionä¸­ç‹¬ç«‹ç»´æŠ¤çš„ï¼Œåœ¨å„ä¸ªåˆ†åŒºå†…ï¼Œéƒ½æ˜¯ä»0å¼€å§‹é€’å¢ç¼–å·ï¼

(1)æ¶ˆè´¹æ¶ˆæ¯

```shell
[root@linux01 logs]# kafka-console-consumer.sh --bootstrap-server linux01:9092 --topic test01 --from-beginning
hive
hello 
hadoop
```

```plain&#x20;text
-- æŒ‡å®šä»æœ€å‰é¢å¼€å§‹æ¶ˆè´¹
[root@linux01 bin]# kafka-console-consumer.sh --bootstrap-server linux01:9092 --topic doitedu01 --from-beginning
hadoop
list
hello
kafka
--ä¸æŒ‡å®šä»–æ¶ˆè´¹çš„ä½ç½®çš„æ—¶å€™ï¼Œå°±æ˜¯ä»æœ€æ–°çš„åœ°æ–¹å¼€å§‹æ¶ˆè´¹
[root@linux01 bin]# kafka-console-consumer.sh --bootstrap-server linux01:9092 --topic doitedu01 
```

(2)æŒ‡å®šè¦æ¶ˆè´¹çš„åˆ†åŒºï¼Œå’Œè¦æ¶ˆè´¹çš„èµ·å§‹offset

```shell
-- ä»æŒ‡å®šçš„offset(éœ€è¦æŒ‡å®šåç§»é‡å’Œåˆ†åŒºå·)
[root@linux01 bin]# kafka-console-consumer.sh --bootstrap-server linux01:9092 --topic doitedu01 --offset 2 --partition 0
yy
abc
3333
2222
```

(3)æ¶ˆè´¹ç»„

* æ¶ˆè´¹ç»„æ˜¯kafkaä¸ºäº†æé«˜æ¶ˆè´¹å¹¶è¡Œåº¦çš„ä¸€ç§æœºåˆ¶ï¼

* åœ¨kafkaçš„åº•å±‚é€»è¾‘ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±æ‰€å±çš„ç»„ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œç³»ç»Ÿä¼šè‡ªå·±ç»™ä½ åˆ†é…ä¸€ä¸ªç»„idï¼‰

* ç»„å’Œç»„ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå¤§å®¶éƒ½å¯ä»¥æ¶ˆè´¹åˆ°ç›®æ ‡topicçš„æ‰€æœ‰æ•°æ®

* ä½†æ˜¯ç»„å†…çš„å„ä¸ªæ¶ˆè´¹è€…ï¼Œå°±åªèƒ½è¯»åˆ°è‡ªå·±æ‰€åˆ†é…åˆ°çš„partitions

* KAFKAä¸­çš„æ¶ˆè´¹ç»„ï¼Œå¯ä»¥åŠ¨æ€å¢å‡æ¶ˆè´¹è€…,è€Œä¸”æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€…æ•°é‡å‘ç”Ÿä»»æ„å˜åŠ¨ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…åˆ†åŒºæ¶ˆè´¹ä»»åŠ¡(æ¶ˆè´¹è€…ç»„åœ¨å‡è¡¡ç­–ç•¥) &#x20;

> **å¦‚ä½•è®©å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªç»„ï¼š å°±æ˜¯è®©è¿™äº›æ¶ˆè´¹è€…çš„groupIdç›¸åŒå³å¯ï¼**

## **3.5æ¶ˆè´¹ä½ç§»çš„è®°å½•**

kafkaçš„æ¶ˆè´¹è€…ï¼Œå¯ä»¥è®°å½•è‡ªå·±æ‰€æ¶ˆè´¹åˆ°çš„æ¶ˆæ¯åç§»é‡ï¼Œè®°å½•çš„è¿™ä¸ªåç§»é‡å°±å«ï¼ˆæ¶ˆè´¹ä½ç§»ï¼‰ï¼›

è®°å½•è¿™ä¸ªæ¶ˆè´¹åˆ°çš„ä½ç½®ï¼Œä½œç”¨å°±åœ¨äºæ¶ˆè´¹è€…é‡å¯åå¯ä»¥æ¥ç»­ä¸Šä¸€æ¬¡æ¶ˆè´¹åˆ°ä½ç½®æ¥ç»§ç»­å¾€åé¢æ¶ˆè´¹ï¼›

æ¶ˆè´¹ä½ç§»ï¼Œæ˜¯ç»„å†…å…±äº«çš„ï¼ï¼ï¼æ¶ˆè´¹ä½ç½®è®°å½•åœ¨ä¸€ä¸ªå†…ç½®çš„topicä¸­ ï¼Œé»˜è®¤æ˜¯5sæäº¤ä¸€æ¬¡ä½ç§»æ›´æ–°ã€‚

å‚æ•°ï¼š**[auto.commit.interval.ms](https://kafka.apache.org/documentation/#consumerconfigs_auto.commit.interval.ms) é»˜è®¤æ˜¯5sè®°å½•ä¸€æ¬¡**

```shell
--  å¯ä»¥ä½¿ç”¨ç‰¹å®šçš„å·¥å…·ç±» è§£æå†…ç½®è®°å½•åç§»é‡çš„topic
kafka-console-consumer.sh --bootstrap-server  linux01:9092 --from-beginning --topic __consumer_offsets --formatter "kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter"
```

é€šè¿‡æŒ‡å®šformatterå·¥å…·ç±»ï¼Œæ¥å¯¹\_\_consumer\_offsetsä¸»é¢˜ä¸­çš„æ•°æ®è¿›è¡Œè§£æï¼›

```shell
[g01,doitedu01,0]::OffsetAndMetadata(offset=14, leaderEpoch=Optional[0], metadata=, commitTimestamp=1659889851318, expireTimestamp=None)
[g01,doitedu01,2]::OffsetAndMetadata(offset=17, leaderEpoch=Optional[0], metadata=, commitTimestamp=1659889856319, expireTimestamp=None)
[g01,doitedu01,1]::OffsetAndMetadata(offset=13, leaderEpoch=Optional[0], metadata=, commitTimestamp=1659889856319, expireTimestamp=None)
[g01,doitedu01,0]::OffsetAndMetadata(offset=14, leaderEpoch=Optional[0], metadata=, commitTimestamp=1659889856319, expireTimestamp=None)
```

å¦‚æœéœ€è¦è·å–æŸä¸ªç‰¹å®š consumer-groupçš„æ¶ˆè´¹åç§»é‡ä¿¡æ¯ï¼Œåˆ™éœ€è¦è®¡ç®—è¯¥æ¶ˆè´¹ç»„çš„åç§»é‡è®°å½•æ‰€åœ¨åˆ†åŒºï¼š Math.abs(groupID.hashCode()) % numPartitions(50)  æ ¹æ®ç»„idçš„hashå–å€¼%50 ç¡®å®šå…·ä½“æ˜¯å°†è¿™ä¸ªç»„å…·ä½“æ¯ä¸ªåˆ†åŒºæ¶ˆè´¹åˆ°äº†å“ªé‡Œ

\_\_consumer\_offsetsçš„åˆ†åŒºæ•°ä¸ºï¼š50

## **3.6é…ç½®ç®¡ç† kafka-config**

kafka-configs.sh è„šæœ¬æ˜¯ä¸“é—¨ç”¨æ¥è¿›è¡ŒåŠ¨æ€å‚æ•°é…ç½®æ“ä½œçš„ï¼Œè¿™é‡Œçš„æ“ä½œæ˜¯è¿è¡ŒçŠ¶æ€ä¿®æ”¹åŸæœ‰çš„é…ç½®ï¼Œå¦‚æ­¤å¯ä»¥è¾¾åˆ°åŠ¨æ€å˜æ›´çš„ç›®çš„ï¼›ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šè¿›è¡ŒåŠ¨æ€ä¿®æ”¹ ã€‚&#x20;

> **åŠ¨æ€é…ç½®çš„å‚æ•°ï¼Œä¼šè¢«å­˜å‚¨åœ¨zookeeperä¸Šï¼Œå› è€Œæ˜¯æŒä¹…ç”Ÿæ•ˆçš„**

å¯ç”¨å‚æ•°çš„æŸ¥é˜…åœ°å€ï¼š https://kafka.apache.org/documentation/#configuration

kafka-configs.sh è„šæœ¬åŒ…å«ï¼šå˜æ›´alterã€æŸ¥çœ‹describe è¿™ä¸¤ç§æŒ‡ä»¤ç±»å‹ï¼›

kafka-configs. sh æ”¯æŒä¸»é¢˜ã€ broker ã€ç”¨æˆ·å’Œå®¢æˆ·ç«¯è¿™4ä¸ªç±»å‹çš„é…ç½®ã€‚

kafka-configs.sh è„šæœ¬ä½¿ç”¨ entity-type å‚æ•°æ¥æŒ‡å®šæ“ä½œé…ç½®çš„ç±»å‹ï¼Œå¹¶ä¸”ä½¿ entity-nameå‚æ•°æ¥æŒ‡å®šæ“ä½œé…ç½®çš„åç§°ã€‚

æ¯”å¦‚æŸ¥çœ‹topicçš„é…ç½®å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ‰§è¡Œï¼š

```shell
kafka-configs.sh --zookeeper linux01:2181  --describe  --entity-type topics  --entity-name doitedu01
```

æ¯”å¦‚æŸ¥çœ‹brokerçš„åŠ¨æ€é…ç½®å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ‰§è¡Œï¼š

```shell
kafka-configs.sh  --describe --entity-type brokers --entity-name 0 --zookeeper linux01:2181
```

**entity-typeå’Œentity-nameçš„å¯¹åº”å…³ç³»**

&#x20; ç¤ºä¾‹ï¼šæ·»åŠ topicçº§åˆ«å‚æ•°

```shell
kafka-configs.sh --zookeeper linux01:2181 --alter --entity-type topics --entity-name doitedu01  --add-config cleanup.policy=compact,max.message.bytes=10000
```

ç¤ºä¾‹ï¼šæ·»åŠ brokerå‚æ•°

```shell
kafka-configs.sh  --entity-type brokers --entity-name 0 --alter --add-config log.flush.interval.ms=1000 --bootstrap-server linux01:9092,linux02:9092,linux03:9092
```

**åŠ¨æ€é…ç½®topicå‚æ•°**

é€šè¿‡ç®¡ç†å‘½ä»¤ï¼Œå¯ä»¥ä¸ºå·²åˆ›å»ºçš„topicå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤topic levelå‚æ•°

æ·»åŠ /ä¿®æ”¹  æŒ‡å®štopicçš„é…ç½®å‚æ•°ï¼š

```shell
kafka-topics.sh  --topic doitedu01 --alter  --config compression.type=gzip --zookeeper linux01:2181  
```

å¦‚æœåˆ©ç”¨ kafka-configs.sh è„šæœ¬æ¥å¯¹topicã€producerã€consumerã€brokerç­‰è¿›è¡Œå‚æ•°åŠ¨æ€

æ·»åŠ ã€ä¿®æ”¹é…ç½®å‚æ•°

```shell
kafka-configs.sh --zookeeper linux01:2181 --entity-type topics --entity-name doitedu01 --alter --add-config compression.type=gzip  
```

åˆ é™¤é…ç½®å‚æ•°

```shell
kafka-configs.sh --zookeeper linux01:2181 --entity-type topics --entity-name doitedu01 --alter --delete-config compression.type  
```

# **4.APIå¼€å‘**

## å‡†å¤‡ï¼š åˆ›å»ºé¡¹ç›® ï¼Œ æ·»åŠ ä¾èµ–

```xml
 <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.apache.kafka</groupId>
            <artifactId>kafka-clients</artifactId>
            <version>2.3.1</version>
        </dependency>
    </dependencies>


    <!-- ä¾èµ–ä¸‹è½½å›½å†…é•œåƒåº“ -->
    <repositories>
        <repository>
            <id>nexus-aliyun</id>
            <name>Nexus aliyun</name>
            <layout>default</layout>
            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
            <snapshots>
                <enabled>false</enabled>
                <updatePolicy>never</updatePolicy>
            </snapshots>
            <releases>
                <enabled>true</enabled>
                <updatePolicy>never</updatePolicy>
            </releases>
        </repository>
    </repositories>

    <!-- mavenæ’ä»¶ä¸‹è½½å›½å†…é•œåƒåº“ -->
    <pluginRepositories>
        <pluginRepository>
            <id>ali-plugin</id>
            <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
            <snapshots>
                <enabled>false</enabled>
                <updatePolicy>never</updatePolicy>
            </snapshots>
            <releases>
                <enabled>true</enabled>
                <updatePolicy>never</updatePolicy>
            </releases>
        </pluginRepository>
    </pluginRepositories>


    <build>
        <plugins>

            <!-- æŒ‡å®šç¼–è¯‘javaçš„æ’ä»¶ -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.5.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>

            <!-- æŒ‡å®šç¼–è¯‘scalaçš„æ’ä»¶ -->
            <plugin>
                <groupId>net.alchim31.maven</groupId>
                <artifactId>scala-maven-plugin</artifactId>
                <version>3.2.2</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>compile</goal>
                            <goal>testCompile</goal>
                        </goals>
                        <configuration>
                            <args>
                                <arg>-dependencyfile</arg>
                                <arg>${project.build.directory}/.scala_dependencies</arg>
                            </args>
                        </configuration>
                    </execution>
                </executions>
            </plugin>


            <!--  æŠŠä¾èµ–jarä¸­çš„ç”¨åˆ°çš„ç±»ï¼Œæå–åˆ°è‡ªå·±çš„jarä¸­ -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>2.6</version>
                <configuration>
                    <archive>
                        <manifest>
                            <mainClass></mainClass>
                        </manifest>
                    </archive>
                    <descriptorRefs>
                        <descriptorRef>jar-with-dependencies</descriptorRef>
                    </descriptorRefs>
                </configuration>
                <!--ä¸‹é¢æ˜¯ä¸ºäº†ä½¿ç”¨ mvn packageå‘½ä»¤ï¼Œå¦‚æœä¸åŠ åˆ™ä½¿ç”¨mvn assembly-->
                <executions>
                    <execution>
                        <id>make-assemble</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

        </plugins>

    </build>

```

## 4.3**topicç®¡ç†**

å¦‚æœå¸Œæœ›å°†ç®¡ç†ç±»çš„åŠŸèƒ½é›†æˆåˆ°å…¬å¸å†…éƒ¨çš„ç³»ç»Ÿä¸­ï¼Œæ‰“é€ é›†ç®¡ç†ã€ç›‘æ§ã€è¿ç»´ã€å‘Šè­¦ä¸ºä¸€ä½“çš„ç”Ÿæ€å¹³å°ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»¥ç¨‹åºè°ƒç”¨ API æ–¹å¼å»å®ç°ã€‚

å·¥å…·ç±»KafkaAdminClientå¯ä»¥ç”¨æ¥**ç®¡ç†brokerã€é…ç½®å’ŒACL ï¼ˆAccess Control Listï¼‰ï¼Œç®¡ç†topic**

![](images/image-7.png)

æ„é€ ä¸€ä¸ªKafkaAdminClient

```java
AdminClient adminClient = KafkaAdminClient.create(props);
```

### **4.3.1åˆ—å‡ºä¸»é¢˜**

```java
ListTopicsResult listTopicsResult = adminClient.listTopics();
Set<String> topics = listTopicsResult.names().get();
System.out.println(topics);
```

### 4.3.2**æŸ¥çœ‹ä¸»é¢˜ä¿¡æ¯**

```java
DescribeTopicsResult describeTopicsResult = adminClient.describeTopics(Arrays.asList("tpc_4", "tpc_3"));
Map<String, TopicDescription> res = describeTopicsResult.all().get();
Set<String> ksets = res.keySet();
for (String k : ksets) {
    System.out.println(res.get(k));
}
```

### 4.3.2**åˆ›å»ºä¸»é¢˜**

```java
// å‚æ•°é…ç½®
Properties props = new Properties();
props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG,"doit01:9092,doit02:9092,doit03:9092");
props.put(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG,3000);

// åˆ›å»º admin client å¯¹è±¡
AdminClient adminClient = KafkaAdminClient.create(props);
// ç”±æœåŠ¡ç«¯controllerè‡ªè¡Œåˆ†é…åˆ†åŒºåŠå‰¯æœ¬æ‰€åœ¨broker
NewTopic tpc_3 = new NewTopic("tpc_3", 2, (short) 1);
// æ‰‹åŠ¨æŒ‡å®šåˆ†åŒºåŠå‰¯æœ¬çš„brokeråˆ†é…
HashMap<Integer, List<Integer>> replicaAssignments = new HashMap<>();
// åˆ†åŒº0ï¼Œåˆ†é…åˆ°broker0ï¼Œbroker1
replicaAssignments.put(0,Arrays.asList(0,1));
// åˆ†åŒº1ï¼Œåˆ†é…åˆ°broker0,broker2
replicaAssignments.put(1,Arrays.asList(0,1));

NewTopic tpc_4 = new NewTopic("tpc_4", replicaAssignments);
CreateTopicsResult result = adminClient.createTopics(Arrays.asList(tpc_3,tpc_4));

// ä»futureä¸­ç­‰å¾…æœåŠ¡ç«¯è¿”å›
try {
    result.all().get();
} catch (Exception e) {
    e.printStackTrace();
}
adminClient.close();
```

### **4.3.3åˆ é™¤ä¸»é¢˜**

```java
DeleteTopicsResult deleteTopicsResult = adminClient.deleteTopics(Arrays.asList("tpc_1", "tpc_1"));
Map<String, KafkaFuture<Void>> values = deleteTopicsResult.values();
System.out.println(values);
```

æ±‡æ€»ä»£ç ç¤ºä¾‹ï¼š

```java
package com.doit.ApisDemo;

import org.apache.kafka.clients.admin.*;
import org.apache.kafka.common.KafkaFuture;
import org.apache.kafka.common.TopicPartitionInfo;

import java.util.*;
import java.util.concurrent.ExecutionException;

public class AdminDemo {
    public static void main(String[] args)  {
        Properties props = new Properties();
        props.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092");
        props.setProperty(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG,"3000");
        //åˆ›å»ºkafkaAdminå¯¹è±¡
        AdminClient adminClient = KafkaAdminClient.create(props);

//åˆ—å‡ºæ‰€æœ‰ä¸»é¢˜
        ListTopicsResult listTopicsResult = adminClient.listTopics();
        System.out.println(listTopicsResult.names().get());

//åˆ›å»ºtopic
        NewTopic topic1 = new NewTopic("idea_topic_1", 2, (short) 2);
        NewTopic topic2 = new NewTopic("idea_topic_2", 3, (short) 3);
        
        
//åˆ›å»ºtopic  æŒ‡å®šåˆ†åŒºæ•°å’Œå‰¯æœ¬æ•°
        CreateTopicsResult res1 = adminClient.createTopics(Arrays.asList(topic1, topic2));
        try {
            res1.all().get();
        } catch (InterruptedException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);
        } catch (ExecutionException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);        }


//åˆ›å»ºtopic æ‰‹åŠ¨æŒ‡å®šåˆ†åŒºå’Œå‰¯æœ¬åˆ†åˆ«åœ¨å“ªä¸ªbrokerä¸Š
        HashMap<Integer, List<Integer>> replicaAssignments = new HashMap<>();
        //éœ€è¦ä¼ ä¸€ä¸ªkey value key ä»£è¡¨çš„æ˜¯broker valueä»£è¡¨çš„æ˜¯å‰¯æœ¬åˆ†åˆ«åœ¨å“ªäº›broker ä¸Š
        replicaAssignments.put(0,Arrays.asList(0,1));
        replicaAssignments.put(1,Arrays.asList(1,2));

        //åˆ›å»ºä¸€ä¸ªæ–°çš„topicä¿¡æ¯
        NewTopic idea_topic_3 = new NewTopic("idea_topic_3", replicaAssignments);
        //åˆ›å»ºtopic
        CreateTopicsResult res2 = adminClient.createTopics(Arrays.asList(idea_topic_3));
        try {
            res2.all().get();
        } catch (InterruptedException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);        } catch (ExecutionException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);        }


//æè¿°ä¸»é¢˜
       DescribeTopicsResult res = adminClient.describeTopics(Arrays.asList("idea_topic_3"));
        //è·å–åˆ°ä¸»é¢˜çš„æ‰€æœ‰ä¿¡æ¯
        Map<String, TopicDescription> map = res.all().get();
        Set<Map.Entry<String, TopicDescription>> entries = map.entrySet();
        for (Map.Entry<String, TopicDescription> entry : entries) {
            String topicName = entry.getKey();
            TopicDescription des = entry.getValue();
            //åˆ†åŒºçš„è¯¦ç»†ä¿¡æ¯ï¼Œleaderåœ¨å“ªï¼Œå‰¯æœ¬åœ¨å“ªï¼Œåˆ†åŒºå…·ä½“æ˜¯ä»€ä¹ˆæƒ…å†µï¼Œisrå‰¯æœ¬æ˜¯ä»€ä¹ˆæƒ…å†µ
            List<TopicPartitionInfo> partitions = des.partitions();
            //ä¸»é¢˜çš„åç§°
            String name = des.name();
            System.out.println(topicName+","+name+","+partitions);
        }


//åˆ é™¤ä¸»å›¾
        DeleteTopicsResult deleteTopicsResult = adminClient.deleteTopics(Arrays.asList("idea_topic_1", "idea_topic_2"));
        try {
            deleteTopicsResult.all().get();
        } catch (InterruptedException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);
        } catch (ExecutionException e) {
            System.out.println("æœ‰å¼‚å¸¸äº†ï¼š"+e);
        }
    }
}
```

## 4.1**ç”Ÿäº§è€…apiç¤ºä¾‹**

ä¸€ä¸ªæ­£å¸¸çš„ç”Ÿäº§é€»è¾‘éœ€è¦å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤

1. é…ç½®ç”Ÿäº§è€…å‚æ•°åŠåˆ›å»ºç›¸åº”çš„ç”Ÿäº§è€…å®ä¾‹

2. æ„å»ºå¾…å‘é€çš„æ¶ˆæ¯

3. å‘é€æ¶ˆæ¯

4. å…³é—­ç”Ÿäº§è€…å®ä¾‹

é‡‡ç”¨é»˜è®¤åˆ†åŒºæ–¹å¼å°†æ¶ˆæ¯æ•£åˆ—çš„å‘é€åˆ°å„ä¸ªåˆ†åŒºå½“ä¸­

```java
package com.doitedu;

import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerRecord;

import java.util.Properties;

public class KafkaProducerDemo {
    public static void main(String[] args) throws InterruptedException {
        /**
         * 1.æ„å»ºä¸€ä¸ªkafkaçš„å®¢æˆ·ç«¯
         * 2.åˆ›å»ºä¸€äº›å¾…å‘é€çš„æ¶ˆæ¯ï¼Œæ„å»ºæˆkafkaæ‰€éœ€è¦çš„æ ¼å¼
         * 3.è°ƒç”¨kafkaçš„apiå»å‘é€æ¶ˆæ¯
         * 4.å…³é—­kafkaç”Ÿäº§å®ä¾‹
         */
        //1.åˆ›å»ºkafkaçš„å¯¹è±¡ï¼Œé…ç½®ä¸€äº›kafkaçš„é…ç½®æ–‡ä»¶
        //å®ƒé‡Œé¢æœ‰ä¸€ä¸ªæ³›å‹k,v
        //è¦å‘é€æ•°æ®çš„key
        //è¦å‘é€çš„æ•°æ®value
        //ä»–æœ‰ä¸€ä¸ªéšå«ä¹‹æ„ï¼Œå°±æ˜¯kafkaå‘é€çš„æ¶ˆæ¯ï¼Œæ˜¯ä¸€ä¸ªkeyï¼Œvalueç±»å‹çš„æ•°æ®ï¼Œä½†æ˜¯ä¸æ˜¯å¿…é¡»å¾—ï¼Œå…¶å®åªéœ€è¦å‘é€valueçš„å€¼å°±å¯ä»¥äº†
        Properties pros = new Properties();
        //æŒ‡å®škafkaé›†ç¾¤çš„åœ°å€
        pros.setProperty("bootstrap.servers", "linux01:9092,linux02:9092,linux03:9092");
        //æŒ‡å®škeyçš„åºåˆ—åŒ–æ–¹å¼
        pros.setProperty("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        //æŒ‡å®švalueçš„åºåˆ—åŒ–æ–¹å¼
        pros.setProperty("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        //ackæ¨¡å¼ï¼Œå–å€¼æœ‰0ï¼Œ1ï¼Œ-1ï¼ˆallï¼‰ï¼Œallæ˜¯æœ€æ…¢ä½†æœ€å®‰å…¨çš„  æœåŠ¡å™¨åº”ç­”ç”Ÿäº§è€…æˆåŠŸçš„ç­–ç•¥
        pros.put("acks", "all");
        //è¿™æ˜¯kafkaå‘é€æ•°æ®å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œè¿™ä¸ªå¯èƒ½ä¼šé€ æˆå‘é€æ•°æ®çš„ä¹±åºé—®é¢˜
        pros.setProperty("retries", "3");
        //æ•°æ®å‘é€æ‰¹æ¬¡çš„å¤§å° å•ä½æ˜¯å­—èŠ‚
        pros.setProperty("batch.size", "10000");
        //ä¸€æ¬¡æ•°æ®å‘é€è¯·æ±‚æ‰€èƒ½å‘é€çš„æœ€å¤§æ•°æ®é‡
        pros.setProperty("max.request.size", "102400");
        //æ¶ˆæ¯åœ¨ç¼“å†²åŒºä¿ç•™çš„æ—¶é—´ï¼Œè¶…è¿‡è®¾ç½®çš„å€¼å°±ä¼šè¢«æäº¤åˆ°æœåŠ¡ç«¯
        pros.put("linger.ms", 10000);
        //æ•´ä¸ªProducerç”¨åˆ°æ€»å†…å­˜çš„å¤§å°ï¼Œå¦‚æœç¼“å†²åŒºæ»¡äº†ä¼šæäº¤æ•°æ®åˆ°æœåŠ¡ç«¯
        //buffer.memoryè¦å¤§äºbatch.sizeï¼Œå¦åˆ™ä¼šæŠ¥ç”³è¯·å†…å­˜ä¸è¶³çš„é”™è¯¯
        pros.put("buffer.memory", 10240);

        KafkaProducer<String, String> kafkaProducer = new KafkaProducer<>(pros);
        for (int i = 0; i < 1000; i++) {
            //key value  0 --> doit32+-->+0
            //key value  1 --> doit32+-->+1
            //key value  2 --> doit32+-->+2
            //2.åˆ›å»ºä¸€äº›å¾…å‘é€çš„æ¶ˆæ¯ï¼Œæ„å»ºæˆkafkaæ‰€éœ€è¦çš„æ ¼å¼
            ProducerRecord<String, String> record = new ProducerRecord<>("test01", i + "", "doit32-->" + i);
            //3.è°ƒç”¨kafkaçš„apiå»å‘é€æ¶ˆæ¯
            kafkaProducer.send(record);
            Thread.sleep(100);
        }
        kafkaProducer.flush();
        kafkaProducer.close();
    }
}
```

å¯¹äºpropertiesé…ç½®çš„ç¬¬äºŒç§å†™æ³•ï¼Œç›¸å¯¹æ¥è¯´ä¸ä¼šå‡ºé”™ï¼Œç®€å•ä¸¾ä¾‹ï¼š

```java
public static void main(String[] args) {
    Properties pros = new Properties();
    pros.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "linux01:9092,linux02:9092,linux03:9092");
    pros.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
    pros.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
}
```

> å°é—®é¢˜ï¼š
>
> **1.kafkaçš„ç”Ÿäº§è€…å¯ä»¥æŒç»­ä¸æ–­çš„å‘topicä¸­å‘é€æ•°æ®ä¸ï¼Ÿ**
>
> å¯ä»¥
>
> **2.kafakçš„ç”Ÿäº§è€…æœ‰å“ªäº›å¿…é¡»é…ç½®çš„å‚æ•°ï¼š**
>
> &#x20;*//æŒ‡å®škafkaé›†ç¾¤çš„åœ°å€*
> pros.setProperty("bootstrap.servers", "linux01:9092,linux02:9092,linux03:9092");
> *//æŒ‡å®škeyçš„åºåˆ—åŒ–æ–¹å¼*
> pros.setProperty("key.serializer","org.apache.kafka.common.serialization.StringSerializer");
> *//æŒ‡å®švalueçš„åºåˆ—åŒ–æ–¹å¼*
> pros.setProperty("value.serializer","org.apache.kafka.common.serialization.StringSerializer");
>
> **3.kafkaç”Ÿäº§è€…å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨jdkçš„åºåˆ—åŒ–å™¨æ¥å°†æ•°æ®è¿›è¡Œåºåˆ—åŒ–ä¸ï¼Ÿ**
>
> ä¸å¯ä»¥ï¼Œkafkaæœ‰æŒ‡å®šçš„åºåˆ—åŒ–æ¥å£ org.apache.kafka.common.serialization.Serializer
>
> **4.æ„é€ ä¸€ä¸ªkafkaçš„ç”Ÿäº§è€…åï¼Œæ˜¯ä¸æ˜¯å°±å·²ç»ç¡®å®šäº†ï¼Œæˆ‘çš„æ•°æ®æ˜¯éœ€è¦å‘é€åˆ°å“ªä¸€ä¸ªtopicé‡Œé¢ä¸ï¼Ÿ**
>
> ä¸æ˜¯å“¦ï¼Œå’±ä»¬æ„é€ ç”Ÿäº§è€…å¯¹è±¡çš„æ—¶å€™ä¸éœ€è¦æŒ‡å®štopicï¼Œæ˜¯åœ¨æ„é€ å‘é€æ•°æ®å¯¹è±¡çš„æ—¶å€™æ‰æŒ‡å®šçš„

## 4.2**æ¶ˆè´¹è€…Apiç¤ºä¾‹**

ä¸€ä¸ªæ­£å¸¸çš„æ¶ˆè´¹é€»è¾‘éœ€è¦å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. é…ç½®æ¶ˆè´¹è€…å®¢æˆ·ç«¯å‚æ•°åŠåˆ›å»ºç›¸åº”çš„æ¶ˆè´¹è€…å®ä¾‹ï¼›

2. è®¢é˜…ä¸»é¢˜topicï¼›

3. **æ‹‰å–**æ¶ˆæ¯å¹¶æ¶ˆè´¹ï¼›

4. å®šæœŸå‘\_\_consumer\_offsetsä¸»é¢˜æäº¤æ¶ˆè´¹ä½ç§»offsetï¼›

5. å…³é—­æ¶ˆè´¹è€…å®ä¾‹

```java
package com.doitedu;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.header.Header;
import org.apache.kafka.common.header.Headers;
import org.apache.kafka.common.record.TimestampType;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.Arrays;
import java.util.Iterator;
import java.util.Optional;
import java.util.Properties;

public class ConsumerDemo {
    public static void main(String[] args) {
        //1.åˆ›å»ºkafkaçš„æ¶ˆè´¹è€…å¯¹è±¡ï¼Œé™„å¸¦ç€æŠŠé…ç½®æ–‡ä»¶æå®š
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092,linux02:9092,linux03:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        // å®šä¹‰kakfa æœåŠ¡çš„åœ°å€ï¼Œä¸éœ€è¦å°†æ‰€æœ‰brokeræŒ‡å®šä¸Š
       // props.put("bootstrap.servers", "linux01:9092,linux02:9092,linux03:9092");
        // åˆ¶å®šconsumer group
        props.put("group.id", "g3");
        // æ˜¯å¦è‡ªåŠ¨æäº¤offset  __consumer_offset   æœ‰å¤šå°‘åˆ†åŒº  50 
        props.put("enable.auto.commit", "true");
        // è‡ªåŠ¨æäº¤offsetçš„æ—¶é—´é—´éš”   -- è¿™ç©æ„è®¾ç½®çš„å¤§å°æ€ä¹ˆæ§åˆ¶
        props.put("auto.commit.interval.ms", "5000");  //50000   1000
        // keyçš„ååºåˆ—åŒ–ç±»
        props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        // valueçš„ååºåˆ—åŒ–ç±»
        props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹åç§»é‡è®°å½•ï¼Œåˆ™è‡ªåŠ¨é‡è®¾ä¸ºèµ·å§‹offsetï¼šlatest, earliest, none
        props.put("auto.offset.reset","earliest");
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

        //2.è®¢é˜…ä¸»é¢˜(ç¡®å®šéœ€è¦æ¶ˆè´¹å“ªä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»é¢˜)
        consumer.subscribe(Arrays.asList("test02"));
        //3.å¼€å§‹ä»topicä¸­è·å–æ•°æ®
        while (true){
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                //è¿™æ˜¯æ•°æ®æ‰€å±çš„å“ªä¸€ä¸ªtopic
                String topic = record.topic();
                //è¯¥æ¡æ•°æ®çš„åç§»é‡
                long offset = record.offset();
                //è¿™æ¡æ•°æ®æ˜¯å“ªä¸€ä¸ªåˆ†åŒºçš„
                int partition = record.partition();
                //è¿™æ¡æ•°æ®è®°å½•çš„æ—¶é—´æˆ³,ä½†æ˜¯è¿™ä¸ªæ—¶é—´æˆ³æœ‰ä¸¤ä¸ªç±»å‹
                long timestamp = record.timestamp();
                //ä¸Šé¢æ—¶é—´æˆ³çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯CreateTime(è¿™æ¡æ•°æ®åˆ›å»ºçš„æ—¶é—´), LogAppendTime(è¿™æ¡æ•°æ®å¾€æ—¥å¿—é‡Œé¢è¿½åŠ çš„æ—¶é—´)
                TimestampType timestampType = record.timestampType();
                //è¿™ä¸ªæ•°æ®keyçš„å€¼
                String key = record.key();
                //è¿™æ¡æ•°æ®valueçš„å€¼
                String value = record.value();
                //åˆ†åŒºleaderçš„çºªå…ƒ
                Optional<Integer> integer = record.leaderEpoch();
                //keyçš„é•¿åº¦
                int keySize = record.serializedKeySize();
                //valueçš„é•¿åº¦
                int valueSize = record.serializedValueSize();
                //æ•°æ®çš„å¤´éƒ¨ä¿¡æ¯
                Headers headers = record.headers();
//            for (Header header : headers) {
//                String hKey = header.key();
//                byte[] hValue = header.value();
//                String valueString = new String(hValue);
//                System.out.println("headerçš„keyå€¼ = " + hKey + "headerçš„valueçš„å€¼ = "+ valueString);
//            }
                System.out.printf("topic = %s ,offset = %d, partition = %d, timestampType = %s ,timestamp = %d , key = %s , value = %s ,leaderçš„çºªå…ƒ = %d , keyåºåˆ—åŒ–çš„é•¿åº¦ = %d ,value åºåˆ—åŒ–çš„é•¿åº¦ = %d \r\n" ,
                        topic,offset,partition,timestampType + "",timestamp,key,value,integer.get(),keySize,valueSize);
            }
        }

        //4.å…³é—­æ¶ˆè´¹è€…å¯¹è±¡
//        consumer.close();
    }
}
```

### **4.2.1subscribeè®¢é˜…ä¸»é¢˜**

subscribeæœ‰å¦‚ä¸‹é‡è½½æ–¹æ³•ï¼š

```java
public void subscribe(Collection<String> topics,ConsumerRebalanceListener listener) 
public void subscribe(Collection<String> topics) 
public void subscribe(Pattern pattern, ConsumerRebalanceListener listener) 
public void subscribe(Pattern pattern)
```

1. æŒ‡å®šé›†åˆæ–¹å¼è®¢é˜…ä¸»é¢˜

```java
consumer.subscribe(Arrays.asList(topicl ));
```

* æ­£åˆ™æ–¹å¼è®¢é˜…ä¸»é¢˜

å¦‚æœæ¶ˆè´¹è€…é‡‡ç”¨çš„æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼ï¼ˆsubscribe(Pattern)ï¼‰è®¢é˜…ï¼Œ åœ¨ä¹‹åçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰äººåˆåˆ›å»ºäº†æ–°çš„ä¸»é¢˜ï¼Œå¹¶ä¸”ä¸»é¢˜åå­—ä¸æ­£è¡¨è¾¾å¼ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆè´¹è€…å°±å¯ä»¥æ¶ˆè´¹åˆ°æ–°æ·»åŠ çš„ä¸»é¢˜ä¸­çš„æ¶ˆæ¯ã€‚å¦‚æœåº”ç”¨ç¨‹åºéœ€è¦æ¶ˆè´¹å¤šä¸ªä¸»é¢˜ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†ä¸åŒçš„ç±»å‹ï¼Œé‚£ä¹ˆè¿™ç§è®¢é˜…æ–¹å¼å°±å¾ˆæœ‰æ•ˆã€‚

æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼è®¢é˜…çš„ç¤ºä¾‹

```java
consumer.subscribe(Pattern.compile ("topic.*" ));
```

> åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è®¢é˜…ä¸»é¢˜ï¼Œå¯å®ç°åŠ¨æ€è®¢é˜…

### **4.2.2assignè®¢é˜…ä¸»é¢˜**

æ¶ˆè´¹è€…ä¸ä»…å¯ä»¥é€šè¿‡ KafkaConsumer.subscribe() æ–¹æ³•è®¢é˜…ä¸»é¢˜ï¼Œè¿˜å¯ç›´æ¥è®¢é˜…æŸäº›ä¸»é¢˜çš„æŒ‡å®šåˆ†åŒºï¼›

&#x20;åœ¨ KafkaConsumer ä¸­æä¾›äº† assign() æ–¹æ³•æ¥å®ç°è¿™äº›åŠŸèƒ½ï¼Œæ­¤æ–¹æ³•çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```java
package com.doitedu;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.common.header.Headers;
import org.apache.kafka.common.record.TimestampType;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.Arrays;
import java.util.Optional;
import java.util.Properties;

public class ConsumerDemo1 {
    public static void main(String[] args) {
        //1.åˆ›å»ºkafkaçš„æ¶ˆè´¹è€…å¯¹è±¡ï¼Œé™„å¸¦ç€æŠŠé…ç½®æ–‡ä»¶æå®š
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092,linux02:9092,linux03:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG,"doit01");

        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

        //2.è®¢é˜…ä¸»é¢˜(ç¡®å®šéœ€è¦æ¶ˆè´¹å“ªä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»é¢˜)
//        consumer.subscribe(Arrays.asList("test03"));

//        consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
//        //æˆ‘ç°åœ¨æƒ³æ‰‹åŠ¨æŒ‡å®šï¼Œæˆ‘éœ€è¦ä»å“ªè¾¹å¼€å§‹æ¶ˆè´¹
//        //å¦‚æœç”¨subscribeå»è®¢é˜…ä¸»é¢˜çš„æ—¶å€™ï¼Œä»–å†…éƒ¨ä¼šç»™è¿™ä¸ªæ¶ˆè´¹è€…ç»„æ¥ä¸€ä¸ªè‡ªåŠ¨å†å‡è¡¡
//        consumer.seek(new TopicPartition("test03",0),2);
        TopicPartition tp01 = new TopicPartition("test03", 0);

        //ä»–å°±æ˜¯æ‰‹åŠ¨å»è®¢é˜…ä¸»é¢˜å’Œpartitionï¼Œæœ‰äº†è¿™ä¸ªå°±ä¸éœ€è¦å†å»è®¢é˜…subscribeä¸»é¢˜äº†ï¼Œæ‰‹åŠ¨æŒ‡å®šä»¥åï¼Œä»–çš„å†…éƒ¨å°±ä¸ä¼šå†æ¥è‡ªåŠ¨å‡è¡¡äº†
        consumer.assign(Arrays.asList(tp01)); // æ‰‹åŠ¨è®¢é˜…æŒ‡å®šä¸»é¢˜çš„æŒ‡å®šåˆ†åŒºçš„æŒ‡å®šä½ç½®
        consumer.seek(new TopicPartition("test03",0),2);

        //3.å¼€å§‹ä»topicä¸­è·å–æ•°æ®
        while (true){
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                //è¿™æ˜¯æ•°æ®æ‰€å±çš„å“ªä¸€ä¸ªtopic
                String topic = record.topic();
                //è¯¥æ¡æ•°æ®çš„åç§»é‡
                long offset = record.offset();
                //è¿™æ¡æ•°æ®æ˜¯å“ªä¸€ä¸ªåˆ†åŒºçš„
                int partition = record.partition();
                //è¿™æ¡æ•°æ®è®°å½•çš„æ—¶é—´æˆ³,ä½†æ˜¯è¿™ä¸ªæ—¶é—´æˆ³æœ‰ä¸¤ä¸ªç±»å‹
                long timestamp = record.timestamp();
                //ä¸Šé¢æ—¶é—´æˆ³çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯CreateTime(è¿™æ¡æ•°æ®åˆ›å»ºçš„æ—¶é—´), LogAppendTime(è¿™æ¡æ•°æ®å¾€æ—¥å¿—é‡Œé¢è¿½åŠ çš„æ—¶é—´)
                TimestampType timestampType = record.timestampType();
                //è¿™ä¸ªæ•°æ®keyçš„å€¼
                String key = record.key();
                //è¿™æ¡æ•°æ®valueçš„å€¼
                String value = record.value();

                //åˆ†åŒºleaderçš„çºªå…ƒ
                Optional<Integer> integer = record.leaderEpoch();
                //keyçš„é•¿åº¦
                int keySize = record.serializedKeySize();
                //valueçš„é•¿åº¦
                int valueSize = record.serializedValueSize();
                //æ•°æ®çš„å¤´éƒ¨ä¿¡æ¯
                Headers headers = record.headers();
//            for (Header header : headers) {
//                String hKey = header.key();
//                byte[] hValue = header.value();
//                String valueString = new String(hValue);
//                System.out.println("headerçš„keyå€¼ = " + hKey + "headerçš„valueçš„å€¼ = "+ valueString);
//            }
                System.out.printf("topic = %s ,offset = %d, partition = %d, timestampType = %s ,timestamp = %d , key = %s , value = %s ,leaderçš„çºªå…ƒ = %d , keyåºåˆ—åŒ–çš„é•¿åº¦ = %d ,value åºåˆ—åŒ–çš„é•¿åº¦ = %d \r\n" ,
                        topic,offset,partition,timestampType + "",timestamp,key,value,integer.get(),keySize,valueSize);
            }
        }

        //4.å…³é—­æ¶ˆè´¹è€…å¯¹è±¡
//        consumer.close();
    }
}
```

è¿™ä¸ªæ–¹æ³•åªæ¥å—å‚æ•°partitionsï¼Œç”¨æ¥æŒ‡å®šéœ€è¦è®¢é˜…çš„åˆ†åŒºé›†åˆã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š&#x20;

```java
consumer.assign(Arrays.asList(new TopicPartition ("tpc_1" , 0),new TopicPartition(â€œtpc_2â€,1))) ;
```

### **4.2.3subscribeä¸assignçš„åŒºåˆ«**

* é€šè¿‡subscribe()æ–¹æ³•è®¢é˜…ä¸»é¢˜å…·æœ‰æ¶ˆè´¹è€…è‡ªåŠ¨å†å‡è¡¡åŠŸèƒ½ ï¼›

åœ¨å¤šä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹å¯ä»¥æ ¹æ®åˆ†åŒºåˆ†é…ç­–ç•¥æ¥è‡ªåŠ¨åˆ†é…å„ä¸ªæ¶ˆè´¹è€…ä¸åˆ†åŒºçš„å…³ç³»ã€‚å½“æ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…å¢åŠ æˆ–å‡å°‘æ—¶ï¼Œåˆ†åŒºåˆ†é…å…³ç³»ä¼šè‡ªåŠ¨è°ƒæ•´ï¼Œä»¥å®ç°æ¶ˆè´¹è´Ÿè½½å‡è¡¡åŠæ•…éšœè‡ªåŠ¨è½¬ç§»ã€‚&#x20;

* assign() æ–¹æ³•è®¢é˜…åˆ†åŒºæ—¶ï¼Œæ˜¯ä¸å…·å¤‡æ¶ˆè´¹è€…è‡ªåŠ¨å‡è¡¡çš„åŠŸèƒ½çš„ï¼›

å…¶å®è¿™ä¸€ç‚¹ä»assignæ–¹æ³•å‚æ•°å¯ä»¥çœ‹å‡ºç«¯å€ªï¼Œä¸¤ç§ç±»å‹subscribe()éƒ½æœ‰ConsumerRebalanceListenerç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œè€Œassign()æ–¹æ³•å´æ²¡æœ‰ã€‚

### 4.2.4**å–æ¶ˆè®¢é˜…**

æ—¢ç„¶æœ‰è®¢é˜…ï¼Œé‚£ä¹ˆå°±æœ‰å–æ¶ˆè®¢é˜…ï¼›

å¯ä»¥ä½¿ç”¨KafkaConsumerä¸­çš„unsubscribe()æ–¹æ³•é‡‡å–æ¶ˆä¸»é¢˜çš„è®¢é˜…ï¼Œè¿™ä¸ªæ–¹æ³•æ—¢å¯ä»¥å–æ¶ˆé€šè¿‡ subscribe( Collectionï¼‰æ–¹å¼å®ç°çš„è®¢é˜…ï¼›

ä¹Ÿå¯ä»¥å–æ¶ˆé€šè¿‡subscribe(Pattemï¼‰æ–¹å¼å®ç°çš„è®¢é˜…ï¼Œè¿˜å¯ä»¥å–æ¶ˆé€šè¿‡assign( Collectionï¼‰æ–¹å¼å®ç°çš„è®¢é˜…ã€‚ç¤ºä¾‹ç å¦‚ä¸‹ï¼š

```java
consumer.unsubscribe();
```

å¦‚æœå°†subscribe(Collection )æˆ–assign(Collectionï¼‰é›†åˆå‚æ•°è®¾ç½®ä¸ºç©ºé›†åˆï¼Œä½œç”¨ä¸unsubscribeï¼ˆï¼‰æ–¹æ³•ç›¸åŒï¼Œå¦‚ä¸‹ç¤ºä¾‹ä¸­ä¸‰è¡Œä»£ç çš„æ•ˆæœç›¸åŒï¼š

```java
consumer.unsubscribe();
consumer.subscribe(new ArrayList<String>()) ;
consumer.assign(new ArrayList<TopicPartition>());
```

### **4.2.5æ¶ˆæ¯çš„æ¶ˆè´¹æ¨¡å¼**

Kafkaä¸­çš„æ¶ˆè´¹æ˜¯åŸºäºæ‹‰å–æ¨¡å¼çš„ã€‚

> æ¶ˆæ¯çš„æ¶ˆè´¹ä¸€èˆ¬æœ‰ä¸¤ç§æ¨¡å¼ï¼šæ¨é€æ¨¡å¼å’Œæ‹‰å–æ¨¡å¼ã€‚æ¨æ¨¡å¼æ˜¯æœåŠ¡ç«¯ä¸»åŠ¨å°†æ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹è€…ï¼Œè€Œæ‹‰æ¨¡å¼æ˜¯æ¶ˆè´¹è€…ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ¥æ‹‰å–æ¶ˆæ¯ã€‚

```java
public class ConsumerRecord<K, V> {
    public static final long NO_TIMESTAMP = RecordBatch.NO_TIMESTAMP;
    public static final int NULL_SIZE = -1;
    public static final int NULL_CHECKSUM = -1;

    private final String topic;
    private final int partition;
    private final long offset;
    private final long timestamp;
    private final TimestampType timestampType;
    private final int serializedKeySize;
    private final int serializedValueSize;
    private final Headers headers;
    private final K key;
    private final V value;

    private volatile Long checksum;
```

* topic partition è¿™ä¸¤ä¸ªå±æ€§åˆ†åˆ«ä»£è¡¨æ¶ˆæ¯æ‰€å±ä¸»é¢˜çš„åç§°å’Œæ‰€åœ¨åˆ†åŒºçš„ç¼–å·ã€‚

* offset è¡¨ç¤ºæ¶ˆæ¯åœ¨æ‰€å±åˆ†åŒºçš„åç§»é‡ã€‚&#x20;

* timestamp è¡¨ç¤ºæ—¶é—´æˆ³ï¼Œä¸æ­¤å¯¹åº”çš„timestampType è¡¨ç¤ºæ—¶é—´æˆ³çš„ç±»å‹ã€‚&#x20;

* timestampType æœ‰ä¸¤ç§ç±»å‹ CreateTime å’ŒLogAppendTime ï¼Œåˆ†åˆ«ä»£è¡¨æ¶ˆæ¯åˆ›å»ºçš„æ—¶é—´æˆ³å’Œæ¶ˆæ¯è¿½åŠ åˆ°æ—¥å¿—çš„æ—¶é—´æˆ³ã€‚

* headers è¡¨ç¤ºæ¶ˆæ¯çš„å¤´éƒ¨å†…å®¹ã€‚&#x20;

* key value åˆ†åˆ«è¡¨ç¤ºæ¶ˆæ¯çš„é”®å’Œæ¶ˆæ¯çš„å€¼ï¼Œä¸€èˆ¬ä¸šåŠ¡åº”ç”¨è¦è¯»å–çš„å°±æ˜¯value ï¼›

* serializedKeySizeã€serializedValueSizeåˆ†åˆ«è¡¨ç¤ºkeyã€value ç»è¿‡åºåˆ—åŒ–ä¹‹åçš„å¤§å°ï¼Œå¦‚æœ key ä¸ºç©ºï¼Œåˆ™ serializedKeySize å€¼ä¸º -1ï¼ŒåŒæ ·ï¼Œå¦‚æœvalueä¸ºç©ºï¼Œåˆ™serializedValueSize çš„å€¼ä¹Ÿä¼šä¸º -1ï¼›

* checksum æ˜¯CRC32çš„æ ¡éªŒå€¼ã€‚

ç¤ºä¾‹ä»£ç ç‰‡æ®µ

```java
/**
 * è®¢é˜…ä¸æ¶ˆè´¹æ–¹å¼2
 */
TopicPartition tp1 = new TopicPartition("x", 0);
TopicPartition tp2 = new TopicPartition("y", 0);
TopicPartition tp3 = new TopicPartition("z", 0);
List<TopicPartition> tps = Arrays.asList(tp1, tp2, tp3);
consumer.assign(tps);
â€‹
while (true) {
 Â  Â ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
 Â  Â for (TopicPartition tp : tps) {
 Â  Â  Â  Â List<ConsumerRecord<String, String>> rList = records.records(tp);
 Â  Â  Â  Â for (ConsumerRecord<String, String> r : rList) {
 Â  Â  Â  Â  Â  Â r.topic();
 Â  Â  Â  Â  Â  Â r.partition();
 Â  Â  Â  Â  Â  Â r.offset();
 Â  Â  Â  Â  Â  Â r.value();
 Â  Â  Â  Â  Â  Â //do something to process record.
 Â  Â  Â   }
 Â   }
}
```

### **4.2.6æŒ‡å®šä½ç§»æ¶ˆè´¹**

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´ç»†ç²’åº¦çš„æŒæ§ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä»ç‰¹å®šçš„ä½ç§»å¤„å¼€å§‹æ‹‰å–æ¶ˆæ¯ï¼Œè€Œ KafkaConsumer ä¸­çš„seek()æ–¹æ³•æ­£å¥½æä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œè®©æˆ‘ä»¬å¯ä»¥è¿½å‰æ¶ˆè´¹æˆ–å›æº¯æ¶ˆè´¹ã€‚&#x20;

seek()æ–¹æ³•çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```java
seekéƒ½æ˜¯å’Œassignè¿™ä¸ªæ–¹æ³•ä¸€èµ·ç”¨ æŒ‡å®šæ¶ˆè´¹ä½ç½®
public void seek(TopicPartiton partition,long offset)
```

ä»£ç ç¤ºä¾‹ï¼š

```java
public class ConsumerDemo3æŒ‡å®šåç§»é‡æ¶ˆè´¹ {
    public static void main(String[] args) {

        Properties props = new Properties();
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG,"g002");
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"doit01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,"latest");
        // æ˜¯å¦è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»
        props.setProperty(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,"true");

        // é™åˆ¶ä¸€æ¬¡pollæ‹‰å–åˆ°çš„æ•°æ®é‡çš„æœ€å¤§å€¼
        props.setProperty(ConsumerConfig.FETCH_MAX_BYTES_CONFIG,"10240000");
         KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

        // assignæ–¹å¼è®¢é˜…doit27-1çš„ä¸¤ä¸ªåˆ†åŒº
        TopicPartition tp0 = new TopicPartition("doit27-1", 0);
        TopicPartition tp1 = new TopicPartition("doit27-1", 1);
        
        consumer.assign(Arrays.asList(tp0,tp1));
        // æŒ‡å®šåˆ†åŒº0ï¼Œä»offsetï¼š800å¼€å§‹æ¶ˆè´¹    ï¼›  åˆ†åŒº1ï¼Œä»offsetï¼š650å¼€å§‹æ¶ˆè´¹
        consumer.seek(tp0,200);
        consumer.seek(tp1,250);

        // å¼€å§‹æ‹‰å–æ¶ˆæ¯
        while(true){
            ConsumerRecords<String, String> poll = consumer.poll(Duration.ofMillis(3000));
            for (ConsumerRecord<String, String> rec : poll) {
                System.out.println(rec.partition()+","+rec.key()+","+rec.value()+","+rec.offset());
            }
        }
    }
}
```

### **4.2.7è‡ªåŠ¨æäº¤æ¶ˆè´¹è€…åç§»é‡**

Kafkaä¸­é»˜è®¤çš„æ¶ˆè´¹ä½ç§»çš„æäº¤æ–¹å¼æ˜¯è‡ªåŠ¨æäº¤ï¼Œè¿™ä¸ªç”±æ¶ˆè´¹è€…å®¢æˆ·ç«¯å‚æ•°enable.auto.commit é…ç½®ï¼Œé»˜è®¤å€¼ä¸º true ã€‚å½“ç„¶è¿™ä¸ªé»˜è®¤çš„è‡ªåŠ¨æäº¤ä¸æ˜¯æ¯æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯å°±æäº¤ä¸€æ¬¡ï¼Œè€Œæ˜¯å®šæœŸæäº¤ï¼Œè¿™ä¸ªå®šæœŸçš„å‘¨æœŸæ—¶é—´ç”±å®¢æˆ·ç«¯å‚æ•° auto.commit.interval.msé…ç½®ï¼Œé»˜è®¤å€¼ä¸º5ç§’ï¼Œæ­¤å‚æ•°ç”Ÿæ•ˆçš„å‰ææ˜¯ enable. auto.commit å‚æ•°ä¸º trueã€‚

åœ¨é»˜è®¤çš„æ–¹å¼ä¸‹ï¼Œæ¶ˆè´¹è€…æ¯éš”5ç§’ä¼šå°†æ‹‰å–åˆ°çš„æ¯ä¸ªåˆ†åŒºä¸­æœ€å¤§çš„æ¶ˆæ¯ä½ç§»è¿›è¡Œæäº¤ã€‚è‡ªåŠ¨ä½ç§»æäº¤çš„åŠ¨ä½œæ˜¯åœ¨ poll() æ–¹æ³•çš„é€»è¾‘é‡Œå®Œæˆçš„ï¼Œåœ¨æ¯æ¬¡çœŸæ­£å‘æœåŠ¡ç«¯å‘èµ·æ‹‰å–è¯·æ±‚ä¹‹å‰ä¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œä½ç§»æäº¤ï¼Œå¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆå°±ä¼šæäº¤ä¸Šä¸€æ¬¡è½®è¯¢çš„ä½ç§»ã€‚

Kafka æ¶ˆè´¹çš„ç¼–ç¨‹é€»è¾‘ä¸­ä½ç§»æäº¤æ˜¯ä¸€å¤§éš¾ç‚¹ï¼Œè‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»çš„æ–¹å¼éå¸¸ç®€ä¾¿ï¼Œå®ƒå…å»äº†å¤æ‚çš„ä½ç§»æäº¤é€»è¾‘ï¼Œè®©ç¼–ç æ›´ç®€æ´ã€‚**ä½†éšä¹‹è€Œæ¥çš„æ˜¯é‡å¤æ¶ˆè´¹å’Œæ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜**ã€‚

* é‡å¤æ¶ˆè´¹

å‡è®¾åˆšåˆšæäº¤å®Œä¸€æ¬¡æ¶ˆè´¹ä½ç§»ï¼Œç„¶åæ‹‰å–ä¸€æ‰¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œåœ¨ä¸‹ä¸€æ¬¡è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»ä¹‹å‰ï¼Œæ¶ˆè´¹è€…å´©æºƒäº†ï¼Œé‚£ä¹ˆåˆå¾—ä»ä¸Šä¸€æ¬¡ä½ç§»æäº¤çš„åœ°æ–¹é‡æ–°å¼€å§‹æ¶ˆè´¹ï¼Œè¿™æ ·ä¾¿å‘ç”Ÿäº†é‡å¤æ¶ˆè´¹çš„ç°è±¡ï¼ˆå¯¹äºå†å‡è¡¡çš„æƒ…å†µåŒæ ·é€‚ç”¨ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å°ä½ç§»æäº¤çš„æ—¶é—´é—´éš”æ¥å‡å°é‡å¤æ¶ˆæ¯çš„çª—å£å¤§å°ï¼Œä½†è¿™æ ·å¹¶ä¸èƒ½é¿å…é‡å¤æ¶ˆè´¹çš„å‘é€ï¼Œè€Œä¸”ä¹Ÿä¼šä½¿ä½ç§»æäº¤æ›´åŠ é¢‘ç¹ã€‚

* ä¸¢å¤±æ¶ˆæ¯

æŒ‰ç…§ä¸€èˆ¬æ€ç»´é€»è¾‘è€Œè¨€ï¼Œè‡ªåŠ¨æäº¤æ˜¯å»¶æ—¶æäº¤ï¼Œé‡å¤æ¶ˆè´¹å¯ä»¥ç†è§£ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¸¢å¤±åˆæ˜¯åœ¨ä»€ä¹ˆæƒ…å½¢ä¸‹ä¼šå‘ç”Ÿçš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹å›¾ä¸­çš„æƒ…å½¢ï¼š

æ‹‰å–çº¿ç¨‹ä¸æ–­åœ°æ‹‰å–æ¶ˆæ¯å¹¶å­˜å…¥æœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚åœ¨BlockingQueue ä¸­ï¼Œå¦ä¸€ä¸ªå¤„ç†çº¿ç¨‹ä»ç¼“å­˜ä¸­è¯»å–æ¶ˆæ¯å¹¶è¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†ã€‚è®¾ç›®å‰è¿›è¡Œåˆ°äº†ç¬¬ y+l æ¬¡æ‹‰å–ï¼Œä»¥åŠç¬¬mæ¬¡ä½ç§»æäº¤çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ x+6 ä¹‹å‰çš„ä½ç§»å·±ç»ç¡®è®¤æäº¤äº†ï¼Œå¤„ç†çº¿ç¨‹å´è¿˜æ­£åœ¨å¤„ç†**x+3**çš„æ¶ˆæ¯ï¼›æ­¤æ—¶å¦‚æœå¤„ç†çº¿ç¨‹å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¾…å…¶æ¢å¤ä¹‹åä¼šä»ç¬¬mæ¬¡ä½ç§»æäº¤å¤„ï¼Œä¹Ÿå°±&#x662F;**&#x20;x+6** çš„ä½ç½®å¼€å§‹æ‹‰å–æ¶ˆæ¯ï¼Œé‚£ä¹ˆ x+3è‡³x+6 ä¹‹é—´çš„æ¶ˆæ¯å°±æ²¡æœ‰å¾—åˆ°ç›¸åº”çš„å¤„ç†ï¼Œè¿™æ ·ä¾¿å‘ç”Ÿæ¶ˆæ¯ä¸¢å¤±çš„ç°è±¡ã€‚

![](images/image-8.png)

### **4.2.8æ‰‹åŠ¨æäº¤æ¶ˆè´¹è€…åç§»é‡ï¼ˆè°ƒç”¨kafka apiï¼‰**

è‡ªåŠ¨ä½ç§»æäº¤çš„æ–¹å¼åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿæ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹çš„ç°è±¡ï¼Œä½†æ˜¯åœ¨ç¼–ç¨‹çš„ä¸–ç•Œé‡Œå¼‚å¸¸æ— å¯é¿å…ï¼›åŒæ—¶ï¼Œè‡ªåŠ¨ä½ç§»æäº¤ä¹Ÿæ— æ³•åšåˆ°ç²¾ç¡®çš„ä½ç§»ç®¡ç†ã€‚åœ¨ Kafkaä¸­è¿˜æä¾›äº†æ‰‹åŠ¨ä½ç§»æäº¤çš„æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—å¼€å‘äººå‘˜å¯¹æ¶ˆè´¹ä½ç§»çš„ç®¡ç†æ§åˆ¶æ›´åŠ çµæ´»ã€‚

å¾ˆå¤šæ—¶å€™å¹¶ä¸æ˜¯è¯´æ‹‰å–åˆ°æ¶ˆæ¯å°±ç®—æ¶ˆè´¹å®Œæˆï¼Œè€Œæ˜¯éœ€è¦å°†æ¶ˆæ¯å†™å…¥æ•°æ®åº“ã€å†™å…¥æœ¬åœ°ç¼“å­˜ï¼Œæˆ–è€…æ˜¯æ›´åŠ å¤æ‚çš„ä¸šåŠ¡å¤„ç†ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡å¤„ç†å®Œæˆæ‰èƒ½è®¤ä¸ºæ¶ˆæ¯è¢«æˆåŠŸæ¶ˆè´¹ï¼›

æ‰‹åŠ¨çš„æäº¤æ–¹å¼å¯ä»¥è®©å¼€å‘äººå‘˜æ ¹æ®ç¨‹åºçš„é€»è¾‘åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œä½ç§»æäº¤ã€‚å¼€å¯æ‰‹åŠ¨æäº¤åŠŸèƒ½çš„å‰ææ˜¯æ¶ˆè´¹è€…å®¢æˆ·ç«¯å‚æ•° enable.auto.commit é…ç½®ä¸ºfalse ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
props.put(ConsumerConf.ENABLE_AUTO_COMMIT_CONFIG, false); 
```

æ‰‹åŠ¨æäº¤å¯ä»¥ç»†åˆ†ä¸ºåŒæ­¥æäº¤å’Œå¼‚æ­¥æäº¤ï¼Œå¯¹åº”äº KafkaConsumer ä¸­çš„ commitSync()å’Œ

commitAsync()ä¸¤ç§ç±»å‹çš„æ–¹æ³•ã€‚

commitSync()æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
/**
 * æ‰‹åŠ¨æäº¤offset
 */
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    for (ConsumerRecord<String, String> r : records) {
        //do something to process record.
    }
    consumer.commitSync();
}
```

å¯¹äºé‡‡ç”¨ commitSync()çš„æ— å‚æ–¹æ³•ï¼Œå®ƒæäº¤æ¶ˆè´¹ä½ç§»çš„é¢‘ç‡å’Œæ‹‰å–æ‰¹æ¬¡æ¶ˆæ¯ã€å¤„ç†æ‰¹æ¬¡æ¶ˆæ¯çš„é¢‘ç‡æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæƒ³å¯»æ±‚æ›´ç»†ç²’åº¦çš„ã€æ›´ç²¾å‡†çš„æäº¤ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨commitSync()çš„å¦ä¸€ä¸ªæœ‰å‚æ–¹æ³•ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```java
public void commitSync(final Map<TopicPartitionï¼ŒOffsetAndMetadata> offsets)
```

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    for (ConsumerRecord<String, String> r : records) {
        long offset = r.offset();
        //do something to process record.

        TopicPartition topicPartition = new TopicPartition(r.topic(), r.partition());
        consumer.commitSync(Collections.singletonMap(topicPartition,new OffsetAndMetadata(offset+1)));
    }
}
```

> æäº¤çš„åç§»é‡  =  æ¶ˆè´¹å®Œçš„recordçš„åç§»é‡  +  1
>
> å› ä¸ºï¼Œ\_\_consumer\_offsetsä¸­è®°å½•çš„æ¶ˆè´¹åç§»é‡ï¼Œä»£è¡¨çš„æ˜¯ï¼Œæ¶ˆè´¹è€…ä¸‹ä¸€æ¬¡è¦è¯»å–çš„ä½ç½®ï¼ï¼ï¼

* **å¼‚æ­¥æäº¤æ–¹å¼**

å¼‚æ­¥æäº¤çš„æ–¹å¼ï¼ˆ commitAsyncï¼ˆï¼‰ï¼‰åœ¨æ‰§è¡Œçš„æ—¶å€™æ¶ˆè´¹è€…çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼›å¯èƒ½åœ¨æäº¤æ¶ˆè´¹ä½ç§»çš„ç»“æœè¿˜æœªè¿”å›ä¹‹å‰å°±å¼€å§‹äº†æ–°ä¸€æ¬¡çš„æ‹‰å–ã€‚å¼‚æ­¥æäº¤å¯ä»¥è®©æ¶ˆè´¹è€…çš„æ€§èƒ½å¾—åˆ°ä¸€å®šçš„å¢å¼ºã€‚ commitAsyncæ–¹æ³•æœ‰ä¸€ä¸ªä¸åŒçš„é‡è½½æ–¹æ³•ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹

![](images/image-9.png)

```java
/**
 * å¼‚æ­¥æäº¤offset
 */
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    for (ConsumerRecord<String, String> r : records) {
        long offset = r.offset();

        //do something to process record.
        TopicPartition topicPartition = new TopicPartition(r.topic(), r.partition());
        consumer.commitSync(Collections.singletonMap(topicPartition,new OffsetAndMetadata(offset+1)));
        consumer.commitAsync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(offset + 1)), new OffsetCommitCallback() {
     @Override
     public void onComplete(Map<TopicPartition, OffsetAndMetadata> map, Exception e) {
                if(e == null ){
                    System.out.println(map);
                }else{
                    System.out.println("error commit offset");
                }
            }
        });
    }
}
```

### **4.2.9æ‰‹åŠ¨æäº¤ä½ç§»ï¼ˆæ—¶æœºçš„é€‰æ‹©ï¼‰**

* æ•°æ®å¤„ç†å®Œæˆä¹‹å‰å…ˆæäº¤åç§»é‡

å¯èƒ½ä¼šå‘ç”Ÿ**æ¼å¤„ç†**çš„ç°è±¡ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰åè¿‡æ¥è¯´ï¼Œè¿™ç§æ–¹å¼å®ç°äº†ï¼š **at most once**çš„æ•°æ®å¤„ç†ï¼ˆä¼ é€’ï¼‰è¯­ä¹‰

* æ•°æ®å¤„ç†å®Œæˆä¹‹åå†æäº¤åç§»é‡

å¯èƒ½ä¼šå‘ç”Ÿ**é‡å¤å¤„ç†**çš„ç°è±¡ï¼ˆæ•°æ®é‡å¤ï¼‰åè¿‡æ¥è¯´ï¼Œè¿™ç§æ–¹å¼å®ç°äº†ï¼š **at least once**çš„æ•°æ®å¤„ç†ï¼ˆä¼ é€’ï¼‰è¯­ä¹‰å½“ç„¶ï¼Œæ•°æ®å¤„ç†ï¼ˆä¼ é€’ï¼‰çš„ç†æƒ³è¯­ä¹‰æ˜¯ï¼š exactly onceï¼ˆç²¾ç¡®ä¸€æ¬¡ï¼‰Kafkaä¹Ÿèƒ½åšåˆ°exactly onceï¼ˆåŸºäºkafkaçš„äº‹åŠ¡æœºåˆ¶ï¼‰

ä»£ç ç¤ºä¾‹ï¼š

```java
package com.doitedu;

import org.apache.kafka.clients.consumer.*;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.sql.*;
import java.time.Duration;
import java.util.Arrays;
import java.util.Collection;
import java.util.Properties;

public class CommitOffsetByMyself {
    public static void main(String[] args) throws SQLException {

        //è·å–mysqlçš„è¿æ¥å¯¹è±¡
        Connection connection = DriverManager.getConnection("jdbc:mysql://localhost:3306/football", "root", "123456");
        connection.setAutoCommit(false);
        PreparedStatement pps = connection.prepareStatement("insert into user values (?,?,?)");
        PreparedStatement pps_offset = connection.prepareStatement("insert into offset values (?,?) on duplicate key update offset = ?");

        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "linux01:9092,linux02:9092,linux03:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        //è®¾ç½®æ‰‹åŠ¨æäº¤åç§»é‡å‚æ•°ï¼Œéœ€è¦å°†è‡ªåŠ¨æäº¤ç»™å…³æ‰
        props.setProperty(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, "false");
        //è®¾ç½®ä»å“ªé‡Œå¼€å§‹æ¶ˆè´¹
//        props.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "latest");
        //è®¾ç½®ç»„id
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG, "group001");

        KafkaConsumer<String, String> consumer = new KafkaConsumer<String, String>(props);
        //è®¢é˜…ä¸»é¢˜
        consumer.subscribe(Arrays.asList("kafka2mysql"), new ConsumerRebalanceListener() {
            @Override
            public void onPartitionsRevoked(Collection<TopicPartition> collection) {

            }

            @Override
            public void onPartitionsAssigned(Collection<TopicPartition> collection) {
                for (TopicPartition topicPartition : collection) {
                    try {
                        PreparedStatement get_offset = connection.prepareStatement("select offset from offset where topic_partition = ?");
                        String topic = topicPartition.topic();
                        int partition = topicPartition.partition();
                        get_offset.setString(1, topic + "_" + partition);
                        ResultSet resultSet = get_offset.executeQuery();
                        if (resultSet.next()){
                            int offset = resultSet.getInt(1);
                            System.out.println("å‘ç”Ÿäº†å†å‡è¡¡ï¼Œè¢«åˆ†é…äº†åˆ†åŒºæ¶ˆè´¹æƒï¼Œå¹¶ä¸”æŸ¥åˆ°äº†ç›®æ ‡åˆ†åŒºçš„åç§»é‡"+partition+" , "+offset);
                            //æ‹¿åˆ°äº†offsetåå°±å¯ä»¥å®šä½æ¶ˆè´¹äº†
                            consumer.seek(new TopicPartition(topic, partition), offset);
                        }
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                }
            }
        });

        //æ‹‰å»æ•°æ®åå†™å…¥åˆ°mysql
        while (true) {
            try {
                ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
                for (ConsumerRecord<String, String> record : records) {
                    String data = record.value();
                    String[] arr = data.split(",");
                    String id = arr[0];
                    String name = arr[1];
                    String age = arr[2];

                    pps.setInt(1, Integer.parseInt(id));
                    pps.setString(2, name);
                    pps.setInt(3, Integer.parseInt(age));
                    pps.execute();

                    //åŸ‹ä¸ªå¼‚å¸¸ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯çœŸçš„æ˜¯è¿™æ ·
//                    if (Integer.parseInt(id) == 5) {
//                        throw new SQLException();
//                    }

                    long offset = record.offset();
                    int partition = record.partition();
                    String topic = record.topic();
                    pps_offset.setString(1, topic + "_" + partition);
                    pps_offset.setInt(2, (int) offset + 1);
                    pps_offset.setInt(3, (int) offset + 1);
                    pps_offset.execute();
                    //æäº¤jdbcäº‹åŠ¡
                    connection.commit();
                }
            } catch (Exception e) {
                connection.rollback();
            }
        }
    }
}
```

### **4.2.10æ¶ˆè´¹è€…æäº¤åç§»é‡æ–¹å¼çš„æ€»ç»“**

consumerçš„æ¶ˆè´¹ä½ç§»æäº¤æ–¹å¼ï¼š

* å…¨è‡ªåŠ¨ &#x20;

  1. auto.offset.commit = true&#x20;

  2. å®šæ—¶æäº¤åˆ°consumer\_offsets

* åŠè‡ªåŠ¨ &#x20;

  1. auto.offset.commit = false;  &#x20;

  2. ç„¶åæ‰‹åŠ¨è§¦å‘æäº¤ consumer.commitSync()ï¼›&#x20;

  3. æäº¤åˆ°consumer\_offsets

* å…¨æ‰‹åŠ¨ &#x20;

  1. auto.offset.commit = false;  &#x20;

  2. å†™è‡ªå·±çš„ä»£ç å»æŠŠæ¶ˆè´¹ä½ç§»ä¿å­˜åˆ°ä½ è‡ªå·±çš„åœ°æ–¹mysql/zk/redis/

  3. æäº¤åˆ°è‡ªå·±æ‰€æ¶‰åŠçš„å­˜å‚¨ï¼›åˆå§‹åŒ–æ—¶ä¹Ÿéœ€è¦è‡ªå·±å»ä»è‡ªå®šä¹‰å­˜å‚¨ä¸­æŸ¥è¯¢åˆ°æ¶ˆè´¹ä½ç§»

### **4.2.11ä¸€äº›ç›¸å¯¹é‡è¦å‚æ•°ï¼ˆäº†è§£ï¼‰**

```java
fetch.min.bytes=1B   // ä¸€æ¬¡æ‹‰å–çš„æœ€å°å­—èŠ‚æ•°

fetch.max.bytes=50M  //ä¸€æ¬¡æ‹‰å–çš„æœ€å¤§æ•°æ®é‡
 
fetch.max.wait.ms=500ms  //æ‹‰å–æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é•¿
 
max.partition.fetch.bytes = 1MB  //æ¯ä¸ªåˆ†åŒºä¸€æ¬¡æ‹‰å–çš„æœ€å¤§æ•°æ®é‡
 
max.poll.records=500 //ä¸€æ¬¡æ‹‰å–çš„æœ€å¤§æ¡æ•°
 
connections.max.idle.ms=540000ms //ç½‘ç»œè¿æ¥çš„æœ€å¤§é—²ç½®æ—¶é•¿
 
request.timeout.ms=30000ms  //ä¸€æ¬¡è¯·æ±‚ç­‰å¾…å“åº”çš„æœ€å¤§è¶…æ—¶æ—¶é—´
 
metadata.max.age.ms=300000ms  //å…ƒæ•°æ®åœ¨é™å®šæ—¶é—´å†…æ²¡æœ‰è¿›è¡Œæ›´æ–°ï¼Œåˆ™ä¼šè¢«å¼ºåˆ¶æ›´æ–°
 
reconnect.backoff.ms=50ms  //å°è¯•é‡æ–°è¿æ¥æŒ‡å®šä¸»æœºä¹‹å‰çš„é€€é¿æ—¶é—´  ==ã€‹ TODO
 
retry.backoff.ms=100ms  //å°è¯•é‡æ–°æ‹‰å–æ•°æ®çš„é‡è¯•é—´éš”
 
 //äº‹åŠ¡çš„æ—¶å€™ä¼šå‡ºç°è¿™ä¸ª   è¯»æœªæäº¤  è¯»å·²æäº¤ 
isolation.level=read_uncommitted  //éš”ç¦»çº§åˆ«ï¼ å†³å®šæ¶ˆè´¹è€…èƒ½è¯»åˆ°ä»€ä¹ˆæ ·çš„æ•°æ®

read_uncommittedï¼š  //å¯ä»¥æ¶ˆè´¹åˆ°LSOï¼ˆLastStableOffsetï¼‰ä½ç½®ï¼›
read_committedï¼š  //å¯ä»¥æ¶ˆè´¹åˆ°HWï¼ˆHigh Watermarkï¼‰ä½ç½®
 
max.poll.interval.ms  //è¶…è¿‡æ—¶é™æ²¡æœ‰å‘èµ·pollæ“ä½œï¼Œåˆ™æ¶ˆè´¹ç»„è®¤ä¸ºè¯¥æ¶ˆè´¹è€…å·²ç¦»å¼€æ¶ˆè´¹ç»„
 
enable.auto.commit=true  //å¼€å¯æ¶ˆè´¹ä½ç§»çš„è‡ªåŠ¨æäº¤

auto.offset.reset = latest
 
auto.commit.interval.ms=5000  //è‡ªåŠ¨æäº¤æ¶ˆè´¹ä½ç§»çš„æ—¶é—´é—´éš”
```

## 4.2.12ç»ƒä¸€ç»ƒ

> éœ€æ±‚ï¼šå†™ä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸æ–­çš„å»ç”Ÿäº§ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œå†™å…¥åˆ°kafkaçš„ä¸€ä¸ªtopicä¸­
>
> ç”Ÿäº§çš„æ•°æ®æ ¼å¼ï¼š  é€ æ•°æ®
>
> {"guid":1,"eventId":"pageview","timestamp":1637868346789}  isNew = 1
>
> {"guid":1,"eventId":"addcard","timestamp":1637868347625}   isNew = 0
>
> {"guid":2,"eventId":"collect","timestamp":16378683463219}
>
> {"guid":3,"eventId":"paid","timestamp":16378683467829}
>
> ......
>
> å†å†™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸æ–­çš„ä»kafkaä¸­æ¶ˆè´¹ä¸Šé¢çš„ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œåšä¸€ä¸ªç»Ÿè®¡
>
> 1.æ¯5sè¾“å‡ºä¸€æ¬¡å½“å‰æ¥äº†å¤šå°‘ç”¨æˆ·(å»é‡)  uv &#x20;
>
> 2.å°†æ¯æ¡æ•°æ®æ·»åŠ ä¸€ä¸ªå­—æ®µæ¥æ ‡è¯†ï¼Œå¦‚æœè¿™ä¸ªç”¨æˆ·çš„idæ˜¯ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œé‚£ä¹ˆå°±æ ‡æ³¨1ï¼Œå¦åˆ™å°±æ˜¯0

ä¾èµ–:

```xml
<dependencies>
    <dependency>
        <groupId>org.apache.kafka</groupId>
        <artifactId>kafka-clients</artifactId>
        <version>${kafka.version}</version>
    </dependency>

    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.75</version>
    </dependency>

    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
        <version>3.8.1</version>
    </dependency>


    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.22</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.roaringbitmap/RoaringBitmap -->
    <dependency>
        <groupId>org.roaringbitmap</groupId>
        <artifactId>RoaringBitmap</artifactId>
        <version>0.9.0</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/com.google.guava/guava -->
    <dependency>
        <groupId>com.google.guava</groupId>
        <artifactId>guava</artifactId>
        <version>31.1-jre</version>
    </dependency>

    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.28</version>
    </dependency>
```

ç”Ÿäº§è€…ä»£ç ç¤ºä¾‹ï¼š

```java
package com.doitedu;

import com.alibaba.fastjson.JSON;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import org.apache.commons.lang3.RandomStringUtils;
import org.apache.commons.lang3.RandomUtils;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.serialization.StringSerializer;

import java.util.Properties;

/**
 * éªŒè¯æ•°æ®ï¼š
 * åˆ›å»ºtopic
 * kafka-topics.sh --create --topic event-log --zookeeper linux01:2181 --partitions 3 --replication-factor 3
 * æä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®
 * kafka-console-consumer.sh  --bootstrap-server linux01:9092 --topic event-log
 * {"eventId":"zTUAbXcWbn","guid":7170,"timeStamp":1659944455262}
 * {"eventId":"KSzaaNmczb","guid":9743,"timeStamp":1659944455823}
 * {"eventId":"FNUERLlCNu","guid":7922,"timeStamp":1659944456295}
 * {"eventId":"VmXVJHlpOF","guid":2505,"timeStamp":1659944458267}
 * {"eventId":"pMIHwLzSIE","guid":7668,"timeStamp":1659944460088}
 * {"eventId":"ZvGYIvmKTx","guid":3636,"timeStamp":1659944460461}
 * {"eventId":"jBanTDSlCO","guid":3468,"timeStamp":1659944460787}
 * {"eventId":"vXregpYeHu","guid":1107,"timeStamp":1659944462525}
 * {"eventId":"PComosCafr","guid":7765,"timeStamp":1659944463640}
 * {"eventId":"xCHFOYIJlb","guid":3443,"timeStamp":1659944464697}
 * {"eventId":"xDToApWwFo","guid":5034,"timeStamp":1659944465953}
 */
public class Exercise_kafkaç¼–ç¨‹ç»ƒä¹  {
    public static void main(String[] args) throws InterruptedException {
        MyData myData = new MyData();
        myData.genData();
    }
}

class MyData{
    KafkaProducer<String, String> producer = null;
    public MyData(){
        Properties props = new Properties();
        props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092,linux02:9092,linux03:9092");
        props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        producer = new KafkaProducer<String, String>(props);
    }
    
    public void genData() throws InterruptedException {
        UserEvent userEvent = new UserEvent();
        while (true){
            //é€ æ•°æ®
            userEvent.setGuid(RandomUtils.nextInt(0,10000));
            userEvent.setEventId(RandomStringUtils.randomAlphabetic(10));
            userEvent.setTimeStamp(System.currentTimeMillis());
            String json = JSON.toJSONString(userEvent);
            //æ•°æ®é€ å®Œäº†å°±å¾€kafkaä¸­å†™
            ProducerRecord<String, String> stringProducerRecord = new ProducerRecord<>("event-log", json);
            Thread.sleep(RandomUtils.nextInt(200,1000));
            producer.send(stringProducerRecord);
        }
    }
}
/*
{"guid":1,"eventId":"pageview","timestamp":1637868346789}
{"guid":1,"eventId":"addcard","timestamp":1637868347625}
{"guid":2,"eventId":"collect","timestamp":16378683463219}
 */
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Setter
class UserEvent{
    private Integer guid;
    private String eventId;
    private long timeStamp;
}
```

æ¶ˆè´¹è€…ä»£ç ç¤ºä¾‹ï¼šç”¨hashsetæ¥å®ç°ï¼š

```java
package com.doitedu;

import com.alibaba.fastjson.JSON;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.*;

/**
 * åˆ†ä¸¤æ­¥èµ°ï¼š
 * ç¬¬ä¸€æ­¥ï¼šä¸€ä¸ªæ¶ˆè´¹è€…ä¸æ–­çš„å»æ¶ˆè´¹æ•°æ®
 * ç¬¬äºŒæ­¥ï¼š5åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡ï¼Œè¿”å›ç”¨æˆ·æ•°è¿™ä¸ªç»“æœ
 */
public class Exercise_consumerDemo {
    public static void main(String[] args) {
        HashSet<Integer> set = new HashSet<>();
        new Thread(new ConsumerThread(set)).start();
        //å®šæ—¶çš„ä»»åŠ¡è°ƒåº¦
        Timer timer = new Timer();
        //è°ƒåº¦ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä½ ç»™æˆ‘ä¸€ä¸ªä»»åŠ¡ï¼Œ
        //ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨è¿‡å¤šä¹…ä¹‹åæˆ‘å¼€å§‹æ‰§è¡Œä»»åŠ¡
        //ç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨æ¯éš”å¤šä¹…æ‰§è¡Œä¸€æ¬¡
        timer.schedule(new ConsumerTask(set),5000,10000);

    }
}

class ConsumerThread implements Runnable {
    HashSet<Integer> set = null;
    KafkaConsumer<String, String> consumer = null;

    public ConsumerThread(HashSet<Integer> set) {
        this.set = set;
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "linux01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG, "test001");

        consumer = new KafkaConsumer<String, String>(props);
        consumer.subscribe(Arrays.asList("event-log"));
    }
    /**
     * é‡å†™runæ–¹æ³•çš„è¯ï¼Œæˆ‘éœ€è¦åœ¨é‡Œé¢å®ç°ä»€ä¹ˆé€»è¾‘ï¼Ÿ
     * æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®ä»¥åï¼Œåªéœ€è¦è·å–åˆ°ç”¨æˆ·id
     * å°†ç”¨æˆ·idå†™åˆ°hashseté›†åˆé‡Œé¢
     */
    @Override
    public void run() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                String json = record.value();
                UserEvent userEvent = JSON.parseObject(json, UserEvent.class);
                Integer guid = userEvent.getGuid();
                set.add(guid);
            }
        }
    }
}

class ConsumerTask extends TimerTask {
    HashSet<Integer> set = null;

    public ConsumerTask(HashSet<Integer> set) {
        this.set = set;
    }
    /**
     * è¿™é‡Œé¢å°±æ˜¯è¿”å›çš„ä¸€ä¸ªç”¨æˆ·æ•°
     */
    @Override
    public void run() {
        int userCount = set.size();
        System.out.println(System.currentTimeMillis() + ",æˆªè‡³åˆ°å½“å‰ä¸ºæ­¢çš„ä¸€ä¸ªç”¨æˆ·æ•°ä¸ºï¼š"+userCount);
    }
}
```

ç”¨hashsetæ¥å®ç°å¾ˆæ˜¾ç„¶ä¼šå‡ºé—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡ä¸€ç›´å¾€ä¸Šå¢é•¿ï¼Œä¼šå‡ºç°oomçš„é—®é¢˜ï¼Œè€Œä¸”å ç”¨èµ„æºè¶Šæ¥è¶Šå¤šï¼Œå½±å“ç”µè„‘æ€§èƒ½ï¼ï¼ï¼

æ–¹æ¡ˆäºŒï¼šå°†HashSetæ”¹æˆbitMapæ¥è®¡æ•°ï¼Œå°±å¾ˆå®Œç¾ï¼Œå¤§é€»è¾‘ä¸å˜ï¼Œå°é€»è¾‘å°±æ˜¯å°†HashMapæ”¹æˆbitMap

```java
package com.doitedu;

import com.alibaba.fastjson.JSON;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.serialization.StringDeserializer;
import org.roaringbitmap.RoaringBitmap;

import java.time.Duration;
import java.util.*;

/**
 * åˆ†ä¸¤æ­¥èµ°ï¼š
 * ç¬¬ä¸€æ­¥ï¼šä¸€ä¸ªæ¶ˆè´¹è€…ä¸æ–­çš„å»æ¶ˆè´¹æ•°æ®
 * ç¬¬äºŒæ­¥ï¼š5åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡ï¼Œè¿”å›ç”¨æˆ·æ•°è¿™ä¸ªç»“æœ
 */
public class BitMap_consumerDemo {
    public static void main(String[] args) {
        //åŸæ¥æˆ‘ç”¨çš„æ˜¯Hashsetæ¥è®°å½•ï¼Œç°åœ¨æˆ‘ç”¨RoaringBitmapæ¥è®°å½•
        RoaringBitmap bitMap = RoaringBitmap.bitmapOf();

        new Thread(new BitMapConsumerThread(bitMap)).start();
        //å®šæ—¶çš„ä»»åŠ¡è°ƒåº¦
        Timer timer = new Timer();
        timer.schedule(new BitMapConsumerTask(bitMap),1000,5000);

    }
}

class BitMapConsumerThread implements Runnable {
    RoaringBitmap bitMap = null;
    KafkaConsumer<String, String> consumer = null;

    public BitMapConsumerThread(RoaringBitmap bitMap) {
        this.bitMap = bitMap;
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "linux01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG, "test001");

        consumer = new KafkaConsumer<String, String>(props);
        consumer.subscribe(Arrays.asList("event-log"));
    }
    /**
     * é‡å†™runæ–¹æ³•çš„è¯ï¼Œæˆ‘éœ€è¦åœ¨é‡Œé¢å®ç°ä»€ä¹ˆé€»è¾‘ï¼Ÿ
     * æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®ä»¥åï¼Œåªéœ€è¦è·å–åˆ°ç”¨æˆ·id
     * å°†ç”¨æˆ·idå†™åˆ°hashseté›†åˆé‡Œé¢
     */
    @Override
    public void run() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                String json = record.value();
                UserEvent userEvent = JSON.parseObject(json, UserEvent.class);
                Integer guid = userEvent.getGuid();
                bitMap.add(guid);
            }
        }
    }
}


class BitMapConsumerTask extends TimerTask {
    RoaringBitmap bitMap = null;

    public BitMapConsumerTask(RoaringBitmap bitMap) {
        this.bitMap = bitMap;
    }
    /**
     * è¿™é‡Œé¢å°±æ˜¯è¿”å›çš„ä¸€ä¸ªç”¨æˆ·æ•°
     */
    @Override
    public void run() {
        int userCount = bitMap.getCardinality();
        System.out.println(System.currentTimeMillis() + ",æˆªè‡³åˆ°å½“å‰ä¸ºæ­¢çš„ä¸€ä¸ªç”¨æˆ·æ•°ä¸ºï¼š"+userCount);
    }
}
```

éœ€æ±‚äºŒï¼šåˆ¤æ–­æ¥æ²¡æ¥è¿‡çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨bitmapæ¥æï¼Œå½“ç„¶è¿˜å¯ä»¥ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥æ

```java
package com.doitedu;

import com.alibaba.fastjson.JSON;
import com.google.common.hash.BloomFilter;
import com.google.common.hash.Funnels;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.Arrays;
import java.util.Properties;
import java.util.Timer;
import java.util.TimerTask;

/**
 * ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥åˆ¤å®šæ˜¯å¦é‡å¤ï¼Œå½“ç„¶ï¼ŒbitMapä¹Ÿæ˜¯å¯ä»¥æ“ä½œçš„
 */
public class BloomFilter_consumerDemo {
    public static void main(String[] args) {

        BloomFilter<Long> longBloomFilter = BloomFilter.create(Funnels.longFunnel(), 100000);

        new Thread(new BloomFilterConsumerThread(longBloomFilter)).start();
    }
}

class BloomFilterConsumerThread implements Runnable {
    BloomFilter<Long> longBloomFilter = null;
    KafkaConsumer<String, String> consumer = null;

    public BloomFilterConsumerThread(BloomFilter<Long> longBloomFilter) {
        this.longBloomFilter = longBloomFilter;
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "linux01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG, "test001");
        consumer = new KafkaConsumer<String, String>(props);
        consumer.subscribe(Arrays.asList("event-log"));
    }

    /**
     * é‡å†™runæ–¹æ³•çš„è¯ï¼Œæˆ‘éœ€è¦åœ¨é‡Œé¢å®ç°ä»€ä¹ˆé€»è¾‘ï¼Ÿ
     * æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®ä»¥åï¼Œåªéœ€è¦è·å–åˆ°ç”¨æˆ·id
     * å°†ç”¨æˆ·idå†™åˆ°hashseté›†åˆé‡Œé¢
     */
    @Override
    public void run() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                String json = record.value();
                UserEvent userEvent = JSON.parseObject(json, UserEvent.class);
                Integer guid = userEvent.getGuid();
                boolean flag = longBloomFilter.mightContain((long) guid);
                if (flag) {
                    userEvent.setIsNew(0);
                } else {
                    userEvent.setIsNew(1);
                }
                //åˆ¤æ–­å®Œæˆä»¥åï¼Œå¾—æŠŠä»–åŠ è¿›å»
                longBloomFilter.put((long) guid);
                System.out.println(JSON.toJSONString(userEvent));
            }
        }
    }
}
```

# 5.**kafkaç³»ç»Ÿçš„æ¶æ„(åŸºç¡€é‡ç‚¹)**

![](images/image-10.png)

## **5.1ä¸»é¢˜topicå’Œåˆ†åŒºpartition**

* topic

Kafkaä¸­å­˜å‚¨æ•°æ®çš„é€»è¾‘åˆ†ç±»ï¼›**ä½ å¯ä»¥ç†è§£ä¸ºæ•°æ®åº“ä¸­â€œè¡¨â€çš„æ¦‚å¿µï¼›**

æ¯”å¦‚ï¼Œå°†appç«¯æ—¥å¿—ã€å¾®ä¿¡å°ç¨‹åºç«¯æ—¥å¿—ã€ä¸šåŠ¡åº“è®¢å•è¡¨æ•°æ®åˆ†åˆ«æ”¾å…¥ä¸åŒçš„topic

* partitionåˆ†åŒºï¼ˆæå‡kafkaååé‡ï¼‰

topicä¸­æ•°æ®çš„å…·ä½“ç®¡ç†å•å…ƒï¼›**ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºhbaseä¸­è¡¨çš„â€œregion"æ¦‚å¿µï¼‰**

\- æ¯ä¸ªpartitionç”±ä¸€ä¸ªkafka brokeræœåŠ¡å™¨ç®¡ç†ï¼›

\- æ¯ä¸ªtopic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ªpartitionï¼Œåˆ†å¸ƒåˆ°å¤šä¸ªbrokerä¸Šç®¡ç†ï¼›

\- æ¯ä¸ªpartitionéƒ½å¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼›ä¿è¯æ•°æ®å®‰å…¨

> åˆ†åŒºå¯¹äº kafka é›†ç¾¤çš„å¥½å¤„æ˜¯ï¼šå®ç°topicæ•°æ®çš„è´Ÿè½½å‡è¡¡ã€‚æé«˜å†™å…¥ã€è¯»å‡ºçš„å¹¶å‘åº¦ï¼Œæé«˜ååé‡ã€‚

* åˆ†åŒºå‰¯æœ¬replica

æ¯ä¸ªtopicçš„**æ¯ä¸ªpartitionéƒ½å¯ä»¥é…ç½®å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ï¼Œä»¥æé«˜æ•°æ®çš„å¯é æ€§**ï¼›

æ¯ä¸ªpartitionçš„æ‰€æœ‰å‰¯æœ¬ä¸­ï¼Œå¿…æœ‰ä¸€ä¸ªleaderå‰¯æœ¬ï¼Œå…¶ä»–çš„å°±æ˜¯followerå‰¯æœ¬ï¼ˆobserverå‰¯æœ¬ï¼‰ï¼›**followerå®šæœŸæ‰¾leaderåŒæ­¥æœ€æ–°çš„æ•°æ®ï¼›å¯¹å¤–æä¾›æœåŠ¡åªæœ‰leaderï¼›**

* åˆ†åŒºfollower &#x20;

partition replicaä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œå®ƒé€šè¿‡å¿ƒè·³é€šä¿¡ä¸æ–­ä»leaderä¸­æ‹‰å–ã€å¤åˆ¶æ•°æ®ï¼ˆ**åªè´Ÿè´£å¤‡ä»½**ï¼‰ã€‚

å¦‚æœleaderæ‰€åœ¨èŠ‚ç‚¹å®•æœºï¼Œfollowerä¸­ä¼šé€‰ä¸¾å‡ºæ–°çš„leaderï¼›

* æ¶ˆæ¯åç§»é‡offset

partitionå†…éƒ¨æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªé€’å¢idï¼ˆoffsetï¼‰ï¼›é€šè¿‡offsetå¯ä»¥å¿«é€Ÿå®šä½åˆ°æ¶ˆæ¯çš„å­˜å‚¨ä½ç½®ï¼›

kafka åªä¿è¯æŒ‰ä¸€ä¸ªpartitionä¸­çš„æ¶ˆæ¯çš„é¡ºåºï¼Œä¸ä¿è¯ä¸€ä¸ª topicçš„æ•´ä½“ï¼ˆå¤šä¸ªpartition é—´ï¼‰çš„é¡ºåºã€‚

æˆ‘ä»¬åœ¨è¯´åˆ°åç§»é‡çš„æ—¶å€™ï¼Œæ˜¯å“ªä¸€ä¸ªtopicçš„å“ªä¸€ä¸ªåˆ†åŒºçš„å“ªä¸€ä¸ªï¼Œåç§»é‡ä»–çš„æ•°æ®åªèƒ½è¿½åŠ ï¼Œä¸èƒ½è¢«ä¿®æ”¹

![](images/image-16.png)

è‡ªæˆ‘æ¨å¯¼è®¾è®¡ï¼š

* kafkaæ˜¯ç”¨æ¥å­˜æ•°æ®çš„ï¼›

* ç°å®ä¸–ç•Œæ•°æ®æœ‰åˆ†ç±»ï¼Œæ‰€ä»¥å­˜å‚¨ç³»ç»Ÿä¹Ÿåº”æœ‰æ•°æ®åˆ†ç±»ç®¡ç†åŠŸèƒ½ï¼Œå¦‚mysqlçš„è¡¨ï¼›kafkaæœ‰topicï¼›

* å¦‚ä¸€ä¸ªtopicçš„æ•°æ®å…¨éƒ¨äº¤ç»™ä¸€å°serverå­˜å‚¨å’Œç®¡ç†ï¼Œåˆ™è¯»å†™ååé‡æœ‰é™ï¼›

* æ‰€ä»¥ï¼Œä¸€ä¸ªtopicçš„æ•°æ®åº”è¯¥å¯ä»¥åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼ˆpartitionï¼‰åˆ†åˆ«äº¤ç»™å¤šå°serverå­˜å‚¨å’Œç®¡ç†ï¼›

* å¦‚ä¸€å°serverå®•æœºï¼Œè¿™å°serverè´Ÿè´£çš„partitionå°†ä¸å¯ç”¨ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªpartitionåº”æœ‰å¤šä¸ªå‰¯æœ¬ï¼›

* ä¸€ä¸ªpartitionæœ‰å¤šä¸ªå‰¯æœ¬ï¼Œåˆ™å‰¯æœ¬é—´çš„æ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿è¯ï¼Œå› æ­¤è¦æœ‰ä¸€ä¸ªleaderç»Ÿé¢†è¯»å†™ï¼›

* ä¸€ä¸ªleaderä¸‡ä¸€æŒ‚æ‰ï¼Œåˆ™è¯¥partitionåˆä¸å¯ç”¨ï¼Œå› æ­¤è¿˜è¦æœ‰leaderçš„åŠ¨æ€é€‰ä¸¾æœºåˆ¶ï¼›

* é›†ç¾¤æœ‰å“ªäº›topicï¼Œtopicæœ‰å“ªå‡ ä¸ªåˆ†åŒºï¼Œserveråœ¨çº¿æƒ…å†µï¼Œç­‰ç­‰å…ƒä¿¡æ¯å’ŒçŠ¶æ€ä¿¡æ¯éœ€è¦åœ¨é›†ç¾¤å†…éƒ¨åŠå®¢æˆ·ç«¯ä¹‹é—´å…±äº«ï¼Œåˆ™å¼•å…¥äº†zookeeperï¼›

* å®¢æˆ·ç«¯åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¾€å¾€éœ€è¦çŸ¥é“è‡ªå·±æ‰€è¯»å–åˆ°çš„ä½ç½®ï¼Œå› è€Œè¦å¼•å…¥æ¶ˆæ¯åç§»é‡ç»´æŠ¤æœºåˆ¶ï¼›

brokeræœåŠ¡å™¨ï¼šä¸€å° kafkaæœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ªbrokerã€‚ä¸€ä¸ªkafkaé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚

ç”Ÿäº§è€…producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘kafka brokerå‘æ¶ˆæ¯çš„å®¢æˆ·ç«¯ã€‚

æ¶ˆè´¹è€…consumer

* consumer ï¼šæ¶ˆè´¹è€…ï¼Œä»kafka broker å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯ã€‚

* consumer groupï¼šæ¶ˆè´¹ç»„ï¼Œå•ä¸ªæˆ–å¤šä¸ªconsumerå¯ä»¥ç»„æˆä¸€ä¸ªæ¶ˆè´¹ç»„ï¼›

æ¶ˆè´¹ç»„æ˜¯ç”¨æ¥å®ç°æ¶ˆæ¯çš„å¹¿æ’­ï¼ˆå‘ç»™æ‰€æœ‰çš„ consumerï¼‰å’Œå•æ’­ï¼ˆå‘ç»™ä»»æ„ä¸€ä¸ª consumerï¼‰çš„æ‰‹æ®µï¼›

![](images/image-15.png)

> æ¶ˆè´¹è€…å¯ä»¥å¯¹æ¶ˆè´¹åˆ°çš„æ¶ˆæ¯ä½ç½®ï¼ˆæ¶ˆæ¯åç§»é‡ï¼‰è¿›è¡Œè®°å½•ï¼›
>
> è€ç‰ˆæœ¬æ˜¯è®°å½•åœ¨zookeeperä¸­ï¼›æ–°ç‰ˆæœ¬æ˜¯è®°å½•åœ¨kafkaä¸­ä¸€ä¸ªå†…ç½®çš„topicä¸­ï¼ˆ\_\_consumer\_offsets)

## 5.2**kafkaçš„æ•°æ®å­˜å‚¨ç»“æ„**

### 5.2.1**kafkaçš„æ•´ä½“å­˜å‚¨ç»“æ„**

![](images/image-18.png)

ç‰©ç†å­˜å‚¨ç›®å½•ç»“æ„         \_\_consumer\_offset   Â·

å­˜å‚¨ç›®å½• åç§°è§„èŒƒï¼š  **topicåç§°-åˆ†åŒºå·**

![](images/image-13.png)

> æ³¨ï¼šâ€œt1"å³ä¸ºä¸€ä¸ªtopicçš„åç§°ï¼›
>
> è€Œâ€œt1-0 / t1-1"åˆ™è¡¨æ˜è¿™ä¸ªç›®å½•æ˜¯t1è¿™ä¸ªtopicçš„å“ªä¸ªpartitionï¼›

* æ•°æ®æ–‡ä»¶ åç§°è§„èŒƒï¼š

ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸æ–­è¿½åŠ åˆ°logæ–‡ä»¶æœ«å°¾ï¼Œä¸ºé˜²æ­¢logæ–‡ä»¶è¿‡å¤§å¯¼è‡´æ•°æ®å®šä½æ•ˆç‡ä½ä¸‹ï¼ŒKafkaé‡‡å–äº†**åˆ†ç‰‡å’Œç´¢å¼•æœºåˆ¶&#x20;**

1. æ¯ä¸ªpartitionçš„æ•°æ®å°†åˆ†ä¸ºå¤šä¸ªsegmentå­˜å‚¨

2. æ¯ä¸ªsegmentå¯¹åº”ä¸¤ä¸ªæ–‡ä»¶ï¼šâ€œ.index"æ–‡ä»¶å’Œâ€œ.log"æ–‡ä»¶ã€‚

![](images/image-17.png)

indexå’Œlogæ–‡ä»¶ä»¥å½“å‰segmentçš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„offsetå‘½åã€‚

![](images/image-14.png)



![](images/2e97d1caa3b84d999f3f15fa551d335e.png)

indexç´¢å¼•æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ºï¼š  æ¶ˆæ¯offset -> logæ–‡ä»¶ä¸­è¯¥æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ä½ç½®ï¼›

Kafka ä¸­çš„ç´¢å¼•æ–‡ä»¶ä»¥ç¨€ç–ç´¢å¼•ï¼ˆ sparse index ï¼‰çš„æ–¹å¼æ„é€ æ¶ˆæ¯çš„ç´¢å¼•ï¼Œå®ƒå¹¶ä¸ä¿è¯æ¯ä¸ªæ¶ˆæ¯åœ¨ç´¢å¼•æ–‡ä»¶ä¸­éƒ½æœ‰å¯¹åº”çš„ç´¢å¼•ï¼›æ¯å½“å†™å…¥ä¸€å®šé‡ï¼ˆç”± broker ç«¯å‚æ•° log.index.interval.bytes æŒ‡å®šï¼Œé»˜è®¤å€¼ä¸º 4096 ï¼Œå³ 4KB ï¼‰çš„æ¶ˆæ¯æ—¶ï¼Œåç§»é‡ç´¢å¼•æ–‡ä»¶å’Œæ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶åˆ†åˆ«å¢åŠ ä¸€ä¸ªåç§»é‡ç´¢å¼•é¡¹å’Œæ—¶é—´æˆ³ç´¢å¼•é¡¹ï¼Œå¢å¤§æˆ–å‡å° log.index.interval.bytesçš„å€¼ï¼Œå¯¹åº”åœ°å¯ä»¥ç¼©å°æˆ–å¢åŠ ç´¢å¼•é¡¹çš„å¯†åº¦ï¼›

æŸ¥è¯¢æŒ‡å®šåç§»é‡æ—¶ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æ¥å¿«é€Ÿå®šä½åç§»é‡çš„ä½ç½®ã€‚

### &#x20;5.2.2**æ¶ˆæ¯messageå­˜å‚¨ç»“æ„&#x20;**

åœ¨å®¢æˆ·ç«¯ç¼–ç¨‹ä»£ç ä¸­ï¼Œæ¶ˆæ¯çš„å°è£…ç±»æœ‰ä¸¤ç§ï¼šProducerRecordã€ConsumerRecordï¼›

ç®€å•æ¥è¯´ï¼Œkafkaä¸­çš„æ¯ä¸ªmassageç”±ä¸€å¯¹key-valueæ„æˆï¼›

Kafkaä¸­çš„messageæ ¼å¼ç»å†äº†3ä¸ªç‰ˆæœ¬çš„å˜åŒ–äº†ï¼šv0 ã€ v1 ã€ v2  &#x20;

![](images/image-11.png)

å„ä¸ªå­—æ®µçš„å«ä¹‰ä»‹ç»å¦‚ä¸‹ï¼š

* crcï¼šå ç”¨4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨äºæ ¡éªŒæ¶ˆæ¯çš„å†…å®¹ï¼›

* magicï¼šè¿™ä¸ªå ç”¨1ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨äºæ ‡è¯†æ—¥å¿—æ ¼å¼ç‰ˆæœ¬å·ï¼Œæ­¤ç‰ˆæœ¬çš„magicå€¼ä¸º1 &#x20;

* attributesï¼šå ç”¨1ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œé¢å­˜å‚¨äº†æ¶ˆæ¯å‹ç¼©ä½¿ç”¨çš„ç¼–ç ä»¥åŠTimestampç±»å‹ã€‚ç›®å‰Kafka æ”¯æŒ gzipã€snappy ä»¥åŠ lz4ï¼ˆ0.8.2å¼•å…¥ï¼‰ ä¸‰ç§å‹ç¼©æ ¼å¼ï¼›\[0,1,2]ä¸‰ä½bitè¡¨ç¤ºå‹ç¼©ç±»å‹ã€‚\[3]ä½è¡¨ç¤ºæ—¶é—´æˆ³ç±»å‹ï¼ˆ0ï¼Œcreate timeï¼›1ï¼Œappend timeï¼‰ï¼Œ\[4,5,6,7]ä½ä¿ç•™ï¼›

* key lengthï¼šå ç”¨4ä¸ªå­—èŠ‚ã€‚ä¸»è¦æ ‡è¯† Keyçš„å†…å®¹çš„é•¿åº¦ï¼›

* keyï¼šå ç”¨ Nä¸ªå­—èŠ‚ï¼Œå­˜å‚¨çš„æ˜¯ key çš„å…·ä½“å†…å®¹ï¼›

* value lengthï¼šå ç”¨4ä¸ªå­—èŠ‚ã€‚ä¸»è¦æ ‡è¯† value çš„å†…å®¹çš„é•¿åº¦ï¼›

* valueï¼švalueå³æ˜¯æ¶ˆæ¯çš„çœŸå®å†…å®¹ï¼Œåœ¨ Kafka ä¸­è¿™ä¸ªä¹Ÿå«åšpayloadã€‚

# **6.kafkaå…³é”®åŸç†åŠ å¼º**

## **6.1æ—¥å¿—åˆ†æ®µåˆ‡åˆ†æ¡ä»¶**

æ—¥å¿—åˆ†æ®µæ–‡ä»¶åˆ‡åˆ†åŒ…å«ä»¥ä¸‹4ä¸ªæ¡ä»¶ï¼Œæ»¡è¶³å…¶ä¸€å³å¯ï¼š

1. å½“å‰æ—¥å¿—åˆ†æ®µæ–‡ä»¶çš„å¤§å°è¶…è¿‡äº†brokerç«¯å‚æ•° log.segment.bytes é…ç½®çš„å€¼ã€‚

log.segment.byteså‚æ•°çš„é»˜è®¤å€¼ä¸º 1073741824ï¼Œå³1GB &#x20;

* å½“å‰æ—¥å¿—åˆ†æ®µä¸­æ¶ˆæ¯çš„æœ€å°æ—¶é—´æˆ³ä¸å½“å‰ç³»ç»Ÿçš„æ—¶é—´æˆ³çš„å·®å€¼å¤§äºlog.roll.msæˆ–log.roll.hourså‚æ•°é…ç½®çš„å€¼ã€‚å¦‚æœåŒæ—¶é…ç½®äº†log.roll.mså’Œlog.roll.hours å‚æ•°ï¼Œé‚£ä¹ˆ log.roll.ms çš„ä¼˜å…ˆçº§é«˜ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªé…ç½®äº†log.roll.hourså‚æ•°ï¼Œå…¶å€¼ä¸º168,å³7å¤©ã€‚ &#x20;

* åç§»é‡ç´¢å¼•æ–‡ä»¶æˆ–æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶çš„å¤§å°è¾¾åˆ° broker ç«¯å‚æ•° log.index.size.max.bytes é…ç½®çš„å€¼ã€‚

log.index.size .max.bytesçš„é»˜è®¤å€¼ä¸º 10485760ï¼Œå³10MB

* è¿½åŠ çš„æ¶ˆæ¯çš„åç§»é‡ä¸å½“å‰æ—¥å¿—åˆ†æ®µçš„èµ·å§‹åç§»é‡ä¹‹é—´çš„å·®å€¼å¤§äºInteger.MAX\_VALUE, å³è¦è¿½åŠ çš„æ¶ˆæ¯çš„åç§»é‡ä¸èƒ½è½¬å˜ä¸ºç›¸å¯¹åç§»é‡ï¼ˆoffset - baseOffset > Integer.MAX\_VALUEï¼‰ã€‚

## 6.2ä»€ä¹ˆæ˜¯Controller

Controllerä½œä¸ºKafkaé›†ç¾¤ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ Apache ZooKeeper çš„å¸®åŠ©ä¸‹ç®¡ç†å’Œåè°ƒæ•´ä¸ª Kafka é›†ç¾¤ã€‚

Controllerä¸Zookeeperè¿›è¡Œäº¤äº’ï¼Œè·å–ä¸æ›´æ–°é›†ç¾¤ä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚å…¶ä»–brokerå¹¶ä¸ç›´æ¥ä¸zookeeperè¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯ä¸ Controller è¿›è¡Œé€šä¿¡å¹¶åŒæ­¥Controllerä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚

Kafkaé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å……å½“ControllerèŠ‚ç‚¹ï¼Œä½†é›†ç¾¤ä¸­åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªControllerèŠ‚ç‚¹ã€‚

> **Controllerç®€å•æ¥è¯´ï¼Œå°±æ˜¯kafkaé›†ç¾¤çš„çŠ¶æ€ç®¡ç†è€…**
>
> **controllerç«é€‰æœºåˆ¶ï¼šç®€å•è¯´ï¼Œå…ˆæ¥å…ˆä¸Šï¼**
>
> Broker åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå°è¯•å» ZooKeeper ä¸­åˆ›å»º /controller èŠ‚ç‚¹ã€‚Kafka å½“å‰é€‰ä¸¾æ§åˆ¶å™¨çš„è§„åˆ™æ˜¯ï¼šç¬¬ä¸€ä¸ªæˆåŠŸåˆ›å»º /controller èŠ‚ç‚¹çš„ Broker ä¼šè¢«æŒ‡å®šä¸ºæ§åˆ¶å™¨ã€‚

åœ¨Kafkaé›†ç¾¤ä¸­ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªbrokerï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªbrokerä¼šè¢«é€‰ä¸¾ä¸ºæ§åˆ¶å™¨ï¼ˆKafka Controllerï¼‰ï¼Œ**å®ƒè´Ÿè´£ç»´æŠ¤æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰åˆ†åŒºå’Œå‰¯æœ¬çš„çŠ¶æ€åŠåˆ†åŒºleaderçš„é€‰ä¸¾ã€‚&#x20;**

å½“æŸä¸ªåˆ†åŒºçš„leaderå‰¯æœ¬å‡ºç°æ•…éšœæ—¶ï¼Œç”±æ§åˆ¶å™¨è´Ÿè´£ä¸ºè¯¥åˆ†åŒºé€‰ä¸¾æ–°çš„leaderå‰¯æœ¬ã€‚å½“æ£€æµ‹åˆ°æŸä¸ªåˆ†åŒºçš„ISRé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ï¼Œç”±æ§åˆ¶å™¨è´Ÿè´£é€šçŸ¥æ‰€æœ‰brokeræ›´æ–°å…¶å…ƒæ•°æ®ä¿¡æ¯ã€‚å½“ä½¿ç”¨kafka-topics.shè„šæœ¬ä¸ºæŸä¸ªtopicå¢åŠ åˆ†åŒºæ•°é‡æ—¶ï¼ŒåŒæ ·è¿˜æ˜¯ç”±æ§åˆ¶å™¨è´Ÿè´£åˆ†åŒºçš„é‡æ–°åˆ†é…ã€‚

Kafkaä¸­çš„æ§åˆ¶å™¨é€‰ä¸¾çš„å·¥ä½œä¾èµ–äºZookeeperï¼ŒæˆåŠŸç«é€‰ä¸ºæ§åˆ¶å™¨çš„brokerä¼šåœ¨Zookeeperä¸­åˆ›å»º/controllerè¿™ä¸ªä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹ï¼Œæ­¤ä¸´æ—¶èŠ‚ç‚¹çš„å†…å®¹å‚è€ƒå¦‚ä¸‹ï¼š

{"version":1,"brokerid":0,"timestamp":"1529210278988"}

å…¶ä¸­versionåœ¨ç›®å‰ç‰ˆæœ¬ä¸­å›ºå®šä¸º1ï¼Œbrokeridè¡¨ç¤ºæˆä¸ºæ§åˆ¶å™¨çš„brokerçš„idç¼–å·ï¼Œtimestampè¡¨ç¤ºç«é€‰æˆä¸ºæ§åˆ¶å™¨æ—¶çš„æ—¶é—´æˆ³ã€‚

åœ¨ä»»æ„æ—¶åˆ»ï¼Œé›†ç¾¤ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ã€‚æ¯ä¸ªbrokerå¯åŠ¨çš„æ—¶å€™ä¼šå»å°è¯•å»è¯»å–zookeeperä¸Šçš„/controllerèŠ‚ç‚¹çš„brokeridçš„å€¼ï¼Œå¦‚æœè¯»å–åˆ°brokeridçš„å€¼ä¸ä¸º-1ï¼Œåˆ™è¡¨ç¤ºå·²ç»æœ‰å…¶å®ƒbrokerèŠ‚ç‚¹æˆåŠŸç«é€‰ä¸ºæ§åˆ¶å™¨ï¼Œæ‰€ä»¥å½“å‰brokerå°±ä¼šæ”¾å¼ƒç«é€‰ï¼›å¦‚æœZookeeperä¸­ä¸å­˜åœ¨/controllerè¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…è¿™ä¸ªèŠ‚ç‚¹ä¸­çš„æ•°æ®å¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šå°è¯•å»åˆ›å»º/controllerè¿™ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰brokerå»åˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¹Ÿæœ‰å¯èƒ½å…¶ä»–brokeråŒæ—¶å»å°è¯•åˆ›å»ºè¿™ä¸ªèŠ‚ç‚¹ï¼Œåªæœ‰åˆ›å»ºæˆåŠŸçš„é‚£ä¸ªbrokeræ‰ä¼šæˆä¸ºæ§åˆ¶å™¨ï¼Œè€Œåˆ›å»ºå¤±è´¥çš„brokeråˆ™è¡¨ç¤ºç«é€‰å¤±è´¥ã€‚æ¯ä¸ªbrokeréƒ½ä¼šåœ¨å†…å­˜ä¸­ä¿å­˜å½“å‰æ§åˆ¶å™¨çš„brokeridå€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥æ ‡è¯†ä¸ºactiveControllerIdã€‚

### **6.2.1controllerçš„èŒè´£**

* ç›‘å¬partitionç›¸å…³å˜åŒ–

```typescript
å¯¹Zookeeperä¸­çš„/admin/reassign_partitionsèŠ‚ç‚¹æ³¨å†ŒPartitionReassignmentListenerï¼Œç”¨æ¥å¤„ç†åˆ†åŒºé‡åˆ†é…çš„åŠ¨ä½œã€‚
å¯¹Zookeeperä¸­çš„/isr_change_notificationèŠ‚ç‚¹æ³¨å†ŒIsrChangeNotificetionListenerï¼Œç”¨æ¥å¤„ç†ISRé›†åˆå˜æ›´çš„åŠ¨ä½œã€‚
å¯¹Zookeeperä¸­çš„/admin/preferred-replica-electionèŠ‚ç‚¹æ·»åŠ PreferredReplicaElectionListenerï¼Œç”¨æ¥å¤„ç†ä¼˜å…ˆå‰¯æœ¬é€‰ä¸¾ã€‚
```

* ç›‘å¬topicå¢å‡å˜åŒ–

```plain&#x20;text
å¯¹Zookeeperä¸­çš„/brokers/topicsèŠ‚ç‚¹æ·»åŠ TopicChangeListenerï¼Œç”¨æ¥å¤„ç†topicå¢å‡çš„å˜åŒ–ï¼›
å¯¹Zookeeperä¸­çš„/admin/delete_topicsèŠ‚ç‚¹æ·»åŠ TopicDeletionListenerï¼Œç”¨æ¥å¤„ç†åˆ é™¤topicçš„åŠ¨ä½œã€‚
```

* ç›‘å¬brokerç›¸å…³çš„å˜åŒ–

```plain&#x20;text
å¯¹Zookeeperä¸­çš„/brokers/ids/èŠ‚ç‚¹æ·»åŠ BrokerChangeListenerï¼Œç”¨æ¥å¤„ç†brokerå¢å‡çš„å˜åŒ–ã€‚
```

* æ›´æ–°é›†ç¾¤çš„å…ƒæ•°æ®ä¿¡æ¯

```plain&#x20;text
ä»Zookeeperä¸­è¯»å–è·å–å½“å‰æ‰€æœ‰ä¸topicã€partitionä»¥åŠbrokeræœ‰å…³çš„ä¿¡æ¯å¹¶è¿›è¡Œç›¸åº”çš„ç®¡ç†ã€‚å¯¹å„topicæ‰€å¯¹åº”çš„Zookeeperä¸­çš„/brokers/topics/[topic]èŠ‚ç‚¹æ·»åŠ PartitionModificationsListenerï¼Œç”¨æ¥ç›‘å¬topicä¸­çš„åˆ†åŒºåˆ†é…å˜åŒ–ã€‚å¹¶å°†æœ€æ–°ä¿¡æ¯åŒæ­¥ç»™å…¶ä»–æ‰€æœ‰brokerã€‚
```

* å¯åŠ¨å¹¶ç®¡ç†åˆ†åŒºçŠ¶æ€æœºå’Œå‰¯æœ¬çŠ¶æ€æœºã€‚

* å¦‚æœå‚æ•°auto.leader.rebalance.enableè®¾ç½®ä¸ºtrueï¼Œåˆ™è¿˜ä¼šå¼€å¯ä¸€ä¸ªåä¸ºâ€œauto-leader-rebalance-taskâ€çš„å®šæ—¶ä»»åŠ¡æ¥è´Ÿè´£ç»´æŠ¤åˆ†åŒºçš„leaderå‰¯æœ¬çš„å‡è¡¡ã€‚

### 6.2.2**åˆ†åŒºçš„è´Ÿè½½åˆ†å¸ƒ**

å®¢æˆ·ç«¯è¯·æ±‚åˆ›å»ºä¸€ä¸ªtopicæ—¶ï¼Œæ¯ä¸€ä¸ªåˆ†åŒºå‰¯æœ¬åœ¨brokerä¸Šçš„åˆ†é…ï¼Œæ˜¯ç”±é›†ç¾¤controlleræ¥å†³å®šï¼›

ç»“è®ºï¼šé‡Œé¢ä¼šåˆ›å»ºå‡ºæ¥ä¸¤ä¸ªéšæœºæ•°

ç¬¬ä¸€ä¸ªéšæœºæ•°ç¡®å®š0å·åˆ†åŒºleaderçš„ä½ç½®ï¼Œå¾€å1å·åˆ†åŒº2å·åˆ†åŒºçš„leaderä¾æ¬¡å¾€åé¡ºå»¶1

ç¬¬äºŒä¸ªéšæœºæ•°ç¡®å®šæ¯ä¸ªåˆ†åŒºçš„ç¬¬ä¸€ä¸ªå‰¯æœ¬çš„ä½ç½® åœ¨leaderæ‰€åœ¨æœºå™¨ä¸Šå¾€åé¡ºå»¶ï¼ˆéšæœºæ•°+1ï¼‰å°æœºå™¨ï¼Œ

è¯¥å°æœºå™¨å°±æ˜¯ç¬¬ä¸€ä¸ªå‰¯æœ¬çš„ä½ç½®ï¼Œå‰©ä½™å‰¯æœ¬ä¾æ¬¡å¾€åé¡ºå»¶1

> ä¸¾ä¾‹ï¼š
>
> broker\_id = 0\~19 ä¸€å…±20å°æœºå™¨
>
> åˆ†åŒºæ•°20,å‰¯æœ¬æ•°10
>
> ç¬¬ä¸€ä¸ªéšæœºæ•°ï¼š19
>
> ç¬¬äºŒä¸ªéšæœºæ•°ï¼š0
>
> (0,ArrayBuffer(19, 0, 1, 2, 3, 4, 5, 6, 7, 8))
>
> (1,ArrayBuffer(0, 1, 2, 3, 4, 5, 6, 7, 8, 9))
>
> (2,ArrayBuffer(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))
>
> (3,ArrayBuffer(2, 3, 4, 5, 6, 7, 8, 9, 10, 11))
>
> (4,ArrayBuffer(3, 4, 5, 6, 7, 8, 9, 10, 11, 12))
>
> (5,ArrayBuffer(4, 5, 6, 7, 8, 9, 10, 11, 12, 13))
>
> (6,ArrayBuffer(5, 6, 7, 8, 9, 10, 11, 12, 13, 14))
>
> (7,ArrayBuffer(6, 7, 8, 9, 10, 11, 12, 13, 14, 15))
>
> (8,ArrayBuffer(7, 8, 9, 10, 11, 12, 13, 14, 15, 16))
>
> (9,ArrayBuffer(8, 9, 10, 11, 12, 13, 14, 15, 16, 17))
>
> (10,ArrayBuffer(9, 10, 11, 12, 13, 14, 15, 16, 17, 18))
>
> (11,ArrayBuffer(10, 11, 12, 13, 14, 15, 16, 17, 18, 19))
>
> (12,ArrayBuffer(11, 12, 13, 14, 15, 16, 17, 18, 19, 0))
>
> (13,ArrayBuffer(12, 13, 14, 15, 16, 17, 18, 19, 0, 1))
>
> (14,ArrayBuffer(13, 14, 15, 16, 17, 18, 19, 0, 1, 2))
>
> (15,ArrayBuffer(14, 15, 16, 17, 18, 19, 0, 1, 2, 3))
>
> (16,ArrayBuffer(15, 16, 17, 18, 19, 0, 1, 2, 3, 4))
>
> (17,ArrayBuffer(16, 17, 18, 19, 0, 1, 2, 3, 4, 5))
>
> (18,ArrayBuffer(17, 18, 19, 0, 1, 2, 3, 4, 5, 6))
>
> (19,ArrayBuffer(18, 19, 0, 1, 2, 3, 4, 5, 6, 7))

å…¶åˆ†å¸ƒç­–ç•¥æºç å¦‚ä¸‹ï¼š &#x20;

```java
private def assignReplicasToBrokersRackUnaware(
nPartitions: Int, //åˆ†åŒºçš„ä¸ªæ•°   10
replicationFactor: Int,  //å‰¯æœ¬çš„ä¸ªæ•°  5 
brokerList: Seq[Int],//brokerçš„é›†åˆ    8   0~7
fixedStartIndex: Int//é»˜è®¤å€¼æ˜¯-1  å›ºå®šå¼€å§‹çš„ç´¢å¼•ä½ç½®
startPartitionId: Int): Map[Int, Seq[Int]] //é»˜è®¤å€¼æ˜¯-1 åˆ†åŒºå¼€å§‹çš„ä½ç½®
= {
  val ret = mutable.Map[Int, Seq[Int]]()
  val brokerArray = brokerList.toArray
  val startIndex = if (fixedStartIndex >= 0) {
      fixedStartIndex
  }else {
          rand.nextInt(brokerArray.length)
  }
  var currentPartitionId = math.max(0, startPartitionId) 
  var nextReplicaShift = if (fixedStartIndex >= 0) {
          fixedStartIndex 
  }else {
          rand.nextInt(brokerArray.length)
  }
  for (_ <- 0 until nPartitions) {
    if (currentPartitionId > 0 && (currentPartitionId % brokerArray.length == 0)){
      nextReplicaShift += 1
        }

    val firstReplicaIndex = (currentPartitionId + startIndex) % brokerArray.length 
    val replicaBuffer = mutable.ArrayBuffer(brokerArray(firstReplicaIndex))
    for (j <- 0 until replicationFactor - 1) {                          
      replicaBuffer += brokerArray(replicaIndex(firstReplicaIndex, nextReplicaShift, j, brokerArray.length))
    }
    ret.put(currentPartitionId, replicaBuffer)
    currentPartitionId += 1
  }
  ret
}
                   
private def replicaIndex(firstReplicaIndex: Int, secondReplicaShift: Int, replicaIndex: Int, nBrokers: Int): Int = {
  val shift = 1 + (secondReplicaShift + replicaIndex) % (nBrokers - 1)
  (firstReplicaIndex + shift) % nBrokers
}
```

* **å‰¯æœ¬å› å­ä¸èƒ½å¤§äº Broker çš„ä¸ªæ•°ï¼›**

**æŠ¥é”™ï¼šReplication factor: 4 larger than available brokers: 3.**

* partition\_0çš„ç¬¬1ä¸ªå‰¯æœ¬ï¼ˆleaderå‰¯æœ¬ï¼‰æ”¾ç½®ä½ç½®æ˜¯éšæœºä» brokerList é€‰æ‹©çš„ï¼›

* å…¶ä»–åˆ†åŒºçš„ç¬¬1ä¸ªå‰¯æœ¬ï¼ˆleaderï¼‰æ”¾ç½®ä½ç½®ç›¸å¯¹äºparitition\_0åˆ†åŒºä¾æ¬¡å¾€åç§»ï¼ˆä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬æœ‰5ä¸ª Brokerï¼Œ5ä¸ªåˆ†åŒºï¼Œå‡è®¾partition0åˆ†åŒºæ”¾åœ¨broker4ä¸Šï¼Œé‚£ä¹ˆpartition1å°†ä¼šæ”¾åœ¨broker5ä¸Šï¼›patition2å°†ä¼šæ”¾åœ¨broker1ä¸Šï¼›partition3åœ¨broker2ï¼Œä¾æ¬¡ç±»ï¼‰ï¼›  &#x20;

* å„åˆ†åŒºå‰©ä½™çš„å‰¯æœ¬ç›¸å¯¹äºåˆ†åŒºå‰ä¸€ä¸ªå‰¯æœ¬åç§»éšæœºæ•°nextReplicaShift+1ï¼Œç„¶ååé¢çš„å‰¯æœ¬ä¾æ¬¡åŠ 1

### **6.2.3åˆ†åŒºLeaderçš„é€‰ä¸¾æœºåˆ¶**

**åˆ†åŒº leader å‰¯æœ¬çš„é€‰ä¸¾ç”±æ§åˆ¶å™¨controllerè´Ÿè´£å…·ä½“å®æ–½ã€‚**

å½“åˆ›å»ºåˆ†åŒºï¼ˆåˆ›å»ºä¸»é¢˜æˆ–å¢åŠ åˆ†åŒºéƒ½æœ‰åˆ›å»ºåˆ†åŒºçš„åŠ¨ä½œï¼‰æˆ–Leaderä¸‹çº¿ï¼ˆæ­¤æ—¶åˆ†åŒºéœ€è¦é€‰ä¸¾ä¸€ä¸ªæ–°çš„leaderä¸Šçº¿æ¥å¯¹å¤–æä¾›æœåŠ¡ï¼‰çš„æ—¶å€™éƒ½éœ€è¦æ‰§è¡Œ leader çš„é€‰ä¸¾åŠ¨ä½œã€‚

é€‰ä¸¾ç­–ç•¥ï¼š**æŒ‰ç…§ ISRé›†åˆä¸­å‰¯æœ¬çš„é¡ºåºæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­˜æ´»çš„å‰¯æœ¬ï¼Œå¹¶ä¸”è¿™ä¸ªå‰¯æœ¬åœ¨ ISR é›†åˆä¸­**

> ä¸€ä¸ªåˆ†åŒºçš„ARé›†åˆåœ¨partitionåˆ†é…çš„æ—¶å€™å°±è¢«æŒ‡å®šï¼Œå¹¶ä¸”åªè¦ä¸å‘ç”Ÿé‡åˆ†é…çš„æƒ…å†µï¼Œé›†åˆå†…éƒ¨å‰¯æœ¬çš„é¡ºåºæ˜¯ä¿æŒä¸å˜çš„ï¼Œè€Œåˆ†åŒºçš„ ISR é›†åˆä¸­å‰¯æœ¬çš„é¡ºåºå¯èƒ½ä¼šæ”¹å˜ï¼›

## 6.3**ç”Ÿäº§è€…åŸç†è§£æ**

ç”Ÿäº§è€…å·¥ä½œæµç¨‹å›¾ï¼š

![](images/image-19.png)

ä¸€ä¸ªç”Ÿäº§è€…å®¢æˆ·ç«¯ç”±ä¸¤ä¸ªçº¿ç¨‹åè°ƒè¿è¡Œï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¸º**ä¸»çº¿ç¨‹**å’Œ **Sender** çº¿ç¨‹ ã€‚

åœ¨ä¸»çº¿ç¨‹ä¸­ç”±kafkaProduceråˆ›å»ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡å¯èƒ½çš„æ‹¦æˆªå™¨ã€åºåˆ—åŒ–å™¨å’Œåˆ†åŒºå™¨çš„ä½œç”¨ä¹‹åç¼“å­˜åˆ°æ¶ˆæ¯ç´¯åŠ å™¨ï¼ˆRecordAccumulator, ä¹Ÿç§°ä¸ºæ¶ˆæ¯æ”¶é›†å™¨ï¼‰ä¸­ã€‚&#x20;

**Sender&#x20;**&#x7EBF;ç¨‹è´Ÿè´£ä»RecordAccumulator è·å–æ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ° Kafka ä¸­ï¼›

RecordAccumulatorä¸»è¦ç”¨æ¥ç¼“å­˜æ¶ˆæ¯ä»¥ä¾¿Sender çº¿ç¨‹å¯ä»¥æ‰¹é‡å‘é€ï¼Œè¿›è€Œå‡å°‘ç½‘ç»œä¼ è¾“çš„èµ„æºæ¶ˆè€—ä»¥æå‡æ€§èƒ½ã€‚RecordAccumulatorç¼“å­˜çš„å¤§å°å¯ä»¥é€šè¿‡ç”Ÿäº§è€…å®¢æˆ·ç«¯å‚æ•°buffer.memory é…ç½®ï¼Œé»˜è®¤å€¼ä¸º 33554432B ï¼Œå³32Mã€‚å¦‚æœç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„é€Ÿåº¦è¶…è¿‡å‘é€åˆ°æœåŠ¡å™¨çš„é€Ÿåº¦ï¼Œåˆ™ä¼šå¯¼è‡´ç”Ÿäº§è€…ç©ºé—´ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™ KafkaProducer.sendï¼ˆï¼‰æ–¹æ³•è°ƒç”¨è¦ä¹ˆè¢«é˜»å¡ï¼Œè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªå–å†³äºå‚æ•° max.block.ms çš„é…ç½®ï¼Œæ­¤å‚æ•°çš„é»˜è®¤å€¼ä¸º 60000,å³60ç§’ã€‚

ä¸»çº¿ç¨‹ä¸­å‘é€è¿‡æ¥çš„æ¶ˆæ¯éƒ½ä¼šè¢«è¿«åŠ åˆ° RecordAccumulator çš„æŸä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆ Deque ï¼‰ä¸­ï¼Œ

RecordAccumulatorå†…éƒ¨ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½ç»´æŠ¤äº†ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œå³Deque\<ProducerBatch>ã€‚

æ¶ˆæ¯å†™å…¥ç¼“å­˜æ—¶ï¼Œè¿½åŠ åˆ°åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨;

Senderè¯»å–æ¶ˆæ¯æ—¶ï¼Œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨è¯»å–ã€‚æ³¨æ„ï¼šProducerBatch æ˜¯æŒ‡ä¸€ä¸ªæ¶ˆæ¯æ‰¹æ¬¡ï¼›

ä¸æ­¤åŒæ—¶ï¼Œä¼šå°†è¾ƒå°çš„ ProducerBatch å‡‘æˆä¸€ä¸ªè¾ƒå¤§ ProducerBatch ï¼Œä¹Ÿå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚çš„æ¬¡æ•°ä»¥æå‡æ•´ä½“çš„ååé‡ã€‚

ProducerBatch å¤§å°å’Œ batch.size å‚æ•°ä¹Ÿæœ‰ç€å¯†åˆ‡çš„å…³ç³»ã€‚å½“ä¸€æ¡æ¶ˆæ¯ï¼ˆProducerRecord ) æµå…¥ RecordAccumulator æ—¶ï¼Œä¼šå…ˆå¯»æ‰¾ä¸æ¶ˆæ¯åˆ†åŒºæ‰€å¯¹åº”çš„åŒç«¯é˜Ÿåˆ—ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºï¼‰ï¼Œå†ä»è¿™ä¸ªåŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨è·å–ä¸€ä¸ªProducerBatch ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºï¼‰ï¼ŒæŸ¥çœ‹ ProducerBatchä¸­æ˜¯å¦è¿˜å¯ä»¥å†™å…¥è¿™ä¸ªProducerRecordï¼Œå¦‚æœå¯ä»¥å†™å…¥å°±ç›´æ¥å†™å…¥ï¼Œå¦‚æœä¸å¯ä»¥åˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Producer Batchã€‚åœ¨æ–°å»º ProducerBatchæ—¶è¯„ä¼°è¿™æ¡æ¶ˆæ¯çš„å¤§å°æ˜¯å¦è¶…è¿‡ batch.size å‚æ•°å¤§å°ï¼Œå¦‚æœä¸è¶…è¿‡ï¼Œé‚£ä¹ˆå°±ä»¥ batch.size å‚æ•°çš„å¤§å°æ¥åˆ›å»º ProducerBatchã€‚

> å¦‚æœç”Ÿäº§è€…å®¢æˆ·ç«¯éœ€è¦å‘å¾ˆå¤šåˆ†åŒºå‘é€æ¶ˆæ¯ï¼Œ åˆ™å¯ä»¥å°†buffer.memoryå‚æ•°é€‚å½“è°ƒå¤§ä»¥å¢åŠ æ•´ä½“çš„ååé‡ã€‚

Senderä» RecordAccumulator è·å–ç¼“å­˜çš„æ¶ˆæ¯ä¹‹åï¼Œä¼šè¿›ä¸€æ­¥å°†<åˆ†åŒº,Deque\<Producer Batch>>çš„å½¢å¼è½¬å˜æˆ\<Node,List< ProducerBatch>çš„å½¢å¼ï¼Œå…¶ä¸­Nodeè¡¨ç¤ºKafkaé›†ç¾¤brokerèŠ‚ç‚¹ã€‚å¯¹äºç½‘ç»œè¿æ¥æ¥è¯´ï¼Œç”Ÿäº§è€…å®¢æˆ·ç«¯æ˜¯ä¸å…·ä½“brokerèŠ‚ç‚¹å»ºç«‹çš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯å‘å…·ä½“çš„brokerèŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼Œè€Œå¹¶ä¸å…³å¿ƒæ¶ˆæ¯å±äºå“ªä¸€ä¸ªåˆ†åŒºï¼›è€Œå¯¹äºKafkaProducerçš„åº”ç”¨é€»è¾‘è€Œè¨€ï¼Œæˆ‘ä»¬åªå…³æ³¨å‘å“ªä¸ªåˆ†åŒºä¸­å‘é€å“ªäº›æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦åšä¸€ä¸ªåº”ç”¨é€»è¾‘å±‚é¢åˆ°ç½‘ç»œI/Oå±‚é¢çš„è½¬æ¢ã€‚

åœ¨è½¬æ¢æˆ\<Node, List\<ProducerBatch>>çš„å½¢å¼ä¹‹åï¼Œ Senderä¼šè¿›ä¸€æ­¥å°è£…æˆ\<Node,Request> çš„å½¢å¼ï¼Œè¿™æ ·å°±å¯ä»¥å°† Request è¯·æ±‚å‘å¾€å„ä¸ªNodeäº†ï¼Œè¿™é‡Œçš„Requestæ˜¯Kafkaå„ç§åè®®è¯·æ±‚ï¼›

è¯·æ±‚åœ¨ä»senderçº¿ç¨‹å‘å¾€Kafkaä¹‹å‰è¿˜ä¼šä¿å­˜åˆ°InFlightRequestsä¸­ï¼ŒInFlightRequestsä¿å­˜å¯¹è±¡çš„å…·ä½“å½¢å¼ä¸º Map\<Nodeld, Deque\<request>>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç¼“å­˜äº†å·²ç»å‘å‡ºå»ä½†è¿˜æ²¡æœ‰æ”¶åˆ°æœåŠ¡ç«¯å“åº”çš„è¯·æ±‚ï¼ˆNodeld æ˜¯ä¸€ä¸ª String ç±»å‹ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„ id ç¼–å·ï¼‰ã€‚ä¸æ­¤åŒæ—¶ï¼ŒInFlightRequests è¿˜æä¾›äº†è®¸å¤šç®¡ç†ç±»çš„æ–¹æ³•ï¼Œå¹¶ä¸”é€šè¿‡é…ç½®å‚æ•°è¿˜å¯ä»¥é™åˆ¶æ¯ä¸ªè¿æ¥ï¼ˆä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯ä¸ Nodeä¹‹é—´çš„è¿æ¥ï¼‰æœ€å¤šç¼“å­˜çš„è¯·æ±‚æ•°ã€‚è¿™ä¸ªé…ç½®å‚æ•°ä¸º max.in.flight.request.per. connection ï¼Œé»˜è®¤å€¼ä¸º5ï¼Œå³æ¯ä¸ªè¿æ¥æœ€å¤šåªèƒ½ç¼“å­˜5ä¸ªæœªå“åº”çš„è¯·æ±‚ï¼Œè¶…è¿‡è¯¥æ•°å€¼ä¹‹åå°±ä¸èƒ½å†å‘è¿™ä¸ªè¿æ¥å‘é€æ›´å¤šçš„è¯·æ±‚äº†ï¼Œé™¤éæœ‰ç¼“å­˜çš„è¯·æ±‚æ”¶åˆ°äº†å“åº”ï¼ˆ Response ï¼‰ã€‚é€šè¿‡æ¯”è¾ƒ Deque\<Request> çš„sizeä¸è¿™ä¸ªå‚æ•°çš„å¤§å°æ¥åˆ¤æ–­å¯¹åº”çš„ Nodeä¸­æ˜¯å¦å·±ç»å †ç§¯äº†å¾ˆå¤šæœªå“åº”çš„æ¶ˆæ¯ï¼Œå¦‚æœçœŸæ˜¯å¦‚æ­¤ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ª Node èŠ‚ç‚¹è´Ÿè½½è¾ƒå¤§æˆ–ç½‘ç»œè¿æ¥æœ‰é—®é¢˜ï¼Œå†ç»§ç»­å‘é€è¯·æ±‚ä¼šå¢å¤§è¯·æ±‚è¶…æ—¶çš„å¯èƒ½ã€‚

### **6.3.1Producerå¾€Brokerå‘é€æ¶ˆæ¯åº”ç­”æœºåˆ¶**

kafka åœ¨ producer é‡Œé¢æä¾›äº†æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥å†³å®šæ¶ˆæ¯å‘é€åˆ°å¯¹åº”åˆ†åŒºçš„å‡ ä¸ªå‰¯æœ¬æ‰ç®—æ¶ˆæ¯å‘é€æˆåŠŸã€‚å¯ä»¥åœ¨æ„é€ producer æ—¶é€šè¿‡ackså‚æ•°æŒ‡å®šï¼ˆåœ¨ 0.8.2.X å‰æ˜¯é€šè¿‡ request.required.acks å‚æ•°è®¾ç½®çš„ï¼‰ã€‚è¿™ä¸ªå‚æ•°æ”¯æŒä»¥ä¸‹ä¸‰ç§å€¼ï¼š

* acks = 0ï¼šæ„å‘³ç€å¦‚æœç”Ÿäº§è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œæŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ¶ˆæ¯å·²æˆåŠŸå†™å…¥ kafka ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹è¿˜æ˜¯æœ‰å¯èƒ½å‘ç”Ÿé”™è¯¯ï¼Œæ¯”å¦‚å‘é€çš„å¯¹è±¡ä¸èƒ½è¢«åºåˆ—åŒ–æˆ–è€…ç½‘å¡å‘ç”Ÿæ•…éšœï¼Œä½†å¦‚æœæ˜¯åˆ†åŒºç¦»çº¿æˆ–æ•´ä¸ªé›†ç¾¤é•¿æ—¶é—´ä¸å¯ç”¨ï¼Œé‚£å°±ä¸ä¼šæ”¶åˆ°ä»»ä½•é”™è¯¯ã€‚åœ¨ acks=0 æ¨¡å¼ä¸‹çš„è¿è¡Œé€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šåŸºå‡†æµ‹è¯•éƒ½æ˜¯åŸºäºè¿™ä¸ªæ¨¡å¼ï¼‰ï¼Œä½ å¯ä»¥å¾—åˆ°æƒŠäººçš„ååé‡å’Œå¸¦å®½åˆ©ç”¨ç‡ï¼Œä¸è¿‡å¦‚æœé€‰æ‹©äº†è¿™ç§æ¨¡å¼ï¼Œå¤§æ¦‚ç‡ä¼šä¸¢å¤±ä¸€äº›æ¶ˆæ¯ã€‚

* acks = 1ï¼šæ„å‘³ç€leader åœ¨æ”¶åˆ°æ¶ˆæ¯å¹¶æŠŠå®ƒå†™å…¥åˆ°åˆ†åŒºæ•°æ®æ–‡ä»¶ï¼ˆä¸ä¸€å®šåŒæ­¥åˆ°ç£ç›˜ä¸Šï¼‰æ—¶ä¼šè¿”å›ç¡®è®¤æˆ–é”™è¯¯å“åº”ã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œå¦‚æœå‘ç”Ÿæ­£å¸¸çš„ leader é€‰ä¸¾ï¼Œç”Ÿäº§è€…ä¼šåœ¨é€‰ä¸¾æ—¶æ”¶åˆ°ä¸€ä¸ª LeaderNotAvailableException å¼‚å¸¸ï¼Œå¦‚æœç”Ÿäº§è€…èƒ½æ°å½“åœ°å¤„ç†è¿™ä¸ªé”™è¯¯ï¼Œå®ƒä¼šé‡è¯•å‘é€æ‚„æ¯ï¼Œæœ€ç»ˆæ¶ˆæ¯ä¼šå®‰å…¨åˆ°è¾¾æ–°çš„ leader é‚£é‡Œã€‚ä¸è¿‡åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ä»ç„¶æœ‰å¯èƒ½ä¸¢å¤±æ•°æ®ï¼Œæ¯”å¦‚æ¶ˆæ¯å·²ç»æˆåŠŸå†™å…¥ leaderï¼Œä½†åœ¨æ¶ˆæ¯è¢«å¤åˆ¶åˆ° follower å‰¯æœ¬ä¹‹å‰ leaderå‘ç”Ÿå´©æºƒã€‚

* acks = allï¼ˆè¿™ä¸ªå’Œ request.required.acks = -1 å«ä¹‰ä¸€æ ·ï¼‰ï¼šæ„å‘³ç€ leader åœ¨è¿”å›ç¡®è®¤æˆ–é”™è¯¯å“åº”ä¹‹å‰ï¼Œä¼šç­‰å¾…æ‰€æœ‰åŒæ­¥å‰¯æœ¬éƒ½æ”¶åˆ°æ‚„æ¯ã€‚å¦‚æœå’Œ min.insync.replicas å‚æ•°ç»“åˆèµ·æ¥ï¼Œå°±å¯ä»¥å†³å®šåœ¨è¿”å›ç¡®è®¤å‰è‡³å°‘æœ‰å¤šå°‘ä¸ªå‰¯æœ¬èƒ½å¤Ÿæ”¶åˆ°æ‚„æ¯ï¼Œç”Ÿäº§è€…ä¼šä¸€ç›´é‡è¯•ç›´åˆ°æ¶ˆæ¯è¢«æˆåŠŸæäº¤ã€‚ä¸è¿‡è¿™ä¹Ÿæ˜¯æœ€æ…¢çš„åšæ³•ï¼Œå› ä¸ºç”Ÿäº§è€…åœ¨ç»§ç»­å‘é€å…¶ä»–æ¶ˆæ¯ä¹‹å‰éœ€è¦ç­‰å¾…æ‰€æœ‰å‰¯æœ¬éƒ½æ”¶åˆ°å½“å‰çš„æ¶ˆæ¯ã€‚

> **æ ¹æ®å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬è®¾ç½®ä¸åŒçš„ acksï¼Œä»¥æ­¤ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚**

| acks   | å«ä¹‰                                                                                             |
| ------ | ---------------------------------------------------------------------------------------------- |
| 0      | Producerå¾€é›†ç¾¤å‘é€æ•°æ®ä¸éœ€è¦ç­‰åˆ°é›†ç¾¤çš„ç¡®è®¤ä¿¡æ¯ï¼Œä¸ç¡®ä¿æ¶ˆæ¯å‘é€æˆåŠŸã€‚å®‰å…¨æ€§æœ€ä½ä½†æ˜¯æ•ˆç‡æœ€é«˜ã€‚                                             |
| 1      | Producerå¾€é›†ç¾¤å‘é€æ•°æ®åªè¦ leaderæˆåŠŸå†™å…¥æ¶ˆæ¯å°±å¯ä»¥å‘é€ä¸‹ä¸€æ¡ï¼Œåªç¡®ä¿Leader æ¥æ”¶æˆåŠŸã€‚                                         |
| -1æˆ–all | Producerå¾€é›†ç¾¤å‘é€æ•°æ®éœ€è¦æ‰€æœ‰çš„ISR Follower éƒ½å®Œæˆä» Leader çš„åŒæ­¥æ‰ä¼šå‘é€ä¸‹ä¸€æ¡ï¼Œç¡®ä¿ Leaderå‘é€æˆåŠŸå’Œæ‰€æœ‰çš„å‰¯æœ¬éƒ½æˆåŠŸæ¥æ”¶ã€‚å®‰å…¨æ€§æœ€é«˜ï¼Œä½†æ˜¯æ•ˆç‡æœ€ä½ã€‚ |

ç”Ÿäº§è€…å°†acksè®¾ç½®ä¸ºallï¼Œæ˜¯å¦å°±ä¸€å®šä¸ä¼šä¸¢æ•°æ®å‘¢ï¼Ÿ

å¦ï¼å¦‚æœåœ¨æŸä¸ªæ—¶åˆ»ISRåˆ—è¡¨åªå‰©leaderè‡ªå·±äº†ï¼Œé‚£ä¹ˆå°±ç®—acks=allï¼Œæ”¶åˆ°è¿™æ¡æ•°æ®è¿˜æ˜¯åªæœ‰ä¸€ä¸ªç‚¹ï¼›

å¯ä»¥é…åˆå¦å¤–ä¸€ä¸ªå‚æ•°ç¼“è§£æ­¤æƒ…å†µï¼š æœ€å°åŒæ­¥å‰¯æœ¬æ•°>=2

> BROKERç«¯å‚æ•°ï¼š  min.insync.replicasï¼ˆé»˜è®¤1ï¼‰
>
> ç”Ÿäº§è€…çš„ack=allï¼Œä¹Ÿä¸èƒ½å®Œå…¨ä¿è¯æ•°æ®å‘é€çš„100%å¯é æ€§
>
> ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºï¼Œå¦‚æœæœåŠ¡ç«¯ç›®æ ‡partitionçš„åŒæ­¥å‰¯æœ¬åªæœ‰leaderè‡ªå·±äº†ï¼Œæ­¤æ—¶ï¼Œå®ƒæ”¶åˆ°æ•°æ®å°±ä¼šç»™ç”Ÿäº§è€…åé¦ˆæˆåŠŸï¼
>
> å¯ä»¥ä¿®æ”¹æœåŠ¡ç«¯çš„ä¸€ä¸ªå‚æ•°ï¼ˆåˆ†åŒºæœ€å°ISRæ•°\[min.insync.replicas]>=2ï¼‰ï¼Œæ¥é¿å…æ­¤é—®é¢˜ï¼›



![](images/86081c1279cafd8c01ff0ab80a20ac6.jpg)

**6.3.2å…¶ä»–çš„ç”Ÿäº§è€…å‚æ•°**

* **acks**

acksæ˜¯æ§åˆ¶kafkaæœåŠ¡ç«¯å‘ç”Ÿäº§è€…**åº”ç­”æ¶ˆæ¯å†™å…¥æˆåŠŸçš„æ¡ä»¶**ï¼›ç”Ÿäº§è€…æ ¹æ®å¾—åˆ°çš„ç¡®è®¤ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­æ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸï¼›

* **max.request.size**

è¿™ä¸ªå‚æ•°ç”¨æ¥é™åˆ¶ç”Ÿäº§è€…å®¢æˆ·ç«¯èƒ½å‘é€çš„æ¶ˆæ¯çš„æœ€å¤§å€¼ï¼Œé»˜è®¤å€¼ä¸º 1048576B ï¼Œå³ 1MB

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé»˜è®¤å€¼å°±å¯ä»¥æ»¡è¶³å¤§å¤šæ•°çš„åº”ç”¨åœºæ™¯äº†ã€‚

&#x20;è¿™ä¸ªå‚æ•°è¿˜æ¶‰åŠä¸€äº›å…¶å®ƒå‚æ•°çš„è”åŠ¨ï¼Œæ¯”å¦‚ broker ç«¯ï¼ˆtopicçº§åˆ«å‚æ•°ï¼‰çš„ message.max.byteså‚æ•°ï¼ˆé»˜è®¤1000012ï¼‰ï¼Œå¦‚æœé…ç½®é”™è¯¯å¯èƒ½ä¼šå¼•èµ·ä¸€äº›ä¸å¿…è¦çš„å¼‚å¸¸ï¼›æ¯”å¦‚å°† broker ç«¯çš„ message.max.bytes å‚æ•°é…ç½®ä¸º10B ï¼Œè€Œ max.request.sizeå‚æ•°é…ç½®ä¸º20Bï¼Œé‚£ä¹ˆå½“å‘é€ä¸€æ¡å¤§å°ä¸º 15B çš„æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…å®¢æˆ·ç«¯å°±ä¼šæŠ¥å‡ºå¼‚å¸¸ï¼›

* **retrieså’Œretry.backoff.ms**

retrieså‚æ•°ç”¨æ¥é…ç½®ç”Ÿäº§è€…é‡è¯•çš„æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œå³åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™è¿›è¡Œä»»ä½•é‡è¯•åŠ¨ä½œã€‚

æ¶ˆæ¯åœ¨ä»ç”Ÿäº§è€…å‘å‡ºåˆ°æˆåŠŸå†™å…¥æœåŠ¡å™¨ä¹‹å‰å¯èƒ½å‘ç”Ÿä¸€äº›ä¸´æ—¶æ€§çš„å¼‚å¸¸ï¼Œæ¯”å¦‚ç½‘ç»œæŠ–åŠ¨ã€ leader å‰¯æœ¬çš„é€‰ä¸¾ç­‰ï¼Œè¿™ç§å¼‚å¸¸å¾€å¾€æ˜¯å¯ä»¥è‡ªè¡Œæ¢å¤çš„ï¼Œç”Ÿäº§è€…å¯ä»¥é€šè¿‡é…ç½® retrieså¤§äº0çš„å€¼ï¼Œä»¥æ­¤é€šè¿‡å†…éƒ¨é‡è¯•æ¥æ¢å¤è€Œä¸æ˜¯ä¸€å‘³åœ°å°†å¼‚å¸¸æŠ›ç»™ç”Ÿäº§è€…çš„åº”ç”¨ç¨‹åºã€‚å¦‚æœé‡è¯•è¾¾åˆ°è®¾å®šçš„æ¬¡æ•°ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±ä¼šæ”¾å¼ƒé‡è¯•å¹¶è¿”å›å¼‚å¸¸ã€‚é‡è¯•è¿˜å’Œå¦ä¸€ä¸ªå‚æ•° retry.backoff.ms æœ‰å…³ï¼Œè¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸º100ï¼Œå®ƒç”¨æ¥è®¾å®šä¸¤æ¬¡é‡è¯•ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé¿å…æ— æ•ˆçš„é¢‘ç¹é‡è¯•    ã€‚å¦‚æœå°† retrieså‚æ•°é…ç½®ä¸ºéé›¶å€¼ï¼Œå¹¶ä¸” max .in.flight.requests.per.connection å‚æ•°é…ç½®ä¸ºå¤§äº1çš„å€¼ï¼Œé‚£**å¯èƒ½ä¼šå‡ºç°é”™åºçš„ç°è±¡ï¼šå¦‚æœæ‰¹æ¬¡1æ¶ˆæ¯å†™å…¥å¤±è´¥ï¼Œè€Œæ‰¹æ¬¡2æ¶ˆæ¯å†™å…¥æˆåŠŸï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¼šé‡è¯•å‘é€æ‰¹æ¬¡1çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶å¦‚æœæ‰¹æ¬¡1çš„æ¶ˆæ¯å†™å…¥æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ‰¹æ¬¡çš„æ¶ˆæ¯å°±å‡ºç°äº†é”™åºã€‚**

å¯¹äºæŸäº›åº”ç”¨æ¥è¯´ï¼Œé¡ºåºæ€§éå¸¸é‡è¦ ï¼Œæ¯”å¦‚MySQL binlogçš„ä¼ è¾“ï¼Œå¦‚æœå‡ºç°é”™è¯¯å°±ä¼šé€ æˆéå¸¸ä¸¥é‡çš„åæœï¼›ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨éœ€è¦ä¿è¯æ¶ˆæ¯é¡ºåºçš„åœºåˆå»ºè®®æŠŠå‚æ•°max.in.flight.requests.per.connection é…ç½®ä¸º1 ï¼Œè€Œä¸æ˜¯æŠŠretriesé…ç½®ä¸º0ï¼Œä¸è¿‡è¿™æ ·ä¹Ÿä¼šå½±å“æ•´ä½“çš„ååã€‚

* **compression.type**

è¿™ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šæ¶ˆæ¯çš„å‹ç¼©æ–¹å¼ï¼Œé»˜è®¤å€¼ä¸ºâ€œnone"ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä¸ä¼šè¢«å‹ç¼©ã€‚è¯¥å‚æ•°è¿˜å¯ä»¥é…ç½®ä¸º "gzip"ï¼Œ"snappy" å’Œ "lz4"ã€‚å¯¹æ¶ˆæ¯è¿›è¡Œå‹ç¼©å¯ä»¥æå¤§åœ°å‡å°‘ç½‘ç»œä¼ è¾“ã€é™ä½ç½‘ç»œI/Oï¼Œä»è€Œæé«˜æ•´ä½“çš„æ€§èƒ½ ã€‚æ¶ˆæ¯å‹ç¼©æ˜¯ä¸€ç§ä»¥æ—¶é—´æ¢ç©ºé—´çš„ä¼˜åŒ–æ–¹å¼ï¼Œå¦‚æœå¯¹æ—¶å»¶æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œåˆ™ä¸æ¨èå¯¹æ¶ˆæ¯è¿›è¡Œå‹ç¼©ï¼›

* **batch.size**

æ¯ä¸ªBatchè¦å­˜æ”¾batch.sizeå¤§å°çš„æ•°æ®åï¼Œæ‰å¯ä»¥å‘é€å‡ºå»ã€‚æ¯”å¦‚è¯´batch.sizeé»˜è®¤å€¼æ˜¯16KBï¼Œé‚£ä¹ˆé‡Œé¢å‡‘å¤Ÿ16KBçš„æ•°æ®æ‰ä¼šå‘é€ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæå‡batch.sizeçš„å¤§å°ï¼Œå¯ä»¥å…è®¸æ›´å¤šçš„æ•°æ®ç¼“å†²åœ¨recordAccumulatoré‡Œé¢ï¼Œé‚£ä¹ˆä¸€æ¬¡Requestå‘é€å‡ºå»çš„æ•°æ®é‡å°±æ›´å¤šäº†ï¼Œè¿™æ ·ååé‡å¯èƒ½ä¼šæœ‰æ‰€æå‡ã€‚ä½†æ˜¯batch.sizeä¹Ÿä¸èƒ½è¿‡å¤§ï¼Œè¦æ˜¯æ•°æ®è€æ˜¯ç¼“å†²åœ¨Batché‡Œè¿Ÿè¿Ÿä¸å‘é€å‡ºå»ï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯çš„å»¶è¿Ÿå°±ä¼šå¾ˆé«˜ã€‚ä¸€èˆ¬å¯ä»¥å°è¯•æŠŠè¿™ä¸ªå‚æ•°è°ƒèŠ‚å¤§äº›ï¼Œåˆ©ç”¨ç”Ÿäº§ç¯å¢ƒå‘æ¶ˆæ¯è´Ÿè½½æµ‹è¯•ä¸€ä¸‹ã€‚

* **linger.ms**

è¿™ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šç”Ÿäº§è€…å‘é€ ProducerBatch ä¹‹å‰ç­‰å¾…æ›´å¤šæ¶ˆæ¯ï¼ˆ ProducerRecord ï¼‰åŠ å…¥

ProducerBatch æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º0ã€‚ç”Ÿäº§è€…å®¢æˆ·ç«¯ä¼šåœ¨ProducerBatchå¡«æ»¡æˆ–ç­‰å¾…æ—¶é—´è¶…è¿‡linger.ms å€¼æ—¶å‘é€å‡ºå»ã€‚

> **å¢å¤§è¿™ä¸ªå‚æ•°çš„å€¼ä¼šå¢åŠ æ¶ˆæ¯çš„å»¶è¿Ÿï¼Œä½†æ˜¯åŒæ—¶èƒ½æå‡ä¸€å®šçš„ååé‡ã€‚&#x20;**



![](images/image-12.png)

![](images/image-34.png)

* **enable.idempotence   å¹‚ç­‰æ€§&#x20;**

æ˜¯å¦å¼€å¯å¹‚ç­‰æ€§åŠŸèƒ½ï¼Œè¯¦è§åç»­åŸç†åŠ å¼ºï¼›

**å¹‚ç­‰æ€§ï¼Œå°±æ˜¯ä¸€ä¸ªæ“ä½œé‡å¤åšï¼Œä¹Ÿä¸ä¼šå½±å“æœ€ç»ˆçš„ç»“æœï¼**

int a = 1;

a++;  // éå¹‚ç­‰æ“ä½œ &#x20;

val map = new HashMap()

map.put(â€œaâ€,1);  // å¹‚ç­‰æ“ä½œ &#x20;

åœ¨kafkaä¸­ï¼ŒåŒä¸€æ¡æ¶ˆæ¯ï¼Œç”Ÿäº§è€…å¦‚æœå¤šæ¬¡é‡è¯•å‘é€ï¼Œåœ¨æœåŠ¡å™¨ä¸­çš„ç»“æœå¦‚æœè¿˜æ˜¯åªæœ‰ä¸€æ¡ï¼Œè¿™å°±æ˜¯å…·å¤‡å¹‚ç­‰æ€§ï¼›å¦åˆ™ï¼Œå°±ä¸å…·å¤‡å¹‚ç­‰æ€§ï¼

* **partitioner.class**

ç”¨æ¥æŒ‡å®šåˆ†åŒºå™¨ï¼Œé»˜è®¤ï¼šorg.apache.kafka.internals.DefaultPartitioner&#x20;

> é»˜è®¤åˆ†åŒºå™¨çš„åˆ†åŒºè§„åˆ™ï¼š &#x20;
>
> * å¦‚æœæ•°æ®ä¸­æœ‰keyï¼Œåˆ™æŒ‰keyçš„murmur hashå€¼ % topicåˆ†åŒºæ€»æ•°å¾—åˆ°ç›®æ ‡åˆ†åŒº
>
> * å¦‚æœæ•°æ®åªæœ‰valueï¼Œåˆ™åœ¨å„ä¸ªåˆ†åŒºé—´è½®è¯¢ï¼ˆè€ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬æ˜¯newå‡ºæ¥çš„ä¸€ä¸ªéšæœºæ•°ï¼‰

è‡ªå®šä¹‰partitioneréœ€è¦å®ç°org.apache.kafka.clients.producer.Partitioneræ¥å£

### ç»ƒä¸€ç»ƒï¼šå¦‚ä½•å®ç°ç²¾å‡†ä¸€æ¬¡æ€§æ¶ˆè´¹

å°†kafkaä¸­çš„æ•°æ®è¯»å‡ºæ¥ï¼Œå†™å…¥åˆ°mysqlä¸­

```java
package com.doit.day01;

import org.apache.kafka.clients.consumer.*;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.common.serialization.StringDeserializer;
import java.sql.*;
import java.time.Duration;
import java.util.Arrays;
import java.util.Collection;
import java.util.Properties;

public class KafkaToMysql {
    public static void main(String[] args) throws Exception {
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG,"doit03");
        props.setProperty(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,"false");
        props.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,"earliest");
        KafkaConsumer<String, String> consumer = new KafkaConsumer<String, String>(props);
        Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/test", "root", "123456");
        conn.setAutoCommit(false);

        PreparedStatement pps = conn.prepareStatement("insert into user_info  values(?,?,?)");
        PreparedStatement pps_off = conn.prepareStatement("insert into  t_offset values(?,?) on DUPLICATE key UPDATE offset = ?");
        PreparedStatement off = conn.prepareStatement("select offset from t_offset where topic_partition = ?");

//        consumer.subscribe(Arrays.asList("k2m1"));
        consumer.subscribe(Arrays.asList("k2m1"), new ConsumerRebalanceListener() {
            @Override
            public void onPartitionsRevoked(Collection<TopicPartition> partitions) {
            }
            @Override
            public void onPartitionsAssigned(Collection<TopicPartition> partitions) {
                try    {
                for (TopicPartition partition : partitions) {
                    int partition1 = partition.partition();
                    String topic = partition.topic();

                        off.setString(1,topic+"_"+partition1);
                        ResultSet resultSet = off.executeQuery();
                        while (resultSet.next()){
                            long offset = resultSet.getLong(1);
                            System.out.println("å‘ç”Ÿäº†æ¶ˆè´¹è€…å†å‡è¡¡äº†ï¼Œåˆ†åŒºå•¥çš„éƒ½é‡æ–°åˆ†é…äº†,æ–°çš„æ–¹æ¡ˆæ˜¯ï¼š"+topic+","+partition1);
                            consumer.seek(new TopicPartition(topic,partition1),offset);
                        }
                    }

                }catch (SQLException e) {
                    e.printStackTrace();
                }
            }
        });

        while (true){
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMinutes(Integer.MAX_VALUE));
            for (ConsumerRecord<String, String> record : records) {
                try {
                    String value = record.value();
                    String[] arr = value.split(",");
                    pps.setInt(1,Integer.parseInt(arr[0]));
                    pps.setString(2,arr[1]);
                    pps.setString(3,arr[2]);
                    pps.execute();

                    String topic = record.topic();
                    int partition = record.partition();
                    long offset = record.offset();
                    pps_off.setString(1,topic+"_"+partition);
                    pps_off.setLong(2,offset+1);
                    pps_off.setLong(3,offset+1);

//                    if (arr[0].equals("4")){
//                        throw new Exception("è‡ªå·±é€ äº†ä¸ªä¸€åœºæŠ›ä¸€ä¸‹");
//                    }
                    pps_off.execute();

                    //æäº¤äº‹åŠ¡
                    conn.commit();
                } catch (Exception e) {
                    e.printStackTrace();
                    //æœ‰å¼‚å¸¸äº†æˆ‘å°±å›æ»šäº‹åŠ¡
                    conn.rollback();
                }
            }
        }
    }
}
```

## **6.4æ¶ˆè´¹è€…ç»„å†å‡è¡¡åˆ†åŒºåˆ†é…ç­–ç•¥**

ä¼šè§¦å‘rebalanceï¼ˆæ¶ˆè´¹è€…ï¼‰çš„äº‹ä»¶å¯èƒ½æ˜¯å¦‚ä¸‹ä»»æ„ä¸€ç§ï¼š

* æœ‰æ–°çš„æ¶ˆè´¹è€…åŠ å…¥æ¶ˆè´¹ç»„ã€‚

* æœ‰æ¶ˆè´¹è€…å®•æœºä¸‹çº¿ï¼Œæ¶ˆè´¹è€…å¹¶ä¸ä¸€å®šéœ€è¦çœŸæ­£ä¸‹çº¿ï¼Œä¾‹å¦‚é‡åˆ°é•¿æ—¶é—´çš„ GC ã€ç½‘ç»œå»¶è¿Ÿå¯¼è‡´æ¶ˆè´¹è€…é•¿æ—¶é—´æœªå‘GroupCoordinatorå‘é€å¿ƒè·³ç­‰æƒ…å†µæ—¶ï¼ŒGroupCoordinator ä¼šè®¤ä¸ºæ¶ˆè´¹è€…å·±ä¸‹çº¿ã€‚

* æœ‰æ¶ˆè´¹è€…ä¸»åŠ¨é€€å‡ºæ¶ˆè´¹ç»„ï¼ˆå‘é€LeaveGroupRequest è¯·æ±‚ï¼‰ï¼šæ¯”å¦‚å®¢æˆ·ç«¯è°ƒç”¨äº†unsubscrible()æ–¹æ³•å–æ¶ˆå¯¹æŸäº›ä¸»é¢˜çš„è®¢é˜…ã€‚

* æ¶ˆè´¹ç»„æ‰€å¯¹åº”çš„ GroupCoorinatorèŠ‚ç‚¹å‘ç”Ÿäº†å˜æ›´ã€‚

* æ¶ˆè´¹ç»„å†…æ‰€è®¢é˜…çš„ä»»ä¸€ä¸»é¢˜æˆ–è€…ä¸»é¢˜çš„åˆ†åŒºæ•°é‡å‘ç”Ÿå˜åŒ–ã€‚

å°†åˆ†åŒºçš„æ¶ˆè´¹æƒä»ä¸€ä¸ªæ¶ˆè´¹è€…ç§»åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ç§°ä¸ºå†å‡è¡¡ï¼ˆrebalanceï¼‰ï¼Œå¦‚ä½•rebalanceä¹Ÿæ¶‰åŠåˆ°åˆ†åŒºåˆ†é…ç­–ç•¥ã€‚

kafkaæœ‰ä¸¤ç§çš„åˆ†åŒºåˆ†é…ç­–ç•¥ï¼šrangeï¼ˆé»˜è®¤ï¼‰ å’Œ roundrobinï¼ˆæ–°ç‰ˆæœ¬ä¸­åˆæ–°å¢äº†å¦å¤–2ç§ï¼‰

> æˆ‘ä»¬å¯ä»¥é€šè¿‡partition.assignment.strategyå‚æ•°é€‰æ‹© range æˆ– roundrobinã€‚
>
> partition.assignment.strategyå‚æ•°é»˜è®¤çš„å€¼æ˜¯rangeã€‚
>
> partition.assignment.strategy=org.apache.kafka.clients.consumer.RoundRobinAssignor
>
> partition.assignment.strategy=org.apache.kafka.clients.consumer.RangeAssignor

### **6.4.1Range Strategy**

* å…ˆå°†æ¶ˆè´¹è€…æŒ‰ç…§client.idå­—å…¸æ’åºï¼Œç„¶åæŒ‰topic**é€ä¸ª**å¤„ç†ï¼›

* é’ˆå¯¹ä¸€ä¸ªtopicï¼Œå°†å…¶partitionæ€»æ•°/æ¶ˆè´¹è€…æ•°å¾—åˆ°å•†nå’Œ ä½™æ•°mï¼Œåˆ™æ¯ä¸ªconsumerè‡³å°‘åˆ†åˆ°nä¸ªåˆ†åŒºï¼Œä¸”å‰mä¸ªconsumeræ¯äººå¤šåˆ†ä¸€ä¸ªåˆ†åŒºï¼›

> ä¸¾ä¾‹è¯´æ˜1ï¼šå‡è®¾æœ‰TOPIC\_Aæœ‰5ä¸ªåˆ†åŒºï¼Œç”±3ä¸ªconsumerï¼ˆC1,C2,C3ï¼‰æ¥æ¶ˆè´¹ï¼›5/3å¾—åˆ°å•†1ï¼Œä½™2ï¼Œåˆ™æ¯ä¸ªæ¶ˆè´¹è€…è‡³å°‘åˆ†1ä¸ªåˆ†åŒºï¼Œå‰ä¸¤ä¸ªæ¶ˆè´¹è€…å„å¤š1ä¸ªåˆ†åŒºC1: 2ä¸ªåˆ†åŒºï¼ŒC2:2ä¸ªåˆ†åŒº,C3:1ä¸ªåˆ†åŒº
>
> æ¥ä¸‹æ¥ï¼Œå°±æŒ‰ç…§â€œåŒºé—´â€è¿›è¡Œåˆ†é…ï¼š
>
> TOPIC\_A-0  TOPIC\_A-1   TOPIC\_A-2  TOPIC\_A\_3   TOPIC\_A-4
>
> C1:   TOPIC\_A-0  TOPIC\_A-1 &#x20;
>
> C2 :   TOPIC\_A-2  TOPIC\_A\_3
>
> C3:   TOPIC\_A-4

> ä¸¾ä¾‹è¯´æ˜2ï¼šå‡è®¾TOPIC\_Aæœ‰5ä¸ªåˆ†åŒºï¼ŒTOPIC\_Bæœ‰3ä¸ªåˆ†åŒºï¼Œç”±2ä¸ªconsumerï¼ˆC1,C2ï¼‰æ¥æ¶ˆè´¹
>
> * å…ˆåˆ†é…TOPIC\_Aï¼š
>
> 5/2å¾—åˆ°å•†2ï¼Œä½™1ï¼Œåˆ™C1æœ‰3ä¸ªåˆ†åŒºï¼ŒC2æœ‰2ä¸ªåˆ†åŒºï¼Œå¾—åˆ°ç»“æœ
>
> C1: TOPIC\_A-0   TOPIC\_A-1  TOPIC\_A-2
>
> C2: TOPIC\_A-3   TOPIC\_A-4
>
> * å†åˆ†é…TOPIC\_B
>
> 3/2å¾—åˆ°å•†1ï¼Œä½™1ï¼Œåˆ™C1æœ‰2ä¸ªåˆ†åŒºï¼ŒC2æœ‰1ä¸ªåˆ†åŒºï¼Œå¾—åˆ°ç»“æœ
>
> C1: TOPIC\_B-0  TOPIC\_B-1
>
> C2: TOPIC\_B-2
>
> * æœ€ç»ˆåˆ†é…ç»“æœï¼š
>
> C1: TOPIC\_A-0   TOPIC\_A-1  TOPIC\_A-2   TOPIC\_B-0  TOPIC\_B-1
>
> C2: TOPIC\_A-3   TOPIC\_A-4  TOPIC\_B-2

### **6.4.2Round-Robin Strategy**

* å°†æ‰€æœ‰ä¸»é¢˜åˆ†åŒºç»„æˆTopicAndPartitionåˆ—è¡¨ï¼Œå¹¶å¯¹TopicAndPartitionåˆ—è¡¨æŒ‰ç…§å…¶hashCode æ’åº

* ç„¶åï¼Œä»¥è½®è¯¢çš„æ–¹å¼åˆ†é…ç»™å„æ¶ˆè´¹è€…

> ä»¥ä¸Šè¿°â€œä¾‹2â€æ¥ä¸¾ä¾‹ï¼š
>
> * å…ˆå¯¹TopicPartitionçš„hashCodeæ’åºï¼Œå‡å¦‚æ’åºç»“æœå¦‚ä¸‹ï¼š
>
> TOPIC\_A-0  TOPIC\_B-0  TOPIC\_A-1  TOPIC\_A-2   TOPIC\_B-1 TOPIC\_A-3  TOPIC\_A-4  TOPIC\_B-2
>
> * ç„¶åæŒ‰è½®è¯¢æ–¹å¼åˆ†é…
>
> C1:  TOPIC\_A-0  TOPIC\_A-1  TOPIC\_B-1 &#x20;
>
> C2:  TOPIC\_B-0  TOPIC\_A-2  TOPIC\_A-3 &#x20;
>
> C3 TOPIC\_A-4

### **6.4.3Sticky Strategy**

å¯¹åº”çš„ç±»å«åšï¼š org.apache.kafka.clients.consumer.StickyAssignor

stickyç­–ç•¥çš„ç‰¹ç‚¹ï¼š

* è¦å»è¾¾æˆæœ€å¤§åŒ–çš„å‡è¡¡

* å°½å¯èƒ½ä¿ç•™å„æ¶ˆè´¹è€…åŸæ¥åˆ†é…çš„åˆ†åŒº

å†å‡è¡¡çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯ä¼šè®©å„æ¶ˆè´¹è€…å…ˆå–æ¶ˆè‡ªèº«çš„åˆ†åŒºï¼Œç„¶åå†é‡æ–°åˆ†é…ï¼ˆåªä¸è¿‡æ˜¯åˆ†é…è¿‡ç¨‹ä¸­ä¼šå°½é‡è®©åŸæ¥å±äºè°çš„åˆ†åŒºä¾ç„¶åˆ†é…ç»™è°ï¼‰

### **6.4.4Cooperative Sticky Strategy**

å¯¹åº”çš„ç±»å«åšï¼š org.apache.kafka.clients.consumer.ConsumerPartitionAssignor

stickyç­–ç•¥çš„ç‰¹ç‚¹ï¼š

* é€»è¾‘ä¸stickyç­–ç•¥ä¸€è‡´

* æ”¯æŒcooperativeå†å‡è¡¡æœºåˆ¶ï¼ˆå†å‡è¡¡çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè®©æ‰€æœ‰æ¶ˆè´¹è€…å–æ¶ˆæ‰æ‰€æœ‰åˆ†åŒºç„¶åå†è¿›è¡Œé‡åˆ†é…ï¼‰

## **6.5æ¶ˆè´¹è€…ç»„å†å‡è¡¡æµç¨‹**

æ¶ˆè´¹ç»„åœ¨æ¶ˆè´¹æ•°æ®çš„æ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªè§’è‰²è¿›è¡Œç»„å†…çš„å„äº‹åŠ¡çš„åè°ƒï¼›

è§’è‰²1ï¼š Group Coordinator ï¼ˆç»„åè°ƒå™¨ï¼‰ ä½äºæœåŠ¡ç«¯ï¼ˆå°±æ˜¯æŸä¸ªbrokerï¼‰

**ç»„åè°ƒå™¨çš„å®šä½ï¼š**

```plain&#x20;text
coordinatoråœ¨æˆ‘ä»¬ç»„è®°åç§»é‡çš„__consumer_offsetsåˆ†åŒºçš„leaderæ‰€åœ¨brokerä¸Š
æŸ¥æ‰¾Group Coordinatorçš„æ–¹å¼ï¼š
å…ˆæ ¹æ®æ¶ˆè´¹ç»„groupidçš„hashcodeå€¼è®¡ç®—å®ƒåº”è¯¥æ‰€åœ¨__consumer_offsets ä¸­çš„åˆ†åŒºç¼–å·ï¼›   åˆ†åŒºæ•°
Utils.abs(groupId.hashCode) % groupMetadataTopicPartitionCount
groupMetadataTopicPartitionCountä¸º__consumer_offsetsçš„åˆ†åŒºæ€»æ•°ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡brokerç«¯å‚æ•°offset.topic.num.partitionsæ¥é…ç½®ï¼Œé»˜è®¤å€¼æ˜¯50ï¼›
æ‰¾åˆ°å¯¹åº”çš„åˆ†åŒºå·åï¼Œå†å¯»æ‰¾æ­¤åˆ†åŒºleaderå‰¯æœ¬æ‰€åœ¨brokerèŠ‚ç‚¹ï¼Œåˆ™æ­¤èŠ‚ç‚¹å³ä¸ºè‡ªå·±çš„Grouping Coordinatorï¼›
```

è§’è‰²2ï¼š Group Leader ï¼ˆç»„é•¿ï¼‰ ä½äºæ¶ˆè´¹ç«¯ï¼ˆå°±æ˜¯æ¶ˆè´¹ç»„ä¸­çš„æŸä¸ªæ¶ˆè´¹è€…ï¼‰

> **ç»„é•¿çš„å®šä½ï¼šéšæœºé€‰çš„å“¦ï¼ï¼ï¼**

### 6.5.1**GroupCoordinatorä»‹ç»**

æ¯ä¸ªæ¶ˆè´¹ç»„åœ¨æœåŠ¡ç«¯å¯¹åº”ä¸€ä¸ªGroupCoordinatorå…¶è¿›è¡Œç®¡ç†ï¼ŒGroupCoordinatoræ˜¯KafkaæœåŠ¡ç«¯ä¸­ç”¨äºç®¡ç†æ¶ˆè´¹ç»„çš„ç»„ä»¶ã€‚

æ¶ˆè´¹è€…å®¢æˆ·ç«¯ä¸­ç”±ConsumerCoordinatorç»„ä»¶è´Ÿè´£ä¸GroupCoordinatorè¡Œäº¤äº’ï¼›

ConsumerCoordinatorå’ŒGroupCoordinatoræœ€é‡è¦çš„èŒè´£å°±æ˜¯è´Ÿè´£æ‰§è¡Œæ¶ˆè´¹è€…rebalanceæ“ä½œ

### **6.5.2å†å‡è¡¡æµç¨‹**

eageråè®®çš„å†å‡è¡¡è¿‡ç¨‹æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

![](images/image-29.png)



> ç‰¹ç‚¹ï¼šå†å‡è¡¡å‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½ä¼šåœæ­¢å·¥ä½œï¼Œç­‰å¾…æ–°æ–¹æ¡ˆçš„åŒæ­¥

Cooperativeåè®®çš„å†å‡è¡¡è¿‡ç¨‹æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

![](images/image-31.png)

> ç‰¹ç‚¹ï¼šcooperativeæŠŠåŸæ¥eageråè®®çš„ä¸€æ¬¡æ€§å…¨å±€å†å‡è¡¡ï¼ŒåŒ–è§£æˆäº†å¤šæ¬¡çš„å°å‡è¡¡ï¼Œå¹¶æœ€ç»ˆè¾¾åˆ°å…¨å±€å‡è¡¡çš„æ”¶æ•›çŠ¶æ€

### 6.5.3**å†å‡è¡¡ç›‘å¬å™¨**

å¦‚æœæƒ³æ§åˆ¶æ¶ˆè´¹è€…åœ¨å‘ç”Ÿå†å‡è¡¡æ—¶æ‰§è¡Œä¸€äº›ç‰¹å®šçš„å·¥ä½œï¼Œå¯ä»¥é€šè¿‡è®¢é˜…ä¸»é¢˜æ—¶æ³¨å†Œâ€œå†å‡è¡¡ç›‘å¬å™¨â€æ¥å®ç°ï¼›

åœºæ™¯ä¸¾ä¾‹ï¼šåœ¨å‘ç”Ÿå†å‡è¡¡æ—¶ï¼Œå¤„ç†æ¶ˆè´¹ä½ç§»

å¦‚æœAæ¶ˆè´¹è€…æ¶ˆè´¹æ‰çš„ä¸€æ‰¹æ¶ˆæ¯è¿˜æ²¡æ¥å¾—åŠæäº¤offsetï¼Œè€Œå®ƒæ‰€è´Ÿè´£çš„åˆ†åŒºåœ¨rebalanceä¸­è½¬ç§»ç»™äº†Bæ¶ˆè´¹è€…ï¼Œåˆ™æœ‰å¯èƒ½å‘ç”Ÿæ•°æ®çš„é‡å¤æ¶ˆè´¹å¤„ç†ã€‚æ­¤æƒ…å½¢ä¸‹ï¼Œå¯ä»¥é€šè¿‡å†å‡è¡¡ç›‘å¬å™¨åšä¸€å®šç¨‹åº¦çš„è¡¥æ•‘ï¼›

ä»£ç ç¤ºä¾‹ï¼š

```java
package com.doitedu;

import org.apache.kafka.clients.consumer.*;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.common.header.Headers;
import org.apache.kafka.common.record.TimestampType;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.Arrays;
import java.util.Collection;
import java.util.Optional;
import java.util.Properties;


/**
 * æ¶ˆè´¹ç»„å†å‡è¡¡è§‚å¯Ÿ
 */

public class ConsumerDemo2 {
    public static void main(String[] args) {
        //1.åˆ›å»ºkafkaçš„æ¶ˆè´¹è€…å¯¹è±¡ï¼Œé™„å¸¦ç€æŠŠé…ç½®æ–‡ä»¶æå®š
        Properties props = new Properties();
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092,linux02:9092,linux03:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG,"g01");
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

        //2.è®¢é˜…ä¸»é¢˜(ç¡®å®šéœ€è¦æ¶ˆè´¹å“ªä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»é¢˜)
        //æˆ‘ç°åœ¨æƒ³çœ‹çœ‹å¦‚æœæˆ‘çš„æ¶ˆè´¹è€…ç»„é‡Œé¢ï¼Œå¤šäº†ä¸€ä¸ªæ¶ˆè´¹è€…æˆ–è€…å°‘äº†ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä»–æœ‰æ²¡æœ‰ç»™æˆ‘åšå†å‡è¡¡
        consumer.subscribe(Arrays.asList("reb-1", "reb-2"), new ConsumerRebalanceListener() {
            /**
             * è¿™ä¸ªæ–¹æ³•æ˜¯å°†åŸæ¥çš„åˆ†é…æƒ…å†µå…¨éƒ¨å–æ¶ˆï¼Œæˆ–è€…è¯´æŠŠæ‰€æœ‰çš„åˆ†åŒºå…¨éƒ¨å›æ”¶äº†
             * è¿™ä¸ªå…¨éƒ¨å–æ¶ˆå¾ˆæ¶å¿ƒï¼ŒåŸæ¥çš„æ¶ˆè´¹è€…æ¶ˆè´¹çš„å¥½å¥½çš„ï¼Œä»–ä¸€ä¸‹å­å°±ç»™ä»–å…¨éƒ¨åœæ‰äº†
             * @param collection
             */
            @Override
            public void onPartitionsRevoked(Collection<TopicPartition> collection) {
                System.out.println("æˆ‘åŸæ¥çš„å‡è¡¡æƒ…å†µæ˜¯ï¼š"+collection + "æˆ‘å·²ç»è¢«å›æ”¶äº†ï¼ï¼");
            }
            /**
             * è¿™ä¸ªæ–¹æ³•æ˜¯å½“ä¸Šé¢çš„åˆ†é…æƒ…å†µå…¨éƒ¨å–æ¶ˆä»¥åï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ¥å†æ¬¡åˆ†é…ï¼Œè¿™æ˜¯åœ¨å‡è¡¡åˆ†é…åçš„æƒ…å†µ
             * @param collection
             */
            @Override
            public void onPartitionsAssigned(Collection<TopicPartition> collection) {
                System.out.println("æˆ‘æ˜¯é‡æ–°åˆ†é…åçš„ç»“æœï¼š"+collection);
            }
        });

        while (true){
            consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
        }


    }
}
```

## 6.6**kafkaç³»ç»Ÿçš„CAPä¿è¯**

CAPç†è®ºä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€ç†è®º,å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ä¸­ï¼š

* ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰

* å¯ç”¨æ€§ï¼ˆAvailability)&#x20;

* åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰

æœ€å¤šæ»¡è¶³å…¶ä¸­çš„ä¸¤ä¸ªç‰¹æ€§ã€‚ä¹Ÿå°±æ˜¯ä¸‹å›¾æ‰€æè¿°çš„ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿè¦ä¹ˆæ»¡è¶³CAï¼Œè¦ä¹ˆCPï¼Œè¦ä¹ˆAPã€‚æ— æ³•åŒæ—¶æ»¡è¶³CAPã€‚

**åˆ†åŒºå®¹é”™æ€§**ï¼šæŒ‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹æˆ–è€…ç½‘ç»œåˆ†åŒºå‡ºç°äº†æ•…éšœçš„æ—¶å€™ï¼Œæ•´ä¸ªç³»ç»Ÿä»ç„¶èƒ½å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´éƒ¨åˆ†æ•…éšœä¸å½±å“æ•´ä½“ä½¿ç”¨ã€‚äº‹å®ä¸Šæˆ‘ä»¬åœ¨è®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶éƒ½ä¼šè€ƒè™‘åˆ°bug,ç¡¬ä»¶ï¼Œç½‘ç»œç­‰å„ç§åŸå› é€ æˆçš„æ•…éšœï¼Œæ‰€ä»¥å³ä½¿éƒ¨åˆ†èŠ‚ç‚¹æˆ–è€…ç½‘ç»œå‡ºç°æ•…éšœï¼Œæˆ‘ä»¬è¦æ±‚æ•´ä¸ªç³»ç»Ÿè¿˜æ˜¯è¦ç»§ç»­ä½¿ç”¨çš„(ä¸ç»§ç»­ä½¿ç”¨,ç›¸å½“äºåªæœ‰ä¸€ä¸ªåˆ†åŒº,é‚£ä¹ˆä¹Ÿå°±æ²¡æœ‰åç»­çš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§äº†)

**å¯ç”¨æ€§ï¼š**&#x4E00;ç›´å¯ä»¥æ­£å¸¸çš„åšè¯»å†™æ“ä½œã€‚ç®€å•è€Œè¨€å°±æ˜¯å®¢æˆ·ç«¯ä¸€ç›´å¯ä»¥æ­£å¸¸è®¿é—®å¹¶å¾—åˆ°ç³»ç»Ÿçš„æ­£å¸¸å“åº”ã€‚ç”¨æˆ·è§’åº¦æ¥çœ‹å°±æ˜¯ä¸ä¼šå‡ºç°ç³»ç»Ÿæ“ä½œå¤±è´¥æˆ–è€…è®¿é—®è¶…æ—¶ç­‰é—®é¢˜ã€‚

**ä¸€è‡´æ€§**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå®ŒæˆæŸå†™æ“ä½œåä»»ä½•è¯»æ“ä½œï¼Œéƒ½åº”è¯¥è·å–åˆ°è¯¥å†™æ“ä½œå†™å…¥çš„é‚£ä¸ªæœ€æ–°çš„å€¼ã€‚ç›¸å½“äºè¦æ±‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å„èŠ‚ç‚¹æ—¶æ—¶åˆ»åˆ»ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚

> Kafka ä½œä¸ºä¸€ä¸ªå•†ä¸šçº§æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ•°æ®å¯é æ€§å’Œå¯ç”¨æ€§æ˜¯ä¼˜å…ˆè€ƒè™‘çš„é‡ç‚¹ï¼Œå…¼é¡¾æ•°æ®ä¸€è‡´æ€§ï¼›
>
> å‚è€ƒæ–‡æ¡£ï¼šhttps://www.cnblogs.com/lilpig/p/16840963.html

### **6.6.1åˆ†åŒºå‰¯æœ¬æœºåˆ¶**

**kafka ä» 0.8.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†åˆ†åŒºå‰¯æœ¬**ï¼›**å¼•å…¥äº†æ•°æ®å†—ä½™**

ç”¨CAPç†è®ºæ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡å‰¯æœ¬åŠå‰¯æœ¬leaderåŠ¨æ€é€‰ä¸¾æœºåˆ¶æé«˜äº†kafkaçš„ **åˆ†åŒºå®¹é”™æ€§**å’Œ**å¯ç”¨æ€§**

ä½†ä»è€Œä¹Ÿå¸¦æ¥äº†æ•°æ®ä¸€è‡´æ€§çš„å·¨å¤§å›°éš¾ï¼

**6.6.2åˆ†åŒºå‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§å›°éš¾**

kafkaè®©åˆ†åŒºå¤šå‰¯æœ¬åŒæ­¥çš„åŸºæœ¬æ‰‹æ®µæ˜¯ï¼š followerå‰¯æœ¬å®šæœŸå‘leaderè¯·æ±‚æ•°æ®åŒæ­¥ï¼

æ—¢ç„¶æ˜¯å®šæœŸåŒæ­¥ï¼Œåˆ™leaderå’Œfollowerä¹‹é—´å¿…ç„¶å­˜åœ¨å„ç§æ•°æ®ä¸ä¸€è‡´çš„æƒ…æ™¯ï¼

* **é—®é¢˜1ï¼šåˆ†åŒºå‰¯æœ¬é—´åŠ¨æ€ä¸ä¸€è‡´**

![](images/image-20.png)

* **é—®é¢˜2ï¼šæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´**

å¦‚æœæ­¤æ—¶leaderå®•æœºï¼Œfollower1æˆ–follower2è¢«é€‰ä¸ºæ–°çš„leaderï¼Œåˆ™leaderæ¢å±Šå‰åï¼Œæ¶ˆè´¹è€…æ‰€èƒ½è¯»å–åˆ°çš„æ•°æ®å‘ç”Ÿäº†ä¸ä¸€è‡´ï¼›

![](images/image-28.png)

* **é—®é¢˜3ï¼šåˆ†åŒºå‰¯æœ¬é—´æœ€ç»ˆä¸ä¸€è‡´**

![](images/image-21.png)

### **6.6.2ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼ˆHWï¼‰  high watermark  é«˜æ°´ä½çº¿**

åŠ¨æ€è¿‡ç¨‹ä¸­çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´ï¼Œæ˜¯å¾ˆéš¾è§£å†³çš„ï¼›

kafkaå…ˆå°è¯•ç€è§£å†³ä¸Šè¿°â€œæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´â€åŠâ€œå‰¯æœ¬é—´æ•°æ®æœ€ç»ˆä¸ä¸€è‡´â€çš„é—®é¢˜ï¼›

> è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³
>
> * åœ¨åŠ¨æ€ä¸ä¸€è‡´çš„è¿‡ç¨‹ä¸­ï¼Œç»´æŠ¤ä¸€æ¡æ­¥è¿›å¼çš„â€œä¸´æ—¶ä¸€è‡´çº¿â€(æ—¢æ‰€è°“çš„High Watermark)ï¼›é«˜æ°´ä½çº¿
>
> * é«˜æ°´ä½çº¿HW = ISRå‰¯æœ¬ä¸­æœ€å°LEO(å‰¯æœ¬çš„æœ€å¤§æ¶ˆæ¯åç§»é‡+1)ï¼›&#x20;
>
> * åº•å±‚é€»è¾‘å°±æ˜¯ï¼šoffset\<HWçš„messageï¼Œæ˜¯å„å‰¯æœ¬é—´ä¸€è‡´çš„ä¸”å®‰å…¨çš„ï¼

* **è§£å†³â€œæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´â€ ï¼ˆæ¶ˆè´¹è€…åªå…è®¸çœ‹åˆ°HWä»¥ä¸‹çš„messageï¼‰**

* **è§£å†³â€œåˆ†åŒºå‰¯æœ¬æ•°æ®æœ€ç»ˆä¸ä¸€è‡´â€ ï¼ˆfolloweræ•°æ®æŒ‰HWæˆªæ–­ï¼‰**

![](images/image-22.png)

### **6.6.3HWæ–¹æ¡ˆçš„å¤©ç”Ÿç¼ºé™·**

å¦‚å‰æ‰€è¿°ï¼Œçœ‹ä¼¼HWè§£å†³äº†â€œåˆ†åŒºæ•°æ®æœ€ç»ˆä¸ä¸€è‡´â€çš„é—®é¢˜ï¼Œä»¥åŠâ€œæ¶ˆè´¹è€…æ‰€è§ä¸ä¸€è‡´â€çš„é—®é¢˜ï¼Œä½†å…¶å®ï¼Œè¿™é‡Œé¢å­˜åœ¨ä¸€ä¸ªå·¨å¤§çš„éšæ‚£ï¼Œå¯¼è‡´ï¼š

* â€œåˆ†åŒºæ•°æ®æœ€ç»ˆä¸ä¸€è‡´â€çš„é—®é¢˜ä¾ç„¶å­˜åœ¨

* producerè®¾ç½®acks=allåï¼Œä¾ç„¶æœ‰å¯èƒ½ä¸¢å¤±æ•°æ®çš„é—®é¢˜

> äº§ç”Ÿå¦‚ä¸Šç»“æœçš„æ ¹æºæ˜¯ï¼šHWé«˜æ°´ä½çº¿çš„æ›´æ–°ï¼Œä¸æ•°æ®åŒæ­¥çš„è¿›åº¦ï¼Œå­˜åœ¨è¿Ÿæ»ï¼

**ç¬¬ä¸€æ¬¡fetchè¯·æ±‚**ï¼Œåˆ†leaderç«¯å’Œfollowerç«¯ï¼š

leaderç«¯ï¼š

1. è¯»å–åº•å±‚logæ•°æ®ã€‚

2. æ ¹æ®fetchå¸¦è¿‡æ¥çš„offset=0çš„æ•°æ®ï¼ˆå°±æ˜¯followerçš„LEOï¼Œå› ä¸ºfollowerè¿˜æ²¡æœ‰å†™å…¥æ•°æ®ï¼Œå› æ­¤LEO=0ï¼‰ï¼Œæ›´æ–°remote LEOä¸º0ã€‚

3. ä¸€è½®ç»“æŸåå°è¯•æ›´æ–°HWï¼Œåšmin(leader LEO,remote LEO)çš„è®¡ç®—ï¼Œç»“æœä¸º0ã€‚

4. æŠŠè¯»å–åˆ°çš„ä¸‰æ¡logæ•°æ®ï¼ŒåŠ ä¸Šleader HW=0ï¼Œä¸€èµ·å‘ç»™followerå‰¯æœ¬ã€‚

followerç«¯ï¼š

1. å†™å…¥æ•°æ®åˆ°logæ–‡ä»¶ï¼Œæ›´æ–°è‡ªå·±çš„LEO=3ã€‚

2. æ›´æ–°HWï¼Œåšmin(leader HW,follower LEO)çš„è®¡ç®—ï¼Œç”±äºleader HW=0ï¼Œå› æ­¤æ›´æ–°åHW=0ã€‚

å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€æ¬¡fetchè¯·æ±‚åï¼Œleaderå’Œfolloweréƒ½æˆåŠŸå†™å…¥äº†ä¸‰æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯HWéƒ½ä¾ç„¶æ˜¯0ï¼Œå¯¹æ¶ˆè´¹è€…æ¥è¯´éƒ½æ˜¯ä¸å¯è§çš„ï¼Œè¿˜éœ€è¦ç¬¬äºŒæ¬¡fetchè¯·æ±‚ã€‚

**ç¬¬äºŒæ¬¡fetchè¯·æ±‚**ï¼Œåˆ†leaderç«¯å’Œfollowerç«¯ï¼š

leaderç«¯ï¼š

1. è¯»å–åº•å±‚logæ•°æ®ã€‚

2. æ ¹æ®fetchå¸¦è¿‡æ¥çš„offset=3çš„æ•°æ®ï¼ˆä¸Šä¸€æ¬¡è¯·æ±‚å†™å…¥äº†æ•°æ®ï¼Œå› æ­¤LEO=3ï¼‰ï¼Œæ›´æ–°remote LEOä¸º3ã€‚

3. å°è¯•æ›´æ–°HWï¼Œåšmin(leader LEO,remote LEO)çš„è®¡ç®—ï¼Œç»“æœä¸º3ã€‚

4. æŠŠè¯»å–åˆ°çš„logæ•°æ®ï¼ˆå…¶å®æ²¡æœ‰æ•°æ®ï¼‰ï¼ŒåŠ ä¸Šleader HW=3ï¼Œä¸€èµ·å‘ç»™followerå‰¯æœ¬ã€‚

followerç«¯ï¼š

1. å†™å…¥æ•°æ®åˆ°logæ–‡ä»¶ï¼Œæ²¡æœ‰æ•°æ®å¯ä»¥å†™ï¼ŒLEOä¾ç„¶æ˜¯3ã€‚

2. æ›´æ–°HWï¼Œåšmin(leader HW,follower LEO)çš„è®¡ç®—ï¼Œç”±äºleader HW=3ï¼Œå› æ­¤æ›´æ–°åHW=3ã€‚

è¿™ä¸ªæ—¶å€™ï¼Œæ‰å®Œæˆæ•°æ®çš„å†™å…¥ï¼Œå¹¶ä¸”åˆ†åŒºHWï¼ˆåˆ†åŒºHWæŒ‡çš„å°±æ˜¯leaderå‰¯æœ¬çš„HWï¼‰æ›´æ–°ä¸º3ï¼Œä»£è¡¨æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹offset=0,1,2çš„ä¸‰æ¡æ¶ˆæ¯äº†ï¼Œä¸Šé¢çš„è¿‡ç¨‹å°±æ˜¯kafkaå¤„ç†æ¶ˆæ¯å†™å…¥å’Œå¤‡ä»½çš„å…¨æµç¨‹ã€‚

> ä»ä»¥ä¸Šæ­¥éª¤å¯çœ‹å‡ºï¼Œleader ä¸­ä¿å­˜çš„ remote LEO å€¼çš„æ›´æ–°ï¼ˆä¹Ÿå³HWçš„æ›´æ–°ï¼‰æ€»æ˜¯éœ€è¦é¢å¤–ä¸€è½® fetch RPC è¯·æ±‚æ‰ èƒ½å®Œæˆï¼Œè¿™æ„å‘³ç€åœ¨ leader åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œä¼šå­˜åœ¨æ•°æ®ä¸¢å¤±ä»¥åŠæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼

### **6.6.4HWä¼šäº§ç”Ÿæ•°æ®ä¸¢å¤±å’Œå‰¯æœ¬æœ€ç»ˆä¸ä¸€è‡´é—®é¢˜**

> **æ•°æ®ä¸¢å¤±çš„é—®é¢˜ï¼ˆå³ä½¿produceè®¾ç½®acks=allï¼Œä¾ç„¶ä¼šå‘ç”Ÿï¼‰**

![](images/image-23.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š

* çŠ¶æ€èµ·å§‹ï¼šæœ€æ–°æ¶ˆæ¯cå·²åŒæ­¥ï¼Œä½†æ˜¯æ°´ä½çº¿è¿˜æ²¡å¼€å§‹åŒæ­¥

* &#x20;åœ¨æ­¤æ—¶leaderå´©æºƒï¼ˆå³ follower æ²¡èƒ½é€šè¿‡ä¸‹ä¸€è½®è¯·æ±‚æ¥æ›´æ–° HW å€¼ï¼‰

* followeræˆä¸ºäº†leaderï¼Œä¼šè‡ªåŠ¨å°† LEO å€¼è°ƒæ•´åˆ°ä¹‹å‰çš„ HW å€¼ï¼Œå³ä¼šè¿›è¡Œæ—¥å¿—æˆªæ–­

* ç„¶åï¼ŒåŸæ¥çš„leaderé‡å¯ä¸Šçº¿ï¼Œä¼šå‘æ–°çš„leaderå‘é€è¯·æ±‚è¯·æ±‚ï¼Œæ”¶åˆ° fetch å“åº”åï¼Œæ‹¿åˆ° HW å€¼ï¼Œå¹¶æ›´æ–°æœ¬åœ° HW å€¼ï¼Œå‘ç°æˆ‘ä¹Ÿè¦æˆªå–ï¼Œæ‚²å‰§å‘ç”Ÿäº†ï¼Œæ•°æ®ä¸¢äº†

> **å‰¯æœ¬é—´æ•°æ®æœ€ç»ˆä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå³ä½¿produceè®¾ç½®acks=allï¼Œä¾ç„¶ä¼šå‘ç”Ÿï¼‰**

![](images/image-30.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š

* çŠ¶æ€èµ·å§‹ï¼šæœ€æ–°æ¶ˆæ¯cå·²åŒæ­¥ï¼Œä½†æ˜¯æ°´ä½çº¿è¿˜æ²¡å¼€å§‹åŒæ­¥

* &#x20;åœ¨æ­¤æ—¶leaderå´©æºƒï¼ˆå³ follower æ²¡èƒ½é€šè¿‡ä¸‹ä¸€è½®è¯·æ±‚æ¥æ›´æ–° HW å€¼ï¼‰

* followeræˆä¸ºäº†leaderï¼Œä¼šè‡ªåŠ¨å°† LEO å€¼è°ƒæ•´åˆ°ä¹‹å‰çš„ HW å€¼ï¼Œå³ä¼šè¿›è¡Œæ—¥å¿—æˆªæ–­

* åœ¨æˆªæ–­æ—¥å¿—ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªdè¢«æˆªæ–­äº†ä¹‹åï¼Œæˆ‘åˆåŠ äº†ä¸€æ¡æ•°æ®æ˜¯e

* ç„¶åï¼ŒåŸæ¥çš„leaderé‡å¯ä¸Šçº¿ï¼Œä¼šå‘æ–°çš„leaderå‘é€è¯·æ±‚è¯·æ±‚ï¼Œæ”¶åˆ° fetch å“åº”åï¼Œæ‹¿åˆ° HW å€¼ï¼Œå¹¶æ›´æ–°æœ¬åœ° HW å€¼ï¼Œå‘ç°æˆ‘çš„æ•°æ®å’Œleaderçš„æ•°æ®ä¸€æ ·ï¼Œå¥½çš„ï¼Œæˆ‘å°±ä¸ç”¨æˆªå–äº†ï¼Œæˆ‘æ›´æ–°HWå°±å¥½äº†ï¼Œå°±è¿™æ ·ï¼Œä¸€ä¸ªæ–°çš„æ‚²å‰§åˆå‘ç”Ÿäº†ï¼Œæ•°æ®ä¸ä¸€è‡´äº†

> *åªè¦æ–°ä¸€å±Šleaderåœ¨è€leaderé‡å¯ä¸Šçº¿å‰ï¼Œæ¥æ”¶äº†æ–°çš„æ•°æ®ï¼Œå°±å¯èƒ½å‘ç”Ÿä¸Šå›¾ä¸­çš„åœºæ™¯ï¼Œæ ¹æºä¹Ÿåœ¨äºHWçš„æ›´æ–°è½åäºæ•°æ®åŒæ­¥è¿›åº¦*

### **6.6.5Leader-Epochæœºåˆ¶çš„å¼•å…¥&#x20;**

ä¸ºäº†è§£å†³ HW æ›´æ–°æ—¶æœºæ˜¯å¼‚æ­¥å»¶è¿Ÿçš„ï¼Œè€Œ HW åˆæ˜¯å†³å®šæ—¥å¿—æ˜¯å¦å¤‡ä»½æˆåŠŸçš„æ ‡å¿—ï¼Œä»è€Œé€ æˆæ•°æ®ä¸¢å¤±å’Œæ•°æ®ä¸ä¸€è‡´çš„ç°è±¡ï¼ŒKafka å¼•å…¥äº† leader epoch æœºåˆ¶ï¼›

åœ¨æ¯ä¸ªå‰¯æœ¬æ—¥å¿—ç›®å½•ä¸‹éƒ½åˆ›å»ºä¸€ä¸ª leader-epoch-checkpoint æ–‡ä»¶ï¼Œç”¨äºä¿å­˜ leader çš„ epoch ä¿¡æ¯ï¼›

**leader-epochçš„å«ä¹‰**

å¦‚ä¸‹ï¼Œleader epoch é•¿è¿™æ ·ï¼š

![](images/image-24.png)

å®ƒçš„æ ¼å¼ä¸º (epoch offset)ï¼ŒepochæŒ‡çš„æ˜¯ leader ç‰ˆæœ¬ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„ä¸€ä¸ªæ­£æ•´æ•°å€¼ï¼Œæ¯æ¬¡ leader å˜æ›´ï¼Œepoch ç‰ˆæœ¬éƒ½ä¼š +1ï¼Œoffset æ˜¯æ¯ä¸€ä»£ leader å†™å…¥çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œæ¯”å¦‚ï¼š

(0,0)

(1,300)

ä»¥ä¸Šç¬¬2ä¸ªç‰ˆæœ¬æ˜¯ä»ä½ç§»300å¼€å§‹å†™å…¥æ¶ˆæ¯ï¼Œæ„å‘³ç€ç¬¬ä¸€ä¸ªç‰ˆæœ¬å†™å…¥äº† 0-299 çš„æ¶ˆæ¯ã€‚

**leader epoch å…·ä½“çš„å·¥ä½œæœºåˆ¶**

* å½“å‰¯æœ¬æˆä¸º leader æ—¶ï¼š

è¿™æ—¶ï¼Œå¦‚æœæ­¤æ—¶ç”Ÿäº§è€…æœ‰æ–°æ¶ˆæ¯å‘é€è¿‡æ¥ï¼Œä¼šé¦–å…ˆæ›´æ–°leader epoch ä»¥åŠLEO ï¼Œå¹¶æ·»åŠ åˆ° leader-epoch-checkpoint æ–‡ä»¶ä¸­ï¼›

* å½“å‰¯æœ¬å˜æˆ follower æ—¶ï¼š

å‘é€LeaderEpochRequestè¯·æ±‚ç»™leaderå‰¯æœ¬ï¼Œè¯¥è¯·æ±‚åŒ…æ‹¬äº†followerä¸­æœ€æ–°çš„epoch ç‰ˆæœ¬ï¼›

leaderè¿”å›ç»™followerçš„å“åº”ä¸­åŒ…å«äº†ä¸€ä¸ªLastOffsetï¼Œå¦‚æœ follower last epoch = leader last epochï¼ˆçºªå…ƒç›¸åŒï¼‰ï¼Œåˆ™ LastOffset = leader LEOï¼Œå¦åˆ™å–follower last epoch ä¸­æœ€å°çš„ leader epoch çš„ start offset å€¼ï¼›&#x20;

> ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾ follower last epoch = 1ï¼Œæ­¤æ—¶ leader æœ‰ (1, 20) (2, 80) (3, 120)ï¼Œåˆ™ LastOffset = 80ï¼›

follwer æ‹¿åˆ° LastOffset ä¹‹åï¼Œä¼šå¯¹æ¯”å½“å‰ LEO å€¼æ˜¯å¦å¤§äº LastOffsetï¼Œå¦‚æœå½“å‰ LEO å¤§äº LastOffsetï¼Œåˆ™ä» LastOffset æˆªæ–­æ—¥å¿—ï¼›

follower å¼€å§‹å‘é€ fetch è¯·æ±‚ç»™ leader ä¿æŒæ¶ˆæ¯åŒæ­¥ã€‚

**leader epoch å¦‚ä½•è§£å†³HWçš„å¤‡ä»½ç¼ºé™·**

* **è§£å†³æ•°æ®ä¸¢å¤±å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜**

![](images/image-25.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š

followerå½“é€‰leaderåï¼Œæ”¶åˆ°çºªå…ƒæ¶ˆæ¯ï¼Œå‘ç° LastOffsetç­‰äºå½“å‰ LEO å€¼ï¼Œæ•…ä¸ç”¨è¿›è¡Œæ—¥å¿—æˆªæ–­ã€‚

followeré‡å¯ååŒæ­¥æ¶ˆæ¯ï¼Œå‘ç°è‡ªå·±ä¹Ÿä¸ç”¨æˆªå–ï¼Œæ•°æ®ä¸€è‡´ï¼Œé½æ´»å„¿

å½“ç„¶ï¼Œå¦‚æœè¯´åæ¥å¢åŠ æ¶ˆæ¯ä»¥åï¼Œä¹Ÿä¸éœ€è¦æˆªå–ï¼Œç›´æ¥åŒæ­¥æ•°æ®å°±è¡Œ(å½“ack=-1)

### **6.6.6LEO/HW/LSOç­‰ç›¸å…³æœ¯è¯­é€ŸæŸ¥**

LEO:ï¼ˆlast end offsetï¼‰å°±æ˜¯è¯¥å‰¯æœ¬ä¸­æ¶ˆæ¯çš„æœ€å¤§åç§»é‡çš„å€¼+1 ï¼›

**HW:ï¼ˆhigh watermarkï¼‰å„å‰¯æœ¬ä¸­LEOçš„æœ€å°å€¼ã€‚è¿™ä¸ªå€¼è§„å®šäº†æ¶ˆè´¹è€…ä»…èƒ½æ¶ˆè´¹HWä¹‹å‰çš„æ•°æ®ï¼›**

LWï¼šï¼ˆlow watermarkï¼‰ä¸€ä¸ªå‰¯æœ¬çš„logä¸­ï¼Œæœ€å°çš„æ¶ˆæ¯åç§»é‡ï¼›  åº”è¯¥æ˜¯å’Œlogé‡Œé¢çš„åç§»é‡æœ‰å…³ç³»

LSOï¼šï¼ˆlast stable offsetï¼‰ æœ€åä¸€ä¸ªç¨³å®šçš„offsetï¼›å¯¹æœªå®Œæˆçš„äº‹åŠ¡è€Œè¨€ï¼ŒLSO çš„å€¼ç­‰äºäº‹åŠ¡ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç½®(firstUnstableOffset)ï¼Œå¯¹å·²å®Œæˆçš„äº‹åŠ¡è€Œè¨€ï¼Œå®ƒçš„å€¼åŒ HW ç›¸åŒï¼›

![](images/image-27.png)

**LEOä¸HW ä¸æ•°æ®ä¸€è‡´æ€§å¯†åˆ‡ç›¸å…³ï¼›**

![](images/image-33.png)

å¦‚å›¾ï¼Œå„å‰¯æœ¬ä¸­æœ€å°çš„LEOæ˜¯3ï¼Œæ‰€ä»¥HWæ˜¯3ï¼Œæ‰€ä»¥ï¼Œæ¶ˆè´¹è€…æ­¤åˆ»æœ€å¤šèƒ½è¯»åˆ°Msg2;

### **6.6.7ä¸æ¸…æ´é€‰ä¸¾\[äº†è§£]**

ä¸æ¸…æ´é€‰ä¸¾ï¼Œæ˜¯æŒ‡å…è®¸â€œéISRå‰¯æœ¬â€å¯ä»¥è¢«é€‰ä¸¾ä¸ºleaderï¼›éISRå‰¯æœ¬è¢«é€‰ä¸¾ä¸ºleaderï¼Œå°†æå¤§å¢åŠ æ•°æ®ä¸¢å¤±åŠæ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½æ€§ï¼ç”±å‚æ•° unclean.leader.election.enable=falseï¼ˆé»˜è®¤ï¼‰ æ§åˆ¶ï¼›

* åˆå§‹çŠ¶æ€ï¼š follower2ä¸¥é‡è½åäºleaderï¼Œå¹¶ä¸”ä¸å±äºISRå‰¯æœ¬

![](images/image-26.png)

* æ­¤åˆ»ï¼Œæ‰€æœ‰ISRå‰¯æœ¬å®•æœºï¼š

![](images/image-32.png)

* Follower2æˆä¸ºæ–°çš„leaderï¼Œå¹¶æ¥æ”¶æ•°æ®

![](images/image-35.png)

* ä¹‹å‰å®•æœºå‰¯æœ¬é‡å¯ï¼ŒæŒ‰ç…§æœ€æ–°leaderçš„æœ€æ–°leoè¿›è¡Œæˆªæ–­ï¼Œäº§ç”Ÿæ•°æ®ä¸¢å¤±åŠä¸ä¸€è‡´

![](images/image-36.png)

## 6.7.**å¹‚ç­‰æ€§&#x20;**

### **6.7.1å¹‚ç­‰æ€§è¦ç‚¹**

Kafka 0.11.0.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†**å¹‚ç­‰æ€§**ä¸äº‹åŠ¡è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œä»¥æ­¤æ¥å®ç° EOS ( exactly once&#x20;

semantics ï¼Œç²¾ç¡®ä¸€æ¬¡å¤„ç†è¯­ä¹‰ï¼‰

ç”Ÿäº§è€…åœ¨è¿›è¡Œå‘é€å¤±è´¥åçš„é‡è¯•æ—¶ï¼ˆretriesï¼‰ï¼Œæœ‰å¯èƒ½ä¼šé‡å¤å†™å…¥æ¶ˆæ¯ï¼Œè€Œä½¿ç”¨ Kafkaå¹‚ç­‰æ€§åŠŸèƒ½ä¹‹åå°±å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚

> å¼€å¯å¹‚ç­‰æ€§åŠŸèƒ½ï¼Œåªéœ€è¦æ˜¾å¼åœ°å°†ç”Ÿäº§è€…å‚æ•° enable.idempotenceè®¾ç½®ä¸º true ï¼ˆé»˜è®¤å€¼ä¸º falseï¼‰ï¼š
>
> props.put("enable.idempotence",true);

åœ¨å¼€å¯å¹‚ç­‰æ€§åŠŸèƒ½æ—¶ï¼Œå¦‚ä¸‹å‡ ä¸ªå‚æ•°å¿…é¡»æ­£ç¡®é…ç½®ï¼š

* retries > 0&#x20;

* max.in.flight.requests.per.connection<=5

* acks = -1

å¦‚æœ‰è¿åï¼Œåˆ™ä¼šæŠ›å‡ºConfigExceptionå¼‚å¸¸ï¼›

### **6.7.2kafkaå¹‚ç­‰æ€§å®ç°æœºåˆ¶**

1ï¼‰æ¯ä¸€ä¸ªproduceråœ¨åˆå§‹åŒ–æ—¶ä¼šç”Ÿæˆä¸€ä¸ªproducer\_idï¼Œå¹¶ä¸ºæ¯ä¸ªç›®æ ‡åˆ†åŒºç»´æŠ¤ä¸€&#x4E2A;**â€œæ¶ˆæ¯åºåˆ—å·â€**ï¼›

2ï¼‰produceræ¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå°†\<producer\_id,åˆ†åŒº>å¯¹åº”çš„â€œåºåˆ—å·â€åŠ 1

3ï¼‰brokerç«¯ä¼šä¸ºæ¯ä¸€å¯¹{producer\_id,åˆ†åŒº}ç»´æŠ¤ä¸€ä¸ªåºåˆ—å·ï¼Œå¯¹äºæ¯æ”¶åˆ°çš„ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šåˆ¤æ–­æœåŠ¡ç«¯çš„SN\_OLDå’Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­çš„SN\_NEWè¿›è¡Œå¯¹æ¯”ï¼š

* å¦‚æœSN\_OLD + 1 == SN\_NEWï¼Œæ­£å¸¸ï¼›

* å¦‚æœSN\_NEW\<SN\_OLD+1ï¼Œè¯´æ˜æ˜¯é‡å¤å†™å…¥çš„æ•°æ®ï¼Œç›´æ¥ä¸¢å¼ƒ

* å¦‚æœSN\_NEW>SN\_OLD+1ï¼Œè¯´æ˜ä¸­é—´æœ‰æ•°æ®å°šæœªå†™å…¥ï¼Œæˆ–è€…æ˜¯å‘ç”Ÿäº†ä¹±åºï¼Œæˆ–è€…æ˜¯æ•°æ®ä¸¢å¤±ï¼Œå°†æŠ›å‡ºä¸¥é‡å¼‚å¸¸ï¼šOutOfOrderSequenceException

![](images/image-37.png)

producer.send(â€œaaaâ€)   æ¶ˆæ¯aaaå°±æ‹¥æœ‰äº†ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·

å¦‚æœè¿™æ¡æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œproducerå†…éƒ¨è‡ªåŠ¨é‡è¯•ï¼ˆretryï¼‰ï¼Œæ­¤æ—¶åºåˆ—å·ä¸å˜ï¼›

producer.send(â€œbbbâ€)   æ¶ˆæ¯bbbæ‹¥æœ‰ä¸€ä¸ªæ–°çš„åºåˆ—å·

> æ³¨æ„ï¼škafkaåªä¿è¯producerå•ä¸ªä¼šè¯ä¸­çš„å•ä¸ªåˆ†åŒºå¹‚ç­‰ï¼›

## **6.8.kafkaäº‹åŠ¡(ä¼ªäº‹åŠ¡)&#x20;**

### **6.8.1äº‹åŠ¡è¦ç‚¹çŸ¥è¯†**

* Kafkaçš„äº‹åŠ¡æ§åˆ¶åŸç†

ä¸»è¦åŸç†ï¼š  å¼€å§‹äº‹åŠ¡-->å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡å¼€å§‹ï¼‰

&#x20;                 æäº¤äº‹åŠ¡-->å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡æäº¤ï¼‰

&#x20;                 æ”¾å¼ƒäº‹åŠ¡-->å‘é€ä¸€ä¸ªControlBatchæ¶ˆæ¯ï¼ˆäº‹åŠ¡ç»ˆæ­¢ï¼‰

* å¼€å¯äº‹åŠ¡çš„å¿…é¡»é…ç½®å‚æ•°ï¼ˆæˆ‘ä¸æ”¯æŒæ•°æ®å¾—å›æ»šï¼Œä½†æ˜¯æˆ‘èƒ½åšåˆ°ï¼Œä¸€è£ä¿±è£ï¼Œä¸€æŸä¿±æŸï¼‰

```java
Properties props = new Properties();
props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"doit01:9092");
props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
// acks
props.setProperty(ProducerConfig.ACKS_CONFIG,"-1");
// ç”Ÿäº§è€…çš„é‡è¯•æ¬¡æ•°
props.setProperty(ProducerConfig.RETRIES_CONFIG,"3");
// é£è¡Œä¸­çš„è¯·æ±‚ç¼“å­˜æœ€å¤§æ•°é‡
props.setProperty(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION,"3");
// å¼€å¯å¹‚ç­‰æ€§
props.setProperty(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,"true");
// è®¾ç½®äº‹åŠ¡id
props.setProperty(ProducerConfig.TRANSACTIONAL_ID_CONFIG,"trans_001");
```

**äº‹åŠ¡æ§åˆ¶çš„ä»£ç æ¨¡æ¿**

```java
// åˆå§‹åŒ–äº‹åŠ¡
producer.initTransaction( )

// å¼€å¯äº‹åŠ¡    
producer.beginTransaction( )
    
// å¹²æ´»

// æäº¤äº‹åŠ¡
producer.commitTransaction( )


// å¼‚å¸¸å›æ»šï¼ˆæ”¾å¼ƒäº‹åŠ¡ï¼‰ catché‡Œé¢
producer.abortTransaction( )
```

![](images/image-38.png)

æ¶ˆè´¹è€…apiæ˜¯ä¼šæ‹‰å–åˆ°å°šæœªæäº¤äº‹åŠ¡çš„æ•°æ®çš„ï¼›åªä¸è¿‡å¯ä»¥é€‰æ‹©æ˜¯å¦è®©ç”¨æˆ·çœ‹åˆ°ï¼

æ˜¯å¦è®©ç”¨æˆ·çœ‹åˆ°æœªæäº¤äº‹åŠ¡çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ¶ˆè´¹è€…å‚æ•°æ¥é…ç½®ï¼š

isolation.level=read\_uncommittedï¼ˆé»˜è®¤å€¼ï¼‰

isolation.level=read\_committed

* kafkaè¿˜æœ‰ä¸€&#x4E2A;**â€œé«˜çº§â€äº‹åŠ¡æ§åˆ¶**ï¼Œåªé’ˆå¯¹ä¸€ç§åœºæ™¯ï¼š

ç”¨æˆ·çš„ç¨‹åºï¼Œè¦ä»kafkaè¯»å–æºæ•°æ®ï¼Œæ•°æ®å¤„ç†çš„ç»“æœåˆè¦å†™å…¥kafka

kafkaèƒ½å®ç°ç«¯åˆ°ç«¯çš„äº‹åŠ¡æ§åˆ¶ï¼ˆæ¯”èµ·ä¸Šé¢çš„â€œåŸºç¡€â€äº‹åŠ¡ï¼Œå¤šäº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé€šè¿‡producerå¯ä»¥å°†consumerçš„æ¶ˆè´¹åç§»é‡ç»‘å®šåˆ°äº‹åŠ¡ä¸Šæäº¤ï¼‰

```java
producer.sendOffsetsToTransaction(offsets,consumer_id)
```

### **6.8.2äº‹åŠ¡apiç¤ºä¾‹**

ä¸ºäº†å®ç°äº‹åŠ¡ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»æä¾›å”¯ä¸€**transactional.id**ï¼Œå¹¶ä¸”å¼€å¯ç”Ÿäº§è€…çš„**å¹‚ç­‰æ€§**

```java
properties.put ("transactional.id","transactionid00001");
properties.put ("enable.idempotence",true);
```

kafkaç”Ÿäº§è€…ä¸­æä¾›çš„å…³äºäº‹åŠ¡çš„æ–¹æ³•å¦‚ä¸‹ï¼š

![](images/image-39.png)

**â€œæ¶ˆè´¹kafka-å¤„ç†-ç”Ÿäº§ç»“æœåˆ°kafkaâ€å…¸å‹åœºæ™¯ä¸‹çš„ä»£ç ç»“æ„ç¤ºä¾‹ï¼š**

```java
package com.doit.day04;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.errors.ProducerFencedException;
import org.apache.kafka.common.serialization.StringDeserializer;
import org.apache.kafka.common.serialization.StringSerializer;

import java.time.Duration;
import java.util.Arrays;
import java.util.Properties;

public class Exercise_kafka2kafka {
    public static void main(String[] args) {

        Properties props = new Properties();
        //æ¶ˆè´¹è€…çš„
        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092");
        props.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        props.setProperty(ConsumerConfig.GROUP_ID_CONFIG, "shouwei");
        //è‡ªåŠ¨æäº¤åç§»é‡
        props.setProperty(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,"false");
        props.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,"earliest");

        //å†™ç”Ÿäº§è€…çš„ä¸€äº›å±æ€§
        props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"linux01:9092");
        props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        //è®¾ç½®ack å¼€å¯å¹‚ç­‰æ€§å¿…é¡»è®¾ç½®çš„ä¸‰ä¸ªå‚æ•°
        props.setProperty(ProducerConfig.ACKS_CONFIG,"-1");
        props.setProperty(ProducerConfig.RETRIES_CONFIG,"3");
        props.setProperty(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION,"3");
        //å¼€å¯å¹‚ç­‰æ€§
        props.setProperty(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,"true");
        //å¼€å¯äº‹åŠ¡
        props.setProperty(ProducerConfig.TRANSACTIONAL_ID_CONFIG,"doit40");

        //æ¶ˆè´¹æ•°æ®
        KafkaConsumer<String, String> consumer = new KafkaConsumer<String, String>(props);
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        //åˆå§‹åŒ–äº‹åŠ¡
        producer.initTransactions();
        //è®¢é˜…ä¸»é¢˜
        consumer.subscribe(Arrays.asList("eventlog"));
        while (true){
            //æ‹‰å–æ•°æ®
            ConsumerRecords<String, String> poll = consumer.poll(Duration.ofMillis(Integer.MAX_VALUE));
            try {
                //å¼€å¯äº‹åŠ¡
                producer.beginTransaction();
                for (ConsumerRecord<String, String> record : poll) {
                    String value = record.value();
                    //å°†valueçš„å€¼å†™å…¥åˆ°å¦å¤–ä¸€ä¸ªtopicä¸­
                    producer.send(new ProducerRecord<String,String>("k2k",value));
                }
                producer.flush();
                //æäº¤åç§»é‡
                consumer.commitAsync();
                //æäº¤äº‹åŠ¡
                producer.commitTransaction();

            } catch (ProducerFencedException e) {
                //æ”¾å¼ƒäº‹åŠ¡
                producer.abortTransaction();
            }
        }
    }
}
```

### 6.8.3äº‹åŠ¡å®æˆ˜æ¡ˆä¾‹

åœ¨å®é™…æ•°æ®å¤„ç†ä¸­ï¼Œconsume-transform-produceæ˜¯ä¸€ç§å¸¸è§ä¸”å…¸å‹çš„åœºæ™¯ï¼›

![](images/image-40.png)

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å®ç°ï¼Œä»â€œè¯»å–sourceæ•°æ®ï¼Œè‡³ä¸šåŠ¡å¤„ç†ï¼Œè‡³å¤„ç†ç»“æœå†™å…¥kafkaâ€çš„æ•´ä¸ªæµç¨‹ï¼Œå…·å¤‡åŸå­æ€§ï¼š

> **è¦ä¹ˆå…¨æµç¨‹æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼**

ï¼ˆå¤„ç†ä¸”è¾“å‡ºç»“æœæˆåŠŸï¼Œæ‰æäº¤æ¶ˆè´¹ç«¯åç§»é‡ï¼›å¤„ç†æˆ–è¾“å‡ºç»“æœå¤±è´¥ï¼Œåˆ™æ¶ˆè´¹åç§»é‡ä¹Ÿä¸ä¼šæäº¤ï¼‰

è¦å®ç°ä¸Šè¿°çš„éœ€æ±‚ï¼Œå¯ä»¥åˆ©ç”¨Kafkaä¸­çš„**äº‹åŠ¡æœºåˆ¶**ï¼š

å®ƒå¯ä»¥ä½¿åº”ç”¨ç¨‹åºå°†**æ¶ˆè´¹æ¶ˆæ¯**ã€**ç”Ÿäº§æ¶ˆæ¯**ã€**æäº¤æ¶ˆè´¹ä½ç§»**å½“ä½œåŸå­æ“ä½œæ¥å¤„ç†ï¼Œå³ä½¿è¯¥ç”Ÿäº§æˆ–æ¶ˆè´¹ä¼šè·¨å¤šä¸ªtopicåˆ†åŒºï¼›

åœ¨æ¶ˆè´¹ç«¯æœ‰ä¸€ä¸ªå‚æ•°isolation.levelï¼Œä¸äº‹åŠ¡æœ‰ç€è«å¤§çš„å…³è”ï¼Œè¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸ºâ€œread\_uncommittedâ€ï¼Œæ„æ€æ˜¯è¯´æ¶ˆè´¹ç«¯åº”ç”¨å¯ä»¥çœ‹åˆ°ï¼ˆæ¶ˆè´¹åˆ°ï¼‰æœªæäº¤çš„äº‹åŠ¡ï¼Œå½“ç„¶å¯¹äºå·²æäº¤çš„äº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚è¿™ä¸ªå‚æ•°è¿˜å¯ä»¥è®¾ç½®ä¸ºâ€œread\_committedâ€ï¼Œè¡¨ç¤ºæ¶ˆè´¹ç«¯åº”ç”¨ä¸å¯ä»¥çœ‹åˆ°å°šæœªæäº¤çš„äº‹åŠ¡å†…çš„æ¶ˆæ¯ã€‚

![](images/image-41.png)

> æ§åˆ¶æ¶ˆæ¯ï¼ˆControlBatchï¼šCOMMIT/ABORTï¼‰è¡¨å¾äº‹åŠ¡æ˜¯è¢«æäº¤è¿˜æ˜¯è¢«æ”¾å¼ƒ

## **6.9åˆ†åŒºæ•°ä¸ååé‡**

Kafkaæœ¬èº«æä¾›ç”¨äºç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•çš„kafka-producer-perf-test.sh å’Œç”¨äºæ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•çš„ kafka-consumer-perf-test. shï¼Œä¸»è¦å‚æ•°å¦‚ä¸‹ï¼š

* topic ç”¨æ¥æŒ‡å®šç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„ç›®æ ‡ä¸»é¢˜ï¼›&#x20;

* num-records ç”¨æ¥æŒ‡å®šå‘é€æ¶ˆæ¯çš„æ€»æ¡æ•°&#x20;

* record-size ç”¨æ¥è®¾ç½®æ¯æ¡æ¶ˆæ¯çš„å­—èŠ‚æ•°ï¼›&#x20;

* producer-props å‚æ•°ç”¨æ¥æŒ‡å®šç”Ÿäº§è€…çš„é…ç½®ï¼Œå¯åŒæ—¶æŒ‡å®šå¤šç»„é…ç½®ï¼Œå„ç»„é…ç½®ä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ä¸ producer-props å‚æ•°å¯¹åº”çš„è¿˜æœ‰ä¸€ä¸ª producer-configå‚æ•°ï¼Œå®ƒç”¨æ¥æŒ‡å®šç”Ÿäº§è€…çš„é…ç½®æ–‡ä»¶ï¼›&#x20;

* throughput ç”¨æ¥è¿›è¡Œé™æµæ§åˆ¶ï¼Œå½“è®¾å®šçš„å€¼å°äº0æ—¶ä¸é™æµï¼Œå½“è®¾å®šçš„å€¼å¤§äº0æ—¶ï¼Œå½“å‘é€çš„ååé‡å¤§äºè¯¥å€¼æ—¶å°±ä¼šè¢«é˜»å¡ä¸€æ®µæ—¶é—´ã€‚

> ç»éªŒï¼šå¦‚ä½•æŠŠkafkaæœåŠ¡å™¨çš„æ€§èƒ½åˆ©ç”¨åˆ°æœ€é«˜ï¼Œä¸€èˆ¬æ˜¯è®©ä¸€å°æœºå™¨æ‰¿è½½ï¼ˆ cpuçº¿ç¨‹æ•°\*2\~3 ï¼‰ä¸ªåˆ†åŒº
>
> æµ‹è¯•ç¯å¢ƒï¼š èŠ‚ç‚¹3ä¸ªï¼Œcpu 2æ ¸2çº¿ç¨‹ï¼Œå†…å­˜8G ï¼Œæ¯æ¡æ¶ˆæ¯1k
>
> æµ‹è¯•ç»“æœï¼š  topicåœ¨12ä¸ªåˆ†åŒºæ—¶ï¼Œå†™å…¥ã€è¯»å–çš„æ•ˆç‡éƒ½æ˜¯è¾¾åˆ°**æœ€é«˜**
>
> å†™å…¥ï¼š 75MB/s  ï¼Œ7.5ä¸‡æ¡/s
>
> è¯»å‡ºï¼š 310MB/s ï¼Œ31ä¸‡æ¡/s
>
> å½“åˆ†åŒºæ•°>12  æˆ–è€… <12 æ—¶ï¼Œæ•ˆç‡éƒ½æ¯”=12æ—¶è¦ä½ï¼

## **6.10æ€§èƒ½æµ‹è¯•**

### **6.10.1ç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•**

**tpc\_3ï¼š åˆ†åŒºæ•°3ï¼Œå‰¯æœ¬æ•°1**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-producer-perf-test.sh --topic tpc_3 --num-records 100000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=linux01:9092 acks=1
```

100000 records sent, 26723.677178 records/sec (26.10 MB/sec), 818.30 ms avg latency, 1689.00 ms max latency, 595 ms 50th, 1580 ms 95th, 1649 ms 99th, 1687 ms 99.9th.

**tpc\_4ï¼š åˆ†åŒºæ•°4ï¼Œå‰¯æœ¬æ•°2**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-producer-perf-test.sh --topic tpc_4 --num-records 100000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=linux01:9092 acks=1
```

100000 records sent, 25886.616619 records/sec (25.28 MB/sec), 962.06 ms avg latency, 1647.00 ms max latency, 857 ms 50th, 1545 ms 95th, 1622 ms 99th, 1645 ms 99.9th.

**tpc\_5ï¼šåˆ†åŒºæ•°5ï¼Œå‰¯æœ¬æ•°1**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-producer-perf-test.sh --topic tpc_5 --num-records 100000 --record-size 1024 --throughput -1  --producer-props bootstrap.servers=doitedu01:9092 acks=1
```

100000 records sent, 28785.261946 records/sec (28.11 MB/sec), 789.29 ms avg latency, 1572.00 ms max latency, 665 ms 50th, 1502 ms 95th, 1549 ms 99th, 1564 ms 99.9th.

**tpc\_6ï¼šåˆ†åŒºæ•°6ï¼Œå‰¯æœ¬æ•°1**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-producer-perf-test.sh --topic tpc_6 --num-records 100000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=doitedu01:9092 acks=1
```

100000 records sent, 42662.116041 records/sec (41.66 MB/sec), 508.68 ms avg latency, 1041.00 ms max latency, 451 ms 50th, 945 ms 95th, 1014 ms 99th, 1033 ms 99.9th.

**tpc\_12ï¼šåˆ†åŒºæ•°12**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-producer-perf-test.sh --topic tpc_12 --num-records 100000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=doitedu01:9092 acks=1
```

100000 records sent, 56561.085973 records/sec (55.24 MB/sec), 371.42 ms avg latency, 1103.00 ms max latency, 314 ms 50th, 988 ms 95th, 1091 ms 99th, 1093 ms 99.9th.

> è„šæœ¬è¿˜åŒ…å«äº†è®¸å¤šå…¶ä»–çš„å‚æ•°ï¼Œæ¯”å¦‚ from latest groupã€print-metricsã€threadsç­‰ï¼Œç¯‡å¹…åŠæ—¶é—´é™åˆ¶ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªè¡Œäº†è§£è¿™äº›å‚æ•°çš„ä½¿ç”¨ç»†èŠ‚ã€‚
>
> ä¾‹å¦‚ï¼ŒåŠ ä¸Šå‚æ•°ï¼š --print-metricsï¼Œåˆ™ä¼šæ‰“å°æ›´å¤šä¿¡æ¯

![](images/image-42.png)

### 6.10.2**æ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•**

```shell
[root@doitedu01 kafka_2.11-2.0.0]# bin/kafka-consumer-perf-test.sh --topic tpc_3 --messages 100000 --broker-list doitedu01:9092 --consumer.config x.properties
```

**ç»“æœæ•°æ®ä¸ªå­—æ®µå«ä¹‰ï¼š**

start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec

2020-11-14 15:43:42:422, 2020-11-14 15:43:43:347, 98.1377, 106.0948, 100493, 108641.0811, 13, 912, 107.6071, 110189.6930

> ç»“æœä¸­åŒ…å«äº†å¤šé¡¹ä¿¡æ¯ï¼Œåˆ†åˆ«å¯¹åº”èµ·å§‹è¿è¡Œæ—¶é—´ï¼ˆstart. timeï¼‰ã€ç»“æŸè¿è¡Œæ—¶ end.timeï¼‰ã€æ¶ˆæ¯æ€»é‡ï¼ˆdata.consumed.in.MB ï¼Œå•ä½ä¸º MB ï¼‰ï¼ŒæŒ‰å­—èŠ‚å¤§å°è®¡ç®—çš„æ¶ˆè´¹ååé‡ï¼ˆå•ä½ä¸º MB ï¼‰ã€æ¶ˆè´¹çš„æ¶ˆæ¯æ€»æ•°ï¼ˆ data. consumed.in nMsg ï¼‰ã€æŒ‰æ¶ˆæ¯ä¸ªæ•°è®¡ç®—çš„ååé‡ï¼ˆnMsg.secï¼‰ã€å†å¹³è¡¡çš„æ—¶é—´ï¼ˆ rebalance time.ms å•ä½ä¸ºMB/sï¼‰ã€æ‹‰å–æ¶ˆæ¯çš„æŒç»­æ—¶é—´ï¼ˆfetch.time.msï¼Œå•ä½ä¸ºmsï¼‰ã€æ¯ç§’æ‹‰å–æ¶ˆæ¯çš„å­—èŠ‚å¤§å°ï¼ˆfetch.MB.sec å•ä½ MB/sï¼‰ã€æ¯ç§’æ‹‰å–æ¶ˆæ¯çš„ä¸ªæ•°( fetch.nM.secï¼‰ã€‚å…¶ä¸­ fetch.time.ms= end.time - start.time - rebalance.time.ms

### 6.10.3åˆ†åŒºæ•°ä¸ååé‡å®é™…æµ‹è¯•

Kafkaåªå…è®¸å•ä¸ªåˆ†åŒºä¸­çš„æ¶ˆæ¯è¢«ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆè´¹ç»„çš„æ¶ˆè´¹å¹¶è¡Œåº¦å®Œå…¨ä¾èµ–äºæ‰€æ¶ˆè´¹çš„åˆ†åŒºæ•°ï¼›

å¦‚æ­¤çœ‹æ¥ï¼Œå¦‚æœä¸€ä¸ªä¸»é¢˜ä¸­çš„åˆ†åŒºæ•°è¶Šå¤šï¼Œç†è®ºä¸Šæ‰€èƒ½è¾¾åˆ°çš„ååé‡å°±è¶Šå¤§ï¼Œé‚£ä¹ˆäº‹å®çœŸçš„å¦‚é¢„æƒ³çš„ä¸€æ ·å—ï¼Ÿ

> æˆ‘ä»¬ä»¥ä¸€ä¸ª3å°æ™®é€šé˜¿é‡Œäº‘ä¸»æœºç»„æˆçš„3èŠ‚ç‚¹kafkaé›†ç¾¤è¿›è¡Œæµ‹è¯•ï¼Œæ¯å°ä¸»æœºçš„å†…å­˜å¤§å°ä¸º8GBï¼Œç£ç›˜ä¸º40GBï¼Œ4æ ¸CPU 16çº¿ç¨‹ ï¼Œä¸»é¢‘2600MHZï¼ŒJVMç‰ˆæœ¬ä¸º1.8.0\_112ï¼ŒLinuxç³»ç»Ÿç‰ˆæœ¬ä¸º2.6.32-504.23.4.el6.x86\_64ã€‚
>
> åˆ›å»ºåˆ†åŒºæ•°ä¸º1ã€20ã€50ã€100ã€200ã€500ã€1000çš„ä¸»é¢˜ï¼Œå¯¹åº”çš„ä¸»é¢˜åç§°åˆ†åˆ«ä¸º topic-1 topic 20 topic-50 topic-100 topic-200 topic-500 topic-1000 ï¼Œæ‰€æœ‰ä¸»é¢˜çš„å‰¯æœ¬å› å­éƒ½è®¾ç½®ä¸º1ã€‚

* ç”Ÿäº§è€…ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹

![](images/image-43.png)

* æ¶ˆè´¹è€…ï¼Œæµ‹è¯•ç»“æœä¸ä¸Šå›¾è¶‹åŠ¿ç±»åŒ

å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ†åŒºæ•°ï¼Ÿä»æŸç§æ„æ©æ¥è¯´ï¼Œè€ƒéªŒçš„æ˜¯å†³ç­–è€…çš„å®æˆ˜ç»éªŒï¼Œæ›´é€å½»åœ°è¯´ï¼Œæ˜¯Kafkaæœ¬èº«ã€ä¸šåŠ¡åº”ç”¨ã€ç¡¬ä»¶èµ„æºã€ç¯å¢ƒé…ç½®ç­‰å¤šæ–¹é¢çš„è€ƒé‡è€Œåšå‡ºçš„é€‰æ‹©ã€‚åœ¨è®¾å®šå®Œåˆ†åŒºæ•°ï¼Œæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´æ˜¯åˆ›å»ºä¸»é¢˜ä¹‹åï¼Œè¿˜è¦å¯¹å…¶è¿½è¸ªã€ç›‘æ§ã€è°ƒä¼˜ä»¥æ±‚æ›´å¥½åœ°åˆ©ç”¨å®ƒ ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ ¹æ®é¢„ä¼°çš„ååé‡åŠæ˜¯å¦ä¸ key ç›¸å…³çš„è§„åˆ™æ¥è®¾å®šåˆ†åŒºæ•°å³å¯ï¼ŒåæœŸå¯ä»¥é€šè¿‡å¢åŠ åˆ†åŒºæ•°ã€å¢åŠ  broker æˆ–åˆ†åŒºé‡åˆ†é…ç­‰æ‰‹æ®µæ¥è¿›è¡Œæ”¹è¿›ã€‚



### **6.10.4åˆ†åŒºæ•°è®¾ç½®çš„ç»éªŒå‚è€ƒ**

å¦‚æœä¸€å®šè¦ç»™ä¸€ä¸ªå‡†åˆ™ï¼Œåˆ™å»ºè®®å°†åˆ†åŒºæ•°è®¾å®šä¸ºé›†ç¾¤ä¸­brokerçš„å€æ•°ï¼Œå³å‡å®šé›†ç¾¤ä¸­æœ‰3ä¸ªbroker èŠ‚ç‚¹ï¼Œå¯ä»¥è®¾å®šåˆ†åŒºæ•°ä¸º3/6/9ç­‰ï¼Œè‡³äºå€æ•°çš„é€‰å®šå¯ä»¥å‚è€ƒé¢„ä¼°çš„ååé‡ã€‚

æˆ–è€…æ ¹æ®æœºå™¨é…ç½®çš„cpuçº¿ç¨‹æ•°å’Œç£ç›˜æ€§èƒ½æ¥è®¾ç½®æœ€å¤§æ•ˆç‡çš„åˆ†åŒºæ•°ï¼š= CPUçº¿ç¨‹æ•° \* 1.5\~2å€

ä¸è¿‡ï¼Œå¦‚æœé›†ç¾¤ä¸­çš„brokerèŠ‚ç‚¹æ•°æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¤§å‡ åæˆ–ä¸Šç™¾ã€ä¸Šåƒï¼Œé‚£ä¹ˆè¿™ç§å‡†åˆ™ä¹Ÿä¸å¤ªé€‚ç”¨ã€‚

è¿˜æœ‰ä¸€ä¸ªå¯ä¾›å‚è€ƒçš„åˆ†åŒºæ•°è®¾ç½®ç®—æ³•ï¼š

æ¯ä¸€ä¸ªåˆ†åŒºçš„å†™å…¥é€Ÿåº¦ï¼Œå¤§çº¦40M/s

æ¯ä¸€ä¸ªåˆ†åŒºçš„è¯»å–é€Ÿåº¦ï¼Œå¤§çº¦60M/s

å‡å¦‚ï¼Œæ•°æ®æºäº§ç”Ÿæ•°æ®çš„é€Ÿåº¦æ˜¯ï¼ˆå³°å€¼ï¼‰800M/s  ï¼Œé‚£ä¹ˆä¸ºäº†ä¿è¯å†™å…¥é€Ÿåº¦ï¼Œè¯¥topicåº”è¯¥è®¾ç½®20ä¸ªåˆ†åŒºï¼ˆå‰¯æœ¬å› å­ä¸º3ï¼‰



## **6.11Kafkaé€Ÿåº¦å¿«çš„åŸå› ï¼ˆäº†è§£ï¼‰**

**Kafkaé€Ÿåº¦å¿«çš„åŸå› ï¼š**

* æ¶ˆæ¯é¡ºåºè¿½åŠ ï¼ˆç£ç›˜é¡ºåºè¯»å†™æ¯”å†…å­˜çš„éšæœºè¯»å†™è¿˜å¿«ï¼‰

* ä½¿ç”¨Zero-Copy ï¼ˆé›¶æ‹·è´ï¼‰æŠ€æœ¯æ¥è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼›

æ‰©å±•é˜…è¯»ï¼šé›¶æ‹·è´    &#x20;

**æ‰€è°“çš„é›¶æ‹·è´æ˜¯æŒ‡å°†æ•°æ®ç›´æ¥ä»ç£ç›˜æ–‡ä»¶å¤åˆ¶åˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼Œè€Œä¸éœ€è¦ç»ç”±åº”ç”¨ç¨‹åºä¹‹æ‰‹ï¼›**

é›¶æ‹·è´å¤§å¤§æé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·æ¨¡å¼ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼›å¯¹äºLinuxç³»ç»Ÿè€Œè¨€ï¼Œé›¶æ‹·è´æŠ€æœ¯ä¾èµ–äºåº•å±‚çš„ sendfile( )æ–¹æ³•å®ç°ï¼›å¯¹åº”äºJava è¯­è¨€ï¼ŒFileChannal.transferTo( )æ–¹æ³•çš„åº•å±‚å®ç°å°±æ˜¯ sendfile( )æ–¹æ³•ï¼›

* **éé›¶æ‹·è´ç¤ºæ„å›¾**

![](images/image-44.png)

* **é›¶æ‹·è´ç¤ºæ„å›¾**

![](images/image-45.png)

é›¶æ‹·è´æŠ€æœ¯é€šè¿‡DMA (Direct Memory Accessï¼‰æŠ€æœ¯å°†æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°å†…æ ¸æ¨¡å¼ä¸‹çš„ Read Bufferã€‚ä¸è¿‡æ²¡æœ‰æ•°æ®è¢«å¤åˆ¶åˆ° Socke Bufferï¼Œåªæœ‰åŒ…å«æ•°æ®çš„ä½ç½®å’Œé•¿åº¦çš„ä¿¡æ¯çš„æ–‡ä»¶æè¿°ç¬¦è¢«åŠ åˆ° Socket Bufferï¼› DMAå¼•æ“ç›´æ¥å°†æ•°æ®ä»å†…æ ¸æ¨¡å¼read bufferä¸­ä¼ é€’åˆ°ç½‘å¡è®¾å¤‡ã€‚

è¿™é‡Œæ•°æ®åªç»å†äº†2æ¬¡å¤åˆ¶å°±ä»ç£ç›˜ä¸­ä¼ é€å‡ºå»äº†ï¼Œå¹¶ä¸”ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿå˜æˆäº†2æ¬¡ã€‚

é›¶æ‹·è´æ˜¯é’ˆå¯¹å†…æ ¸æ¨¡å¼è€Œè¨€çš„ï¼Œæ•°æ®åœ¨å†…æ ¸æ¨¡å¼ä¸‹å®ç°äº†é›¶æ‹·è´ï¼›

# 7.kafkaé¢è¯•é¢˜

## 7.22 **kafka éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ**

é«˜ååé‡ï¼Œä½å»¶è¿Ÿ

å¯ä»¥çƒ­æ‰©å±•

å¹¶å‘åº¦é«˜

å…·æœ‰å®¹é”™æ€§(æŒ‚çš„åªå‰©1å°ä¹Ÿèƒ½æ­£å¸¸è·‘)

å¯é æ€§é«˜



## 7.23 **è¯·ç®€è¿°ä½ åœ¨å“ªäº›åœºæ™¯ä¸‹ä¼šé€‰æ‹© kafkaï¼Ÿ  kafkaçš„ä¸€äº›åº”ç”¨**

* æ—¥å¿—æ”¶é›†ï¼šä¸€ä¸ªå…¬å¸å¯ä»¥ç”¨kafkaå¯ä»¥æ”¶é›†å„ç§æœåŠ¡çš„logï¼Œé€šè¿‡kafkaä»¥ç»Ÿä¸€æ¥å£æœåŠ¡çš„æ–¹å¼å¼€æ”¾ç»™å„ç§consumerï¼Œä¾‹å¦‚hadoopã€HBaseã€Solrç­‰ã€‚

* æ¶ˆæ¯ç³»ç»Ÿï¼šè§£è€¦å’Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€ç¼“å­˜æ¶ˆæ¯ç­‰ã€‚

* ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ªï¼škafkaç»å¸¸è¢«ç”¨æ¥è®°å½•webç”¨æˆ·æˆ–è€…appç”¨æˆ·çš„å„ç§æ´»åŠ¨ï¼Œå¦‚æµè§ˆç½‘é¡µã€æœç´¢ã€ç‚¹å‡»ç­‰æ´»åŠ¨ï¼Œè¿™äº›æ´»åŠ¨ä¿¡æ¯è¢«å„ä¸ªæœåŠ¡å™¨å‘å¸ƒåˆ°kafkaçš„topicä¸­ï¼Œç„¶åè®¢é˜…è€…é€šè¿‡è®¢é˜…è¿™äº›topicæ¥åšå®æ—¶çš„ç›‘æ§åˆ†æï¼Œæˆ–è€…è£…è½½åˆ°hadoopã€æ•°æ®ä»“åº“ä¸­åšç¦»çº¿åˆ†æå’ŒæŒ–æ˜ã€‚

* è¿è¥æŒ‡æ ‡ï¼škafkaä¹Ÿç»å¸¸ç”¨æ¥è®°å½•è¿è¥ç›‘æ§æ•°æ®ã€‚åŒ…æ‹¬æ”¶é›†å„ç§åˆ†å¸ƒå¼åº”ç”¨çš„æ•°æ®ï¼Œç”Ÿäº§å„ç§æ“ä½œçš„é›†ä¸­åé¦ˆï¼Œæ¯”å¦‚æŠ¥è­¦å’ŒæŠ¥å‘Šã€‚

* ä½œä¸ºæµå¼å¤„ç†çš„æ•°æ®æºï¼šæ¯”å¦‚spark streamingå’Œ Flink

## 7.24 **kafka çš„è®¾è®¡æ¶æ„ä½ çŸ¥é“å—ï¼Ÿ**



## 7.25 **kafka åˆ†åŒºçš„ç›®çš„ï¼Ÿ**

åˆ†åŒºå¯¹äºkafkaé›†ç¾¤çš„å¥½å¤„æ˜¯ï¼šå®ç°è´Ÿè½½å‡è¡¡ã€‚

åˆ†åŒºå¯¹äºæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æ¥è¯´ï¼Œå¯ä»¥æé«˜å¹¶è¡Œåº¦ï¼Œæé«˜æ•ˆç‡ã€‚--------æé«˜æ¶ˆè´¹è€…çš„å¹¶è¡Œåº¦---ã€‹æ¶ˆè´¹è€…ç»„



## 7.26 **kafka æ˜¯å¦‚ä½•åšåˆ°æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Ÿ**

kafkaä¸­çš„æ¯ä¸ª partition ä¸­çš„æ¶ˆæ¯åœ¨å†™å…¥æ—¶éƒ½æ˜¯æœ‰åºçš„ï¼ˆä¸æ–­è¿½åŠ ï¼‰ï¼Œè€Œä¸”å•ç‹¬ä¸€ä¸ª partitionåªèƒ½ç”±ä¸€ä¸ªæ¶ˆè´¹è€…å»æ¶ˆè´¹ï¼Œå¯ä»¥åœ¨é‡Œé¢ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚ä½†æ˜¯åˆ†åŒºä¹‹é—´çš„æ¶ˆæ¯æ˜¯ä¸ä¿è¯æœ‰åºçš„ã€‚



## 7.27 **kafka çš„é«˜å¯é æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ**

æ•°æ®çš„å­˜å‚¨==ã€‹æœ‰å‰¯æœ¬æœºåˆ¶ï¼Œç”Ÿäº§è€…è¿˜æœ‰å¹‚ç­‰æ€§ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œack = -1&#x20;



## 7.28 **è¯·è°ˆä¸€è°ˆkafkaæ•°æ®ä¸€è‡´æ€§åŸç†**

ä¸€è‡´æ€§æŒ‡çš„æ˜¯ä¸è®ºåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼ŒConsumeréƒ½èƒ½è¯»åˆ°ä¸€è‡´çš„æ•°æ®ã€‚

HW é«˜æ°´ä½çº¿   åœ¨0.11ç‰ˆæœ¬ä¹‹å‰ï¼Œåªç”¨äº†é«˜æ°´ä½çº¿æ¥ä¿è¯ï¼Œä½†æ˜¯è¿™ä¸ªé‡Œé¢å…¶å®æ˜¯ä¼šå‡ºç°ä¸€äº›é—®é¢˜çš„ï¼Œæ¯”å¦‚æ•°æ®ä¸¢å¤±ï¼Œå³ä½¿æ˜¯ackç­‰äº-1çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯èƒ½ä¼šä¸¢æ•°æ®

LEOç­‰

åœ¨0.11ç‰ˆæœ¬ä¹‹åï¼Œæ–°åŠ äº†ä¸€ä¸ªè§’è‰²å«leaderçš„çºªå…ƒå·ï¼Œæ ¹æ®é«˜æ°´ä½çº¿å’Œçºªå…ƒå·æ¥å¤„ç†ï¼Œå†é…ä¸Šack=-1çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå°±ä¸ä¼šä¸¢æ•°æ®äº†ã€‚ã€‚ã€‚ã€‚



## 7.29 **kafka åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±ï¼Ÿ**

* topicçš„å‰¯æœ¬å¦‚æœåªæœ‰1ä¸ªï¼Œé‚£ä¹ˆä¸€æ—¦è¿™ä¸ªå‰¯æœ¬æ‰€åœ¨brokeræœåŠ¡å™¨å®•æœºï¼Œåˆ™æœ‰å¯èƒ½ä¸¢å¤±ï¼›

* producerå¾€kafkaå†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœç¡®è®¤æœºåˆ¶å‚æ•°acks !=allï¼Œä¹Ÿå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼›

* ä¸æ¸…æ´é€‰ä¸¾æœºåˆ¶å¦‚æœå¼€å¯ï¼Œä¹Ÿå¯èƒ½é€ æˆæ•°æ®ä¸¢å¤±ï¼ˆä¸æ¸…æ´é€‰ä¸¾å°±æ˜¯è¯´åœ¨æ‰€æœ‰ISRå‰¯æœ¬å…¨éƒ¨å®•æœºçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è®©OSRå‰¯æœ¬æˆä¸ºLeaderï¼Œè€ŒOSRä¸­çš„æ•°æ®æ˜¾ç„¶ä¸å…¨ï¼›é‚£ä¹ˆï¼Œå°±ç®—ä¹‹å‰çš„Leaderé‡æ–°ä¸Šçº¿äº†ï¼Œä¹Ÿä¼šè¢«è¿›è¡Œæ—¥å¿—æˆªæ–­ï¼‰



## 7.30 **æ€ä¹ˆå°½å¯èƒ½ä¿è¯ kafka çš„å¯é æ€§**

å‰¯æœ¬æ•°>1

ack=all

min.insync.replicas >= 2    æœ€å°çš„åŒæ­¥å‰¯æœ¬æ•°



## 7.31 **æ•°æ®ä¼ è¾“çš„è¯­ä¹‰æœ‰å‡ ç§ï¼Ÿ**

æ•°æ®ä¼ è¾“çš„è¯­ä¹‰é€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§çº§åˆ«ï¼š

è®¾ç½®æ¶ˆè´¹è€…é‡Œé¢æœ‰enable.auto.commit = true/false

* æœ€å¤šä¸€æ¬¡: æ¶ˆæ¯ä¸ä¼šè¢«é‡å¤å‘é€ï¼Œæœ€å¤šè¢«ä¼ è¾“ä¸€æ¬¡ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½ä¸€æ¬¡ä¸ä¼ è¾“

å…ˆæäº¤åç§»é‡ï¼Œåœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘

* æœ€å°‘ä¸€æ¬¡: æ¶ˆæ¯ä¸ä¼šè¢«æ¼å‘é€ï¼Œæœ€å°‘è¢«ä¼ è¾“ä¸€æ¬¡ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½è¢«é‡å¤ä¼ è¾“

* ç²¾ç¡®ä¸€æ¬¡ï¼ˆExactly onceï¼‰: ä¸ä¼šæ¼ä¼ è¾“ä¹Ÿä¸ä¼šé‡å¤ä¼ è¾“

## 7.32 **kafka æ¶ˆè´¹è€…æ˜¯å¦å¯ä»¥æŒ‡å®šåˆ†åŒºçš„æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Ÿ**



## 7.33 **kafka æ¶ˆè´¹è€…æ˜¯å¦ä»æŒ‡å®šåç§»é‡å¼€å§‹æ¶ˆè´¹ï¼Ÿ**

å¯ä»¥ï¼Œé€šè¿‡seekæŒ‡å®šåç§»é‡åå†å¼€å§‹æ¶ˆè´¹



## 7.34 **å®¢æˆ·ç«¯æ“ä½œkafkaæ¶ˆæ¯æ˜¯é‡‡ç”¨pollæ¨¡å¼ï¼Œè¿˜æ˜¯pushæ¨¡å¼ï¼Ÿ**

kafkaæœ€åˆè€ƒè™‘çš„é—®é¢˜æ˜¯ï¼Œcustomeråº”è¯¥ä»brokesæ‹‰å–æ¶ˆæ¯è¿˜æ˜¯brokerså°†æ¶ˆæ¯æ¨é€åˆ°consumerï¼Œä¹Ÿå°±æ˜¯pullè¿˜æ˜¯pushã€‚åœ¨è¿™æ–¹é¢ï¼ŒKafkaéµå¾ªäº†ä¸€ç§å¤§éƒ¨åˆ†æ¶ˆæ¯ç³»ç»Ÿå…±åŒçš„ä¼ ç»Ÿçš„è®¾è®¡ï¼šproducerå°†æ¶ˆæ¯æ¨é€åˆ°brokerï¼Œconsumerä»brokeræ‹‰å–æ¶ˆæ¯ã€‚

ä¸€äº›æ¶ˆæ¯ç³»ç»Ÿæ¯”å¦‚Scribeå’ŒApache Flumeé‡‡ç”¨äº†pushæ¨¡å¼ï¼Œå°†æ¶ˆæ¯æ¨é€åˆ°ä¸‹æ¸¸çš„consumerã€‚è¿™æ ·åšæœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ï¼šç”±brokerå†³å®šæ¶ˆæ¯æ¨é€çš„é€Ÿç‡ï¼Œå¯¹äºä¸åŒæ¶ˆè´¹é€Ÿç‡çš„consumerå°±ä¸å¤ªå¥½å¤„ç†äº†ã€‚æ¶ˆæ¯ç³»ç»Ÿéƒ½è‡´åŠ›äºè®©consumerä»¥æœ€å¤§çš„é€Ÿç‡æœ€å¿«é€Ÿçš„æ¶ˆè´¹æ¶ˆæ¯ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œpushæ¨¡å¼ä¸‹ï¼Œå½“brokeræ¨é€çš„é€Ÿç‡è¿œå¤§äºconsumeræ¶ˆè´¹çš„é€Ÿç‡æ—¶ï¼Œconsumerææ€•å°±è¦å´©æºƒäº†ã€‚æœ€ç»ˆKafkaè¿˜æ˜¯é€‰å–äº†ä¼ ç»Ÿçš„pullæ¨¡å¼ã€‚
pullæ¨¡å¼çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯consumerå¯ä»¥è‡ªä¸»å†³å®šæ˜¯å¦æ‰¹é‡çš„ä»brokeræ‹‰å–æ•°æ®ã€‚pushæ¨¡å¼å¿…é¡»åœ¨ä¸çŸ¥é“ä¸‹æ¸¸consumeræ¶ˆè´¹èƒ½åŠ›å’Œæ¶ˆè´¹ç­–ç•¥çš„æƒ…å†µä¸‹å†³å®šæ˜¯ç«‹å³æ¨é€æ¯æ¡æ¶ˆæ¯è¿˜æ˜¯ç¼“å­˜ä¹‹åæ‰¹é‡æ¨é€ã€‚å¦‚æœä¸ºäº†é¿å…consumerå´©æºƒè€Œé‡‡ç”¨è¾ƒä½çš„æ¨é€é€Ÿç‡ï¼Œå°†å¯èƒ½å¯¼è‡´ä¸€æ¬¡åªæ¨é€è¾ƒå°‘çš„æ¶ˆæ¯è€Œé€ æˆæµªè´¹ã€‚Pullæ¨¡å¼ä¸‹ï¼Œconsumerå°±å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¶ˆè´¹èƒ½åŠ›å»å†³å®šè¿™äº›ç­–ç•¥ã€‚
pullæœ‰ä¸ªç¼ºç‚¹æ˜¯ï¼Œå¦‚æœbrokeræ²¡æœ‰å¯ä¾›æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå°†å¯¼è‡´consumerä¸æ–­åœ¨å¾ªç¯ä¸­è½®è¯¢ï¼Œç›´åˆ°æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚ä¸ºäº†é¿å…è¿™ç‚¹ï¼ŒKafkaæœ‰ä¸ªå‚æ•°å¯ä»¥è®©consumeré˜»å¡ç›´åˆ°æ–°æ¶ˆæ¯åˆ°è¾¾(å½“ç„¶ä¹Ÿå¯ä»¥é˜»å¡ç›´åˆ°æ¶ˆæ¯çš„æ•°é‡è¾¾åˆ°æŸä¸ªç‰¹å®šçš„é‡è¿™æ ·å°±å¯ä»¥æ‰¹é‡æ‹‰å–ï¼‰

## 7.35 **kafkaçš„æ¶ˆæ¯æ ¼å¼æœ‰äº†è§£å—ï¼Ÿ**

## 7.36 **kafka é«˜æ•ˆæ–‡ä»¶å­˜å‚¨è®¾è®¡ç‰¹ç‚¹**

KafkaæŠŠtopicä¸­ä¸€ä¸ªparitionå¤§æ–‡ä»¶åˆ†æˆå¤šä¸ªå°æ–‡ä»¶æ®µï¼Œé€šè¿‡å¤šä¸ªå°æ–‡ä»¶æ®µï¼Œå°±å®¹æ˜“å®šæœŸæ¸…é™¤æˆ–åˆ é™¤å·²ç»æ¶ˆè´¹å®Œæ–‡ä»¶ï¼Œå‡å°‘ç£ç›˜å ç”¨ã€‚  é»˜è®¤å­˜å‚¨æ—¶é—´7å¤©

é€šè¿‡ç´¢å¼•ä¿¡æ¯å¯ä»¥å¿«é€Ÿå®šä½messageã€‚







## 7.37 **kafkaçš„åˆ†åŒºåˆ†å¸ƒç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ**

åˆ†åŒºåˆ†å¸ƒçš„è®¡ç®—ç­–ç•¥å¦‚ä¸‹

* å‰¯æœ¬å› å­ä¸èƒ½å¤§äº Broker çš„ä¸ªæ•°ï¼›

* **ç¬¬ä¸€ä¸ªåˆ†åŒº**ï¼ˆç¼–å·ä¸º0ï¼‰çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®æ˜¯éšæœºä» brokerList é€‰æ‹©çš„ï¼›

* **å…¶ä»–åˆ†åŒº**çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®ç›¸å¯¹äºç¬¬0ä¸ªåˆ†åŒºä¾æ¬¡å¾€åç§»ã€‚ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬æœ‰5ä¸ª Brokerï¼Œ5ä¸ªåˆ†åŒºï¼Œå‡è®¾ç¬¬1ä¸ªåˆ†åŒºæ”¾åœ¨ç¬¬å››ä¸ª Broker ä¸Šï¼Œé‚£ä¹ˆç¬¬2ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬äº”ä¸ª Broker ä¸Šï¼›ç¬¬3ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬ä¸€ä¸ª Broker ä¸Šï¼›ç¬¬4ä¸ªåˆ†åŒºå°†ä¼šæ”¾åœ¨ç¬¬äºŒä¸ª Broker ä¸Šï¼Œä¾æ¬¡ç±»æ¨ï¼›

* **å‰©ä½™å‰¯æœ¬**ç›¸å¯¹äºç¬¬1ä¸ªå‰¯æœ¬æ”¾ç½®ä½ç½®æ˜¯ç”±ä¸€ä¸ªéšæœºæ•°nextReplicaShift å†³å®šï¼›&#x20;

## 7.38 **kafkaåˆ†åŒºæ•°å¯ä»¥å¢åŠ æˆ–å‡å°‘å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ**

**kafkaå…è®¸å¯¹topicåŠ¨æ€å¢åŠ åˆ†åŒºï¼Œä½†ä¸æ”¯æŒå‡å°‘åˆ†åŒº**

Kafka åˆ†åŒºæ•°æ®ä¸æ”¯æŒå‡å°‘æ˜¯ç”±å¾ˆå¤šåŸå› çš„ï¼Œæ¯”å¦‚å‡å°‘çš„åˆ†åŒºå…¶æ•°æ®æ”¾åˆ°å“ªé‡Œå»ï¼Ÿæ˜¯åˆ é™¤ï¼Œè¿˜æ˜¯ä¿ç•™ï¼Ÿåˆ é™¤çš„è¯ï¼Œé‚£ä¹ˆè¿™äº›æ²¡æ¶ˆè´¹çš„æ¶ˆæ¯ä¸å°±ä¸¢äº†ã€‚å¦‚æœä¿ç•™è¿™äº›æ¶ˆæ¯å¦‚ä½•æ”¾åˆ°å…¶ä»–åˆ†åŒºé‡Œé¢ï¼Ÿè¿½åŠ åˆ°å…¶ä»–åˆ†åŒºåé¢çš„è¯é‚£ä¹ˆå°±ç ´åäº† Kafka å•ä¸ªåˆ†åŒºçš„æœ‰åºæ€§ã€‚å¦‚æœè¦ä¿è¯åˆ é™¤åˆ†åŒºæ•°æ®æ’å…¥åˆ°å…¶ä»–åˆ†åŒºä¿è¯æœ‰åºæ€§ï¼Œé‚£ä¹ˆå®ç°èµ·æ¥é€»è¾‘å°±ä¼šéå¸¸å¤æ‚ã€‚

## 7.39 **kafkaæ–°å»ºçš„åˆ†åŒºä¼šåœ¨å“ªåˆ›å»ºå­˜å‚¨ç›®å½•**

**log.dirs**å‚æ•°ï¼Œå…¶å€¼æ˜¯ kafka æ•°æ®çš„å­˜æ”¾ç›®å½•ï¼›

**è¿™ä¸ªå‚æ•°å¯ä»¥é…ç½®å¤šä¸ªç›®å½•**ï¼Œç›®å½•ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”ï¼Œé€šå¸¸è¿™äº›ç›®å½•æ˜¯åˆ†å¸ƒåœ¨ä¸åŒçš„ç£ç›˜ä¸Šç”¨äºæé«˜è¯»å†™æ€§èƒ½ã€‚

å¦‚æœlog.dirså‚æ•°åªé…ç½®äº†ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆåˆ†é…åˆ°å„ä¸ª broker ä¸Šçš„åˆ†åŒºè‚¯å®šåªèƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾æ•°æ®ã€‚

ä½†æ˜¯å¦‚æœlog.dirså‚æ•°é…ç½®äº†å¤šä¸ªç›®å½•ï¼Œé‚£ä¹ˆ kafka ä¼šåœ¨å“ªä¸ªæ–‡ä»¶å¤¹ä¸­åˆ›å»ºåˆ†åŒºç›®å½•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šKafka ä¼šåœ¨å«æœ‰åˆ†åŒºç›®å½•æœ€å°‘çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ–°çš„åˆ†åŒºç›®å½•ï¼Œåˆ†åŒºç›®å½•åä¸º Topicå+åˆ†åŒºIDã€‚

æ³¨æ„ï¼Œæ˜¯åˆ†åŒºæ–‡ä»¶å¤¹æ€»æ•°æœ€å°‘çš„ç›®å½•ï¼Œè€Œä¸æ˜¯ç£ç›˜ä½¿ç”¨é‡æœ€å°‘çš„ç›®å½•ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ ç»™ log.dirs å‚æ•°æ–°å¢äº†ä¸€ä¸ªæ–°çš„ç£ç›˜ï¼Œæ–°çš„åˆ†åŒºç›®å½•è‚¯å®šæ˜¯å…ˆåœ¨è¿™ä¸ªæ–°çš„ç£ç›˜ä¸Šåˆ›å»ºç›´åˆ°è¿™ä¸ªæ–°çš„ç£ç›˜ç›®å½•æ‹¥æœ‰çš„åˆ†åŒºç›®å½•ä¸æ˜¯æœ€å°‘ä¸ºæ­¢ã€‚

## 7.40 **æ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…ç»„æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ**

æ¯ä¸ªæ¶ˆè´¹è€…ä»å±äºæ¶ˆè´¹ç»„ã€‚æ¶ˆè´¹è€…é€šè¿‡ä¸€ä¸ªå‚æ•°ï¼šgroup.id æ¥æŒ‡å®šæ‰€å±çš„ç»„ï¼›

å¯ä»¥æŠŠå¤šä¸ªæ¶ˆè´¹è€…çš„group.idè®¾ç½®æˆåŒä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™å‡ ä¸ªæ¶ˆè´¹è€…å°±å±äºåŒä¸€ä¸ªç»„ï¼›

æ¯”å¦‚ï¼Œè®©c-1ï¼Œc-2,c-3çš„group.id=â€œg1",é‚£ä¹ˆc-1,c-2,c-3è¿™3ä¸ªæ¶ˆè´¹è€…éƒ½å±äºg1æ¶ˆè´¹ç»„ï¼›

ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œåœ¨æœ¬è´¨ä¸Šç©¶ç«Ÿå¦‚ä½•å®šä¹‰ï¼šä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªconsumerå¯¹è±¡å®ä¾‹ï¼

**æ¶ˆè´¹è€…ç»„çš„æ„ä¹‰ï¼š**ï¼ˆå¯ä»¥è®©å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªç»„ï¼Œå¹¶å…±åŒåä½œæ¥æ¶ˆè´¹æ•°æ®ï¼Œæé«˜æ¶ˆè´¹å¹¶è¡Œåº¦ï¼‰ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„å„æ¶ˆè´¹è€…ï¼Œåœ¨æ¶ˆè´¹ä¸€ä¸ªtopicçš„æ•°æ®æ—¶ï¼Œäº’ç›¸ä¸é‡å¤ï¼å¦‚æœtopicçš„æŸåˆ†åŒºè¢«ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹æ¶ˆè´¹ï¼Œé‚£ä¹ˆï¼Œå…¶ä»–æ¶ˆè´¹è€…å°±ä¸ä¼šå†æ¶ˆè´¹è¿™ä¸ªåˆ†åŒºäº†ï¼›

å…·ä½“å…³ç³»å¦‚ä¸‹ï¼š

![](images/image-46.png)

##

## 7.41 **kafkaç›‘æ§æ’ä»¶éƒ½æœ‰å“ªäº›ï¼Ÿ**

kafka manager

kafka-offset-monitor ï¼šä¸»è¦åšæ¶ˆè´¹è€…åç§»é‡çš„ç›‘æ§

kafka-eagleï¼šåŠŸèƒ½å¾ˆå¼ºå¤§ï¼ï¼ˆç°å·²æ”¹åä¸ºï¼šEFAK â€”â€” eagle for apache kafkaï¼‰

&#x20;

&#x20;

