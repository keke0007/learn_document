# MongoDB é«˜æ€§èƒ½åŸç†ä¸é«˜çº§åº”ç”¨æ¡ˆä¾‹ï¼ˆæ·±å…¥ç‰ˆï¼‰

## æ¡ˆä¾‹æ¦‚è¿°

æœ¬æ¡ˆä¾‹æ·±å…¥ MongoDB é«˜æ€§èƒ½åŸç†ã€æ•°æ®ç»“æ„ç»„åˆæœºåˆ¶ã€é«˜çº§åº”ç”¨åœºæ™¯ã€‚**é‡ç‚¹ï¼šWiredTiger å­˜å‚¨å¼•æ“ã€B-Tree ç´¢å¼•ã€å‰¯æœ¬é›†æœºåˆ¶ã€åˆ†ç‰‡ç­–ç•¥ã€çœŸå®ä¸šåŠ¡åœºæ™¯è®¾è®¡ã€‚**

---

## ğŸš€ é«˜æ€§èƒ½åŸç†

### 1. WiredTiger å­˜å‚¨å¼•æ“

**å­˜å‚¨æ¶æ„ï¼š**
- **æ•°æ®æ–‡ä»¶**ï¼šæŒ‰é›†åˆï¼ˆCollectionï¼‰ç»„ç»‡ï¼Œæ¯ä¸ªé›†åˆä¸€ä¸ªæ–‡ä»¶
- **æ—¥å¿—æ–‡ä»¶**ï¼šWALï¼ˆWrite-Ahead Logï¼‰ï¼Œä¿è¯æ•°æ®æŒä¹…åŒ–
- **ç¼“å­˜**ï¼šé»˜è®¤ä½¿ç”¨ 50% çš„å¯ç”¨å†…å­˜ä½œä¸ºç¼“å­˜

**å†™å…¥æµç¨‹ï¼š**
```
å†™å…¥è¯·æ±‚
  -> å†™å…¥å†…å­˜ç¼“å­˜ï¼ˆWiredTiger Cacheï¼‰
    -> å†™å…¥ WALï¼ˆWrite-Ahead Logï¼‰
      -> å®šæœŸ Checkpointï¼ˆå°†ç¼“å­˜æ•°æ®åˆ·åˆ°ç£ç›˜ï¼‰
        -> å‹ç¼©æ•°æ®æ–‡ä»¶
```

**Checkpoint æœºåˆ¶ï¼š**
- **è§¦å‘æ¡ä»¶**ï¼š
  - 60 ç§’é—´éš”ï¼ˆ`checkpointIntervalSecs`ï¼‰
  - WAL å¤§å°è¾¾åˆ° 2GBï¼ˆ`checkpointSizeMB`ï¼‰
- **è¿‡ç¨‹**ï¼š
  - å°†ç¼“å­˜ä¸­çš„è„é¡µå†™å…¥ç£ç›˜
  - æ›´æ–°æ•°æ®æ–‡ä»¶
  - æ¸…ç†æ—§çš„ WAL æ–‡ä»¶

**å‹ç¼©æœºåˆ¶ï¼š**
- **å—å‹ç¼©**ï¼šä½¿ç”¨ Snappy å‹ç¼©æ•°æ®å—
- **å‰ç¼€å‹ç¼©**ï¼šç›¸åŒå‰ç¼€çš„é”®å€¼å¯¹å‹ç¼©
- **å‹ç¼©æ¯”**ï¼šé€šå¸¸ 2-3:1

---

### 2. B-Tree ç´¢å¼•æœºåˆ¶

**B-Tree ç»“æ„ï¼š**
```
æ ¹èŠ‚ç‚¹
  â”œâ”€ å†…éƒ¨èŠ‚ç‚¹1
  â”‚   â”œâ”€ å¶å­èŠ‚ç‚¹1ï¼ˆæ•°æ®æŒ‡é’ˆï¼‰
  â”‚   â””â”€ å¶å­èŠ‚ç‚¹2ï¼ˆæ•°æ®æŒ‡é’ˆï¼‰
  â””â”€ å†…éƒ¨èŠ‚ç‚¹2
      â”œâ”€ å¶å­èŠ‚ç‚¹3ï¼ˆæ•°æ®æŒ‡é’ˆï¼‰
      â””â”€ å¶å­èŠ‚ç‚¹4ï¼ˆæ•°æ®æŒ‡é’ˆï¼‰
```

**ç´¢å¼•ç±»å‹ï¼š**
- **å•å­—æ®µç´¢å¼•**ï¼šå•ä¸ªå­—æ®µçš„ç´¢å¼•
- **å¤åˆç´¢å¼•**ï¼šå¤šä¸ªå­—æ®µçš„ç»„åˆç´¢å¼•
- **å¤šé”®ç´¢å¼•**ï¼šæ•°ç»„å­—æ®µçš„ç´¢å¼•
- **æ–‡æœ¬ç´¢å¼•**ï¼šå…¨æ–‡æœç´¢ç´¢å¼•
- **åœ°ç†ç©ºé—´ç´¢å¼•**ï¼š2dsphereã€2d ç´¢å¼•

**ç´¢å¼•é€‰æ‹©ç­–ç•¥ï¼š**
- **ESR è§„åˆ™**ï¼šEqualityï¼ˆç­‰å€¼ï¼‰â†’ Sortï¼ˆæ’åºï¼‰â†’ Rangeï¼ˆèŒƒå›´ï¼‰
- **æœ€å·¦å‰ç¼€**ï¼šå¤åˆç´¢å¼•æ”¯æŒæœ€å·¦å‰ç¼€åŒ¹é…
- **ç´¢å¼•è¦†ç›–**ï¼šæŸ¥è¯¢å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€å›è¡¨

**ç´¢å¼•æ€§èƒ½ï¼š**
- **æŸ¥æ‰¾**ï¼šO(log N)
- **æ’å…¥**ï¼šO(log N)
- **æ›´æ–°**ï¼šO(log N)

---

### 3. å‰¯æœ¬é›†æœºåˆ¶ï¼ˆReplica Setï¼‰

**å‰¯æœ¬é›†æ¶æ„ï¼š**
```
Primaryï¼ˆä¸»èŠ‚ç‚¹ï¼‰
  â”œâ”€ Secondary 1ï¼ˆä»èŠ‚ç‚¹ï¼Œå¯è¯»ï¼‰
  â”œâ”€ Secondary 2ï¼ˆä»èŠ‚ç‚¹ï¼Œå¯è¯»ï¼‰
  â””â”€ Arbiterï¼ˆä»²è£èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨æ•°æ®ï¼‰
```

**ä¸»ä»å¤åˆ¶æµç¨‹ï¼š**
```
Primary å†™å…¥æ“ä½œ
  -> Oplogï¼ˆæ“ä½œæ—¥å¿—ï¼‰
    -> Secondary æ‹‰å– Oplog
      -> åº”ç”¨æ“ä½œåˆ° Secondary
        -> æ›´æ–° Secondary æ•°æ®
```

**Oplog ç»“æ„ï¼š**
```json
{
  "ts": Timestamp(1640000000, 1),
  "h": NumberLong("1234567890"),
  "v": 2,
  "op": "i",  // i=insert, u=update, d=delete
  "ns": "mydb.users",
  "o": {
    "_id": ObjectId("..."),
    "name": "Alice",
    "age": 25
  }
}
```

**æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰ï¼š**
- **å¿ƒè·³æ£€æµ‹**ï¼šæ¯ 2 ç§’å‘é€å¿ƒè·³
- **é€‰ä¸¾æœºåˆ¶**ï¼šPrimary æ•…éšœï¼ŒSecondary é€‰ä¸¾æ–° Primary
- **é€‰ä¸¾æ¡ä»¶**ï¼š
  - è·å¾—å¤§å¤šæ•°æŠ•ç¥¨
  - æ•°æ®æœ€æ–°ï¼ˆOplog æœ€æ–°ï¼‰

---

### 4. åˆ†ç‰‡é›†ç¾¤ï¼ˆSharded Clusterï¼‰

**åˆ†ç‰‡æ¶æ„ï¼š**
```
Mongosï¼ˆè·¯ç”±èŠ‚ç‚¹ï¼‰
  â”œâ”€ Config Serverï¼ˆé…ç½®æœåŠ¡å™¨ï¼‰
  â””â”€ Shardï¼ˆåˆ†ç‰‡ï¼‰
      â”œâ”€ Shard 1ï¼ˆPrimary + Secondaryï¼‰
      â”œâ”€ Shard 2ï¼ˆPrimary + Secondaryï¼‰
      â””â”€ Shard 3ï¼ˆPrimary + Secondaryï¼‰
```

**åˆ†ç‰‡é”®ï¼ˆShard Keyï¼‰ï¼š**
- **èŒƒå›´åˆ†ç‰‡**ï¼šæŒ‰åˆ†ç‰‡é”®èŒƒå›´åˆ†ç‰‡
- **å“ˆå¸Œåˆ†ç‰‡**ï¼šæŒ‰åˆ†ç‰‡é”®å“ˆå¸Œå€¼åˆ†ç‰‡

**åˆ†ç‰‡ç­–ç•¥ï¼š**
- **èŒƒå›´åˆ†ç‰‡**ï¼š
  - ä¼˜åŠ¿ï¼šèŒƒå›´æŸ¥è¯¢æ•ˆç‡é«˜
  - åŠ£åŠ¿ï¼šå¯èƒ½æ•°æ®å€¾æ–œ
- **å“ˆå¸Œåˆ†ç‰‡**ï¼š
  - ä¼˜åŠ¿ï¼šæ•°æ®åˆ†å¸ƒå‡åŒ€
  - åŠ£åŠ¿ï¼šèŒƒå›´æŸ¥è¯¢éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡

**Chunk è¿ç§»ï¼š**
- **è§¦å‘æ¡ä»¶**ï¼šChunk å¤§å°è¶…è¿‡ `chunkSize`ï¼ˆé»˜è®¤ 64MBï¼‰
- **è¿ç§»è¿‡ç¨‹**ï¼š
  - ä»æºåˆ†ç‰‡å¤åˆ¶æ•°æ®
  - æ›´æ–° Config Server
  - åˆ é™¤æºåˆ†ç‰‡æ•°æ®

---

### 5. èšåˆç®¡é“ä¼˜åŒ–

**èšåˆç®¡é“é˜¶æ®µï¼š**
```
$matchï¼ˆè¿‡æ»¤ï¼‰
  -> $projectï¼ˆæŠ•å½±ï¼‰
    -> $groupï¼ˆåˆ†ç»„ï¼‰
      -> $sortï¼ˆæ’åºï¼‰
        -> $limitï¼ˆé™åˆ¶ï¼‰
```

**ä¼˜åŒ–ç­–ç•¥ï¼š**
- **å°½æ—©è¿‡æ»¤**ï¼š`$match` æ”¾åœ¨å‰é¢ï¼Œå‡å°‘æ•°æ®é‡
- **ç´¢å¼•åˆ©ç”¨**ï¼š`$match` ä½¿ç”¨ç´¢å¼•ï¼Œæé«˜æ€§èƒ½
- **æŠ•å½±ä¼˜åŒ–**ï¼š`$project` åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
- **å†…å­˜é™åˆ¶**ï¼š`allowDiskUse: true` å…è®¸ä½¿ç”¨ç£ç›˜

---

## ğŸ”§ æ•°æ®ç»“æ„ç»„åˆåŠŸèƒ½

### ç»„åˆ1ï¼šæ–‡æ¡£æ¨¡å‹ + åµŒå¥—æŸ¥è¯¢

**æ•°æ®ç»“æ„ç»„åˆï¼š**
- **åµŒå¥—æ–‡æ¡£**ï¼šæ–‡æ¡£å†…åµŒå¥—å­æ–‡æ¡£
- **æ•°ç»„å­—æ®µ**ï¼šæ–‡æ¡£å†…åŒ…å«æ•°ç»„
- **å¼•ç”¨å…³ç³»**ï¼šæ–‡æ¡£é—´é€šè¿‡ `_id` å¼•ç”¨

**åµŒå¥—æ–‡æ¡£è®¾è®¡ï¼š**
```json
{
  "_id": ObjectId("..."),
  "user_id": "user123",
  "profile": {
    "name": "Alice",
    "age": 25,
    "address": {
      "city": "Beijing",
      "street": "Main St"
    }
  },
  "orders": [
    {
      "order_id": "order1",
      "amount": 100.0,
      "status": "completed"
    },
    {
      "order_id": "order2",
      "amount": 200.0,
      "status": "pending"
    }
  ]
}
```

**åµŒå¥—æŸ¥è¯¢ï¼š**
```python
# æŸ¥è¯¢åµŒå¥—å­—æ®µ
users = collection.find({
    'profile.name': 'Alice',
    'profile.address.city': 'Beijing'
})

# æŸ¥è¯¢æ•°ç»„å…ƒç´ 
users = collection.find({
    'orders.status': 'completed',
    'orders.amount': {'$gte': 100}
})

# æ•°ç»„å…ƒç´ åŒ¹é…ï¼ˆ$elemMatchï¼‰
users = collection.find({
    'orders': {
        '$elemMatch': {
            'status': 'completed',
            'amount': {'$gte': 100}
        }
    }
})
```

---

### ç»„åˆ2ï¼šç´¢å¼• + èšåˆç®¡é“

**æ•°æ®ç»“æ„ç»„åˆï¼š**
- **å•å­—æ®µç´¢å¼•**ï¼šå¿«é€Ÿå®šä½æ–‡æ¡£
- **å¤åˆç´¢å¼•**ï¼šæ”¯æŒå¤šå­—æ®µæŸ¥è¯¢å’Œæ’åº
- **èšåˆç®¡é“**ï¼šå¤šé˜¶æ®µæ•°æ®å¤„ç†

**ç´¢å¼• + èšåˆè®¾è®¡ï¼š**
```python
# åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆESR è§„åˆ™ï¼‰
collection.create_index([
    ('status', 1),      # Equality
    ('created_at', -1)  # Sort
])

# èšåˆæŸ¥è¯¢ï¼ˆåˆ©ç”¨ç´¢å¼•ï¼‰
pipeline = [
    {'$match': {'status': 'active'}},  # ä½¿ç”¨ç´¢å¼•
    {'$sort': {'created_at': -1}},     # ä½¿ç”¨ç´¢å¼•
    {'$group': {
        '_id': '$category',
        'count': {'$sum': 1},
        'total_amount': {'$sum': '$amount'}
    }},
    {'$limit': 10}
]

results = collection.aggregate(pipeline)
```

---

### ç»„åˆ3ï¼šå‰¯æœ¬é›† + è¯»å†™åˆ†ç¦»

**æ•°æ®ç»“æ„ç»„åˆï¼š**
- **Primary**ï¼šå¤„ç†å†™æ“ä½œ
- **Secondary**ï¼šå¤„ç†è¯»æ“ä½œï¼ˆå¯é…ç½®ï¼‰
- **Read Preference**ï¼šæ§åˆ¶è¯»æ“ä½œè·¯ç”±

**è¯»å†™åˆ†ç¦»è®¾è®¡ï¼š**
```python
from pymongo import MongoClient, ReadPreference

# å†™æ“ä½œï¼ˆPrimaryï¼‰
write_client = MongoClient(
    'mongodb://primary:27017/',
    read_preference=ReadPreference.PRIMARY
)
write_db = write_client['mydb']
write_collection = write_db['users']

# å†™æ“ä½œ
write_collection.insert_one({'name': 'Alice', 'age': 25})

# è¯»æ“ä½œï¼ˆSecondaryï¼‰
read_client = MongoClient(
    'mongodb://secondary1:27017,secondary2:27017/',
    read_preference=ReadPreference.SECONDARY_PREFERRED  # ä¼˜å…ˆä» Secondary è¯»
)
read_db = read_client['mydb']
read_collection = read_db['users']

# è¯»æ“ä½œ
user = read_collection.find_one({'name': 'Alice'})
```

---

## ğŸ’¼ é«˜çº§åº”ç”¨åœºæ™¯æ¡ˆä¾‹

### åœºæ™¯1ï¼šå†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰

**ä¸šåŠ¡éœ€æ±‚ï¼š**
- æ–‡ç« ç®¡ç†ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾ã€åˆ†ç±»ï¼‰
- å¤šç‰ˆæœ¬ç®¡ç†ï¼ˆæ–‡ç« å†å²ç‰ˆæœ¬ï¼‰
- å…¨æ–‡æœç´¢ï¼ˆæ ‡é¢˜ã€å†…å®¹æœç´¢ï¼‰
- è¯„è®ºç³»ç»Ÿï¼ˆåµŒå¥—è¯„è®ºï¼‰

**æ–‡æ¡£è®¾è®¡ï¼š**
```json
{
  "_id": ObjectId("..."),
  "article_id": "article123",
  "title": "MongoDB é«˜æ€§èƒ½åŸç†",
  "content": "MongoDB ä½¿ç”¨ WiredTiger å­˜å‚¨å¼•æ“...",
  "author": {
    "user_id": "user123",
    "name": "Alice"
  },
  "category": "æŠ€æœ¯",
  "tags": ["mongodb", "database", "performance"],
  "status": "published",
  "created_at": ISODate("2024-01-26T10:00:00Z"),
  "updated_at": ISODate("2024-01-26T10:00:00Z"),
  "views": 1000,
  "likes": 50,
  "versions": [
    {
      "version": 1,
      "content": "æ—§ç‰ˆæœ¬å†…å®¹",
      "created_at": ISODate("2024-01-25T10:00:00Z")
    }
  ],
  "comments": [
    {
      "comment_id": "comment1",
      "user_id": "user456",
      "content": "å¾ˆå¥½çš„æ–‡ç« ",
      "created_at": ISODate("2024-01-26T11:00:00Z"),
      "replies": [
        {
          "comment_id": "reply1",
          "user_id": "user123",
          "content": "è°¢è°¢",
          "created_at": ISODate("2024-01-26T11:30:00Z")
        }
      ]
    }
  ]
}
```

**ç´¢å¼•è®¾è®¡ï¼š**
```python
# å…¨æ–‡æœç´¢ç´¢å¼•
collection.create_index([
    ('title', 'text'),
    ('content', 'text')
])

# å¤åˆç´¢å¼•ï¼ˆæŸ¥è¯¢ + æ’åºï¼‰
collection.create_index([
    ('status', 1),
    ('created_at', -1)
])

# æ ‡ç­¾ç´¢å¼•
collection.create_index([('tags', 1)])

# åˆ†ç±»ç´¢å¼•
collection.create_index([('category', 1)])
```

**æŸ¥è¯¢è®¾è®¡ï¼š**
```python
# å…¨æ–‡æœç´¢
articles = collection.find({
    '$text': {'$search': 'MongoDB é«˜æ€§èƒ½'}
}).sort([('score', {'$meta': 'textScore'})])

# åˆ†ç±» + æ’åº
articles = collection.find({
    'category': 'æŠ€æœ¯',
    'status': 'published'
}).sort([('created_at', -1)]).limit(20)

# æ ‡ç­¾è¿‡æ»¤
articles = collection.find({
    'tags': {'$in': ['mongodb', 'database']}
})

# èšåˆç»Ÿè®¡
pipeline = [
    {'$match': {'status': 'published'}},
    {'$group': {
        '_id': '$category',
        'count': {'$sum': 1},
        'total_views': {'$sum': '$views'},
        'avg_likes': {'$avg': '$likes'}
    }},
    {'$sort': {'count': -1}}
]

stats = collection.aggregate(pipeline)
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- **ç´¢å¼•è¦†ç›–**ï¼šæŸ¥è¯¢å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€å›è¡¨
- **æŠ•å½±ä¼˜åŒ–**ï¼šåªé€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
- **åˆ†é¡µä¼˜åŒ–**ï¼šä½¿ç”¨ `skip()` + `limit()`ï¼Œæˆ–åŸºäº `_id` çš„åˆ†é¡µ

**éªŒè¯æ•°æ®ï¼š**
- **å†™å…¥æ€§èƒ½**ï¼š1ä¸‡ç¯‡æ–‡ç« /åˆ†é’Ÿï¼ˆå•èŠ‚ç‚¹ï¼‰
- **æŸ¥è¯¢æ€§èƒ½**ï¼šå…¨æ–‡æœç´¢ < 200msï¼Œåˆ†ç±»æŸ¥è¯¢ < 50ms
- **å­˜å‚¨**ï¼š100ä¸‡ç¯‡æ–‡ç« ï¼ŒåŸå§‹æ•°æ® 50GBï¼Œç´¢å¼•å 80GB

---

### åœºæ™¯2ï¼šç”µå•†è®¢å•ç³»ç»Ÿ

**ä¸šåŠ¡éœ€æ±‚ï¼š**
- è®¢å•ç®¡ç†ï¼ˆè®¢å•ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æ”¯ä»˜ä¿¡æ¯ï¼‰
- è®¢å•çŠ¶æ€æµè½¬ï¼ˆå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å‘è´§ã€å·²å®Œæˆï¼‰
- è®¢å•æŸ¥è¯¢ï¼ˆæŒ‰ç”¨æˆ·ã€æŒ‰æ—¶é—´ã€æŒ‰çŠ¶æ€ï¼‰
- è®¢å•ç»Ÿè®¡ï¼ˆé”€å”®é¢ã€è®¢å•æ•°ã€è½¬åŒ–ç‡ï¼‰

**æ–‡æ¡£è®¾è®¡ï¼š**
```json
{
  "_id": ObjectId("..."),
  "order_id": "ORDER20240126001",
  "user_id": "user123",
  "status": "paid",
  "created_at": ISODate("2024-01-26T10:00:00Z"),
  "paid_at": ISODate("2024-01-26T10:05:00Z"),
  "items": [
    {
      "product_id": "product1",
      "product_name": "iPhone 15",
      "quantity": 1,
      "price": 5999.0,
      "subtotal": 5999.0
    },
    {
      "product_id": "product2",
      "product_name": "AirPods Pro",
      "quantity": 1,
      "price": 1899.0,
      "subtotal": 1899.0
    }
  ],
  "total_amount": 7898.0,
  "discount": 100.0,
  "final_amount": 7798.0,
  "payment": {
    "method": "alipay",
    "transaction_id": "txn123456",
    "paid_at": ISODate("2024-01-26T10:05:00Z")
  },
  "shipping": {
    "address": {
      "name": "Alice",
      "phone": "13800138000",
      "city": "Beijing",
      "street": "Main St 123"
    },
    "shipped_at": null,
    "tracking_number": null
  }
}
```

**ç´¢å¼•è®¾è®¡ï¼š**
```python
# ç”¨æˆ·è®¢å•æŸ¥è¯¢
collection.create_index([('user_id', 1), ('created_at', -1)])

# è®¢å•çŠ¶æ€æŸ¥è¯¢
collection.create_index([('status', 1), ('created_at', -1)])

# è®¢å•IDæŸ¥è¯¢ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
collection.create_index([('order_id', 1)], unique=True)

# æ”¯ä»˜æ—¶é—´æŸ¥è¯¢
collection.create_index([('paid_at', -1)])
```

**æŸ¥è¯¢è®¾è®¡ï¼š**
```python
# ç”¨æˆ·è®¢å•åˆ—è¡¨
orders = collection.find({
    'user_id': 'user123'
}).sort([('created_at', -1)]).limit(20)

# è®¢å•çŠ¶æ€ç»Ÿè®¡
pipeline = [
    {'$match': {
        'created_at': {
            '$gte': datetime(2024, 1, 1),
            '$lt': datetime(2024, 2, 1)
        }
    }},
    {'$group': {
        '_id': '$status',
        'count': {'$sum': 1},
        'total_amount': {'$sum': '$final_amount'}
    }},
    {'$sort': {'count': -1}}
]

stats = collection.aggregate(pipeline)

# é”€å”®é¢ç»Ÿè®¡ï¼ˆæŒ‰å¤©ï¼‰
pipeline = [
    {'$match': {
        'status': 'paid',
        'paid_at': {
            '$gte': datetime(2024, 1, 1),
            '$lt': datetime(2024, 2, 1)
        }
    }},
    {'$group': {
        '_id': {
            '$dateToString': {
                'format': '%Y-%m-%d',
                'date': '$paid_at'
            }
        },
        'order_count': {'$sum': 1},
        'total_amount': {'$sum': '$final_amount'},
        'avg_amount': {'$avg': '$final_amount'}
    }},
    {'$sort': {'_id': 1}}
]

daily_stats = collection.aggregate(pipeline)
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- **å¤åˆç´¢å¼•**ï¼šæŒ‰æŸ¥è¯¢æ¨¡å¼åˆ›å»ºå¤åˆç´¢å¼•
- **æŠ•å½±ä¼˜åŒ–**ï¼šåªé€‰æ‹©éœ€è¦çš„å­—æ®µ
- **åˆ†é¡µä¼˜åŒ–**ï¼šä½¿ç”¨ `skip()` + `limit()`ï¼Œæˆ–åŸºäº `_id` çš„åˆ†é¡µ

**éªŒè¯æ•°æ®ï¼š**
- **å†™å…¥æ€§èƒ½**ï¼š10ä¸‡è®¢å•/åˆ†é’Ÿï¼ˆå•èŠ‚ç‚¹ï¼‰
- **æŸ¥è¯¢æ€§èƒ½**ï¼šç”¨æˆ·è®¢å•æŸ¥è¯¢ < 50msï¼Œç»Ÿè®¡æŸ¥è¯¢ < 500ms
- **å­˜å‚¨**ï¼š1000ä¸‡è®¢å•ï¼ŒåŸå§‹æ•°æ® 200GBï¼Œç´¢å¼•å 300GB

---

### åœºæ™¯3ï¼šç‰©è”ç½‘æ•°æ®å­˜å‚¨ï¼ˆæ—¶åºæ•°æ®ï¼‰

**ä¸šåŠ¡éœ€æ±‚ï¼š**
- è®¾å¤‡æ•°æ®é‡‡é›†ï¼ˆæ¸©åº¦ã€æ¹¿åº¦ã€å‹åŠ›ç­‰ä¼ æ„Ÿå™¨æ•°æ®ï¼‰
- å®æ—¶æŸ¥è¯¢ï¼ˆæœ€æ–°æ•°æ®ã€å†å²æ•°æ®ï¼‰
- æ•°æ®èšåˆï¼ˆæŒ‰æ—¶é—´ã€æŒ‰è®¾å¤‡èšåˆï¼‰
- æ•°æ®ä¿ç•™ï¼ˆçƒ­æ•°æ®ã€æ¸©æ•°æ®ã€å†·æ•°æ®ï¼‰

**æ–‡æ¡£è®¾è®¡ï¼ˆæŒ‰è®¾å¤‡åˆ†é›†åˆï¼‰ï¼š**
```json
{
  "_id": ObjectId("..."),
  "device_id": "device001",
  "timestamp": ISODate("2024-01-26T10:00:00Z"),
  "sensors": {
    "temperature": 25.5,
    "humidity": 60.0,
    "pressure": 1013.25
  },
  "location": {
    "type": "Point",
    "coordinates": [116.3974, 39.9093]
  },
  "status": "online"
}
```

**ç´¢å¼•è®¾è®¡ï¼š**
```python
# æ—¶é—´åºåˆ—ç´¢å¼•ï¼ˆTTL ç´¢å¼•ï¼‰
collection.create_index(
    [('timestamp', 1)],
    expireAfterSeconds=2592000  # 30å¤©åè‡ªåŠ¨åˆ é™¤
)

# è®¾å¤‡ + æ—¶é—´ç´¢å¼•
collection.create_index([
    ('device_id', 1),
    ('timestamp', -1)
])

# åœ°ç†ç©ºé—´ç´¢å¼•
collection.create_index([('location', '2dsphere')])
```

**æŸ¥è¯¢è®¾è®¡ï¼š**
```python
# æœ€æ–°æ•°æ®æŸ¥è¯¢
latest_data = collection.find_one(
    {'device_id': 'device001'},
    sort=[('timestamp', -1)]
)

# å†å²æ•°æ®æŸ¥è¯¢ï¼ˆæ—¶é—´èŒƒå›´ï¼‰
history_data = collection.find({
    'device_id': 'device001',
    'timestamp': {
        '$gte': datetime(2024, 1, 1),
        '$lt': datetime(2024, 1, 2)
    }
}).sort([('timestamp', 1)])

# æ•°æ®èšåˆï¼ˆæŒ‰å°æ—¶ï¼‰
pipeline = [
    {'$match': {
        'device_id': 'device001',
        'timestamp': {
            '$gte': datetime(2024, 1, 26, 0, 0, 0),
            '$lt': datetime(2024, 1, 27, 0, 0, 0)
        }
    }},
    {'$group': {
        '_id': {
            '$dateToString': {
                'format': '%Y-%m-%d %H:00:00',
                'date': '$timestamp'
            }
        },
        'avg_temperature': {'$avg': '$sensors.temperature'},
        'max_temperature': {'$max': '$sensors.temperature'},
        'min_temperature': {'$min': '$sensors.temperature'},
        'count': {'$sum': 1}
    }},
    {'$sort': {'_id': 1}}
]

hourly_stats = collection.aggregate(pipeline)

# åœ°ç†ç©ºé—´æŸ¥è¯¢ï¼ˆé™„è¿‘è®¾å¤‡ï¼‰
nearby_devices = collection.find({
    'location': {
        '$near': {
            '$geometry': {
                'type': 'Point',
                'coordinates': [116.3974, 39.9093]
            },
            '$maxDistance': 1000  # 1å…¬é‡Œå†…
        }
    }
})
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- **TTL ç´¢å¼•**ï¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œå‡å°‘å­˜å‚¨
- **åˆ†é›†åˆå­˜å‚¨**ï¼šæŒ‰è®¾å¤‡åˆ†é›†åˆï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- **æ—¶é—´åºåˆ—ä¼˜åŒ–**ï¼šä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼Œåˆ©ç”¨ç´¢å¼•

**éªŒè¯æ•°æ®ï¼š**
- **å†™å…¥æ€§èƒ½**ï¼š100ä¸‡æ¡æ•°æ®/åˆ†é’Ÿï¼ˆå•èŠ‚ç‚¹ï¼‰
- **æŸ¥è¯¢æ€§èƒ½**ï¼šæœ€æ–°æ•°æ®æŸ¥è¯¢ < 10msï¼Œå†å²æ•°æ®æŸ¥è¯¢ < 100ms
- **å­˜å‚¨**ï¼šæ¯å¤© 100GB æ•°æ®ï¼ŒTTL ç´¢å¼•è‡ªåŠ¨æ¸…ç†

---

## ğŸ› å¸¸è§å‘ä¸æ’æŸ¥

### å‘1ï¼šæ…¢æŸ¥è¯¢
**ç°è±¡**ï¼šæŸ¥è¯¢å“åº”æ—¶é—´ > 1s
**åŸå› **ï¼š
1. æœªä½¿ç”¨ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰
2. ç´¢å¼•é€‰æ‹©ä¸å½“ï¼ˆå¤åˆç´¢å¼•é¡ºåºé”™è¯¯ï¼‰
3. æŸ¥è¯¢èŒƒå›´è¿‡å¤§ï¼ˆæ‰«æå¤§é‡æ–‡æ¡£ï¼‰
**æ’æŸ¥**ï¼š
1. ä½¿ç”¨ `explain()` åˆ†ææŸ¥è¯¢è®¡åˆ’
2. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼ˆ`executionStats.executionStages.stage`ï¼‰
3. ä¼˜åŒ–æŸ¥è¯¢ï¼šä½¿ç”¨ç´¢å¼•ã€å‡å°‘æ‰«æèŒƒå›´

### å‘2ï¼šå†…å­˜æº¢å‡º
**ç°è±¡**ï¼šMongoDB å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼ŒOOM
**åŸå› **ï¼š
1. ç¼“å­˜è®¾ç½®è¿‡å¤§ï¼ˆè¶…è¿‡å¯ç”¨å†…å­˜ï¼‰
2. å¤§æ–‡æ¡£ï¼ˆå•ä¸ªæ–‡æ¡£ > 16MBï¼‰
3. ç´¢å¼•è¿‡å¤šï¼ˆç´¢å¼•å ç”¨å†…å­˜ï¼‰
**æ’æŸ¥**ï¼š
1. è®¾ç½®åˆç†çš„ `wiredTigerCacheSizeGB`ï¼ˆä¸è¶…è¿‡å¯ç”¨å†…å­˜çš„ 50%ï¼‰
2. æ‹†åˆ†å¤§æ–‡æ¡£ï¼ˆä½¿ç”¨å¼•ç”¨å…³ç³»ï¼‰
3. åˆ é™¤ä¸å¿…è¦çš„ç´¢å¼•

### å‘3ï¼šå‰¯æœ¬é›†å»¶è¿Ÿ
**ç°è±¡**ï¼šSecondary æ•°æ®æ»å Primary
**åŸå› **ï¼š
1. ç½‘ç»œå»¶è¿Ÿ
2. Secondary å¤„ç†èƒ½åŠ›ä¸è¶³
3. Oplog å¤§å°ä¸è¶³
**æ’æŸ¥**ï¼š
1. ä½¿ç”¨ `rs.printSlaveReplicationInfo()` æŸ¥çœ‹å»¶è¿Ÿ
2. æ£€æŸ¥ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿ
3. å¢åŠ  Oplog å¤§å°ï¼ˆ`oplogSizeMB`ï¼‰

---

## éªŒè¯æ•°æ®

### MongoDB æ€§èƒ½æµ‹è¯•

| æ“ä½œ | æ•°æ®é‡ | è€—æ—¶ | è¯´æ˜ |
|-----|--------|------|------|
| æ’å…¥ | 100ä¸‡æ¡ | 2min | å•èŠ‚ç‚¹ï¼Œæ‰¹é‡æ’å…¥ |
| æŸ¥è¯¢ï¼ˆç´¢å¼•ï¼‰ | 100ä¸‡æ¡ | <10ms | ä½¿ç”¨ç´¢å¼• |
| æŸ¥è¯¢ï¼ˆå…¨è¡¨æ‰«æï¼‰ | 100ä¸‡æ¡ | 5s | æœªä½¿ç”¨ç´¢å¼• |
| èšåˆ | 100ä¸‡æ¡ | 500ms | ç®€å•èšåˆ |

### å­˜å‚¨æ€§èƒ½

```
å†™å…¥é€Ÿåº¦ï¼š50MB/sï¼ˆå•èŠ‚ç‚¹ï¼‰
è¯»å–é€Ÿåº¦ï¼š100MB/sï¼ˆå•èŠ‚ç‚¹ï¼‰
å‹ç¼©æ¯”ï¼š2-3:1ï¼ˆWiredTiger å‹ç¼©ï¼‰
```

---

## æ€»ç»“

1. **é«˜æ€§èƒ½åŸç†**
   - WiredTiger å­˜å‚¨å¼•æ“ï¼ˆç¼“å­˜ + WAL + Checkpointï¼‰
   - B-Tree ç´¢å¼•ï¼ˆO(log N) æŸ¥æ‰¾ï¼‰
   - å‰¯æœ¬é›†æœºåˆ¶ï¼ˆä¸»ä»å¤åˆ¶ + æ•…éšœè½¬ç§»ï¼‰
   - åˆ†ç‰‡é›†ç¾¤ï¼ˆæ°´å¹³æ‰©å±•ï¼‰

2. **æ•°æ®ç»“æ„ç»„åˆ**
   - æ–‡æ¡£æ¨¡å‹ + åµŒå¥—æŸ¥è¯¢ï¼šçµæ´»çš„æ•°æ®ç»“æ„
   - ç´¢å¼• + èšåˆç®¡é“ï¼šé«˜æ•ˆçš„æ•°æ®å¤„ç†
   - å‰¯æœ¬é›† + è¯»å†™åˆ†ç¦»ï¼šé«˜å¯ç”¨æ¶æ„

3. **é«˜çº§åº”ç”¨åœºæ™¯**
   - å†…å®¹ç®¡ç†ç³»ç»Ÿï¼šå…¨æ–‡æœç´¢ã€ç‰ˆæœ¬ç®¡ç†ã€è¯„è®ºç³»ç»Ÿ
   - ç”µå•†è®¢å•ç³»ç»Ÿï¼šè®¢å•ç®¡ç†ã€çŠ¶æ€æµè½¬ã€ç»Ÿè®¡åˆ†æ
   - ç‰©è”ç½‘æ•°æ®å­˜å‚¨ï¼šæ—¶åºæ•°æ®ã€å®æ—¶æŸ¥è¯¢ã€æ•°æ®èšåˆ

4. **æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ**
   - åˆç†åˆ›å»ºç´¢å¼•ï¼ˆESR è§„åˆ™ã€æœ€å·¦å‰ç¼€ï¼‰
   - ä¼˜åŒ–èšåˆç®¡é“ï¼ˆå°½æ—©è¿‡æ»¤ã€ç´¢å¼•åˆ©ç”¨ï¼‰
   - ä½¿ç”¨æŠ•å½±ä¼˜åŒ–ï¼ˆåªé€‰æ‹©éœ€è¦çš„å­—æ®µï¼‰
   - è®¾ç½® TTL ç´¢å¼•ï¼ˆè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼‰
