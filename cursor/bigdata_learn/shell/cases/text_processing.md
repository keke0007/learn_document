# 案例3：文本处理

## 案例描述
学习 Shell 脚本中的文本处理工具，包括 grep、sed、awk、cut 等。

## 数据准备

### 数据文件 (log.txt)
```
2024-01-15 09:00:00 INFO User login: user001
2024-01-15 09:05:23 ERROR Database connection failed
2024-01-15 09:10:45 INFO User logout: user001
2024-01-15 09:15:30 WARN Low memory warning
2024-01-15 09:20:12 INFO User login: user002
2024-01-15 09:25:55 ERROR File not found: /path/to/file
2024-01-15 09:30:20 INFO User logout: user002
```

### 数据文件 (data.csv)
```
id,name,age,salary,department
1,张三,25,5000,IT
2,李四,30,8000,HR
3,王五,28,6000,IT
4,赵六,35,12000,Sales
5,孙七,27,5500,IT
```

## 脚本示例

### 1. grep 使用 (grep_examples.sh)
```bash
#!/bin/bash

# ============================================
# 基本搜索
# ============================================

echo "=== 搜索包含'INFO'的行 ==="
grep "INFO" data/log.txt

# ============================================
# 忽略大小写
# ============================================

echo -e "\n=== 忽略大小写搜索 ==="
grep -i "error" data/log.txt

# ============================================
# 显示行号
# ============================================

echo -e "\n=== 显示行号 ==="
grep -n "ERROR" data/log.txt

# ============================================
# 反向匹配
# ============================================

echo -e "\n=== 不包含'ERROR'的行 ==="
grep -v "ERROR" data/log.txt

# ============================================
# 统计匹配行数
# ============================================

echo -e "\n=== 统计匹配行数 ==="
echo "INFO 行数: $(grep -c "INFO" data/log.txt)"
echo "ERROR 行数: $(grep -c "ERROR" data/log.txt)"

# ============================================
# 只显示匹配的部分
# ============================================

echo -e "\n=== 只显示匹配部分 ==="
grep -o "user[0-9]*" data/log.txt

# ============================================
# 递归搜索
# ============================================

echo -e "\n=== 递归搜索 ==="
grep -r "INFO" data/
```

### 2. sed 使用 (sed_examples.sh)
```bash
#!/bin/bash

mkdir -p output

# ============================================
# 替换
# ============================================

echo "=== 替换 ==="
sed 's/INFO/信息/g' data/log.txt > output/log1.txt
head -n 3 output/log1.txt

# ============================================
# 全局替换
# ============================================

echo -e "\n=== 全局替换 ==="
sed 's/user/USER/g' data/log.txt > output/log2.txt
head -n 3 output/log2.txt

# ============================================
# 打印指定行
# ============================================

echo -e "\n=== 打印1-3行 ==="
sed -n '1,3p' data/log.txt

# ============================================
# 删除指定行
# ============================================

echo -e "\n=== 删除包含ERROR的行 ==="
sed '/ERROR/d' data/log.txt > output/log3.txt
head -n 3 output/log3.txt

# ============================================
# 插入行
# ============================================

echo -e "\n=== 在第2行后插入 ==="
sed '2a\---插入的行---' data/log.txt | head -n 5

# ============================================
# 原地修改
# ============================================

echo -e "\n=== 原地修改 ==="
cp data/log.txt output/log4.txt
sed -i 's/INFO/信息/g' output/log4.txt
head -n 3 output/log4.txt
```

### 3. awk 使用 (awk_examples.sh)
```bash
#!/bin/bash

# ============================================
# 打印列
# ============================================

echo "=== 打印第一列 ==="
awk '{print $1}' data/log.txt

# ============================================
# 指定分隔符
# ============================================

echo -e "\n=== CSV文件处理 ==="
awk -F',' '{print $2, $5}' data/data.csv

# ============================================
# 条件过滤
# ============================================

echo -e "\n=== 过滤包含ERROR的行 ==="
awk '/ERROR/ {print}' data/log.txt

# ============================================
# 数值计算
# ============================================

echo -e "\n=== 计算薪资总和 ==="
awk -F',' 'NR>1 {sum+=$4} END {print "薪资总和:", sum}' data/data.csv

# ============================================
# 分组统计
# ============================================

echo -e "\n=== 按部门统计人数 ==="
awk -F',' 'NR>1 {dept[$5]++} END {for(d in dept) print d, dept[d]}' data/data.csv

# ============================================
# 格式化输出
# ============================================

echo -e "\n=== 格式化输出 ==="
awk -F',' 'NR>1 {printf "%-5s %-10s %-10s\n", $1, $2, $5}' data/data.csv
```

### 4. cut 使用 (cut_examples.sh)
```bash
#!/bin/bash

# ============================================
# 按分隔符切分
# ============================================

echo "=== 按逗号切分，取第2列 ==="
cut -d',' -f2 data/data.csv

# ============================================
# 取多列
# ============================================

echo -e "\n=== 取第2和第5列 ==="
cut -d',' -f2,5 data/data.csv

# ============================================
# 按字符位置切分
# ============================================

echo -e "\n=== 取前10个字符 ==="
cut -c1-10 data/log.txt

# ============================================
# 取指定字符
# ============================================

echo -e "\n=== 取第5-10个字符 ==="
cut -c5-10 data/log.txt
```

### 5. 综合示例 (text_processing.sh)
```bash
#!/bin/bash

mkdir -p output

# ============================================
# 提取日志中的用户ID
# ============================================

echo "=== 提取用户ID ==="
grep -o "user[0-9]*" data/log.txt | sort -u

# ============================================
# 统计各日志级别数量
# ============================================

echo -e "\n=== 统计日志级别 ==="
awk '{level=$3; count[level]++} END {for(l in count) print l, count[l]}' data/log.txt

# ============================================
# 提取高薪员工
# ============================================

echo -e "\n=== 高薪员工（薪资>7000） ==="
awk -F',' 'NR>1 && $4>7000 {print $2, $4}' data/data.csv

# ============================================
# 生成报告
# ============================================

echo -e "\n=== 生成报告 ==="
cat > output/report.txt << EOF
=== 员工统计报告 ===

总人数: $(awk -F',' 'NR>1 {count++} END {print count}' data/data.csv)

平均薪资: $(awk -F',' 'NR>1 {sum+=$4; count++} END {printf "%.2f", sum/count}' data/data.csv)

各部门人数:
$(awk -F',' 'NR>1 {dept[$5]++} END {for(d in dept) print "  " d ": " dept[d]}' data/data.csv)
EOF

cat output/report.txt
```

## 运行方式

```bash
# 创建输出目录
mkdir -p output

# 添加执行权限
chmod +x grep_examples.sh sed_examples.sh awk_examples.sh cut_examples.sh text_processing.sh

# 运行脚本
./grep_examples.sh
./sed_examples.sh
./awk_examples.sh
./cut_examples.sh
./text_processing.sh
```

## 预期结果

### grep 输出
```
=== 搜索包含'INFO'的行 ===
2024-01-15 09:00:00 INFO User login: user001
2024-01-15 09:10:45 INFO User logout: user001
...

=== 统计匹配行数 ===
INFO 行数: 4
ERROR 行数: 2
```

### awk 输出
```
=== 计算薪资总和 ===
薪资总和: 36500

=== 按部门统计人数 ===
IT 3
HR 1
Sales 1
```

## 学习要点

1. **grep**：搜索、过滤、统计
2. **sed**：替换、删除、插入
3. **awk**：列处理、计算、格式化
4. **cut**：列提取、字符提取
5. **组合使用**：管道连接多个工具
